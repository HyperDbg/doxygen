<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg: hyperdbg/hprdbghv/code/vmm/vmx/Vmx.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HyperDbg
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_vmx_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Vmx.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>VMX Instructions and VMX Related Functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aefc23d5a8cd57a497e57045930e55eed"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#aefc23d5a8cd57a497e57045930e55eed">SELECTOR_TABLE_LDT</a>&#160;&#160;&#160;0x1</td></tr>
<tr class="separator:aefc23d5a8cd57a497e57045930e55eed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16f7f49927e1575a97fc0c3b57dceba1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a>&#160;&#160;&#160;0x0</td></tr>
<tr class="separator:a16f7f49927e1575a97fc0c3b57dceba1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:abbbc35bf970ac6b655e08bc3c0f46905"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#abbbc35bf970ac6b655e08bc3c0f46905">VmxCheckVmxSupport</a> ()</td></tr>
<tr class="memdesc:abbbc35bf970ac6b655e08bc3c0f46905"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether VMX Feature is supported or not.  <br /></td></tr>
<tr class="separator:abbbc35bf970ac6b655e08bc3c0f46905"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a21a5facaf10e8fbeb70dd00942e51ef1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a> ()</td></tr>
<tr class="memdesc:a21a5facaf10e8fbeb70dd00942e51ef1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check current execution mode (vmx-root and non-root)  <br /></td></tr>
<tr class="separator:a21a5facaf10e8fbeb70dd00942e51ef1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a54291454c7d99c90bf5e19a939825634"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a54291454c7d99c90bf5e19a939825634">VmxGetCurrentLaunchState</a> ()</td></tr>
<tr class="memdesc:a54291454c7d99c90bf5e19a939825634"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check if the VMX is launched or not.  <br /></td></tr>
<tr class="separator:a54291454c7d99c90bf5e19a939825634"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae8edcdeb74c24f1408eca2daf1ce986a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ae8edcdeb74c24f1408eca2daf1ce986a">VmxInitialize</a> ()</td></tr>
<tr class="memdesc:ae8edcdeb74c24f1408eca2daf1ce986a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize Vmx operation.  <br /></td></tr>
<tr class="separator:ae8edcdeb74c24f1408eca2daf1ce986a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a412b9cc437ccd62987c8f5a01e0a3f2d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a412b9cc437ccd62987c8f5a01e0a3f2d">VmxPerformVirtualizationOnAllCores</a> ()</td></tr>
<tr class="memdesc:a412b9cc437ccd62987c8f5a01e0a3f2d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize essential VMX Operation tasks.  <br /></td></tr>
<tr class="separator:a412b9cc437ccd62987c8f5a01e0a3f2d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad7d79ec1775eef01d11b05fd316b7eb7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ad7d79ec1775eef01d11b05fd316b7eb7">VmxPerformVirtualizationOnSpecificCore</a> ()</td></tr>
<tr class="memdesc:ad7d79ec1775eef01d11b05fd316b7eb7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocates Vmx regions for all logical cores (Vmxon region and Vmcs region)  <br /></td></tr>
<tr class="separator:ad7d79ec1775eef01d11b05fd316b7eb7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a56536723aab6c8ccb4719ff1eac2c25f"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a56536723aab6c8ccb4719ff1eac2c25f">VmxFixCr4AndCr0Bits</a> ()</td></tr>
<tr class="memdesc:a56536723aab6c8ccb4719ff1eac2c25f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Fix values for cr0 and cr4 bits.  <br /></td></tr>
<tr class="separator:a56536723aab6c8ccb4719ff1eac2c25f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1383bf1b0ee0da71f29e832a1e86144"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ae1383bf1b0ee0da71f29e832a1e86144">VmxCheckIsOnVmxRoot</a> ()</td></tr>
<tr class="memdesc:ae1383bf1b0ee0da71f29e832a1e86144"><td class="mdescLeft">&#160;</td><td class="mdescRight">It can deterministically check whether the caller is on vmx-root mode or not.  <br /></td></tr>
<tr class="separator:ae1383bf1b0ee0da71f29e832a1e86144"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af666da6f076709f466795cf1627d5e94"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#af666da6f076709f466795cf1627d5e94">VmxVirtualizeCurrentSystem</a> (PVOID GuestStack)</td></tr>
<tr class="memdesc:af666da6f076709f466795cf1627d5e94"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize VMX Operation.  <br /></td></tr>
<tr class="separator:af666da6f076709f466795cf1627d5e94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae683fd4d4ecd99c28292045bc8a65e18"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ae683fd4d4ecd99c28292045bc8a65e18">VmxTerminate</a> ()</td></tr>
<tr class="memdesc:ae683fd4d4ecd99c28292045bc8a65e18"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast to terminate VMX on all logical cores.  <br /></td></tr>
<tr class="separator:ae683fd4d4ecd99c28292045bc8a65e18"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a099f2c93689489c8a4117c8f6648efc1"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a099f2c93689489c8a4117c8f6648efc1">VmxVmptrst</a> ()</td></tr>
<tr class="memdesc:a099f2c93689489c8a4117c8f6648efc1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Implementation of VMPTRST instruction.  <br /></td></tr>
<tr class="separator:a099f2c93689489c8a4117c8f6648efc1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a40b4c16e2a106d27460f4a5dc8c76d70"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a40b4c16e2a106d27460f4a5dc8c76d70">VmxClearVmcsState</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a40b4c16e2a106d27460f4a5dc8c76d70"><td class="mdescLeft">&#160;</td><td class="mdescRight">Clearing Vmcs status using vmclear instruction.  <br /></td></tr>
<tr class="separator:a40b4c16e2a106d27460f4a5dc8c76d70"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d502eb714f3e5b8a9a405674190d1ca"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a5d502eb714f3e5b8a9a405674190d1ca">VmxLoadVmcs</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:a5d502eb714f3e5b8a9a405674190d1ca"><td class="mdescLeft">&#160;</td><td class="mdescRight">Implementation of VMPTRLD instruction.  <br /></td></tr>
<tr class="separator:a5d502eb714f3e5b8a9a405674190d1ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab410d0d271e13e18eb97f0870de4380d"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ab410d0d271e13e18eb97f0870de4380d">VmxSetupVmcs</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, PVOID GuestStack)</td></tr>
<tr class="memdesc:ab410d0d271e13e18eb97f0870de4380d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create and Configure a Vmcs Layout.  <br /></td></tr>
<tr class="separator:ab410d0d271e13e18eb97f0870de4380d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a78415dd94deee3861f8cdfe695331aa9"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a78415dd94deee3861f8cdfe695331aa9">VmxVmresume</a> ()</td></tr>
<tr class="memdesc:a78415dd94deee3861f8cdfe695331aa9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Resume VM using VMRESUME instruction.  <br /></td></tr>
<tr class="separator:a78415dd94deee3861f8cdfe695331aa9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeebf0c9346849df0d8fbf5a008c593dc"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#aeebf0c9346849df0d8fbf5a008c593dc">VmxVmfunc</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> EptpIndex, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Function)</td></tr>
<tr class="memdesc:aeebf0c9346849df0d8fbf5a008c593dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">VMFUNC instruction.  <br /></td></tr>
<tr class="separator:aeebf0c9346849df0d8fbf5a008c593dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9193ed1677033cd08c5d5b7788b15c7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#ad9193ed1677033cd08c5d5b7788b15c7">VmxVmxoff</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu)</td></tr>
<tr class="memdesc:ad9193ed1677033cd08c5d5b7788b15c7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Prepare and execute Vmxoff instruction.  <br /></td></tr>
<tr class="separator:ad9193ed1677033cd08c5d5b7788b15c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1493a49dc1f387ee57f95207869ad3b4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a1493a49dc1f387ee57f95207869ad3b4">VmxReturnStackPointerForVmxoff</a> ()</td></tr>
<tr class="memdesc:a1493a49dc1f387ee57f95207869ad3b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the RIP of guest (VMCS_GUEST_RIP) in the case of return from VMXOFF.  <br /></td></tr>
<tr class="separator:a1493a49dc1f387ee57f95207869ad3b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a121be6f80493612573f2177d8a17424e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a121be6f80493612573f2177d8a17424e">VmxReturnInstructionPointerForVmxoff</a> ()</td></tr>
<tr class="memdesc:a121be6f80493612573f2177d8a17424e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get the RIP of guest (VMCS_GUEST_RIP) in the case of return from VMXOFF.  <br /></td></tr>
<tr class="separator:a121be6f80493612573f2177d8a17424e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f8cf05fd265cf9568bc5f3b1ee57897"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a3f8cf05fd265cf9568bc5f3b1ee57897">VmxPerformTermination</a> ()</td></tr>
<tr class="memdesc:a3f8cf05fd265cf9568bc5f3b1ee57897"><td class="mdescLeft">&#160;</td><td class="mdescRight">Terminate Vmx on all logical cores.  <br /></td></tr>
<tr class="separator:a3f8cf05fd265cf9568bc5f3b1ee57897"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a84a3bd5efc8ff0858c095e18fe0999da"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a84a3bd5efc8ff0858c095e18fe0999da">VmxCompatibleStrlen</a> (const <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *<a class="el" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>)</td></tr>
<tr class="memdesc:a84a3bd5efc8ff0858c095e18fe0999da"><td class="mdescLeft">&#160;</td><td class="mdescRight">implementation of vmx-root mode compatible strlen  <br /></td></tr>
<tr class="separator:a84a3bd5efc8ff0858c095e18fe0999da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e2e419641070da1b794c2c62e691cc3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a2e2e419641070da1b794c2c62e691cc3">VmxCompatibleWcslen</a> (const wchar_t *<a class="el" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>)</td></tr>
<tr class="memdesc:a2e2e419641070da1b794c2c62e691cc3"><td class="mdescLeft">&#160;</td><td class="mdescRight">implementation of vmx-root mode compatible wcslen  <br /></td></tr>
<tr class="separator:a2e2e419641070da1b794c2c62e691cc3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f273dcefdaca4adfd02199030214a0c"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_vmx_8c.html#a4f273dcefdaca4adfd02199030214a0c">VmxGetSegmentDescriptor</a> (PUCHAR GdtBase, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> <a class="el" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ac0981ad69bb8ce42661d8f4eec22f5fe">PVMX_SEGMENT_SELECTOR</a> <a class="el" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>)</td></tr>
<tr class="memdesc:a4f273dcefdaca4adfd02199030214a0c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get Segment Descriptor.  <br /></td></tr>
<tr class="separator:a4f273dcefdaca4adfd02199030214a0c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>VMX Instructions and VMX Related Functions. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span class="obfuscator">.nosp@m.</span>hype<span class="obfuscator">.nosp@m.</span>rdbg.<span class="obfuscator">.nosp@m.</span>org</a>)</dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-11</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a16f7f49927e1575a97fc0c3b57dceba1" name="a16f7f49927e1575a97fc0c3b57dceba1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16f7f49927e1575a97fc0c3b57dceba1">&#9670;&#160;</a></span>SELECTOR_TABLE_GDT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SELECTOR_TABLE_GDT&#160;&#160;&#160;0x0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aefc23d5a8cd57a497e57045930e55eed" name="aefc23d5a8cd57a497e57045930e55eed"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aefc23d5a8cd57a497e57045930e55eed">&#9670;&#160;</a></span>SELECTOR_TABLE_LDT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SELECTOR_TABLE_LDT&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ae1383bf1b0ee0da71f29e832a1e86144" name="ae1383bf1b0ee0da71f29e832a1e86144"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1383bf1b0ee0da71f29e832a1e86144">&#9670;&#160;</a></span>VmxCheckIsOnVmxRoot()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxCheckIsOnVmxRoot </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>It can deterministically check whether the caller is on vmx-root mode or not. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if current operation mode is vmx-root and false if current operation mode is vmx non-root </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  383</span>{</div>
<div class="line"><span class="lineno">  384</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmcsLink = 0;</div>
<div class="line"><span class="lineno">  385</span> </div>
<div class="line"><span class="lineno">  386</span>    __try</div>
<div class="line"><span class="lineno">  387</span>    {</div>
<div class="line"><span class="lineno">  388</span>        <span class="keywordflow">if</span> (!__vmx_vmread(VMCS_GUEST_VMCS_LINK_POINTER, &amp;VmcsLink))</div>
<div class="line"><span class="lineno">  389</span>        {</div>
<div class="line"><span class="lineno">  390</span>            <span class="keywordflow">if</span> (VmcsLink != 0)</div>
<div class="line"><span class="lineno">  391</span>            {</div>
<div class="line"><span class="lineno">  392</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  393</span>            }</div>
<div class="line"><span class="lineno">  394</span>        }</div>
<div class="line"><span class="lineno">  395</span>    }</div>
<div class="line"><span class="lineno">  396</span>    __except (1)</div>
<div class="line"><span class="lineno">  397</span>    {</div>
<div class="line"><span class="lineno">  398</span>    }</div>
<div class="line"><span class="lineno">  399</span> </div>
<div class="line"><span class="lineno">  400</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  401</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:50</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:49</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:19</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abbbc35bf970ac6b655e08bc3c0f46905" name="abbbc35bf970ac6b655e08bc3c0f46905"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abbbc35bf970ac6b655e08bc3c0f46905">&#9670;&#160;</a></span>VmxCheckVmxSupport()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxCheckVmxSupport </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check whether VMX Feature is supported or not. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if vmx is supported or false if it's not supported </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   21</span>{</div>
<div class="line"><span class="lineno">   22</span>    <a class="code hl_struct" href="struct___c_p_u_i_d.html">CPUID</a>                         Data              = {0};</div>
<div class="line"><span class="lineno">   23</span>    IA32_FEATURE_CONTROL_REGISTER FeatureControlMsr = {0};</div>
<div class="line"><span class="lineno">   24</span> </div>
<div class="line"><span class="lineno">   25</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   26</span>    <span class="comment">// Gets Processor Info and Feature Bits</span></div>
<div class="line"><span class="lineno">   27</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   28</span>    __cpuid((<span class="keywordtype">int</span> *)&amp;Data, 1);</div>
<div class="line"><span class="lineno">   29</span> </div>
<div class="line"><span class="lineno">   30</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   31</span>    <span class="comment">// Check For VMX Bit CPUID.ECX[5]</span></div>
<div class="line"><span class="lineno">   32</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   33</span>    <span class="keywordflow">if</span> (!_bittest((<span class="keyword">const</span> LONG *)&amp;Data.<a class="code hl_variable" href="struct___c_p_u_i_d.html#ae21f8f943cb5557e135c5a5dddbfb67d">ecx</a>, 5))</div>
<div class="line"><span class="lineno">   34</span>    {</div>
<div class="line"><span class="lineno">   35</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   36</span>        <span class="comment">// returns FALSE if vmx is not supported</span></div>
<div class="line"><span class="lineno">   37</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   38</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">   39</span>    }</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>    FeatureControlMsr.AsUInt = __readmsr(IA32_FEATURE_CONTROL);</div>
<div class="line"><span class="lineno">   42</span> </div>
<div class="line"><span class="lineno">   43</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   44</span>    <span class="comment">// Commented because of https://stackoverflow.com/questions/34900224/</span></div>
<div class="line"><span class="lineno">   45</span>    <span class="comment">// and https://github.com/HyperDbg/HyperDbg/issues/24</span></div>
<div class="line"><span class="lineno">   46</span>    <span class="comment">// the problem is when writing to IA32_FEATURE_CONTROL MSR, the lock bit</span></div>
<div class="line"><span class="lineno">   47</span>    <span class="comment">// of this MSR Is not set to 0 on most computers, if the user enabled VT-X</span></div>
<div class="line"><span class="lineno">   48</span>    <span class="comment">// from the BIOS the VMXON will be already set so checking lock bit and</span></div>
<div class="line"><span class="lineno">   49</span>    <span class="comment">// then writing to EnableVmxon again is not meaningful since its already</span></div>
<div class="line"><span class="lineno">   50</span>    <span class="comment">// there</span></div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   52</span> </div>
<div class="line"><span class="lineno">   53</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   54</span>    <span class="comment">// if (FeatureControlMsr.Fields.Lock == 0)</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="comment">// {</span></div>
<div class="line"><span class="lineno">   56</span>    <span class="comment">//     FeatureControlMsr.Fields.Lock        = TRUE;</span></div>
<div class="line"><span class="lineno">   57</span>    <span class="comment">//     FeatureControlMsr.Fields.EnableVmxon = TRUE;</span></div>
<div class="line"><span class="lineno">   58</span>    <span class="comment">//     __writemsr(IA32_FEATURE_CONTROL, FeatureControlMsr.Flags);</span></div>
<div class="line"><span class="lineno">   59</span>    <span class="comment">// }</span></div>
<div class="line"><span class="lineno">   60</span> </div>
<div class="line"><span class="lineno">   61</span>    <span class="keywordflow">if</span> (FeatureControlMsr.EnableVmxOutsideSmx == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">   62</span>    {</div>
<div class="line"><span class="lineno">   63</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, you should enable vt-x from BIOS&quot;</span>);</div>
<div class="line"><span class="lineno">   64</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">   65</span>    }</div>
<div class="line"><span class="lineno">   66</span> </div>
<div class="line"><span class="lineno">   67</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">   68</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_a459b19922fecfbb9438dd56b66930d16"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a></div><div class="ttdeci">#define LogError(format,...)</div><div class="ttdoc">Log in the case of error.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:113</div></div>
<div class="ttc" id="astruct___c_p_u_i_d_html"><div class="ttname"><a href="struct___c_p_u_i_d.html">_CPUID</a></div><div class="ttdoc">CPUID Registers.</div><div class="ttdef"><b>Definition:</b> Common.h:233</div></div>
<div class="ttc" id="astruct___c_p_u_i_d_html_ae21f8f943cb5557e135c5a5dddbfb67d"><div class="ttname"><a href="struct___c_p_u_i_d.html#ae21f8f943cb5557e135c5a5dddbfb67d">_CPUID::ecx</a></div><div class="ttdeci">int ecx</div><div class="ttdef"><b>Definition:</b> Common.h:236</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a40b4c16e2a106d27460f4a5dc8c76d70" name="a40b4c16e2a106d27460f4a5dc8c76d70"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a40b4c16e2a106d27460f4a5dc8c76d70">&#9670;&#160;</a></span>VmxClearVmcsState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxClearVmcsState </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *&#160;</td>
          <td class="paramname"><em>VCpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Clearing Vmcs status using vmclear instruction. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If vmclear execution was successful it returns true otherwise and if there was error with vmclear then it returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  539</span>{</div>
<div class="line"><span class="lineno">  540</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ab27e9918b538ce9d8ca692479b375b6a">UINT8</a> VmclearStatus;</div>
<div class="line"><span class="lineno">  541</span> </div>
<div class="line"><span class="lineno">  542</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  543</span>    <span class="comment">// Clear the state of the VMCS to inactive</span></div>
<div class="line"><span class="lineno">  544</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  545</span>    VmclearStatus = __vmx_vmclear(&amp;VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a78c799e28ded00cb661165c92d53272a">VmcsRegionPhysicalAddress</a>);</div>
<div class="line"><span class="lineno">  546</span> </div>
<div class="line"><span class="lineno">  547</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMCS VMCLEAR status : 0x%x&quot;</span>, VmclearStatus);</div>
<div class="line"><span class="lineno">  548</span> </div>
<div class="line"><span class="lineno">  549</span>    <span class="keywordflow">if</span> (VmclearStatus)</div>
<div class="line"><span class="lineno">  550</span>    {</div>
<div class="line"><span class="lineno">  551</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  552</span>        <span class="comment">// Otherwise terminate the VMX</span></div>
<div class="line"><span class="lineno">  553</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  554</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMCS failed to clear, status : 0x%x&quot;</span>, VmclearStatus);</div>
<div class="line"><span class="lineno">  555</span>        __vmx_off();</div>
<div class="line"><span class="lineno">  556</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  557</span>    }</div>
<div class="line"><span class="lineno">  558</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  559</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_ab27e9918b538ce9d8ca692479b375b6a"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ab27e9918b538ce9d8ca692479b375b6a">UINT8</a></div><div class="ttdeci">unsigned char UINT8</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:44</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_a108126279e46f4d46d25abe24da43fdc"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a></div><div class="ttdeci">#define LogDebugInfo(format,...)</div><div class="ttdoc">Log, initilize boot information and debug information.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:155</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a78c799e28ded00cb661165c92d53272a"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a78c799e28ded00cb661165c92d53272a">_VIRTUAL_MACHINE_STATE::VmcsRegionPhysicalAddress</a></div><div class="ttdeci">UINT64 VmcsRegionPhysicalAddress</div><div class="ttdef"><b>Definition:</b> State.h:230</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a84a3bd5efc8ff0858c095e18fe0999da" name="a84a3bd5efc8ff0858c095e18fe0999da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a84a3bd5efc8ff0858c095e18fe0999da">&#9670;&#160;</a></span>VmxCompatibleStrlen()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> VmxCompatibleStrlen </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *&#160;</td>
          <td class="paramname"><em>S</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>implementation of vmx-root mode compatible strlen </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">S</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 If 0x0 indicates an error, otherwise length of the string </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1037</span>{</div>
<div class="line"><span class="lineno"> 1038</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>     Temp  = NULL;</div>
<div class="line"><span class="lineno"> 1039</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>   Count = 0;</div>
<div class="line"><span class="lineno"> 1040</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   AlignedAddress;</div>
<div class="line"><span class="lineno"> 1041</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><span class="lineno"> 1042</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> OriginalCr3;</div>
<div class="line"><span class="lineno"> 1043</span> </div>
<div class="line"><span class="lineno"> 1044</span>    AlignedAddress = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>);</div>
<div class="line"><span class="lineno"> 1045</span> </div>
<div class="line"><span class="lineno"> 1046</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1047</span>    <span class="comment">// Find the current process cr3</span></div>
<div class="line"><span class="lineno"> 1048</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1049</span>    GuestCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ade88a95bca6e425e8c81c358d041d76c">LayoutGetCurrentProcessCr3</a>().<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><span class="lineno"> 1050</span> </div>
<div class="line"><span class="lineno"> 1051</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1052</span>    <span class="comment">// Move to new cr3</span></div>
<div class="line"><span class="lineno"> 1053</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1054</span>    OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><span class="lineno"> 1055</span>    __writecr3(GuestCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1056</span> </div>
<div class="line"><span class="lineno"> 1057</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1058</span>    <span class="comment">// First check</span></div>
<div class="line"><span class="lineno"> 1059</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1060</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a240789bd1c3cf023cd1403d4ea32bb19">CheckAccessValidityAndSafety</a>(AlignedAddress, <span class="keyword">sizeof</span>(<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>)))</div>
<div class="line"><span class="lineno"> 1061</span>    {</div>
<div class="line"><span class="lineno"> 1062</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1063</span>        <span class="comment">// Error</span></div>
<div class="line"><span class="lineno"> 1064</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1065</span> </div>
<div class="line"><span class="lineno"> 1066</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1067</span>        <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1068</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1069</span>        __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1070</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno"> 1071</span>    }</div>
<div class="line"><span class="lineno"> 1072</span> </div>
<div class="line"><span class="lineno"> 1073</span>    <span class="keywordflow">while</span> (<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1074</span>    {</div>
<div class="line"><span class="lineno"> 1075</span>        <span class="comment">/*</span></div>
<div class="line"><span class="lineno"> 1076</span><span class="comment">        Temp = *S;</span></div>
<div class="line"><span class="lineno"> 1077</span><span class="comment">        */</span></div>
<div class="line"><span class="lineno"> 1078</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a>(<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>, &amp;Temp, <span class="keyword">sizeof</span>(<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>));</div>
<div class="line"><span class="lineno"> 1079</span> </div>
<div class="line"><span class="lineno"> 1080</span>        <span class="keywordflow">if</span> (Temp != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line"><span class="lineno"> 1081</span>        {</div>
<div class="line"><span class="lineno"> 1082</span>            Count++;</div>
<div class="line"><span class="lineno"> 1083</span>            <a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>++;</div>
<div class="line"><span class="lineno"> 1084</span>        }</div>
<div class="line"><span class="lineno"> 1085</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1086</span>        {</div>
<div class="line"><span class="lineno"> 1087</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1088</span>            <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1089</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1090</span>            __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1091</span>            <span class="keywordflow">return</span> Count;</div>
<div class="line"><span class="lineno"> 1092</span>        }</div>
<div class="line"><span class="lineno"> 1093</span> </div>
<div class="line"><span class="lineno"> 1094</span>        <span class="keywordflow">if</span> (!((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a> &amp; (<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)))</div>
<div class="line"><span class="lineno"> 1095</span>        {</div>
<div class="line"><span class="lineno"> 1096</span>            <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a240789bd1c3cf023cd1403d4ea32bb19">CheckAccessValidityAndSafety</a>((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>, <span class="keyword">sizeof</span>(<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>)))</div>
<div class="line"><span class="lineno"> 1097</span>            {</div>
<div class="line"><span class="lineno"> 1098</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1099</span>                <span class="comment">// Error</span></div>
<div class="line"><span class="lineno"> 1100</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1101</span> </div>
<div class="line"><span class="lineno"> 1102</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1103</span>                <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1104</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1105</span>                __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1106</span>                <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno"> 1107</span>            }</div>
<div class="line"><span class="lineno"> 1108</span>        }</div>
<div class="line"><span class="lineno"> 1109</span>    }</div>
<div class="line"><span class="lineno"> 1110</span> </div>
<div class="line"><span class="lineno"> 1111</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1112</span>    <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1113</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1114</span>    __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1115</span>}</div>
<div class="ttc" id="a_grammar_8txt_html_a0090525a3807846992c51ba3026d2355"><div class="ttname"><a href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a></div><div class="ttdeci">ThreeOpFunc1 interlocked_compare_exchange memcpy TwoOpFunc1 ed eb eq interlocked_exchange interlocked_exchange_add TwoOpFunc2 spinlock_lock_custom_wait OneOpFunc1 poi db dd dw dq neg hi low not check_address strlen wcslen interlocked_increment interlocked_decrement reference physical_to_virtual virtual_to_physical event_sc OneOpFunc2 print formats event_enable event_disable test_statement spinlock_lock spinlock_unlock ZeroOpFunc1 pause flush VarArgFunc1 printf OperatorsTwoOperand or xor and asr asl add sub mul div mod gt lt egt elt equal neq OperatorsOneOperand inc dec reference dereference SemantiRules start_of_if jmp jz jnz jmp_to_end_and_jzcompleted end_of_if start_of_while end_of_while vargstart mov start_of_do_while start_of_do_while_commands end_of_do_while start_of_for for_inc_dec start_of_for_ommands end_of_if ignore_lvalue Registers rax eax ax ah al rcx ecx cx ch cl rdx edx dx dh dl rbx ebx bx bh bl rsp esp sp spl rbp ebp bp bpl rsi esi si sil rdi edi di dil r8 r8d r8w r8h r8l r9 r9d r9w r9h r9l r10 r10d r10w r10h r10l r11 r11d r11w r11h r11l r12 r12d r12w r12h r12l r13 r13d r13w r13h r13l r14 r14d r14w r14h r14l r15 r15d r15w r15h r15l ds es fs gs cs ss rflags eflags flags cf pf af zf sf tf if df of iopl nt rf vm ac vif vip id rip eip ip idtr ldtr gdtr tr cr0 cr2 cr3 cr4 cr8 dr0 dr1 dr2 dr3 dr6 dr7 PseudoRegisters pid tid pname core proc thread peb teb ip buffer context event_tag event_id S STATEMENT S S</div><div class="ttdef"><b>Definition:</b> Grammar.txt:33</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:46</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aebb9e13210d88d43e32e735ada43a425"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a></div><div class="ttdeci">char CHAR</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:29</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a240789bd1c3cf023cd1403d4ea32bb19"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a240789bd1c3cf023cd1403d4ea32bb19">CheckAccessValidityAndSafety</a></div><div class="ttdeci">IMPORT_EXPORT_VMM BOOLEAN CheckAccessValidityAndSafety(UINT64 TargetAddress, UINT32 Size)</div><div class="ttdoc">Check the safety to access the memory.</div><div class="ttdef"><b>Definition:</b> common.cpp:1038</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a2f6df53976f17e73cc27e73ebcc8156a"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a></div><div class="ttdeci">IMPORT_EXPORT_VMM BOOLEAN MemoryMapperReadMemorySafe(_In_ UINT64 VaAddressToRead, _Inout_ PVOID BufferToSaveMemory, _In_ SIZE_T SizeToRead)</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_ade88a95bca6e425e8c81c358d041d76c"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ade88a95bca6e425e8c81c358d041d76c">LayoutGetCurrentProcessCr3</a></div><div class="ttdeci">IMPORT_EXPORT_VMM CR3_TYPE LayoutGetCurrentProcessCr3()</div><div class="ttdoc">Get cr3 of the target running process.</div><div class="ttdef"><b>Definition:</b> Layout.c:55</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_a7d467c1d283fdfa1f2081ba1e0d01b6e"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a></div><div class="ttdeci">#define PAGE_SIZE</div><div class="ttdoc">Size of each page (4096 bytes)</div><div class="ttdef"><b>Definition:</b> common.h:59</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_aa02188de52b66a3aa5e1aecc6bd963ae"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a></div><div class="ttdeci">#define PAGE_ALIGN(Va)</div><div class="ttdoc">Aligning a page.</div><div class="ttdef"><b>Definition:</b> common.h:65</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html">_CR3_TYPE</a></div><div class="ttdoc">CR3 Structure.</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:136</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html_a04eb96cc99b0458be739bcc9c640e08b"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">_CR3_TYPE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:139</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2e2e419641070da1b794c2c62e691cc3" name="a2e2e419641070da1b794c2c62e691cc3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e2e419641070da1b794c2c62e691cc3">&#9670;&#160;</a></span>VmxCompatibleWcslen()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> VmxCompatibleWcslen </td>
          <td>(</td>
          <td class="paramtype">const wchar_t *&#160;</td>
          <td class="paramname"><em>S</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>implementation of vmx-root mode compatible wcslen </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">S</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 If 0x0 indicates an error, otherwise length of the string </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1126</span>{</div>
<div class="line"><span class="lineno"> 1127</span>    <span class="keywordtype">wchar_t</span>  Temp  = NULL;</div>
<div class="line"><span class="lineno"> 1128</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>   Count = 0;</div>
<div class="line"><span class="lineno"> 1129</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   AlignedAddress;</div>
<div class="line"><span class="lineno"> 1130</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><span class="lineno"> 1131</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> OriginalCr3;</div>
<div class="line"><span class="lineno"> 1132</span> </div>
<div class="line"><span class="lineno"> 1133</span>    AlignedAddress = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>);</div>
<div class="line"><span class="lineno"> 1134</span> </div>
<div class="line"><span class="lineno"> 1135</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1136</span>    <span class="comment">// Find the current process cr3</span></div>
<div class="line"><span class="lineno"> 1137</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1138</span>    GuestCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ade88a95bca6e425e8c81c358d041d76c">LayoutGetCurrentProcessCr3</a>().<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><span class="lineno"> 1139</span> </div>
<div class="line"><span class="lineno"> 1140</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1141</span>    <span class="comment">// Move to new cr3</span></div>
<div class="line"><span class="lineno"> 1142</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1143</span>    OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><span class="lineno"> 1144</span>    __writecr3(GuestCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1145</span> </div>
<div class="line"><span class="lineno"> 1146</span>    AlignedAddress = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>);</div>
<div class="line"><span class="lineno"> 1147</span> </div>
<div class="line"><span class="lineno"> 1148</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1149</span>    <span class="comment">// First check</span></div>
<div class="line"><span class="lineno"> 1150</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1151</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a240789bd1c3cf023cd1403d4ea32bb19">CheckAccessValidityAndSafety</a>(AlignedAddress, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)))</div>
<div class="line"><span class="lineno"> 1152</span>    {</div>
<div class="line"><span class="lineno"> 1153</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1154</span>        <span class="comment">// Error</span></div>
<div class="line"><span class="lineno"> 1155</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1156</span> </div>
<div class="line"><span class="lineno"> 1157</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1158</span>        <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1159</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1160</span>        __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1161</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno"> 1162</span>    }</div>
<div class="line"><span class="lineno"> 1163</span> </div>
<div class="line"><span class="lineno"> 1164</span>    <span class="keywordflow">while</span> (<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1165</span>    {</div>
<div class="line"><span class="lineno"> 1166</span>        <span class="comment">/*</span></div>
<div class="line"><span class="lineno"> 1167</span><span class="comment">        Temp = *S;</span></div>
<div class="line"><span class="lineno"> 1168</span><span class="comment">        */</span></div>
<div class="line"><span class="lineno"> 1169</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a>(<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>, &amp;Temp, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>));</div>
<div class="line"><span class="lineno"> 1170</span> </div>
<div class="line"><span class="lineno"> 1171</span>        <span class="keywordflow">if</span> (Temp != <span class="stringliteral">&#39;\0\0&#39;</span>)</div>
<div class="line"><span class="lineno"> 1172</span>        {</div>
<div class="line"><span class="lineno"> 1173</span>            Count++;</div>
<div class="line"><span class="lineno"> 1174</span>            <a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>++;</div>
<div class="line"><span class="lineno"> 1175</span>        }</div>
<div class="line"><span class="lineno"> 1176</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1177</span>        {</div>
<div class="line"><span class="lineno"> 1178</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1179</span>            <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1180</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1181</span>            __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1182</span>            <span class="keywordflow">return</span> Count;</div>
<div class="line"><span class="lineno"> 1183</span>        }</div>
<div class="line"><span class="lineno"> 1184</span> </div>
<div class="line"><span class="lineno"> 1185</span>        <span class="keywordflow">if</span> (!((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a> &amp; (<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)))</div>
<div class="line"><span class="lineno"> 1186</span>        {</div>
<div class="line"><span class="lineno"> 1187</span>            <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a240789bd1c3cf023cd1403d4ea32bb19">CheckAccessValidityAndSafety</a>((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_variable" href="_grammar_8txt.html#a0090525a3807846992c51ba3026d2355">S</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)))</div>
<div class="line"><span class="lineno"> 1188</span>            {</div>
<div class="line"><span class="lineno"> 1189</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1190</span>                <span class="comment">// Error</span></div>
<div class="line"><span class="lineno"> 1191</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1192</span> </div>
<div class="line"><span class="lineno"> 1193</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1194</span>                <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1195</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1196</span>                __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1197</span>                <span class="keywordflow">return</span> 0;</div>
<div class="line"><span class="lineno"> 1198</span>            }</div>
<div class="line"><span class="lineno"> 1199</span>        }</div>
<div class="line"><span class="lineno"> 1200</span>    }</div>
<div class="line"><span class="lineno"> 1201</span> </div>
<div class="line"><span class="lineno"> 1202</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1203</span>    <span class="comment">// Move back to original cr3</span></div>
<div class="line"><span class="lineno"> 1204</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1205</span>    __writecr3(OriginalCr3.<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><span class="lineno"> 1206</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a56536723aab6c8ccb4719ff1eac2c25f" name="a56536723aab6c8ccb4719ff1eac2c25f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a56536723aab6c8ccb4719ff1eac2c25f">&#9670;&#160;</a></span>VmxFixCr4AndCr0Bits()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> VmxFixCr4AndCr0Bits </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Fix values for cr0 and cr4 bits. </p>
<p>The Cr4 And Cr0 Bits During VMX Operation Preventing Them From Any Change (<a href="https://revers.engineering/day-2-entering-vmx-operation/">https://revers.engineering/day-2-entering-vmx-operation/</a>)</p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  348</span>{</div>
<div class="line"><span class="lineno">  349</span>    <a class="code hl_union" href="union___c_r___f_i_x_e_d.html">CR_FIXED</a> CrFixed = {0};</div>
<div class="line"><span class="lineno">  350</span>    CR4      Cr4     = {0};</div>
<div class="line"><span class="lineno">  351</span>    CR0      Cr0     = {0};</div>
<div class="line"><span class="lineno">  352</span> </div>
<div class="line"><span class="lineno">  353</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  354</span>    <span class="comment">// Fix Cr0</span></div>
<div class="line"><span class="lineno">  355</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  356</span>    CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a234b22477a295b0e57092544d0f02a62">Flags</a> = __readmsr(IA32_VMX_CR0_FIXED0);</div>
<div class="line"><span class="lineno">  357</span>    Cr0.AsUInt    = __readcr0();</div>
<div class="line"><span class="lineno">  358</span>    Cr0.AsUInt |= CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#aee843bb3ac8e72a6aa2f8ddf7aa10cdc">Fields</a>.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a1295d83d7e48f5a6a180fea7978619a6">Low</a>;</div>
<div class="line"><span class="lineno">  359</span>    CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a234b22477a295b0e57092544d0f02a62">Flags</a> = __readmsr(IA32_VMX_CR0_FIXED1);</div>
<div class="line"><span class="lineno">  360</span>    Cr0.AsUInt &amp;= CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#aee843bb3ac8e72a6aa2f8ddf7aa10cdc">Fields</a>.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a1295d83d7e48f5a6a180fea7978619a6">Low</a>;</div>
<div class="line"><span class="lineno">  361</span>    __writecr0(Cr0.AsUInt);</div>
<div class="line"><span class="lineno">  362</span> </div>
<div class="line"><span class="lineno">  363</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  364</span>    <span class="comment">// Fix Cr4</span></div>
<div class="line"><span class="lineno">  365</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  366</span>    CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a234b22477a295b0e57092544d0f02a62">Flags</a> = __readmsr(IA32_VMX_CR4_FIXED0);</div>
<div class="line"><span class="lineno">  367</span>    Cr4.AsUInt    = __readcr4();</div>
<div class="line"><span class="lineno">  368</span>    Cr4.AsUInt |= CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#aee843bb3ac8e72a6aa2f8ddf7aa10cdc">Fields</a>.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a1295d83d7e48f5a6a180fea7978619a6">Low</a>;</div>
<div class="line"><span class="lineno">  369</span>    CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a234b22477a295b0e57092544d0f02a62">Flags</a> = __readmsr(IA32_VMX_CR4_FIXED1);</div>
<div class="line"><span class="lineno">  370</span>    Cr4.AsUInt &amp;= CrFixed.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#aee843bb3ac8e72a6aa2f8ddf7aa10cdc">Fields</a>.<a class="code hl_variable" href="union___c_r___f_i_x_e_d.html#a1295d83d7e48f5a6a180fea7978619a6">Low</a>;</div>
<div class="line"><span class="lineno">  371</span>    __writecr4(Cr4.AsUInt);</div>
<div class="line"><span class="lineno">  372</span>}</div>
<div class="ttc" id="aunion___c_r___f_i_x_e_d_html"><div class="ttname"><a href="union___c_r___f_i_x_e_d.html">_CR_FIXED</a></div><div class="ttdef"><b>Definition:</b> Common.h:258</div></div>
<div class="ttc" id="aunion___c_r___f_i_x_e_d_html_a1295d83d7e48f5a6a180fea7978619a6"><div class="ttname"><a href="union___c_r___f_i_x_e_d.html#a1295d83d7e48f5a6a180fea7978619a6">_CR_FIXED::Low</a></div><div class="ttdeci">unsigned long Low</div><div class="ttdef"><b>Definition:</b> Common.h:263</div></div>
<div class="ttc" id="aunion___c_r___f_i_x_e_d_html_a234b22477a295b0e57092544d0f02a62"><div class="ttname"><a href="union___c_r___f_i_x_e_d.html#a234b22477a295b0e57092544d0f02a62">_CR_FIXED::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> Common.h:259</div></div>
<div class="ttc" id="aunion___c_r___f_i_x_e_d_html_aee843bb3ac8e72a6aa2f8ddf7aa10cdc"><div class="ttname"><a href="union___c_r___f_i_x_e_d.html#aee843bb3ac8e72a6aa2f8ddf7aa10cdc">_CR_FIXED::Fields</a></div><div class="ttdeci">struct _CR_FIXED::@6 Fields</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a21a5facaf10e8fbeb70dd00942e51ef1" name="a21a5facaf10e8fbeb70dd00942e51ef1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a21a5facaf10e8fbeb70dd00942e51ef1">&#9670;&#160;</a></span>VmxGetCurrentExecutionMode()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxGetCurrentExecutionMode </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check current execution mode (vmx-root and non-root) </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the execution is on vmx-root, otherwise false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   77</span>{</div>
<div class="line"><span class="lineno">   78</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>)</div>
<div class="line"><span class="lineno">   79</span>    {</div>
<div class="line"><span class="lineno">   80</span>        <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   CurrentCore    = KeGetCurrentProcessorIndex();</div>
<div class="line"><span class="lineno">   81</span>        <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * CurrentVmState = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">   82</span> </div>
<div class="line"><span class="lineno">   83</span>        <span class="keywordflow">return</span> CurrentVmState-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ac3a540948c9dbdb00cce2ef4beb6aa20">IsOnVmxRootMode</a> ? <a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#aa3d274ecfb8f42a16c4827d872241fc4a6ad497a95ab270156d4acfb3b1106104">VmxExecutionModeRoot</a> : <a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#aa3d274ecfb8f42a16c4827d872241fc4a4766e6886433f4096309a4643a4b2572">VmxExecutionModeNonRoot</a>;</div>
<div class="line"><span class="lineno">   84</span>    }</div>
<div class="line"><span class="lineno">   85</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">   86</span>    {</div>
<div class="line"><span class="lineno">   87</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   88</span>        <span class="comment">// The structure for guest state is not initialized, thus, we&#39;re in VMX non-root</span></div>
<div class="line"><span class="lineno">   89</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   90</span>        <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#aa3d274ecfb8f42a16c4827d872241fc4a4766e6886433f4096309a4643a4b2572">VmxExecutionModeNonRoot</a>;</div>
<div class="line"><span class="lineno">   91</span>    }</div>
<div class="line"><span class="lineno">   92</span>}</div>
<div class="ttc" id="a_global_variables_8h_html_a04bac1f4beef0dcf1ce1a4d9ce72ea76"><div class="ttname"><a href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a></div><div class="ttdeci">VIRTUAL_MACHINE_STATE * g_GuestState</div><div class="ttdoc">Save the state and variables related to virtualization on each to logical core.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:38</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:35</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_aa3d274ecfb8f42a16c4827d872241fc4a4766e6886433f4096309a4643a4b2572"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#aa3d274ecfb8f42a16c4827d872241fc4a4766e6886433f4096309a4643a4b2572">VmxExecutionModeNonRoot</a></div><div class="ttdeci">@ VmxExecutionModeNonRoot</div><div class="ttdef"><b>Definition:</b> DataTypes.h:68</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_aa3d274ecfb8f42a16c4827d872241fc4a6ad497a95ab270156d4acfb3b1106104"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#aa3d274ecfb8f42a16c4827d872241fc4a6ad497a95ab270156d4acfb3b1106104">VmxExecutionModeRoot</a></div><div class="ttdeci">@ VmxExecutionModeRoot</div><div class="ttdef"><b>Definition:</b> DataTypes.h:69</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">_VIRTUAL_MACHINE_STATE</a></div><div class="ttdoc">The status of each core after and before VMX.</div><div class="ttdef"><b>Definition:</b> State.h:208</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_ac3a540948c9dbdb00cce2ef4beb6aa20"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ac3a540948c9dbdb00cce2ef4beb6aa20">_VIRTUAL_MACHINE_STATE::IsOnVmxRootMode</a></div><div class="ttdeci">BOOLEAN IsOnVmxRootMode</div><div class="ttdef"><b>Definition:</b> State.h:209</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a54291454c7d99c90bf5e19a939825634" name="a54291454c7d99c90bf5e19a939825634"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a54291454c7d99c90bf5e19a939825634">&#9670;&#160;</a></span>VmxGetCurrentLaunchState()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxGetCurrentLaunchState </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check if the VMX is launched or not. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if it's launched, otherwise false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  101</span>{</div>
<div class="line"><span class="lineno">  102</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   CurrentCore    = KeGetCurrentProcessorIndex();</div>
<div class="line"><span class="lineno">  103</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * CurrentVmState = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">  104</span> </div>
<div class="line"><span class="lineno">  105</span>    <span class="keywordflow">return</span> CurrentVmState-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">HasLaunched</a>;</div>
<div class="line"><span class="lineno">  106</span>}</div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_aaacba0883eec22779a564fb93aea73fd"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">_VIRTUAL_MACHINE_STATE::HasLaunched</a></div><div class="ttdeci">BOOLEAN HasLaunched</div><div class="ttdef"><b>Definition:</b> State.h:211</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a4f273dcefdaca4adfd02199030214a0c" name="a4f273dcefdaca4adfd02199030214a0c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f273dcefdaca4adfd02199030214a0c">&#9670;&#160;</a></span>VmxGetSegmentDescriptor()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxGetSegmentDescriptor </td>
          <td>(</td>
          <td class="paramtype">PUCHAR&#160;</td>
          <td class="paramname"><em>GdtBase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>&#160;</td>
          <td class="paramname"><em>Selector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ac0981ad69bb8ce42661d8f4eec22f5fe">PVMX_SEGMENT_SELECTOR</a>&#160;</td>
          <td class="paramname"><em>SegmentSelector</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get Segment Descriptor. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">SegmentSelector</td><td></td></tr>
    <tr><td class="paramname">Selector</td><td></td></tr>
    <tr><td class="paramname">GdtBase</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1219</span>{</div>
<div class="line"><span class="lineno"> 1220</span>    SEGMENT_DESCRIPTOR_32 * DescriptorTable32;</div>
<div class="line"><span class="lineno"> 1221</span>    SEGMENT_DESCRIPTOR_32 * Descriptor32;</div>
<div class="line"><span class="lineno"> 1222</span>    SEGMENT_SELECTOR        SegSelector = {.AsUInt = <a class="code hl_variable" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>};</div>
<div class="line"><span class="lineno"> 1223</span> </div>
<div class="line"><span class="lineno"> 1224</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>)</div>
<div class="line"><span class="lineno"> 1225</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1226</span> </div>
<div class="line"><span class="lineno"> 1227</span><span class="preprocessor">#define SELECTOR_TABLE_LDT 0x1</span></div>
<div class="line"><span class="lineno"> 1228</span><span class="preprocessor">#define SELECTOR_TABLE_GDT 0x0</span></div>
<div class="line"><span class="lineno"> 1229</span> </div>
<div class="line"><span class="lineno"> 1230</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1231</span>    <span class="comment">// Ignore LDT</span></div>
<div class="line"><span class="lineno"> 1232</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1233</span>    <span class="keywordflow">if</span> ((<a class="code hl_variable" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a> == 0x0) || (SegSelector.Table != <a class="code hl_define" href="_vmx_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a>))</div>
<div class="line"><span class="lineno"> 1234</span>    {</div>
<div class="line"><span class="lineno"> 1235</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1236</span>    }</div>
<div class="line"><span class="lineno"> 1237</span> </div>
<div class="line"><span class="lineno"> 1238</span>    DescriptorTable32 = (SEGMENT_DESCRIPTOR_32 *)(GdtBase);</div>
<div class="line"><span class="lineno"> 1239</span>    Descriptor32      = &amp;DescriptorTable32[SegSelector.Index];</div>
<div class="line"><span class="lineno"> 1240</span> </div>
<div class="line"><span class="lineno"> 1241</span>    <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#ab6ee44522229df1c55cca4f72f172abf">Selector</a> = <a class="code hl_variable" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>;</div>
<div class="line"><span class="lineno"> 1242</span>    <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a>    = __segmentlimit(<a class="code hl_variable" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>);</div>
<div class="line"><span class="lineno"> 1243</span>    <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a>     = (Descriptor32-&gt;BaseAddressLow | Descriptor32-&gt;BaseAddressMiddle &lt;&lt; 16 | Descriptor32-&gt;BaseAddressHigh &lt;&lt; 24);</div>
<div class="line"><span class="lineno"> 1244</span> </div>
<div class="line"><span class="lineno"> 1245</span>    <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a351ac6eabc90a04fff1b1c8c99875dd9">Attributes</a>.<a class="code hl_variable" href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#a911f358641501ff3e2864fcfdc0262ff">AsUInt</a> = (<a class="code hl_function" href="_inline_asm_8h.html#aedeb3f3df41e4bb43b6aed532e969195">AsmGetAccessRights</a>(<a class="code hl_variable" href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>) &gt;&gt; 8);</div>
<div class="line"><span class="lineno"> 1246</span> </div>
<div class="line"><span class="lineno"> 1247</span>    <span class="keywordflow">if</span> (SegSelector.Table == 0 &amp;&amp; SegSelector.Index == 0)</div>
<div class="line"><span class="lineno"> 1248</span>    {</div>
<div class="line"><span class="lineno"> 1249</span>        <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a351ac6eabc90a04fff1b1c8c99875dd9">Attributes</a>.<a class="code hl_variable" href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#af86e8c35cdab1d3c5f302761596bcdae">Unusable</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1250</span>    }</div>
<div class="line"><span class="lineno"> 1251</span> </div>
<div class="line"><span class="lineno"> 1252</span>    <span class="keywordflow">if</span> ((Descriptor32-&gt;Type == SEGMENT_DESCRIPTOR_TYPE_TSS_BUSY) || (Descriptor32-&gt;Type == SEGMENT_DESCRIPTOR_TYPE_CALL_GATE))</div>
<div class="line"><span class="lineno"> 1253</span>    {</div>
<div class="line"><span class="lineno"> 1254</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1255</span>        <span class="comment">// this is a TSS or callgate etc, save the base high part</span></div>
<div class="line"><span class="lineno"> 1256</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1257</span> </div>
<div class="line"><span class="lineno"> 1258</span>        <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> SegmentLimitHigh;</div>
<div class="line"><span class="lineno"> 1259</span>        SegmentLimitHigh      = (*(<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> *)((PUCHAR)Descriptor32 + 8));</div>
<div class="line"><span class="lineno"> 1260</span>        <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a> = (<a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a> &amp; 0xffffffff) | (SegmentLimitHigh &lt;&lt; 32);</div>
<div class="line"><span class="lineno"> 1261</span>    }</div>
<div class="line"><span class="lineno"> 1262</span> </div>
<div class="line"><span class="lineno"> 1263</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a351ac6eabc90a04fff1b1c8c99875dd9">Attributes</a>.<a class="code hl_variable" href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#a2f6bda13194a3525ec136782a138e06a">Granularity</a>)</div>
<div class="line"><span class="lineno"> 1264</span>    {</div>
<div class="line"><span class="lineno"> 1265</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1266</span>        <span class="comment">// 4096-bit granularity is enabled for this segment, scale the limit</span></div>
<div class="line"><span class="lineno"> 1267</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1268</span>        <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a> = (<a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a> &lt;&lt; 12) + 0xfff;</div>
<div class="line"><span class="lineno"> 1269</span>    }</div>
<div class="line"><span class="lineno"> 1270</span> </div>
<div class="line"><span class="lineno"> 1271</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1272</span>}</div>
<div class="ttc" id="a_inline_asm_8h_html_aedeb3f3df41e4bb43b6aed532e969195"><div class="ttname"><a href="_inline_asm_8h.html#aedeb3f3df41e4bb43b6aed532e969195">AsmGetAccessRights</a></div><div class="ttdeci">UINT32 AsmGetAccessRights(unsigned short Selector)</div></div>
<div class="ttc" id="a_vmx_8c_html_a16f7f49927e1575a97fc0c3b57dceba1"><div class="ttname"><a href="_vmx_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a></div><div class="ttdeci">#define SELECTOR_TABLE_GDT</div></div>
<div class="ttc" id="a_vmx_8h_html_a4a0d94e93bbb0b7abc6f24679b7dfc06"><div class="ttname"><a href="_vmx_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a></div><div class="ttdeci">_In_ UINT16 Selector</div><div class="ttdef"><b>Definition:</b> Vmx.h:392</div></div>
<div class="ttc" id="a_vmx_8h_html_a68870ccf6841ce76f7ca30ab1f3b1b4d"><div class="ttname"><a href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a></div><div class="ttdeci">_In_ UINT16 _Out_ PVMX_SEGMENT_SELECTOR SegmentSelector</div><div class="ttdef"><b>Definition:</b> Vmx.h:392</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_a0bd32da992b5c13d921807c82f3f932a"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">_VMX_SEGMENT_SELECTOR::Limit</a></div><div class="ttdeci">UINT32 Limit</div><div class="ttdef"><b>Definition:</b> DataTypes.h:326</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_a351ac6eabc90a04fff1b1c8c99875dd9"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a351ac6eabc90a04fff1b1c8c99875dd9">_VMX_SEGMENT_SELECTOR::Attributes</a></div><div class="ttdeci">VMX_SEGMENT_ACCESS_RIGHTS_TYPE Attributes</div><div class="ttdef"><b>Definition:</b> DataTypes.h:325</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_ab6ee44522229df1c55cca4f72f172abf"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#ab6ee44522229df1c55cca4f72f172abf">_VMX_SEGMENT_SELECTOR::Selector</a></div><div class="ttdeci">UINT16 Selector</div><div class="ttdef"><b>Definition:</b> DataTypes.h:324</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_af782f7b350ce9911745618fa9051428a"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">_VMX_SEGMENT_SELECTOR::Base</a></div><div class="ttdeci">UINT64 Base</div><div class="ttdef"><b>Definition:</b> DataTypes.h:327</div></div>
<div class="ttc" id="aunion_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e_html_a2f6bda13194a3525ec136782a138e06a"><div class="ttname"><a href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#a2f6bda13194a3525ec136782a138e06a">VMX_SEGMENT_ACCESS_RIGHTS_TYPE::Granularity</a></div><div class="ttdeci">UINT32 Granularity</div><div class="ttdef"><b>Definition:</b> DataTypes.h:307</div></div>
<div class="ttc" id="aunion_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e_html_a911f358641501ff3e2864fcfdc0262ff"><div class="ttname"><a href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#a911f358641501ff3e2864fcfdc0262ff">VMX_SEGMENT_ACCESS_RIGHTS_TYPE::AsUInt</a></div><div class="ttdeci">UINT32 AsUInt</div><div class="ttdef"><b>Definition:</b> DataTypes.h:315</div></div>
<div class="ttc" id="aunion_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e_html_af86e8c35cdab1d3c5f302761596bcdae"><div class="ttname"><a href="union_v_m_x___s_e_g_m_e_n_t___a_c_c_e_s_s___r_i_g_h_t_s___t_y_p_e.html#af86e8c35cdab1d3c5f302761596bcdae">VMX_SEGMENT_ACCESS_RIGHTS_TYPE::Unusable</a></div><div class="ttdeci">UINT32 Unusable</div><div class="ttdef"><b>Definition:</b> DataTypes.h:311</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae8edcdeb74c24f1408eca2daf1ce986a" name="ae8edcdeb74c24f1408eca2daf1ce986a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae8edcdeb74c24f1408eca2daf1ce986a">&#9670;&#160;</a></span>VmxInitialize()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxInitialize </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize Vmx operation. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if vmx initialized successfully </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  115</span>{</div>
<div class="line"><span class="lineno">  116</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> LogicalProcessorsCount;</div>
<div class="line"><span class="lineno">  117</span> </div>
<div class="line"><span class="lineno">  118</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  119</span>    <span class="comment">// ****** Start Virtualizing Current System ******</span></div>
<div class="line"><span class="lineno">  120</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  121</span> </div>
<div class="line"><span class="lineno">  122</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  123</span>    <span class="comment">// Initiating EPTP and VMX</span></div>
<div class="line"><span class="lineno">  124</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  125</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_8c.html#a412b9cc437ccd62987c8f5a01e0a3f2d">VmxPerformVirtualizationOnAllCores</a>())</div>
<div class="line"><span class="lineno">  126</span>    {</div>
<div class="line"><span class="lineno">  127</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  128</span>        <span class="comment">// there was error somewhere in initializing</span></div>
<div class="line"><span class="lineno">  129</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  130</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  131</span>    }</div>
<div class="line"><span class="lineno">  132</span> </div>
<div class="line"><span class="lineno">  133</span>    LogicalProcessorsCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><span class="lineno">  134</span> </div>
<div class="line"><span class="lineno">  135</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ProcessorID = 0; ProcessorID &lt; LogicalProcessorsCount; ProcessorID++)</div>
<div class="line"><span class="lineno">  136</span>    {</div>
<div class="line"><span class="lineno">  137</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  138</span>        <span class="comment">// *** Launching VM for Test (in the all logical processor) ***</span></div>
<div class="line"><span class="lineno">  139</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  140</span> </div>
<div class="line"><span class="lineno">  141</span>        <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * GuestState = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[ProcessorID];</div>
<div class="line"><span class="lineno">  142</span> </div>
<div class="line"><span class="lineno">  143</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  144</span>        <span class="comment">// Allocating VMM Stack</span></div>
<div class="line"><span class="lineno">  145</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  146</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_regions_8c.html#aa52d4fb46038fa50963bca46df2bba20">VmxAllocateVmmStack</a>(GuestState))</div>
<div class="line"><span class="lineno">  147</span>        {</div>
<div class="line"><span class="lineno">  148</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  149</span>            <span class="comment">// Some error in allocating Vmm Stack</span></div>
<div class="line"><span class="lineno">  150</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  151</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  152</span>        }</div>
<div class="line"><span class="lineno">  153</span> </div>
<div class="line"><span class="lineno">  154</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  155</span>        <span class="comment">// Allocating MSR Bit</span></div>
<div class="line"><span class="lineno">  156</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  157</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_regions_8c.html#a6b5ac1b2515912b3097922be01ed264a">VmxAllocateMsrBitmap</a>(GuestState))</div>
<div class="line"><span class="lineno">  158</span>        {</div>
<div class="line"><span class="lineno">  159</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  160</span>            <span class="comment">// Some error in allocating Msr Bitmaps</span></div>
<div class="line"><span class="lineno">  161</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  162</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  163</span>        }</div>
<div class="line"><span class="lineno">  164</span> </div>
<div class="line"><span class="lineno">  165</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  166</span>        <span class="comment">// Allocating I/O Bit</span></div>
<div class="line"><span class="lineno">  167</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  168</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_regions_8c.html#a5ecb9af59c8b9652916b17716448d188">VmxAllocateIoBitmaps</a>(GuestState))</div>
<div class="line"><span class="lineno">  169</span>        {</div>
<div class="line"><span class="lineno">  170</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  171</span>            <span class="comment">// Some error in allocating I/O Bitmaps</span></div>
<div class="line"><span class="lineno">  172</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  173</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  174</span>        }</div>
<div class="line"><span class="lineno">  175</span>    }</div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  178</span>    <span class="comment">// Create a bitmap of the MSRs that cause #GP</span></div>
<div class="line"><span class="lineno">  179</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  180</span>    <a class="code hl_variable" href="_global_variables_8h.html#a9e6472532ed800987ac4fe7240b2d51c">g_MsrBitmapInvalidMsrs</a> = <a class="code hl_function" href="_vmx_regions_8c.html#a5cefd3b5b3b98c661acad573794aa917">VmxAllocateInvalidMsrBimap</a>();</div>
<div class="line"><span class="lineno">  181</span> </div>
<div class="line"><span class="lineno">  182</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a9e6472532ed800987ac4fe7240b2d51c">g_MsrBitmapInvalidMsrs</a> == NULL)</div>
<div class="line"><span class="lineno">  183</span>    {</div>
<div class="line"><span class="lineno">  184</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  185</span>    }</div>
<div class="line"><span class="lineno">  186</span> </div>
<div class="line"><span class="lineno">  187</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  188</span>    <span class="comment">// As we want to support more than 32 processor (64 logical-core)</span></div>
<div class="line"><span class="lineno">  189</span>    <span class="comment">// we let windows execute our routine for us</span></div>
<div class="line"><span class="lineno">  190</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  191</span>    KeGenericCallDpc(<a class="code hl_function" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#a67111af34ae8884c33e13dec23046119">DpcRoutineInitializeGuest</a>, 0x0);</div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  193</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  194</span>    <span class="comment">// Check if everything is ok then return true otherwise false</span></div>
<div class="line"><span class="lineno">  195</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  196</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code hl_define" href="_vmcall_8h.html#a7b45a0cbafe7472996868357b52f1265">VMCALL_TEST</a>, 0x22, 0x333, 0x4444) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno">  197</span>    {</div>
<div class="line"><span class="lineno">  198</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  199</span>    }</div>
<div class="line"><span class="lineno">  200</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  201</span>    {</div>
<div class="line"><span class="lineno">  202</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  203</span>    }</div>
<div class="line"><span class="lineno">  204</span>}</div>
<div class="ttc" id="a_global_variables_8h_html_a9e6472532ed800987ac4fe7240b2d51c"><div class="ttname"><a href="_global_variables_8h.html#a9e6472532ed800987ac4fe7240b2d51c">g_MsrBitmapInvalidMsrs</a></div><div class="ttdeci">UINT64 * g_MsrBitmapInvalidMsrs</div><div class="ttdoc">Bitmap of MSRs that cause #GP.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:107</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a0fd87b88c03b3c10883f0ad70239bf6c"><div class="ttname"><a href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a></div><div class="ttdeci">NTSTATUS AsmVmxVmcall(unsigned long long VmcallNumber, unsigned long long OptionalParam1, unsigned long long OptionalParam2, long long OptionalParam3)</div><div class="ttdoc">Request Vmcall.</div></div>
<div class="ttc" id="a_vmcall_8h_html_a7b45a0cbafe7472996868357b52f1265"><div class="ttname"><a href="_vmcall_8h.html#a7b45a0cbafe7472996868357b52f1265">VMCALL_TEST</a></div><div class="ttdeci">#define VMCALL_TEST</div><div class="ttdoc">VMCALL to test hypervisor.</div><div class="ttdef"><b>Definition:</b> Vmcall.h:22</div></div>
<div class="ttc" id="a_vmx_8c_html_a412b9cc437ccd62987c8f5a01e0a3f2d"><div class="ttname"><a href="_vmx_8c.html#a412b9cc437ccd62987c8f5a01e0a3f2d">VmxPerformVirtualizationOnAllCores</a></div><div class="ttdeci">BOOLEAN VmxPerformVirtualizationOnAllCores()</div><div class="ttdoc">Initialize essential VMX Operation tasks.</div><div class="ttdef"><b>Definition:</b> Vmx.c:212</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_a5cefd3b5b3b98c661acad573794aa917"><div class="ttname"><a href="_vmx_regions_8c.html#a5cefd3b5b3b98c661acad573794aa917">VmxAllocateInvalidMsrBimap</a></div><div class="ttdeci">UINT64 * VmxAllocateInvalidMsrBimap()</div><div class="ttdoc">Allocates a buffer and tests for the MSRs that cause #GP.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:265</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_a5ecb9af59c8b9652916b17716448d188"><div class="ttname"><a href="_vmx_regions_8c.html#a5ecb9af59c8b9652916b17716448d188">VmxAllocateIoBitmaps</a></div><div class="ttdeci">BOOLEAN VmxAllocateIoBitmaps(_Inout_ VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Allocate a buffer forr I/O Bitmap.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:222</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_a6b5ac1b2515912b3097922be01ed264a"><div class="ttname"><a href="_vmx_regions_8c.html#a6b5ac1b2515912b3097922be01ed264a">VmxAllocateMsrBitmap</a></div><div class="ttdeci">BOOLEAN VmxAllocateMsrBitmap(_Inout_ VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Allocate a buffer forr Msr Bitmap.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:193</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_aa52d4fb46038fa50963bca46df2bba20"><div class="ttname"><a href="_vmx_regions_8c.html#aa52d4fb46038fa50963bca46df2bba20">VmxAllocateVmmStack</a></div><div class="ttdeci">BOOLEAN VmxAllocateVmmStack(_Inout_ VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Allocate VMM Stack.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:167</div></div>
<div class="ttc" id="ahprdbghv_2code_2broadcast_2_dpc_routines_8c_html_a67111af34ae8884c33e13dec23046119"><div class="ttname"><a href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#a67111af34ae8884c33e13dec23046119">DpcRoutineInitializeGuest</a></div><div class="ttdeci">VOID DpcRoutineInitializeGuest(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which initialize the guest.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1673</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5d502eb714f3e5b8a9a405674190d1ca" name="a5d502eb714f3e5b8a9a405674190d1ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d502eb714f3e5b8a9a405674190d1ca">&#9670;&#160;</a></span>VmxLoadVmcs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxLoadVmcs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *&#160;</td>
          <td class="paramname"><em>VCpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Implementation of VMPTRLD instruction. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If vmptrld was unsuccessful then it returns false otherwise it returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  571</span>{</div>
<div class="line"><span class="lineno">  572</span>    <span class="keywordtype">int</span> VmptrldStatus;</div>
<div class="line"><span class="lineno">  573</span> </div>
<div class="line"><span class="lineno">  574</span>    VmptrldStatus = __vmx_vmptrld(&amp;VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a78c799e28ded00cb661165c92d53272a">VmcsRegionPhysicalAddress</a>);</div>
<div class="line"><span class="lineno">  575</span>    <span class="keywordflow">if</span> (VmptrldStatus)</div>
<div class="line"><span class="lineno">  576</span>    {</div>
<div class="line"><span class="lineno">  577</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMCS failed to load, status : 0x%x&quot;</span>, VmptrldStatus);</div>
<div class="line"><span class="lineno">  578</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  579</span>    }</div>
<div class="line"><span class="lineno">  580</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  581</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3f8cf05fd265cf9568bc5f3b1ee57897" name="a3f8cf05fd265cf9568bc5f3b1ee57897"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f8cf05fd265cf9568bc5f3b1ee57897">&#9670;&#160;</a></span>VmxPerformTermination()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> VmxPerformTermination </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Terminate Vmx on all logical cores. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  953</span>{</div>
<div class="line"><span class="lineno">  954</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Terminating VMX ...\n&quot;</span>);</div>
<div class="line"><span class="lineno">  955</span> </div>
<div class="line"><span class="lineno">  956</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  957</span>    <span class="comment">// ******* Terminating Vmx *******</span></div>
<div class="line"><span class="lineno">  958</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  959</span> </div>
<div class="line"><span class="lineno">  960</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  961</span>    <span class="comment">// Unhide (disable and de-allocate) transparent-mode</span></div>
<div class="line"><span class="lineno">  962</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  963</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2255c5b6bf0f5b43764e32c8e15d9941">TransparentUnhideDebugger</a>();</div>
<div class="line"><span class="lineno">  964</span> </div>
<div class="line"><span class="lineno">  965</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  966</span>    <span class="comment">// Remove All the hooks if any</span></div>
<div class="line"><span class="lineno">  967</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  968</span>    <a class="code hl_function" href="_ept_hook_8c.html#ac8845ca75f3b4c267d3542d20621f547">EptHookUnHookAll</a>();</div>
<div class="line"><span class="lineno">  969</span> </div>
<div class="line"><span class="lineno">  970</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  971</span>    <span class="comment">// Broadcast to terminate Vmx</span></div>
<div class="line"><span class="lineno">  972</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  973</span>    KeGenericCallDpc(<a class="code hl_function" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#a05844bdebfe78c424be8f44ecd65b48e">DpcRoutineTerminateGuest</a>, 0x0);</div>
<div class="line"><span class="lineno">  974</span> </div>
<div class="line"><span class="lineno">  975</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  976</span>    <span class="comment">// ****** De-allocatee global variables ******</span></div>
<div class="line"><span class="lineno">  977</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  978</span> </div>
<div class="line"><span class="lineno">  979</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  980</span>    <span class="comment">// Free the buffer related to MSRs that cause #GP</span></div>
<div class="line"><span class="lineno">  981</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  982</span>    ExFreePoolWithTag(<a class="code hl_variable" href="_global_variables_8h.html#a9e6472532ed800987ac4fe7240b2d51c">g_MsrBitmapInvalidMsrs</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  983</span> </div>
<div class="line"><span class="lineno">  984</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  985</span>    <span class="comment">// Free Identity Page Table</span></div>
<div class="line"><span class="lineno">  986</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  987</span>    MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>);</div>
<div class="line"><span class="lineno">  988</span> </div>
<div class="line"><span class="lineno">  989</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  990</span>    <span class="comment">// Free Identity Page Table for MBEC hooks</span></div>
<div class="line"><span class="lineno">  991</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  992</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#ac027510d5d86c50286c869cf2919b891">ModeBasedEptPageTable</a> != NULL)</div>
<div class="line"><span class="lineno">  993</span>    {</div>
<div class="line"><span class="lineno">  994</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#ac027510d5d86c50286c869cf2919b891">ModeBasedEptPageTable</a>);</div>
<div class="line"><span class="lineno">  995</span>    }</div>
<div class="line"><span class="lineno">  996</span> </div>
<div class="line"><span class="lineno">  997</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  998</span>    <span class="comment">// Free Identity Page Table for execute-only hooks</span></div>
<div class="line"><span class="lineno">  999</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1000</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#ae998f71a6dd64397b5929178ced5bab1">ExecuteOnlyEptPageTable</a> != NULL)</div>
<div class="line"><span class="lineno"> 1001</span>    {</div>
<div class="line"><span class="lineno"> 1002</span>        MmFreeContiguousMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#ae998f71a6dd64397b5929178ced5bab1">ExecuteOnlyEptPageTable</a>);</div>
<div class="line"><span class="lineno"> 1003</span>    }</div>
<div class="line"><span class="lineno"> 1004</span> </div>
<div class="line"><span class="lineno"> 1005</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1006</span>    <span class="comment">// Free EptState</span></div>
<div class="line"><span class="lineno"> 1007</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1008</span>    ExFreePoolWithTag(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno"> 1009</span> </div>
<div class="line"><span class="lineno"> 1010</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1011</span>    <span class="comment">// Free the Pool manager</span></div>
<div class="line"><span class="lineno"> 1012</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1013</span>    <a class="code hl_function" href="_pool_manager_8c.html#ac159e1f3a096c5e9da7aaff001987237">PoolManagerUninitialize</a>();</div>
<div class="line"><span class="lineno"> 1014</span> </div>
<div class="line"><span class="lineno"> 1015</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1016</span>    <span class="comment">// Uninitialize memory mapper</span></div>
<div class="line"><span class="lineno"> 1017</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1018</span>    <a class="code hl_function" href="_memory_mapper_8c.html#a4c1a12a407bc281cb9f03db67b203913">MemoryMapperUninitialize</a>();</div>
<div class="line"><span class="lineno"> 1019</span> </div>
<div class="line"><span class="lineno"> 1020</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1021</span>    <span class="comment">// Free g_GuestState</span></div>
<div class="line"><span class="lineno"> 1022</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1023</span>    <a class="code hl_function" href="_global_variable_management_8c.html#abe0a55c40aade44eb9ed8852d627fd91">GlobalGuestStateFreeMemory</a>();</div>
<div class="line"><span class="lineno"> 1024</span> </div>
<div class="line"><span class="lineno"> 1025</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMX operation turned off successfully&quot;</span>);</div>
<div class="line"><span class="lineno"> 1026</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_ac8845ca75f3b4c267d3542d20621f547"><div class="ttname"><a href="_ept_hook_8c.html#ac8845ca75f3b4c267d3542d20621f547">EptHookUnHookAll</a></div><div class="ttdeci">VOID EptHookUnHookAll()</div><div class="ttdoc">Remove all hooks from the hooked pages list and invalidate TLB @detailsShould be called from Vmx Non-...</div><div class="ttdef"><b>Definition:</b> EptHook.c:1603</div></div>
<div class="ttc" id="a_global_variable_management_8c_html_abe0a55c40aade44eb9ed8852d627fd91"><div class="ttname"><a href="_global_variable_management_8c.html#abe0a55c40aade44eb9ed8852d627fd91">GlobalGuestStateFreeMemory</a></div><div class="ttdeci">VOID GlobalGuestStateFreeMemory(VOID)</div><div class="ttdoc">Free guest state memory.</div><div class="ttdef"><b>Definition:</b> GlobalVariableManagement.c:52</div></div>
<div class="ttc" id="a_global_variables_8h_html_a302f00c62e7ad092a9f44a3aa7452d99"><div class="ttname"><a href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a></div><div class="ttdeci">EPT_STATE * g_EptState</div><div class="ttdoc">Save the state and variables related to EPT.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:50</div></div>
<div class="ttc" id="a_memory_mapper_8c_html_a4c1a12a407bc281cb9f03db67b203913"><div class="ttname"><a href="_memory_mapper_8c.html#a4c1a12a407bc281cb9f03db67b203913">MemoryMapperUninitialize</a></div><div class="ttdeci">VOID MemoryMapperUninitialize()</div><div class="ttdoc">uninitialize the Memory Mapper</div><div class="ttdef"><b>Definition:</b> MemoryMapper.c:487</div></div>
<div class="ttc" id="a_pool_manager_8c_html_ac159e1f3a096c5e9da7aaff001987237"><div class="ttname"><a href="_pool_manager_8c.html#ac159e1f3a096c5e9da7aaff001987237">PoolManagerUninitialize</a></div><div class="ttdeci">VOID PoolManagerUninitialize()</div><div class="ttdoc">Uninitialize the pool manager (free the buffers, etc.)</div><div class="ttdef"><b>Definition:</b> PoolManager.c:107</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_constants_8h_html_ab7f91e71074ce1488e61869adbc44d8d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a></div><div class="ttdeci">#define POOLTAG</div><div class="ttdoc">Pool tag.</div><div class="ttdef"><b>Definition:</b> Constants.h:377</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a2255c5b6bf0f5b43764e32c8e15d9941"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2255c5b6bf0f5b43764e32c8e15d9941">TransparentUnhideDebugger</a></div><div class="ttdeci">IMPORT_EXPORT_VMM NTSTATUS TransparentUnhideDebugger()</div><div class="ttdoc">Deactive transparent-mode.</div><div class="ttdef"><b>Definition:</b> Transparency.c:443</div></div>
<div class="ttc" id="ahprdbghv_2code_2broadcast_2_dpc_routines_8c_html_a05844bdebfe78c424be8f44ecd65b48e"><div class="ttname"><a href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#a05844bdebfe78c424be8f44ecd65b48e">DpcRoutineTerminateGuest</a></div><div class="ttdeci">VOID DpcRoutineTerminateGuest(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which terminate the guest.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1704</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a63cb7b9ebbfafeb6f69caa76f755c7bd"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">_EPT_STATE::EptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE EptPageTable</div><div class="ttdef"><b>Definition:</b> Ept.h:151</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_ac027510d5d86c50286c869cf2919b891"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#ac027510d5d86c50286c869cf2919b891">_EPT_STATE::ModeBasedEptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE ModeBasedEptPageTable</div><div class="ttdef"><b>Definition:</b> Ept.h:152</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_ae998f71a6dd64397b5929178ced5bab1"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#ae998f71a6dd64397b5929178ced5bab1">_EPT_STATE::ExecuteOnlyEptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE ExecuteOnlyEptPageTable</div><div class="ttdef"><b>Definition:</b> Ept.h:153</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a412b9cc437ccd62987c8f5a01e0a3f2d" name="a412b9cc437ccd62987c8f5a01e0a3f2d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a412b9cc437ccd62987c8f5a01e0a3f2d">&#9670;&#160;</a></span>VmxPerformVirtualizationOnAllCores()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxPerformVirtualizationOnAllCores </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize essential VMX Operation tasks. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if vmx is successfully initialized </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  213</span>{</div>
<div class="line"><span class="lineno">  214</span>    <span class="keywordtype">int</span>       ProcessorCount;</div>
<div class="line"><span class="lineno">  215</span>    KAFFINITY AffinityMask;</div>
<div class="line"><span class="lineno">  216</span> </div>
<div class="line"><span class="lineno">  217</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_8c.html#abbbc35bf970ac6b655e08bc3c0f46905">VmxCheckVmxSupport</a>())</div>
<div class="line"><span class="lineno">  218</span>    {</div>
<div class="line"><span class="lineno">  219</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, VMX is not supported in this machine&quot;</span>);</div>
<div class="line"><span class="lineno">  220</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  221</span>    }</div>
<div class="line"><span class="lineno">  222</span> </div>
<div class="line"><span class="lineno">  223</span>    PAGED_CODE();</div>
<div class="line"><span class="lineno">  224</span> </div>
<div class="line"><span class="lineno">  225</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  226</span>    <span class="comment">// Allocate global variable to hold Ept State</span></div>
<div class="line"><span class="lineno">  227</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  228</span>    <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a> = ExAllocatePoolWithTag(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___s_t_a_t_e.html">EPT_STATE</a>), <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  229</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>)</div>
<div class="line"><span class="lineno">  230</span>    {</div>
<div class="line"><span class="lineno">  231</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, insufficient memory&quot;</span>);</div>
<div class="line"><span class="lineno">  232</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  233</span>    }</div>
<div class="line"><span class="lineno">  234</span> </div>
<div class="line"><span class="lineno">  235</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  236</span>    <span class="comment">// Zero memory</span></div>
<div class="line"><span class="lineno">  237</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  238</span>    RtlZeroMemory(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___s_t_a_t_e.html">EPT_STATE</a>));</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  241</span>    <span class="comment">// Initialize the list of hooked pages detail</span></div>
<div class="line"><span class="lineno">  242</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  243</span>    <a class="code hl_function" href="list_8h.html#a71fd97aa8bac50a2f3a1d98cf680b2f4">InitializeListHead</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>);</div>
<div class="line"><span class="lineno">  244</span> </div>
<div class="line"><span class="lineno">  245</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  246</span>    <span class="comment">// Check whether EPT is supported or not</span></div>
<div class="line"><span class="lineno">  247</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  248</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_8c.html#ae17811ecc7d8ff5bf69964d8fcba77f6">EptCheckFeatures</a>())</div>
<div class="line"><span class="lineno">  249</span>    {</div>
<div class="line"><span class="lineno">  250</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, your processor doesn&#39;t support all EPT features&quot;</span>);</div>
<div class="line"><span class="lineno">  251</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  252</span>    }</div>
<div class="line"><span class="lineno">  253</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  254</span>    {</div>
<div class="line"><span class="lineno">  255</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  256</span>        <span class="comment">// Our processor supports EPT, now let&#39;s build MTRR</span></div>
<div class="line"><span class="lineno">  257</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  258</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Your processor supports all EPT features&quot;</span>);</div>
<div class="line"><span class="lineno">  259</span> </div>
<div class="line"><span class="lineno">  260</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  261</span>        <span class="comment">// Build MTRR Map</span></div>
<div class="line"><span class="lineno">  262</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  263</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_8c.html#a0f9ca37f192f19426d5d21e77110023e">EptBuildMtrrMap</a>())</div>
<div class="line"><span class="lineno">  264</span>        {</div>
<div class="line"><span class="lineno">  265</span>            <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not build MTRR memory map&quot;</span>);</div>
<div class="line"><span class="lineno">  266</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  267</span>        }</div>
<div class="line"><span class="lineno">  268</span> </div>
<div class="line"><span class="lineno">  269</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;MTRR memory map built successfully&quot;</span>);</div>
<div class="line"><span class="lineno">  270</span>    }</div>
<div class="line"><span class="lineno">  271</span> </div>
<div class="line"><span class="lineno">  272</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  273</span>    <span class="comment">// Initialize Pool Manager</span></div>
<div class="line"><span class="lineno">  274</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  275</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_pool_manager_8c.html#a8c4426c380bebca34fd7b6d10722ee8e">PoolManagerInitialize</a>())</div>
<div class="line"><span class="lineno">  276</span>    {</div>
<div class="line"><span class="lineno">  277</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not initialize pool manager&quot;</span>);</div>
<div class="line"><span class="lineno">  278</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  279</span>    }</div>
<div class="line"><span class="lineno">  280</span> </div>
<div class="line"><span class="lineno">  281</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_8c.html#a0df276ac02bb2ba45c710c4d28add769">EptLogicalProcessorInitialize</a>())</div>
<div class="line"><span class="lineno">  282</span>    {</div>
<div class="line"><span class="lineno">  283</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  284</span>        <span class="comment">// There were some errors in EptLogicalProcessorInitialize</span></div>
<div class="line"><span class="lineno">  285</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  286</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  287</span>    }</div>
<div class="line"><span class="lineno">  288</span> </div>
<div class="line"><span class="lineno">  289</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  290</span>    <span class="comment">// Broadcast to run vmx-specific task to vitualize cores</span></div>
<div class="line"><span class="lineno">  291</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  292</span>    <a class="code hl_function" href="_broadcast_8c.html#a755e84fc0bacd87bd8044f52d1adc7a5">BroadcastVmxVirtualizationAllCores</a>();</div>
<div class="line"><span class="lineno">  293</span> </div>
<div class="line"><span class="lineno">  294</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  295</span>    <span class="comment">// Everything is ok, let&#39;s return true</span></div>
<div class="line"><span class="lineno">  296</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  297</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  298</span>}</div>
<div class="ttc" id="a_broadcast_8c_html_a755e84fc0bacd87bd8044f52d1adc7a5"><div class="ttname"><a href="_broadcast_8c.html#a755e84fc0bacd87bd8044f52d1adc7a5">BroadcastVmxVirtualizationAllCores</a></div><div class="ttdeci">VOID BroadcastVmxVirtualizationAllCores()</div><div class="ttdoc">routines to broadcast virtualization and vmx initialization on all cores</div><div class="ttdef"><b>Definition:</b> Broadcast.c:21</div></div>
<div class="ttc" id="a_ept_8c_html_a0df276ac02bb2ba45c710c4d28add769"><div class="ttname"><a href="_ept_8c.html#a0df276ac02bb2ba45c710c4d28add769">EptLogicalProcessorInitialize</a></div><div class="ttdeci">BOOLEAN EptLogicalProcessorInitialize()</div><div class="ttdoc">Initialize EPT for an individual logical processor.</div><div class="ttdef"><b>Definition:</b> Ept.c:617</div></div>
<div class="ttc" id="a_ept_8c_html_a0f9ca37f192f19426d5d21e77110023e"><div class="ttname"><a href="_ept_8c.html#a0f9ca37f192f19426d5d21e77110023e">EptBuildMtrrMap</a></div><div class="ttdeci">BOOLEAN EptBuildMtrrMap()</div><div class="ttdoc">Build MTRR Map of current physical addresses.</div><div class="ttdef"><b>Definition:</b> Ept.c:66</div></div>
<div class="ttc" id="a_ept_8c_html_ae17811ecc7d8ff5bf69964d8fcba77f6"><div class="ttname"><a href="_ept_8c.html#ae17811ecc7d8ff5bf69964d8fcba77f6">EptCheckFeatures</a></div><div class="ttdeci">BOOLEAN EptCheckFeatures()</div><div class="ttdoc">Check whether EPT features are present or not.</div><div class="ttdef"><b>Definition:</b> Ept.c:21</div></div>
<div class="ttc" id="a_pool_manager_8c_html_a8c4426c380bebca34fd7b6d10722ee8e"><div class="ttname"><a href="_pool_manager_8c.html#a8c4426c380bebca34fd7b6d10722ee8e">PoolManagerInitialize</a></div><div class="ttdeci">BOOLEAN PoolManagerInitialize()</div><div class="ttdoc">Initializes the pool manager.</div><div class="ttdef"><b>Definition:</b> PoolManager.c:53</div></div>
<div class="ttc" id="a_vmx_8c_html_abbbc35bf970ac6b655e08bc3c0f46905"><div class="ttname"><a href="_vmx_8c.html#abbbc35bf970ac6b655e08bc3c0f46905">VmxCheckVmxSupport</a></div><div class="ttdeci">BOOLEAN VmxCheckVmxSupport()</div><div class="ttdoc">Check whether VMX Feature is supported or not.</div><div class="ttdef"><b>Definition:</b> Vmx.c:20</div></div>
<div class="ttc" id="alist_8h_html_a71fd97aa8bac50a2f3a1d98cf680b2f4"><div class="ttname"><a href="list_8h.html#a71fd97aa8bac50a2f3a1d98cf680b2f4">InitializeListHead</a></div><div class="ttdeci">void InitializeListHead(PLIST_ENTRY ListHead)</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html">_EPT_STATE</a></div><div class="ttdef"><b>Definition:</b> Ept.h:147</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a2503c5862b1bb2b779e2185b4097aa15"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">_EPT_STATE::HookedPagesList</a></div><div class="ttdeci">LIST_ENTRY HookedPagesList</div><div class="ttdef"><b>Definition:</b> Ept.h:148</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad7d79ec1775eef01d11b05fd316b7eb7" name="ad7d79ec1775eef01d11b05fd316b7eb7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad7d79ec1775eef01d11b05fd316b7eb7">&#9670;&#160;</a></span>VmxPerformVirtualizationOnSpecificCore()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxPerformVirtualizationOnSpecificCore </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocates Vmx regions for all logical cores (Vmxon region and Vmcs region) </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  307</span>{</div>
<div class="line"><span class="lineno">  308</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   CurrentProcessorNumber = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  309</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * VCpu                   = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentProcessorNumber];</div>
<div class="line"><span class="lineno">  310</span> </div>
<div class="line"><span class="lineno">  311</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Allocating vmx regions for logical core %d&quot;</span>, CurrentProcessorNumber);</div>
<div class="line"><span class="lineno">  312</span> </div>
<div class="line"><span class="lineno">  313</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  314</span>    <span class="comment">// Enabling VMX Operation</span></div>
<div class="line"><span class="lineno">  315</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  316</span>    <a class="code hl_function" href="_inline_asm_8h.html#a141567e2e7a4abc1106cccca5d365af3">AsmEnableVmxOperation</a>();</div>
<div class="line"><span class="lineno">  317</span> </div>
<div class="line"><span class="lineno">  318</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  319</span>    <span class="comment">// Fix Cr4 and Cr0 bits during VMX operation</span></div>
<div class="line"><span class="lineno">  320</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  321</span>    <a class="code hl_function" href="_vmx_8c.html#a56536723aab6c8ccb4719ff1eac2c25f">VmxFixCr4AndCr0Bits</a>();</div>
<div class="line"><span class="lineno">  322</span> </div>
<div class="line"><span class="lineno">  323</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMX-Operation enabled successfully&quot;</span>);</div>
<div class="line"><span class="lineno">  324</span> </div>
<div class="line"><span class="lineno">  325</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_regions_8c.html#a5689a509a4e8dc00802c736a89b08126">VmxAllocateVmxonRegion</a>(VCpu))</div>
<div class="line"><span class="lineno">  326</span>    {</div>
<div class="line"><span class="lineno">  327</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, allocating memory for vmxon region was not successfull&quot;</span>);</div>
<div class="line"><span class="lineno">  328</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  329</span>    }</div>
<div class="line"><span class="lineno">  330</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_regions_8c.html#aee5a298244f8ad894335caff42a79d16">VmxAllocateVmcsRegion</a>(VCpu))</div>
<div class="line"><span class="lineno">  331</span>    {</div>
<div class="line"><span class="lineno">  332</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, allocating memory for vmcs region was not successfull&quot;</span>);</div>
<div class="line"><span class="lineno">  333</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  334</span>    }</div>
<div class="line"><span class="lineno">  335</span> </div>
<div class="line"><span class="lineno">  336</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  337</span>}</div>
<div class="ttc" id="a_inline_asm_8h_html_a141567e2e7a4abc1106cccca5d365af3"><div class="ttname"><a href="_inline_asm_8h.html#a141567e2e7a4abc1106cccca5d365af3">AsmEnableVmxOperation</a></div><div class="ttdeci">void AsmEnableVmxOperation()</div><div class="ttdoc">Enable VMX Operation.</div></div>
<div class="ttc" id="a_vmx_8c_html_a56536723aab6c8ccb4719ff1eac2c25f"><div class="ttname"><a href="_vmx_8c.html#a56536723aab6c8ccb4719ff1eac2c25f">VmxFixCr4AndCr0Bits</a></div><div class="ttdeci">VOID VmxFixCr4AndCr0Bits()</div><div class="ttdoc">Fix values for cr0 and cr4 bits.</div><div class="ttdef"><b>Definition:</b> Vmx.c:347</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_a5689a509a4e8dc00802c736a89b08126"><div class="ttname"><a href="_vmx_regions_8c.html#a5689a509a4e8dc00802c736a89b08126">VmxAllocateVmxonRegion</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxAllocateVmxonRegion(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Allocates Vmxon region and set the Revision ID based on IA32_VMX_BASIC_MSR.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:23</div></div>
<div class="ttc" id="a_vmx_regions_8c_html_aee5a298244f8ad894335caff42a79d16"><div class="ttname"><a href="_vmx_regions_8c.html#aee5a298244f8ad894335caff42a79d16">VmxAllocateVmcsRegion</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxAllocateVmcsRegion(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Allocate Vmcs region and set the Revision ID based on IA32_VMX_BASIC_MSR.</div><div class="ttdef"><b>Definition:</b> VmxRegions.c:103</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a121be6f80493612573f2177d8a17424e" name="a121be6f80493612573f2177d8a17424e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a121be6f80493612573f2177d8a17424e">&#9670;&#160;</a></span>VmxReturnInstructionPointerForVmxoff()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmxReturnInstructionPointerForVmxoff </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the RIP of guest (VMCS_GUEST_RIP) in the case of return from VMXOFF. </p>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the instruction pointer, to change in the case of Vmxoff </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  942</span>{</div>
<div class="line"><span class="lineno">  943</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">VmxoffState</a>.<a class="code hl_variable" href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#a4f2e88d445f5ece493b3d201e3b6f19f">GuestRip</a>;</div>
<div class="line"><span class="lineno">  944</span>}</div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_abe260607315f60c0e4676113b125d4a4"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">_VIRTUAL_MACHINE_STATE::VmxoffState</a></div><div class="ttdeci">VMX_VMXOFF_STATE VmxoffState</div><div class="ttdef"><b>Definition:</b> State.h:246</div></div>
<div class="ttc" id="astruct___v_m_x___v_m_x_o_f_f___s_t_a_t_e_html_a4f2e88d445f5ece493b3d201e3b6f19f"><div class="ttname"><a href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#a4f2e88d445f5ece493b3d201e3b6f19f">_VMX_VMXOFF_STATE::GuestRip</a></div><div class="ttdeci">UINT64 GuestRip</div><div class="ttdef"><b>Definition:</b> State.h:81</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1493a49dc1f387ee57f95207869ad3b4" name="a1493a49dc1f387ee57f95207869ad3b4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1493a49dc1f387ee57f95207869ad3b4">&#9670;&#160;</a></span>VmxReturnStackPointerForVmxoff()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmxReturnStackPointerForVmxoff </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get the RIP of guest (VMCS_GUEST_RIP) in the case of return from VMXOFF. </p>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the stack pointer, to change in the case of Vmxoff </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  931</span>{</div>
<div class="line"><span class="lineno">  932</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">VmxoffState</a>.<a class="code hl_variable" href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#ac920a356627a6c44d5255bc5611238da">GuestRsp</a>;</div>
<div class="line"><span class="lineno">  933</span>}</div>
<div class="ttc" id="astruct___v_m_x___v_m_x_o_f_f___s_t_a_t_e_html_ac920a356627a6c44d5255bc5611238da"><div class="ttname"><a href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#ac920a356627a6c44d5255bc5611238da">_VMX_VMXOFF_STATE::GuestRsp</a></div><div class="ttdeci">UINT64 GuestRsp</div><div class="ttdef"><b>Definition:</b> State.h:82</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab410d0d271e13e18eb97f0870de4380d" name="ab410d0d271e13e18eb97f0870de4380d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab410d0d271e13e18eb97f0870de4380d">&#9670;&#160;</a></span>VmxSetupVmcs()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxSetupVmcs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *&#160;</td>
          <td class="paramname"><em>VCpu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>GuestStack</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Create and Configure a Vmcs Layout. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td></td></tr>
    <tr><td class="paramname">GuestStack</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  593</span>{</div>
<div class="line"><span class="lineno">  594</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   CpuBasedVmExecControls;</div>
<div class="line"><span class="lineno">  595</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   SecondaryProcBasedVmExecControls;</div>
<div class="line"><span class="lineno">  596</span>    PVOID                   HostRsp;</div>
<div class="line"><span class="lineno">  597</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  GdtBase         = 0;</div>
<div class="line"><span class="lineno">  598</span>    <a class="code hl_struct" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html">VMX_SEGMENT_SELECTOR</a>    <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a> = {0};</div>
<div class="line"><span class="lineno">  599</span>    IA32_VMX_BASIC_REGISTER VmxBasicMsr     = {0};</div>
<div class="line"><span class="lineno">  600</span> </div>
<div class="line"><span class="lineno">  601</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  602</span>    <span class="comment">// Reading IA32_VMX_BASIC_MSR</span></div>
<div class="line"><span class="lineno">  603</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  604</span>    VmxBasicMsr.AsUInt = __readmsr(IA32_VMX_BASIC);</div>
<div class="line"><span class="lineno">  605</span> </div>
<div class="line"><span class="lineno">  606</span>    __vmx_vmwrite(VMCS_HOST_ES_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a898dd1b2dbb7da3619247ff5bccccf5d">AsmGetEs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  607</span>    __vmx_vmwrite(VMCS_HOST_CS_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a75e25107aec121e0874c846b0d8d67cb">AsmGetCs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  608</span>    __vmx_vmwrite(VMCS_HOST_SS_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a276dd927a653efc4e5cb44e25a333390">AsmGetSs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  609</span>    __vmx_vmwrite(VMCS_HOST_DS_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a17937fce94794fd648657badd1af77d1">AsmGetDs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  610</span>    __vmx_vmwrite(VMCS_HOST_FS_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a7b5a370d8ac34b34780b4f4cc9c34c47">AsmGetFs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  611</span>    __vmx_vmwrite(VMCS_HOST_GS_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a12b7927eac69cc5789b749beda7cecce">AsmGetGs</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  612</span>    __vmx_vmwrite(VMCS_HOST_TR_SELECTOR, <a class="code hl_function" href="_inline_asm_8h.html#a14941c0b49cf64161c8e1d6d98c4e472">AsmGetTr</a>() &amp; 0xF8);</div>
<div class="line"><span class="lineno">  613</span> </div>
<div class="line"><span class="lineno">  614</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  615</span>    <span class="comment">// Setting the link pointer to the required value for 4KB VMCS</span></div>
<div class="line"><span class="lineno">  616</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  617</span>    __vmx_vmwrite(VMCS_GUEST_VMCS_LINK_POINTER, ~0ULL);</div>
<div class="line"><span class="lineno">  618</span> </div>
<div class="line"><span class="lineno">  619</span>    __vmx_vmwrite(VMCS_GUEST_DEBUGCTL, __readmsr(IA32_DEBUGCTL) &amp; 0xFFFFFFFF);</div>
<div class="line"><span class="lineno">  620</span>    __vmx_vmwrite(<a class="code hl_define" href="_vmx_8h.html#adb28f9bd5c8c2e64101be81259d5bc30">VMCS_GUEST_DEBUGCTL_HIGH</a>, __readmsr(IA32_DEBUGCTL) &gt;&gt; 32);</div>
<div class="line"><span class="lineno">  621</span> </div>
<div class="line"><span class="lineno">  622</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  623</span>    <span class="comment">// ******* Time-stamp counter offset *******</span></div>
<div class="line"><span class="lineno">  624</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  625</span>    __vmx_vmwrite(VMCS_CTRL_TSC_OFFSET, 0);</div>
<div class="line"><span class="lineno">  626</span> </div>
<div class="line"><span class="lineno">  627</span>    __vmx_vmwrite(VMCS_CTRL_PAGEFAULT_ERROR_CODE_MASK, 0);</div>
<div class="line"><span class="lineno">  628</span>    __vmx_vmwrite(VMCS_CTRL_PAGEFAULT_ERROR_CODE_MATCH, 0);</div>
<div class="line"><span class="lineno">  629</span> </div>
<div class="line"><span class="lineno">  630</span>    __vmx_vmwrite(VMCS_CTRL_VMEXIT_MSR_STORE_COUNT, 0);</div>
<div class="line"><span class="lineno">  631</span>    __vmx_vmwrite(VMCS_CTRL_VMEXIT_MSR_LOAD_COUNT, 0);</div>
<div class="line"><span class="lineno">  632</span> </div>
<div class="line"><span class="lineno">  633</span>    __vmx_vmwrite(VMCS_CTRL_VMENTRY_MSR_LOAD_COUNT, 0);</div>
<div class="line"><span class="lineno">  634</span>    __vmx_vmwrite(VMCS_CTRL_VMENTRY_INTERRUPTION_INFORMATION_FIELD, 0);</div>
<div class="line"><span class="lineno">  635</span> </div>
<div class="line"><span class="lineno">  636</span>    GdtBase = <a class="code hl_function" href="_inline_asm_8h.html#a96667e63238aa74a0a2bbc63d6e02ca3">AsmGetGdtBase</a>();</div>
<div class="line"><span class="lineno">  637</span> </div>
<div class="line"><span class="lineno">  638</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa5a0892a1c7e395be57cf5b9f1cd9c76f">ES</a>, <a class="code hl_function" href="_inline_asm_8h.html#a898dd1b2dbb7da3619247ff5bccccf5d">AsmGetEs</a>());</div>
<div class="line"><span class="lineno">  639</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa78bcece98b40c207eb8988c589694e33">CS</a>, <a class="code hl_function" href="_inline_asm_8h.html#a75e25107aec121e0874c846b0d8d67cb">AsmGetCs</a>());</div>
<div class="line"><span class="lineno">  640</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfacc878d90418c98b0b3a20258310c0f52">SS</a>, <a class="code hl_function" href="_inline_asm_8h.html#a276dd927a653efc4e5cb44e25a333390">AsmGetSs</a>());</div>
<div class="line"><span class="lineno">  641</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfab8092694163a64aa32694a8246d94210">DS</a>, <a class="code hl_function" href="_inline_asm_8h.html#a17937fce94794fd648657badd1af77d1">AsmGetDs</a>());</div>
<div class="line"><span class="lineno">  642</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa59e0bfb4f405c70dd8788b19d5084966">FS</a>, <a class="code hl_function" href="_inline_asm_8h.html#a7b5a370d8ac34b34780b4f4cc9c34c47">AsmGetFs</a>());</div>
<div class="line"><span class="lineno">  643</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa9c922c72676cab2b540d081a8bb3788a">GS</a>, <a class="code hl_function" href="_inline_asm_8h.html#a12b7927eac69cc5789b749beda7cecce">AsmGetGs</a>());</div>
<div class="line"><span class="lineno">  644</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa3594a8ba3d161207b31fa82265f5638a">LDTR</a>, <a class="code hl_function" href="_inline_asm_8h.html#a41891ef7fab70f71723f388f0f3752fa">AsmGetLdtr</a>());</div>
<div class="line"><span class="lineno">  645</span>    <a class="code hl_function" href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a>((PVOID)GdtBase, <a class="code hl_enumvalue" href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa1743e98464bf7bcabcf51101b49a6a3d">TR</a>, <a class="code hl_function" href="_inline_asm_8h.html#a14941c0b49cf64161c8e1d6d98c4e472">AsmGetTr</a>());</div>
<div class="line"><span class="lineno">  646</span> </div>
<div class="line"><span class="lineno">  647</span>    __vmx_vmwrite(VMCS_GUEST_FS_BASE, __readmsr(IA32_FS_BASE));</div>
<div class="line"><span class="lineno">  648</span>    __vmx_vmwrite(VMCS_GUEST_GS_BASE, __readmsr(IA32_GS_BASE));</div>
<div class="line"><span class="lineno">  649</span> </div>
<div class="line"><span class="lineno">  650</span>    CpuBasedVmExecControls = <a class="code hl_function" href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a>(<a class="code hl_define" href="_vmx_8h.html#a7f15b5f2b70043c3d47d03a742046b37">CPU_BASED_ACTIVATE_IO_BITMAP</a> | <a class="code hl_define" href="_vmx_8h.html#a42bb1d6f6f8fa8572ddb3f8df18a701a">CPU_BASED_ACTIVATE_MSR_BITMAP</a> | <a class="code hl_define" href="_vmx_8h.html#a71f99a8dd4674f9ee97f8e32b35eaeb3">CPU_BASED_ACTIVATE_SECONDARY_CONTROLS</a>,</div>
<div class="line"><span class="lineno">  651</span>                                              VmxBasicMsr.VmxControls ? IA32_VMX_TRUE_PROCBASED_CTLS : IA32_VMX_PROCBASED_CTLS);</div>
<div class="line"><span class="lineno">  652</span> </div>
<div class="line"><span class="lineno">  653</span>    __vmx_vmwrite(VMCS_CTRL_PROCESSOR_BASED_VM_EXECUTION_CONTROLS, CpuBasedVmExecControls);</div>
<div class="line"><span class="lineno">  654</span> </div>
<div class="line"><span class="lineno">  655</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;CPU Based VM Exec Controls (Based on %s) : 0x%x&quot;</span>,</div>
<div class="line"><span class="lineno">  656</span>                 VmxBasicMsr.VmxControls ? <span class="stringliteral">&quot;IA32_VMX_TRUE_PROCBASED_CTLS&quot;</span> : <span class="stringliteral">&quot;IA32_VMX_PROCBASED_CTLS&quot;</span>,</div>
<div class="line"><span class="lineno">  657</span>                 CpuBasedVmExecControls);</div>
<div class="line"><span class="lineno">  658</span> </div>
<div class="line"><span class="lineno">  659</span>    SecondaryProcBasedVmExecControls = <a class="code hl_function" href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a>(<a class="code hl_define" href="_vmx_8h.html#ac78db8d29730368dc077dd82da21eb1b">CPU_BASED_CTL2_RDTSCP</a> | <a class="code hl_define" href="_vmx_8h.html#aa40f5d1a14ed338050356b51f0025153">CPU_BASED_CTL2_ENABLE_EPT</a> | <a class="code hl_define" href="_vmx_8h.html#a85e94f9d45b269be9ef16c312c018e33">CPU_BASED_CTL2_ENABLE_INVPCID</a> | <a class="code hl_define" href="_vmx_8h.html#a835548efc131eb7e819b19001ca40847">CPU_BASED_CTL2_ENABLE_XSAVE_XRSTORS</a> | <a class="code hl_define" href="_vmx_8h.html#a06cc6a733e6b312ad98c4fce6a1725fc">CPU_BASED_CTL2_ENABLE_VPID</a>,</div>
<div class="line"><span class="lineno">  660</span>                                                        IA32_VMX_PROCBASED_CTLS2);</div>
<div class="line"><span class="lineno">  661</span> </div>
<div class="line"><span class="lineno">  662</span>    __vmx_vmwrite(VMCS_CTRL_SECONDARY_PROCESSOR_BASED_VM_EXECUTION_CONTROLS, SecondaryProcBasedVmExecControls);</div>
<div class="line"><span class="lineno">  663</span> </div>
<div class="line"><span class="lineno">  664</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Secondary Proc Based VM Exec Controls (IA32_VMX_PROCBASED_CTLS2) : 0x%x&quot;</span>, SecondaryProcBasedVmExecControls);</div>
<div class="line"><span class="lineno">  665</span> </div>
<div class="line"><span class="lineno">  666</span>    __vmx_vmwrite(VMCS_CTRL_PIN_BASED_VM_EXECUTION_CONTROLS, <a class="code hl_function" href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a>(0, VmxBasicMsr.VmxControls ? IA32_VMX_TRUE_PINBASED_CTLS : IA32_VMX_PINBASED_CTLS));</div>
<div class="line"><span class="lineno">  667</span> </div>
<div class="line"><span class="lineno">  668</span>    __vmx_vmwrite(VMCS_CTRL_PRIMARY_VMEXIT_CONTROLS, <a class="code hl_function" href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a>(<a class="code hl_define" href="_vmx_8h.html#a7023237efbd3a07d3187483b52550dcf">VM_EXIT_HOST_ADDR_SPACE_SIZE</a>, VmxBasicMsr.VmxControls ? IA32_VMX_TRUE_EXIT_CTLS : IA32_VMX_EXIT_CTLS));</div>
<div class="line"><span class="lineno">  669</span> </div>
<div class="line"><span class="lineno">  670</span>    __vmx_vmwrite(VMCS_CTRL_VMENTRY_CONTROLS, <a class="code hl_function" href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a>(<a class="code hl_define" href="_vmx_8h.html#ab380f7803e1fa5a6d8c2fe25e72fe4f9">VM_ENTRY_IA32E_MODE</a>, VmxBasicMsr.VmxControls ? IA32_VMX_TRUE_ENTRY_CTLS : IA32_VMX_ENTRY_CTLS));</div>
<div class="line"><span class="lineno">  671</span> </div>
<div class="line"><span class="lineno">  672</span>    __vmx_vmwrite(VMCS_CTRL_CR0_GUEST_HOST_MASK, 0);</div>
<div class="line"><span class="lineno">  673</span>    __vmx_vmwrite(VMCS_CTRL_CR4_GUEST_HOST_MASK, 0);</div>
<div class="line"><span class="lineno">  674</span> </div>
<div class="line"><span class="lineno">  675</span>    __vmx_vmwrite(VMCS_CTRL_CR0_READ_SHADOW, 0);</div>
<div class="line"><span class="lineno">  676</span>    __vmx_vmwrite(VMCS_CTRL_CR4_READ_SHADOW, 0);</div>
<div class="line"><span class="lineno">  677</span> </div>
<div class="line"><span class="lineno">  678</span>    __vmx_vmwrite(VMCS_GUEST_CR0, __readcr0());</div>
<div class="line"><span class="lineno">  679</span>    __vmx_vmwrite(VMCS_GUEST_CR3, __readcr3());</div>
<div class="line"><span class="lineno">  680</span>    __vmx_vmwrite(VMCS_GUEST_CR4, __readcr4());</div>
<div class="line"><span class="lineno">  681</span> </div>
<div class="line"><span class="lineno">  682</span>    __vmx_vmwrite(VMCS_GUEST_DR7, 0x400);</div>
<div class="line"><span class="lineno">  683</span> </div>
<div class="line"><span class="lineno">  684</span>    __vmx_vmwrite(VMCS_HOST_CR0, __readcr0());</div>
<div class="line"><span class="lineno">  685</span>    __vmx_vmwrite(VMCS_HOST_CR4, __readcr4());</div>
<div class="line"><span class="lineno">  686</span> </div>
<div class="line"><span class="lineno">  687</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  688</span>    <span class="comment">// Because we may be executing in an arbitrary user-mode, process as part</span></div>
<div class="line"><span class="lineno">  689</span>    <span class="comment">// of the DPC interrupt we execute in We have to save Cr3, for VMCS_HOST_CR3</span></div>
<div class="line"><span class="lineno">  690</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  691</span> </div>
<div class="line"><span class="lineno">  692</span>    __vmx_vmwrite(VMCS_HOST_CR3, <a class="code hl_function" href="_layout_8c.html#a7e85fee03ff82383d60a7712e231e51b">LayoutGetSystemDirectoryTableBase</a>());</div>
<div class="line"><span class="lineno">  693</span> </div>
<div class="line"><span class="lineno">  694</span>    __vmx_vmwrite(VMCS_GUEST_GDTR_BASE, <a class="code hl_function" href="_inline_asm_8h.html#a96667e63238aa74a0a2bbc63d6e02ca3">AsmGetGdtBase</a>());</div>
<div class="line"><span class="lineno">  695</span>    __vmx_vmwrite(VMCS_GUEST_IDTR_BASE, <a class="code hl_function" href="_inline_asm_8h.html#a3a8c367f15eb70f1869f5677dd120d5a">AsmGetIdtBase</a>());</div>
<div class="line"><span class="lineno">  696</span> </div>
<div class="line"><span class="lineno">  697</span>    __vmx_vmwrite(VMCS_GUEST_GDTR_LIMIT, <a class="code hl_function" href="_inline_asm_8h.html#a3205fb84e901444e860d9b8140c81c86">AsmGetGdtLimit</a>());</div>
<div class="line"><span class="lineno">  698</span>    __vmx_vmwrite(VMCS_GUEST_IDTR_LIMIT, <a class="code hl_function" href="_inline_asm_8h.html#ae6e476bf54448b171c301ddf98fb9323">AsmGetIdtLimit</a>());</div>
<div class="line"><span class="lineno">  699</span> </div>
<div class="line"><span class="lineno">  700</span>    __vmx_vmwrite(VMCS_GUEST_RFLAGS, <a class="code hl_function" href="_inline_asm_8h.html#a97ea04558b1e32ed2204ac428efaa7dc">AsmGetRflags</a>());</div>
<div class="line"><span class="lineno">  701</span> </div>
<div class="line"><span class="lineno">  702</span>    __vmx_vmwrite(VMCS_GUEST_SYSENTER_CS, __readmsr(IA32_SYSENTER_CS));</div>
<div class="line"><span class="lineno">  703</span>    __vmx_vmwrite(VMCS_GUEST_SYSENTER_EIP, __readmsr(IA32_SYSENTER_EIP));</div>
<div class="line"><span class="lineno">  704</span>    __vmx_vmwrite(VMCS_GUEST_SYSENTER_ESP, __readmsr(IA32_SYSENTER_ESP));</div>
<div class="line"><span class="lineno">  705</span> </div>
<div class="line"><span class="lineno">  706</span>    <a class="code hl_function" href="_vmx_8c.html#a4f273dcefdaca4adfd02199030214a0c">VmxGetSegmentDescriptor</a>((PUCHAR)<a class="code hl_function" href="_inline_asm_8h.html#a96667e63238aa74a0a2bbc63d6e02ca3">AsmGetGdtBase</a>(), <a class="code hl_function" href="_inline_asm_8h.html#a14941c0b49cf64161c8e1d6d98c4e472">AsmGetTr</a>(), &amp;<a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>);</div>
<div class="line"><span class="lineno">  707</span>    __vmx_vmwrite(VMCS_HOST_TR_BASE, <a class="code hl_variable" href="_vmx_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>.<a class="code hl_variable" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a>);</div>
<div class="line"><span class="lineno">  708</span> </div>
<div class="line"><span class="lineno">  709</span>    __vmx_vmwrite(VMCS_HOST_FS_BASE, __readmsr(IA32_FS_BASE));</div>
<div class="line"><span class="lineno">  710</span>    __vmx_vmwrite(VMCS_HOST_GS_BASE, __readmsr(IA32_GS_BASE));</div>
<div class="line"><span class="lineno">  711</span> </div>
<div class="line"><span class="lineno">  712</span>    __vmx_vmwrite(VMCS_HOST_GDTR_BASE, <a class="code hl_function" href="_inline_asm_8h.html#a96667e63238aa74a0a2bbc63d6e02ca3">AsmGetGdtBase</a>());</div>
<div class="line"><span class="lineno">  713</span>    __vmx_vmwrite(VMCS_HOST_IDTR_BASE, <a class="code hl_function" href="_inline_asm_8h.html#a3a8c367f15eb70f1869f5677dd120d5a">AsmGetIdtBase</a>());</div>
<div class="line"><span class="lineno">  714</span> </div>
<div class="line"><span class="lineno">  715</span>    __vmx_vmwrite(VMCS_HOST_SYSENTER_CS, __readmsr(IA32_SYSENTER_CS));</div>
<div class="line"><span class="lineno">  716</span>    __vmx_vmwrite(VMCS_HOST_SYSENTER_EIP, __readmsr(IA32_SYSENTER_EIP));</div>
<div class="line"><span class="lineno">  717</span>    __vmx_vmwrite(VMCS_HOST_SYSENTER_ESP, __readmsr(IA32_SYSENTER_ESP));</div>
<div class="line"><span class="lineno">  718</span> </div>
<div class="line"><span class="lineno">  719</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  720</span>    <span class="comment">// Set MSR Bitmaps</span></div>
<div class="line"><span class="lineno">  721</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  722</span>    __vmx_vmwrite(VMCS_CTRL_MSR_BITMAP_ADDRESS, VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a01fda82355aebcc1e29b22e6e7d6aa90">MsrBitmapPhysicalAddress</a>);</div>
<div class="line"><span class="lineno">  723</span> </div>
<div class="line"><span class="lineno">  724</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  725</span>    <span class="comment">// Set I/O Bitmaps</span></div>
<div class="line"><span class="lineno">  726</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  727</span>    __vmx_vmwrite(VMCS_CTRL_IO_BITMAP_A_ADDRESS, VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a6fd103be7de174b060bd46ea46a35e89">IoBitmapPhysicalAddressA</a>);</div>
<div class="line"><span class="lineno">  728</span>    __vmx_vmwrite(VMCS_CTRL_IO_BITMAP_B_ADDRESS, VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad49c33f9ba391ac9625e4ccbf1bf2dbf">IoBitmapPhysicalAddressB</a>);</div>
<div class="line"><span class="lineno">  729</span> </div>
<div class="line"><span class="lineno">  730</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  731</span>    <span class="comment">// Set up EPT</span></div>
<div class="line"><span class="lineno">  732</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  733</span>    __vmx_vmwrite(VMCS_CTRL_EPT_POINTER, <a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a802f9cb6976aad8b6503cebfa3777a33">EptPointer</a>.AsUInt);</div>
<div class="line"><span class="lineno">  734</span> </div>
<div class="line"><span class="lineno">  735</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  736</span>    <span class="comment">// Set up VPID</span></div>
<div class="line"><span class="lineno">  737</span> </div>
<div class="line"><span class="lineno">  738</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  739</span>    <span class="comment">// For all processors, we will use a VPID = 1. This allows the processor to separate caching</span></div>
<div class="line"><span class="lineno">  740</span>    <span class="comment">//  of EPT structures away from the regular OS page translation tables in the TLB.</span></div>
<div class="line"><span class="lineno">  741</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  742</span>    __vmx_vmwrite(<a class="code hl_define" href="_vmx_8h.html#a281e645caa36e4bdcd12e6e5a61ab62c">VIRTUAL_PROCESSOR_ID</a>, <a class="code hl_define" href="_vpid_8h.html#ac29c244ea6b9522b000f1633c4d65bc8">VPID_TAG</a>);</div>
<div class="line"><span class="lineno">  743</span> </div>
<div class="line"><span class="lineno">  744</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  745</span>    <span class="comment">// setup guest rsp</span></div>
<div class="line"><span class="lineno">  746</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  747</span>    __vmx_vmwrite(VMCS_GUEST_RSP, (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)GuestStack);</div>
<div class="line"><span class="lineno">  748</span> </div>
<div class="line"><span class="lineno">  749</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  750</span>    <span class="comment">// setup guest rip</span></div>
<div class="line"><span class="lineno">  751</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  752</span>    __vmx_vmwrite(VMCS_GUEST_RIP, (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_function" href="_inline_asm_8h.html#a99ddf21c2beb923fc68f01d200140782">AsmVmxRestoreState</a>);</div>
<div class="line"><span class="lineno">  753</span> </div>
<div class="line"><span class="lineno">  754</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">// Stack should be aligned to 16 because we wanna save XMM and FPU registers and those instructions</span></div>
<div class="line"><span class="lineno">  756</span>    <span class="comment">// needs alignment to 16</span></div>
<div class="line"><span class="lineno">  757</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  758</span>    HostRsp = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a853f222f05d48aa4e74c882556ab25f8">VmmStack</a> + <a class="code hl_define" href="_vmx_8h.html#ad0f7cb46b6f0d6a27da192097ea21f03">VMM_STACK_SIZE</a> - 1;</div>
<div class="line"><span class="lineno">  759</span>    HostRsp = ((PVOID)((ULONG_PTR)(HostRsp) &amp; ~(16 - 1)));</div>
<div class="line"><span class="lineno">  760</span>    __vmx_vmwrite(VMCS_HOST_RSP, HostRsp);</div>
<div class="line"><span class="lineno">  761</span>    __vmx_vmwrite(VMCS_HOST_RIP, (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code hl_function" href="_inline_asm_8h.html#a13081cdd78e83db6cd8e1d2f3b501379">AsmVmexitHandler</a>);</div>
<div class="line"><span class="lineno">  762</span> </div>
<div class="line"><span class="lineno">  763</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  764</span>}</div>
<div class="ttc" id="a_hv_8c_html_a2e77ab1584aa306f8c30a526fe6f63ad"><div class="ttname"><a href="_hv_8c.html#a2e77ab1584aa306f8c30a526fe6f63ad">HvFillGuestSelectorData</a></div><div class="ttdeci">VOID HvFillGuestSelectorData(PVOID GdtBase, ULONG SegmentRegister, UINT16 Selector)</div><div class="ttdoc">Fill the guest's selector data.</div><div class="ttdef"><b>Definition:</b> Hv.c:277</div></div>
<div class="ttc" id="a_hv_8c_html_af4b5fbb4d7aab890383c5ea30789e265"><div class="ttname"><a href="_hv_8c.html#af4b5fbb4d7aab890383c5ea30789e265">HvAdjustControls</a></div><div class="ttdeci">ULONG HvAdjustControls(ULONG Ctl, ULONG Msr)</div><div class="ttdoc">Adjust controls for VMCS based on processor capability.</div><div class="ttdef"><b>Definition:</b> Hv.c:23</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a12b7927eac69cc5789b749beda7cecce"><div class="ttname"><a href="_inline_asm_8h.html#a12b7927eac69cc5789b749beda7cecce">AsmGetGs</a></div><div class="ttdeci">unsigned short AsmGetGs()</div><div class="ttdoc">Get GS Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a13081cdd78e83db6cd8e1d2f3b501379"><div class="ttname"><a href="_inline_asm_8h.html#a13081cdd78e83db6cd8e1d2f3b501379">AsmVmexitHandler</a></div><div class="ttdeci">void AsmVmexitHandler()</div><div class="ttdoc">Vm-exit handler.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a14941c0b49cf64161c8e1d6d98c4e472"><div class="ttname"><a href="_inline_asm_8h.html#a14941c0b49cf64161c8e1d6d98c4e472">AsmGetTr</a></div><div class="ttdeci">unsigned short AsmGetTr()</div><div class="ttdoc">Get TR Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a17937fce94794fd648657badd1af77d1"><div class="ttname"><a href="_inline_asm_8h.html#a17937fce94794fd648657badd1af77d1">AsmGetDs</a></div><div class="ttdeci">unsigned short AsmGetDs()</div><div class="ttdoc">Get DS Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a276dd927a653efc4e5cb44e25a333390"><div class="ttname"><a href="_inline_asm_8h.html#a276dd927a653efc4e5cb44e25a333390">AsmGetSs</a></div><div class="ttdeci">unsigned short AsmGetSs()</div><div class="ttdoc">Get SS Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a3205fb84e901444e860d9b8140c81c86"><div class="ttname"><a href="_inline_asm_8h.html#a3205fb84e901444e860d9b8140c81c86">AsmGetGdtLimit</a></div><div class="ttdeci">unsigned short AsmGetGdtLimit()</div><div class="ttdoc">Get GDT Limit.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a3a8c367f15eb70f1869f5677dd120d5a"><div class="ttname"><a href="_inline_asm_8h.html#a3a8c367f15eb70f1869f5677dd120d5a">AsmGetIdtBase</a></div><div class="ttdeci">unsigned long long AsmGetIdtBase()</div><div class="ttdoc">Get IDT base.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a41891ef7fab70f71723f388f0f3752fa"><div class="ttname"><a href="_inline_asm_8h.html#a41891ef7fab70f71723f388f0f3752fa">AsmGetLdtr</a></div><div class="ttdeci">unsigned short AsmGetLdtr()</div><div class="ttdoc">Get LDTR Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a75e25107aec121e0874c846b0d8d67cb"><div class="ttname"><a href="_inline_asm_8h.html#a75e25107aec121e0874c846b0d8d67cb">AsmGetCs</a></div><div class="ttdeci">unsigned short AsmGetCs()</div><div class="ttdoc">Get CS Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a7b5a370d8ac34b34780b4f4cc9c34c47"><div class="ttname"><a href="_inline_asm_8h.html#a7b5a370d8ac34b34780b4f4cc9c34c47">AsmGetFs</a></div><div class="ttdeci">unsigned short AsmGetFs()</div><div class="ttdoc">Get FS Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a898dd1b2dbb7da3619247ff5bccccf5d"><div class="ttname"><a href="_inline_asm_8h.html#a898dd1b2dbb7da3619247ff5bccccf5d">AsmGetEs</a></div><div class="ttdeci">unsigned short AsmGetEs()</div><div class="ttdoc">Get ES Register.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a96667e63238aa74a0a2bbc63d6e02ca3"><div class="ttname"><a href="_inline_asm_8h.html#a96667e63238aa74a0a2bbc63d6e02ca3">AsmGetGdtBase</a></div><div class="ttdeci">unsigned long long AsmGetGdtBase()</div><div class="ttdoc">get GDT base</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a97ea04558b1e32ed2204ac428efaa7dc"><div class="ttname"><a href="_inline_asm_8h.html#a97ea04558b1e32ed2204ac428efaa7dc">AsmGetRflags</a></div><div class="ttdeci">unsigned short AsmGetRflags()</div><div class="ttdoc">Get R/EFLAGS.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a99ddf21c2beb923fc68f01d200140782"><div class="ttname"><a href="_inline_asm_8h.html#a99ddf21c2beb923fc68f01d200140782">AsmVmxRestoreState</a></div><div class="ttdeci">void AsmVmxRestoreState()</div><div class="ttdoc">Restore state on vmx.</div></div>
<div class="ttc" id="a_inline_asm_8h_html_ae6e476bf54448b171c301ddf98fb9323"><div class="ttname"><a href="_inline_asm_8h.html#ae6e476bf54448b171c301ddf98fb9323">AsmGetIdtLimit</a></div><div class="ttdeci">unsigned short AsmGetIdtLimit()</div><div class="ttdoc">Get IDT limit.</div></div>
<div class="ttc" id="a_layout_8c_html_a7e85fee03ff82383d60a7712e231e51b"><div class="ttname"><a href="_layout_8c.html#a7e85fee03ff82383d60a7712e231e51b">LayoutGetSystemDirectoryTableBase</a></div><div class="ttdeci">UINT64 LayoutGetSystemDirectoryTableBase()</div><div class="ttdoc">Find cr3 of system process.</div><div class="ttdef"><b>Definition:</b> Layout.c:75</div></div>
<div class="ttc" id="a_vmx_8c_html_a4f273dcefdaca4adfd02199030214a0c"><div class="ttname"><a href="_vmx_8c.html#a4f273dcefdaca4adfd02199030214a0c">VmxGetSegmentDescriptor</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxGetSegmentDescriptor(PUCHAR GdtBase, UINT16 Selector, PVMX_SEGMENT_SELECTOR SegmentSelector)</div><div class="ttdoc">Get Segment Descriptor.</div><div class="ttdef"><b>Definition:</b> Vmx.c:1218</div></div>
<div class="ttc" id="a_vmx_8h_html_a06cc6a733e6b312ad98c4fce6a1725fc"><div class="ttname"><a href="_vmx_8h.html#a06cc6a733e6b312ad98c4fce6a1725fc">CPU_BASED_CTL2_ENABLE_VPID</a></div><div class="ttdeci">#define CPU_BASED_CTL2_ENABLE_VPID</div><div class="ttdef"><b>Definition:</b> Vmx.h:72</div></div>
<div class="ttc" id="a_vmx_8h_html_a281e645caa36e4bdcd12e6e5a61ab62c"><div class="ttname"><a href="_vmx_8h.html#a281e645caa36e4bdcd12e6e5a61ab62c">VIRTUAL_PROCESSOR_ID</a></div><div class="ttdeci">#define VIRTUAL_PROCESSOR_ID</div><div class="ttdef"><b>Definition:</b> Vmx.h:291</div></div>
<div class="ttc" id="a_vmx_8h_html_a42bb1d6f6f8fa8572ddb3f8df18a701a"><div class="ttname"><a href="_vmx_8h.html#a42bb1d6f6f8fa8572ddb3f8df18a701a">CPU_BASED_ACTIVATE_MSR_BITMAP</a></div><div class="ttdeci">#define CPU_BASED_ACTIVATE_MSR_BITMAP</div><div class="ttdef"><b>Definition:</b> Vmx.h:61</div></div>
<div class="ttc" id="a_vmx_8h_html_a7023237efbd3a07d3187483b52550dcf"><div class="ttname"><a href="_vmx_8h.html#a7023237efbd3a07d3187483b52550dcf">VM_EXIT_HOST_ADDR_SPACE_SIZE</a></div><div class="ttdeci">#define VM_EXIT_HOST_ADDR_SPACE_SIZE</div><div class="ttdef"><b>Definition:</b> Vmx.h:84</div></div>
<div class="ttc" id="a_vmx_8h_html_a71f99a8dd4674f9ee97f8e32b35eaeb3"><div class="ttname"><a href="_vmx_8h.html#a71f99a8dd4674f9ee97f8e32b35eaeb3">CPU_BASED_ACTIVATE_SECONDARY_CONTROLS</a></div><div class="ttdeci">#define CPU_BASED_ACTIVATE_SECONDARY_CONTROLS</div><div class="ttdef"><b>Definition:</b> Vmx.h:64</div></div>
<div class="ttc" id="a_vmx_8h_html_a7f15b5f2b70043c3d47d03a742046b37"><div class="ttname"><a href="_vmx_8h.html#a7f15b5f2b70043c3d47d03a742046b37">CPU_BASED_ACTIVATE_IO_BITMAP</a></div><div class="ttdeci">#define CPU_BASED_ACTIVATE_IO_BITMAP</div><div class="ttdef"><b>Definition:</b> Vmx.h:59</div></div>
<div class="ttc" id="a_vmx_8h_html_a835548efc131eb7e819b19001ca40847"><div class="ttname"><a href="_vmx_8h.html#a835548efc131eb7e819b19001ca40847">CPU_BASED_CTL2_ENABLE_XSAVE_XRSTORS</a></div><div class="ttdeci">#define CPU_BASED_CTL2_ENABLE_XSAVE_XRSTORS</div><div class="ttdef"><b>Definition:</b> Vmx.h:77</div></div>
<div class="ttc" id="a_vmx_8h_html_a85e94f9d45b269be9ef16c312c018e33"><div class="ttname"><a href="_vmx_8h.html#a85e94f9d45b269be9ef16c312c018e33">CPU_BASED_CTL2_ENABLE_INVPCID</a></div><div class="ttdeci">#define CPU_BASED_CTL2_ENABLE_INVPCID</div><div class="ttdef"><b>Definition:</b> Vmx.h:75</div></div>
<div class="ttc" id="a_vmx_8h_html_aa40f5d1a14ed338050356b51f0025153"><div class="ttname"><a href="_vmx_8h.html#aa40f5d1a14ed338050356b51f0025153">CPU_BASED_CTL2_ENABLE_EPT</a></div><div class="ttdeci">#define CPU_BASED_CTL2_ENABLE_EPT</div><div class="ttdoc">Secondary CPU-Based Controls.</div><div class="ttdef"><b>Definition:</b> Vmx.h:70</div></div>
<div class="ttc" id="a_vmx_8h_html_ab380f7803e1fa5a6d8c2fe25e72fe4f9"><div class="ttname"><a href="_vmx_8h.html#ab380f7803e1fa5a6d8c2fe25e72fe4f9">VM_ENTRY_IA32E_MODE</a></div><div class="ttdeci">#define VM_ENTRY_IA32E_MODE</div><div class="ttdef"><b>Definition:</b> Vmx.h:98</div></div>
<div class="ttc" id="a_vmx_8h_html_ac78db8d29730368dc077dd82da21eb1b"><div class="ttname"><a href="_vmx_8h.html#ac78db8d29730368dc077dd82da21eb1b">CPU_BASED_CTL2_RDTSCP</a></div><div class="ttdeci">#define CPU_BASED_CTL2_RDTSCP</div><div class="ttdef"><b>Definition:</b> Vmx.h:71</div></div>
<div class="ttc" id="a_vmx_8h_html_ad0f7cb46b6f0d6a27da192097ea21f03"><div class="ttname"><a href="_vmx_8h.html#ad0f7cb46b6f0d6a27da192097ea21f03">VMM_STACK_SIZE</a></div><div class="ttdeci">#define VMM_STACK_SIZE</div><div class="ttdoc">Stack Size.</div><div class="ttdef"><b>Definition:</b> Vmx.h:140</div></div>
<div class="ttc" id="a_vmx_8h_html_adb28f9bd5c8c2e64101be81259d5bc30"><div class="ttname"><a href="_vmx_8h.html#adb28f9bd5c8c2e64101be81259d5bc30">VMCS_GUEST_DEBUGCTL_HIGH</a></div><div class="ttdeci">#define VMCS_GUEST_DEBUGCTL_HIGH</div><div class="ttdef"><b>Definition:</b> Vmx.h:290</div></div>
<div class="ttc" id="a_vpid_8h_html_ac29c244ea6b9522b000f1633c4d65bc8"><div class="ttname"><a href="_vpid_8h.html#ac29c244ea6b9522b000f1633c4d65bc8">VPID_TAG</a></div><div class="ttdeci">#define VPID_TAG</div><div class="ttdoc">VPID Tag.</div><div class="ttdef"><b>Definition:</b> Vpid.h:30</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa1743e98464bf7bcabcf51101b49a6a3d"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa1743e98464bf7bcabcf51101b49a6a3d">TR</a></div><div class="ttdeci">@ TR</div><div class="ttdef"><b>Definition:</b> Common.h:31</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa3594a8ba3d161207b31fa82265f5638a"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa3594a8ba3d161207b31fa82265f5638a">LDTR</a></div><div class="ttdeci">@ LDTR</div><div class="ttdef"><b>Definition:</b> Common.h:30</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa59e0bfb4f405c70dd8788b19d5084966"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa59e0bfb4f405c70dd8788b19d5084966">FS</a></div><div class="ttdeci">@ FS</div><div class="ttdef"><b>Definition:</b> Common.h:28</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa5a0892a1c7e395be57cf5b9f1cd9c76f"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa5a0892a1c7e395be57cf5b9f1cd9c76f">ES</a></div><div class="ttdeci">@ ES</div><div class="ttdef"><b>Definition:</b> Common.h:24</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa78bcece98b40c207eb8988c589694e33"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa78bcece98b40c207eb8988c589694e33">CS</a></div><div class="ttdeci">@ CS</div><div class="ttdef"><b>Definition:</b> Common.h:25</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfa9c922c72676cab2b540d081a8bb3788a"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfa9c922c72676cab2b540d081a8bb3788a">GS</a></div><div class="ttdeci">@ GS</div><div class="ttdef"><b>Definition:</b> Common.h:29</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfab8092694163a64aa32694a8246d94210"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfab8092694163a64aa32694a8246d94210">DS</a></div><div class="ttdeci">@ DS</div><div class="ttdef"><b>Definition:</b> Common.h:27</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a7439723a15461f5bf1905bb57eb295bfacc878d90418c98b0b3a20258310c0f52"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a7439723a15461f5bf1905bb57eb295bfacc878d90418c98b0b3a20258310c0f52">SS</a></div><div class="ttdeci">@ SS</div><div class="ttdef"><b>Definition:</b> Common.h:26</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a802f9cb6976aad8b6503cebfa3777a33"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a802f9cb6976aad8b6503cebfa3777a33">_EPT_STATE::EptPointer</a></div><div class="ttdeci">EPT_POINTER EptPointer</div><div class="ttdef"><b>Definition:</b> Ept.h:154</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a01fda82355aebcc1e29b22e6e7d6aa90"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a01fda82355aebcc1e29b22e6e7d6aa90">_VIRTUAL_MACHINE_STATE::MsrBitmapPhysicalAddress</a></div><div class="ttdeci">UINT64 MsrBitmapPhysicalAddress</div><div class="ttdef"><b>Definition:</b> State.h:234</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a6fd103be7de174b060bd46ea46a35e89"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a6fd103be7de174b060bd46ea46a35e89">_VIRTUAL_MACHINE_STATE::IoBitmapPhysicalAddressA</a></div><div class="ttdeci">UINT64 IoBitmapPhysicalAddressA</div><div class="ttdef"><b>Definition:</b> State.h:236</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a853f222f05d48aa4e74c882556ab25f8"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a853f222f05d48aa4e74c882556ab25f8">_VIRTUAL_MACHINE_STATE::VmmStack</a></div><div class="ttdeci">UINT64 VmmStack</div><div class="ttdef"><b>Definition:</b> State.h:232</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_ad49c33f9ba391ac9625e4ccbf1bf2dbf"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#ad49c33f9ba391ac9625e4ccbf1bf2dbf">_VIRTUAL_MACHINE_STATE::IoBitmapPhysicalAddressB</a></div><div class="ttdeci">UINT64 IoBitmapPhysicalAddressB</div><div class="ttdef"><b>Definition:</b> State.h:238</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html">_VMX_SEGMENT_SELECTOR</a></div><div class="ttdoc">Segment selector.</div><div class="ttdef"><b>Definition:</b> DataTypes.h:323</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae683fd4d4ecd99c28292045bc8a65e18" name="ae683fd4d4ecd99c28292045bc8a65e18"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae683fd4d4ecd99c28292045bc8a65e18">&#9670;&#160;</a></span>VmxTerminate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxTerminate </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast to terminate VMX on all logical cores. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if vmxoff successfully executed in vmcall or otherwise returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  484</span>{</div>
<div class="line"><span class="lineno">  485</span>    NTSTATUS                Status           = STATUS_SUCCESS;</div>
<div class="line"><span class="lineno">  486</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   CurrentCoreIndex = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  487</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * VCpu             = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentCoreIndex];</div>
<div class="line"><span class="lineno">  488</span> </div>
<div class="line"><span class="lineno">  489</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  490</span>    <span class="comment">// Execute Vmcall to to turn off vmx from Vmx root mode</span></div>
<div class="line"><span class="lineno">  491</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  492</span>    Status = <a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code hl_define" href="_vmcall_8h.html#a589357d083b5353f74c07972e1448924">VMCALL_VMXOFF</a>, NULL, NULL, NULL);</div>
<div class="line"><span class="lineno">  493</span> </div>
<div class="line"><span class="lineno">  494</span>    <span class="keywordflow">if</span> (Status == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno">  495</span>    {</div>
<div class="line"><span class="lineno">  496</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMX terminated on logical core %d\n&quot;</span>, CurrentCoreIndex);</div>
<div class="line"><span class="lineno">  497</span> </div>
<div class="line"><span class="lineno">  498</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  499</span>        <span class="comment">// Free the destination memory</span></div>
<div class="line"><span class="lineno">  500</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  501</span>        MmFreeContiguousMemory(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1890e7a832ea68482839c0f8e6aa1bb7">VmxonRegionVirtualAddress</a>);</div>
<div class="line"><span class="lineno">  502</span>        MmFreeContiguousMemory(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aea5d9809e4e4b9f3e271045ef459f66d">VmcsRegionVirtualAddress</a>);</div>
<div class="line"><span class="lineno">  503</span>        ExFreePoolWithTag(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a853f222f05d48aa4e74c882556ab25f8">VmmStack</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  504</span>        ExFreePoolWithTag(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a7ca0fe2d6633bddddfc4839bd2ad393c">MsrBitmapVirtualAddress</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  505</span>        ExFreePoolWithTag(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#adc08fd36ed7c5088b430d9d46de38772">IoBitmapVirtualAddressA</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  506</span>        ExFreePoolWithTag(VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a42bb99b3abac8271d5f430862b86fa12">IoBitmapVirtualAddressB</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  507</span> </div>
<div class="line"><span class="lineno">  508</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  509</span>    }</div>
<div class="line"><span class="lineno">  510</span> </div>
<div class="line"><span class="lineno">  511</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  512</span>}</div>
<div class="ttc" id="a_vmcall_8h_html_a589357d083b5353f74c07972e1448924"><div class="ttname"><a href="_vmcall_8h.html#a589357d083b5353f74c07972e1448924">VMCALL_VMXOFF</a></div><div class="ttdeci">#define VMCALL_VMXOFF</div><div class="ttdoc">VMCALL to Call VMXOFF to turn off the hypervisor.</div><div class="ttdef"><b>Definition:</b> Vmcall.h:28</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a1890e7a832ea68482839c0f8e6aa1bb7"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a1890e7a832ea68482839c0f8e6aa1bb7">_VIRTUAL_MACHINE_STATE::VmxonRegionVirtualAddress</a></div><div class="ttdeci">UINT64 VmxonRegionVirtualAddress</div><div class="ttdef"><b>Definition:</b> State.h:229</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a42bb99b3abac8271d5f430862b86fa12"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a42bb99b3abac8271d5f430862b86fa12">_VIRTUAL_MACHINE_STATE::IoBitmapVirtualAddressB</a></div><div class="ttdeci">UINT64 IoBitmapVirtualAddressB</div><div class="ttdef"><b>Definition:</b> State.h:237</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_a7ca0fe2d6633bddddfc4839bd2ad393c"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#a7ca0fe2d6633bddddfc4839bd2ad393c">_VIRTUAL_MACHINE_STATE::MsrBitmapVirtualAddress</a></div><div class="ttdeci">UINT64 MsrBitmapVirtualAddress</div><div class="ttdef"><b>Definition:</b> State.h:233</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_adc08fd36ed7c5088b430d9d46de38772"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#adc08fd36ed7c5088b430d9d46de38772">_VIRTUAL_MACHINE_STATE::IoBitmapVirtualAddressA</a></div><div class="ttdeci">UINT64 IoBitmapVirtualAddressA</div><div class="ttdef"><b>Definition:</b> State.h:235</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_aea5d9809e4e4b9f3e271045ef459f66d"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aea5d9809e4e4b9f3e271045ef459f66d">_VIRTUAL_MACHINE_STATE::VmcsRegionVirtualAddress</a></div><div class="ttdeci">UINT64 VmcsRegionVirtualAddress</div><div class="ttdef"><b>Definition:</b> State.h:231</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="af666da6f076709f466795cf1627d5e94" name="af666da6f076709f466795cf1627d5e94"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af666da6f076709f466795cf1627d5e94">&#9670;&#160;</a></span>VmxVirtualizeCurrentSystem()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> VmxVirtualizeCurrentSystem </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>GuestStack</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize VMX Operation. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">GuestStack</td><td>Guest stack for the this core (VMCS_GUEST_RSP) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN This function won't return true as when Vmlaunch is executed the rest of the function never executes but returning FALSE is an indication of error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  412</span>{</div>
<div class="line"><span class="lineno">  413</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  ErrorCode   = 0;</div>
<div class="line"><span class="lineno">  414</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   ProcessorID = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  415</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * VCpu        = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[ProcessorID];</div>
<div class="line"><span class="lineno">  416</span> </div>
<div class="line"><span class="lineno">  417</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Virtualizing current system (logical core : 0x%x)&quot;</span>, ProcessorID);</div>
<div class="line"><span class="lineno">  418</span> </div>
<div class="line"><span class="lineno">  419</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  420</span>    <span class="comment">// Clear the VMCS State</span></div>
<div class="line"><span class="lineno">  421</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  422</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_8c.html#a40b4c16e2a106d27460f4a5dc8c76d70">VmxClearVmcsState</a>(VCpu))</div>
<div class="line"><span class="lineno">  423</span>    {</div>
<div class="line"><span class="lineno">  424</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, failed to clear vmcs&quot;</span>);</div>
<div class="line"><span class="lineno">  425</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  426</span>    }</div>
<div class="line"><span class="lineno">  427</span> </div>
<div class="line"><span class="lineno">  428</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  429</span>    <span class="comment">// Load VMCS (Set the Current VMCS)</span></div>
<div class="line"><span class="lineno">  430</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  431</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_vmx_8c.html#a5d502eb714f3e5b8a9a405674190d1ca">VmxLoadVmcs</a>(VCpu))</div>
<div class="line"><span class="lineno">  432</span>    {</div>
<div class="line"><span class="lineno">  433</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, failed to load vmcs&quot;</span>);</div>
<div class="line"><span class="lineno">  434</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  435</span>    }</div>
<div class="line"><span class="lineno">  436</span> </div>
<div class="line"><span class="lineno">  437</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Setting up VMCS for current logical core&quot;</span>);</div>
<div class="line"><span class="lineno">  438</span> </div>
<div class="line"><span class="lineno">  439</span>    <a class="code hl_function" href="_vmx_8c.html#ab410d0d271e13e18eb97f0870de4380d">VmxSetupVmcs</a>(VCpu, GuestStack);</div>
<div class="line"><span class="lineno">  440</span> </div>
<div class="line"><span class="lineno">  441</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Executing VMLAUNCH on logical core %d&quot;</span>, ProcessorID);</div>
<div class="line"><span class="lineno">  442</span> </div>
<div class="line"><span class="lineno">  443</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  444</span>    <span class="comment">// Setting the state to indicate current core is currently virtualized</span></div>
<div class="line"><span class="lineno">  445</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  446</span> </div>
<div class="line"><span class="lineno">  447</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">HasLaunched</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  448</span> </div>
<div class="line"><span class="lineno">  449</span>    __vmx_vmlaunch();</div>
<div class="line"><span class="lineno">  450</span> </div>
<div class="line"><span class="lineno">  451</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  452</span>    <span class="comment">// ******** if Vmlaunch succeed will never be here ! ********</span></div>
<div class="line"><span class="lineno">  453</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  454</span> </div>
<div class="line"><span class="lineno">  455</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  456</span>    <span class="comment">// If failed, then indicate that current core is not currently virtualized</span></div>
<div class="line"><span class="lineno">  457</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  458</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">HasLaunched</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  459</span> </div>
<div class="line"><span class="lineno">  460</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  461</span>    <span class="comment">// Read error code firstly</span></div>
<div class="line"><span class="lineno">  462</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  463</span>    __vmx_vmread(VMCS_VM_INSTRUCTION_ERROR, &amp;ErrorCode);</div>
<div class="line"><span class="lineno">  464</span> </div>
<div class="line"><span class="lineno">  465</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, unable to execute VMLAUNCH, status : 0x%llx&quot;</span>, ErrorCode);</div>
<div class="line"><span class="lineno">  466</span> </div>
<div class="line"><span class="lineno">  467</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  468</span>    <span class="comment">// Then Execute Vmxoff</span></div>
<div class="line"><span class="lineno">  469</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  470</span>    __vmx_off();</div>
<div class="line"><span class="lineno">  471</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, VMXOFF Executed Successfully but it was because of an error&quot;</span>);</div>
<div class="line"><span class="lineno">  472</span> </div>
<div class="line"><span class="lineno">  473</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  474</span>}</div>
<div class="ttc" id="a_vmx_8c_html_a40b4c16e2a106d27460f4a5dc8c76d70"><div class="ttname"><a href="_vmx_8c.html#a40b4c16e2a106d27460f4a5dc8c76d70">VmxClearVmcsState</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxClearVmcsState(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Clearing Vmcs status using vmclear instruction.</div><div class="ttdef"><b>Definition:</b> Vmx.c:538</div></div>
<div class="ttc" id="a_vmx_8c_html_a5d502eb714f3e5b8a9a405674190d1ca"><div class="ttname"><a href="_vmx_8c.html#a5d502eb714f3e5b8a9a405674190d1ca">VmxLoadVmcs</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxLoadVmcs(VIRTUAL_MACHINE_STATE *VCpu)</div><div class="ttdoc">Implementation of VMPTRLD instruction.</div><div class="ttdef"><b>Definition:</b> Vmx.c:570</div></div>
<div class="ttc" id="a_vmx_8c_html_ab410d0d271e13e18eb97f0870de4380d"><div class="ttname"><a href="_vmx_8c.html#ab410d0d271e13e18eb97f0870de4380d">VmxSetupVmcs</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN VmxSetupVmcs(VIRTUAL_MACHINE_STATE *VCpu, PVOID GuestStack)</div><div class="ttdoc">Create and Configure a Vmcs Layout.</div><div class="ttdef"><b>Definition:</b> Vmx.c:592</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aeebf0c9346849df0d8fbf5a008c593dc" name="aeebf0c9346849df0d8fbf5a008c593dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeebf0c9346849df0d8fbf5a008c593dc">&#9670;&#160;</a></span>VmxVmfunc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmxVmfunc </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>EptpIndex</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>Function</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>VMFUNC instruction. </p>
<p>Should be executed in VMX NON-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">EptpIndex</td><td></td></tr>
    <tr><td class="paramname">Function</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  803</span>{</div>
<div class="line"><span class="lineno">  804</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  805</span>    <span class="comment">// *** To be executed in VMX non-root ***</span></div>
<div class="line"><span class="lineno">  806</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  807</span> </div>
<div class="line"><span class="lineno">  808</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  809</span>    <span class="comment">// Description from : https://users.cs.utah.edu/~aburtsev/lls-sem/index.php?n=Main.VMFUNCNotes</span></div>
<div class="line"><span class="lineno">  810</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  811</span>    <span class="comment">// VMFUNC is a new Intel primitive that allows to change an EPT page table underneath a VT-x VM without exiting into the hypervisor</span></div>
<div class="line"><span class="lineno">  812</span>    <span class="comment">// Effectively, it&#39;s a page table switch in hardware and thus it allows one to build a fast context switch</span></div>
<div class="line"><span class="lineno">  813</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  814</span> </div>
<div class="line"><span class="lineno">  815</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  816</span>    <span class="comment">// Each VT-x virtual machine is configured with a Virtual Machine Control Structure (VMCS)</span></div>
<div class="line"><span class="lineno">  817</span>    <span class="comment">//  This is a page of memory in which the VMM writes configuration data for things like how interrupts are handled,</span></div>
<div class="line"><span class="lineno">  818</span>    <span class="comment">//  initial control register values during guest entry, and a whole bunch of other things</span></div>
<div class="line"><span class="lineno">  819</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  820</span>    <span class="comment">// One of those other things is a pointer to a page of candidate EPT pointers. These are pointers to different EPT</span></div>
<div class="line"><span class="lineno">  821</span>    <span class="comment">//  page table hierarchies, each one giving a possibly different physical -&gt; machine mapping. The VMM sets up this page</span></div>
<div class="line"><span class="lineno">  822</span>    <span class="comment">//  of EPT pointers and has to also turn on a couple other settings in the VMCS to fully enable EPT switching via VMFUNC</span></div>
<div class="line"><span class="lineno">  823</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  824</span>    <span class="comment">// In non-root operation (inside a VM) code running in any privilege level can switch EPT hierarchies through the following</span></div>
<div class="line"><span class="lineno">  825</span>    <span class="comment">//  steps:</span></div>
<div class="line"><span class="lineno">  826</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  827</span>    <span class="comment">// Storing 0 in %rax (EPT switching is VMFUNC 0)</span></div>
<div class="line"><span class="lineno">  828</span>    <span class="comment">// Storing the index into the candidate EPT table in %rcx</span></div>
<div class="line"><span class="lineno">  829</span>    <span class="comment">// Invoking the VMFUNC instruction</span></div>
<div class="line"><span class="lineno">  830</span>    <span class="comment">// The processor will switch EPTs. Invoking VMFUNC will not cause a VM Exit</span></div>
<div class="line"><span class="lineno">  831</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  832</span>    <span class="comment">// All of this is detailed in the Intel SDM Volume 3, 25.5.5.3 &quot;EPT Switching&quot;</span></div>
<div class="line"><span class="lineno">  833</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  834</span>    <span class="comment">// It is worth noting that this will not change/save values in control registers (e.g. %cr3), general purpose registers,</span></div>
<div class="line"><span class="lineno">  835</span>    <span class="comment">//  and so on. It&#39;s up to the code and VMM to set things up so it all works gracefully</span></div>
<div class="line"><span class="lineno">  836</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  837</span> </div>
<div class="line"><span class="lineno">  838</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  839</span>    <span class="comment">// Are TLBs flushed ? No, unless VPIDs are not being used(which I, Charlie, would say is rare)</span></div>
<div class="line"><span class="lineno">  840</span>    <span class="comment">// See Intel SDM Volume 3, 25.5.5.3 &quot;EPT Switching&quot; and 28.3.3.1 &quot;Operations that Invalidate Cached Mappings&quot;</span></div>
<div class="line"><span class="lineno">  841</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  842</span> </div>
<div class="line"><span class="lineno">  843</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="_inline_asm_8h.html#ab7fb7831f7b835f04bb05ad4e9631913">AsmVmfunc</a>(EptpIndex, Function);</div>
<div class="line"><span class="lineno">  844</span>}</div>
<div class="ttc" id="a_inline_asm_8h_html_ab7fb7831f7b835f04bb05ad4e9631913"><div class="ttname"><a href="_inline_asm_8h.html#ab7fb7831f7b835f04bb05ad4e9631913">AsmVmfunc</a></div><div class="ttdeci">unsigned long long AsmVmfunc(unsigned long EptpIndex, unsigned long Function)</div><div class="ttdoc">VMFUNC instruction.</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a099f2c93689489c8a4117c8f6648efc1" name="a099f2c93689489c8a4117c8f6648efc1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a099f2c93689489c8a4117c8f6648efc1">&#9670;&#160;</a></span>VmxVmptrst()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> VmxVmptrst </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Implementation of VMPTRST instruction. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  521</span>{</div>
<div class="line"><span class="lineno">  522</span>    PHYSICAL_ADDRESS VmcsPhysicalAddr;</div>
<div class="line"><span class="lineno">  523</span>    VmcsPhysicalAddr.QuadPart = 0;</div>
<div class="line"><span class="lineno">  524</span>    __vmx_vmptrst((<span class="keywordtype">unsigned</span> __int64 *)&amp;VmcsPhysicalAddr);</div>
<div class="line"><span class="lineno">  525</span> </div>
<div class="line"><span class="lineno">  526</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;VMPTRST result : %llx&quot;</span>, VmcsPhysicalAddr);</div>
<div class="line"><span class="lineno">  527</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a78415dd94deee3861f8cdfe695331aa9" name="a78415dd94deee3861f8cdfe695331aa9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a78415dd94deee3861f8cdfe695331aa9">&#9670;&#160;</a></span>VmxVmresume()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> VmxVmresume </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Resume VM using VMRESUME instruction. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  773</span>{</div>
<div class="line"><span class="lineno">  774</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> ErrorCode = 0;</div>
<div class="line"><span class="lineno">  775</span> </div>
<div class="line"><span class="lineno">  776</span>    __vmx_vmresume();</div>
<div class="line"><span class="lineno">  777</span> </div>
<div class="line"><span class="lineno">  778</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  779</span>    <span class="comment">// if VMRESUME succeed will never be here !</span></div>
<div class="line"><span class="lineno">  780</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  781</span> </div>
<div class="line"><span class="lineno">  782</span>    __vmx_vmread(VMCS_VM_INSTRUCTION_ERROR, &amp;ErrorCode);</div>
<div class="line"><span class="lineno">  783</span>    __vmx_off();</div>
<div class="line"><span class="lineno">  784</span> </div>
<div class="line"><span class="lineno">  785</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  786</span>    <span class="comment">// It&#39;s such a bad error because we don&#39;t where to go !</span></div>
<div class="line"><span class="lineno">  787</span>    <span class="comment">// prefer to break</span></div>
<div class="line"><span class="lineno">  788</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  789</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err,  in executing VMRESUME , status : 0x%llx&quot;</span>, ErrorCode);</div>
<div class="line"><span class="lineno">  790</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad9193ed1677033cd08c5d5b7788b15c7" name="ad9193ed1677033cd08c5d5b7788b15c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad9193ed1677033cd08c5d5b7788b15c7">&#9670;&#160;</a></span>VmxVmxoff()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> VmxVmxoff </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *&#160;</td>
          <td class="paramname"><em>VCpu</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Prepare and execute Vmxoff instruction. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  854</span>{</div>
<div class="line"><span class="lineno">  855</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> GuestRSP              = 0; <span class="comment">// Save a pointer to guest rsp for times that we want to return to previous guest stateS</span></div>
<div class="line"><span class="lineno">  856</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> GuestRIP              = 0; <span class="comment">// Save a pointer to guest rip for times that we want to return to previous guest state</span></div>
<div class="line"><span class="lineno">  857</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> GuestCr3              = 0;</div>
<div class="line"><span class="lineno">  858</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> ExitInstructionLength = 0;</div>
<div class="line"><span class="lineno">  859</span> </div>
<div class="line"><span class="lineno">  860</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  861</span>    <span class="comment">// According to SimpleVisor :</span></div>
<div class="line"><span class="lineno">  862</span>    <span class="comment">//      Our callback routine may have interrupted an arbitrary user process,</span></div>
<div class="line"><span class="lineno">  863</span>    <span class="comment">//      and therefore not a thread running with a system-wide page directory.</span></div>
<div class="line"><span class="lineno">  864</span>    <span class="comment">//      Therefore if we return back to the original caller after turning off</span></div>
<div class="line"><span class="lineno">  865</span>    <span class="comment">//      VMX, it will keep our current &quot;host&quot; CR3 value which we set on entry</span></div>
<div class="line"><span class="lineno">  866</span>    <span class="comment">//      to the PML4 of the SYSTEM process. We want to return back with the</span></div>
<div class="line"><span class="lineno">  867</span>    <span class="comment">//      correct value of the &quot;guest&quot; CR3, so that the currently executing</span></div>
<div class="line"><span class="lineno">  868</span>    <span class="comment">//      process continues to run with its expected address space mappings.</span></div>
<div class="line"><span class="lineno">  869</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  870</span> </div>
<div class="line"><span class="lineno">  871</span>    __vmx_vmread(VMCS_GUEST_CR3, &amp;GuestCr3);</div>
<div class="line"><span class="lineno">  872</span>    __writecr3(GuestCr3);</div>
<div class="line"><span class="lineno">  873</span> </div>
<div class="line"><span class="lineno">  874</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  875</span>    <span class="comment">// Read guest rsp and rip</span></div>
<div class="line"><span class="lineno">  876</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  877</span>    __vmx_vmread(VMCS_GUEST_RIP, &amp;GuestRIP);</div>
<div class="line"><span class="lineno">  878</span>    __vmx_vmread(VMCS_GUEST_RSP, &amp;GuestRSP);</div>
<div class="line"><span class="lineno">  879</span> </div>
<div class="line"><span class="lineno">  880</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  881</span>    <span class="comment">// Read instruction length</span></div>
<div class="line"><span class="lineno">  882</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  883</span>    __vmx_vmread(VMCS_VMEXIT_INSTRUCTION_LENGTH, &amp;ExitInstructionLength);</div>
<div class="line"><span class="lineno">  884</span>    GuestRIP += ExitInstructionLength;</div>
<div class="line"><span class="lineno">  885</span> </div>
<div class="line"><span class="lineno">  886</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  887</span>    <span class="comment">// Set the previous register states</span></div>
<div class="line"><span class="lineno">  888</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  889</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">VmxoffState</a>.<a class="code hl_variable" href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#a4f2e88d445f5ece493b3d201e3b6f19f">GuestRip</a> = GuestRIP;</div>
<div class="line"><span class="lineno">  890</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">VmxoffState</a>.<a class="code hl_variable" href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#ac920a356627a6c44d5255bc5611238da">GuestRsp</a> = GuestRSP;</div>
<div class="line"><span class="lineno">  891</span> </div>
<div class="line"><span class="lineno">  892</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  893</span>    <span class="comment">// Notify the Vmexit handler that VMX already turned off</span></div>
<div class="line"><span class="lineno">  894</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  895</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abe260607315f60c0e4676113b125d4a4">VmxoffState</a>.<a class="code hl_variable" href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#ad5fb82af1c2574681bf6199e3ff85cc4">IsVmxoffExecuted</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  896</span> </div>
<div class="line"><span class="lineno">  897</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  898</span>    <span class="comment">// Restore the previous FS, GS , GDTR and IDTR register as patchguard might find the modified</span></div>
<div class="line"><span class="lineno">  899</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  900</span>    <a class="code hl_function" href="_hv_8c.html#a011d070043f596f715b8a1deee31786c">HvRestoreRegisters</a>();</div>
<div class="line"><span class="lineno">  901</span> </div>
<div class="line"><span class="lineno">  902</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  903</span>    <span class="comment">// Before using vmxoff, you first need to use vmclear on any VMCSes that you want to be able to use again.</span></div>
<div class="line"><span class="lineno">  904</span>    <span class="comment">// See sections 24.1 and 24.11 of the SDM.</span></div>
<div class="line"><span class="lineno">  905</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  906</span>    <a class="code hl_function" href="_vmx_8c.html#a40b4c16e2a106d27460f4a5dc8c76d70">VmxClearVmcsState</a>(VCpu);</div>
<div class="line"><span class="lineno">  907</span> </div>
<div class="line"><span class="lineno">  908</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  909</span>    <span class="comment">// Execute Vmxoff</span></div>
<div class="line"><span class="lineno">  910</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  911</span>    __vmx_off();</div>
<div class="line"><span class="lineno">  912</span> </div>
<div class="line"><span class="lineno">  913</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  914</span>    <span class="comment">// Indicate the current core is not currently virtualized</span></div>
<div class="line"><span class="lineno">  915</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  916</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aaacba0883eec22779a564fb93aea73fd">HasLaunched</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  917</span> </div>
<div class="line"><span class="lineno">  918</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  919</span>    <span class="comment">// Now that VMX is OFF, we have to unset vmx-enable bit on cr4</span></div>
<div class="line"><span class="lineno">  920</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  921</span>    __writecr4(__readcr4() &amp; (~<a class="code hl_define" href="hprdbghv_2header_2common_2common_8h.html#a8352c2d920c1435e681c21a07c06b28c">X86_CR4_VMXE</a>));</div>
<div class="line"><span class="lineno">  922</span>}</div>
<div class="ttc" id="a_hv_8c_html_a011d070043f596f715b8a1deee31786c"><div class="ttname"><a href="_hv_8c.html#a011d070043f596f715b8a1deee31786c">HvRestoreRegisters</a></div><div class="ttdeci">VOID HvRestoreRegisters()</div><div class="ttdoc">Reset GDTR/IDTR and other old when you do vmxoff as the patchguard will detect them left modified.</div><div class="ttdef"><b>Definition:</b> Hv.c:442</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a8352c2d920c1435e681c21a07c06b28c"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a8352c2d920c1435e681c21a07c06b28c">X86_CR4_VMXE</a></div><div class="ttdeci">#define X86_CR4_VMXE</div><div class="ttdef"><b>Definition:</b> Common.h:83</div></div>
<div class="ttc" id="astruct___v_m_x___v_m_x_o_f_f___s_t_a_t_e_html_ad5fb82af1c2574681bf6199e3ff85cc4"><div class="ttname"><a href="struct___v_m_x___v_m_x_o_f_f___s_t_a_t_e.html#ad5fb82af1c2574681bf6199e3ff85cc4">_VMX_VMXOFF_STATE::IsVmxoffExecuted</a></div><div class="ttdeci">BOOLEAN IsVmxoffExecuted</div><div class="ttdef"><b>Definition:</b> State.h:80</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_19054a674c4bd5cb8fceb6542228579c.html">hprdbghv</a></li><li class="navelem"><a class="el" href="dir_aac0c9299474d8b4035e61d55763e72a.html">code</a></li><li class="navelem"><a class="el" href="dir_cf1aeb8a0832b3a8c096fe99262e15f1.html">vmm</a></li><li class="navelem"><a class="el" href="dir_dac4239286a54b14e4ccc46a7d4ec35b.html">vmx</a></li><li class="navelem"><a class="el" href="_vmx_8c.html">Vmx.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
