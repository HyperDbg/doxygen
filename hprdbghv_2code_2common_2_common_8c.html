<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg Debugger: hyperdbg/hprdbghv/code/common/Common.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HyperDbg Debugger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('hprdbghv_2code_2common_2_common_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Common.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Common functions that needs to be used in all source code files.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:aefc23d5a8cd57a497e57045930e55eed"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#aefc23d5a8cd57a497e57045930e55eed">SELECTOR_TABLE_LDT</a>&#160;&#160;&#160;0x1</td></tr>
<tr class="separator:aefc23d5a8cd57a497e57045930e55eed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16f7f49927e1575a97fc0c3b57dceba1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a>&#160;&#160;&#160;0x0</td></tr>
<tr class="separator:a16f7f49927e1575a97fc0c3b57dceba1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a0f16df9e7e4722921b04a6db04144236"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a0f16df9e7e4722921b04a6db04144236">MathPower</a> (int Base, int Exp)</td></tr>
<tr class="memdesc:a0f16df9e7e4722921b04a6db04144236"><td class="mdescLeft">&#160;</td><td class="mdescRight">Power function in order to computer address for MSR bitmaps.  <a href="hprdbghv_2code_2common_2_common_8c.html#a0f16df9e7e4722921b04a6db04144236">More...</a><br /></td></tr>
<tr class="separator:a0f16df9e7e4722921b04a6db04144236"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8a13133ef947f9fe935eda60b66784c6"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a8a13133ef947f9fe935eda60b66784c6">BroadcastToProcessors</a> (<a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ProcessorNumber, <a class="el" href="hprdbghv_2header_2common_2common_8h.html#a25f777554b949fe8dfd4ffbd1313f30d">RunOnLogicalCoreFunc</a> Routine)</td></tr>
<tr class="memdesc:a8a13133ef947f9fe935eda60b66784c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast a function to all logical cores.  <a href="hprdbghv_2code_2common_2_common_8c.html#a8a13133ef947f9fe935eda60b66784c6">More...</a><br /></td></tr>
<tr class="separator:a8a13133ef947f9fe935eda60b66784c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf9996f46885e97a5d0f4d6fdbba98e0"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#abf9996f46885e97a5d0f4d6fdbba98e0">TestBit</a> (int nth, unsigned long *addr)</td></tr>
<tr class="memdesc:abf9996f46885e97a5d0f4d6fdbba98e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether the bit is set or not.  <a href="hprdbghv_2code_2common_2_common_8c.html#abf9996f46885e97a5d0f4d6fdbba98e0">More...</a><br /></td></tr>
<tr class="separator:abf9996f46885e97a5d0f4d6fdbba98e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1325b69024a8a649457e13b496d678ee"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a1325b69024a8a649457e13b496d678ee">ClearBit</a> (int nth, unsigned long *addr)</td></tr>
<tr class="memdesc:a1325b69024a8a649457e13b496d678ee"><td class="mdescLeft">&#160;</td><td class="mdescRight">unset the bit  <a href="hprdbghv_2code_2common_2_common_8c.html#a1325b69024a8a649457e13b496d678ee">More...</a><br /></td></tr>
<tr class="separator:a1325b69024a8a649457e13b496d678ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ea193321338d577be44e8490533c285"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a6ea193321338d577be44e8490533c285">SetBit</a> (int nth, unsigned long *addr)</td></tr>
<tr class="memdesc:a6ea193321338d577be44e8490533c285"><td class="mdescLeft">&#160;</td><td class="mdescRight">set the bit  <a href="hprdbghv_2code_2common_2_common_8c.html#a6ea193321338d577be44e8490533c285">More...</a><br /></td></tr>
<tr class="separator:a6ea193321338d577be44e8490533c285"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7aedff95075e77cd8fbe128f01d2853"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ab7aedff95075e77cd8fbe128f01d2853">VirtualAddressToPhysicalAddress</a> (_In_ PVOID VirtualAddress)</td></tr>
<tr class="memdesc:ab7aedff95075e77cd8fbe128f01d2853"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Virtual Address to Physical Address.  <a href="hprdbghv_2code_2common_2_common_8c.html#ab7aedff95075e77cd8fbe128f01d2853">More...</a><br /></td></tr>
<tr class="separator:ab7aedff95075e77cd8fbe128f01d2853"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af530cb1a7ccd595fa84d7e27001ab933"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#af530cb1a7ccd595fa84d7e27001ab933">GetCr3FromProcessId</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:af530cb1a7ccd595fa84d7e27001ab933"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts pid to kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#af530cb1a7ccd595fa84d7e27001ab933">More...</a><br /></td></tr>
<tr class="separator:af530cb1a7ccd595fa84d7e27001ab933"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a837a1bba323c96382e713627b60e3dad"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a837a1bba323c96382e713627b60e3dad">SwitchOnAnotherProcessMemoryLayout</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:a837a1bba323c96382e713627b60e3dad"><td class="mdescLeft">&#160;</td><td class="mdescRight">Switch to another process's cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a837a1bba323c96382e713627b60e3dad">More...</a><br /></td></tr>
<tr class="separator:a837a1bba323c96382e713627b60e3dad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad28edc4807eae2171a6d8b898863e8e5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ad28edc4807eae2171a6d8b898863e8e5">SwitchOnMemoryLayoutOfTargetProcess</a> ()</td></tr>
<tr class="memdesc:ad28edc4807eae2171a6d8b898863e8e5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Switch to guest's running process's cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#ad28edc4807eae2171a6d8b898863e8e5">More...</a><br /></td></tr>
<tr class="separator:ad28edc4807eae2171a6d8b898863e8e5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6fd3d4f5957bf2db1e26c9150500aaa0"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">SwitchOnAnotherProcessMemoryLayoutByCr3</a> (<a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> TargetCr3)</td></tr>
<tr class="memdesc:a6fd3d4f5957bf2db1e26c9150500aaa0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Switch to another process's cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">More...</a><br /></td></tr>
<tr class="separator:a6fd3d4f5957bf2db1e26c9150500aaa0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a979b3a59be793422133f37c01e471981"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a979b3a59be793422133f37c01e471981">GetSegmentDescriptor</a> (PUCHAR GdtBase, <a class="el" href="_script_engine_eval_8h.html#a09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a> <a class="el" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>, <a class="el" href="hprdbghv_2header_2common_2common_8h.html#ac0981ad69bb8ce42661d8f4eec22f5fe">PVMX_SEGMENT_SELECTOR</a> <a class="el" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>)</td></tr>
<tr class="memdesc:a979b3a59be793422133f37c01e471981"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get Segment Descriptor.  <a href="hprdbghv_2code_2common_2_common_8c.html#a979b3a59be793422133f37c01e471981">More...</a><br /></td></tr>
<tr class="separator:a979b3a59be793422133f37c01e471981"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3b20ca080234a45df3a99f5ccfcce840"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a> (<a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> PreviousProcess)</td></tr>
<tr class="memdesc:a3b20ca080234a45df3a99f5ccfcce840"><td class="mdescLeft">&#160;</td><td class="mdescRight">Switch to previous process's cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">More...</a><br /></td></tr>
<tr class="separator:a3b20ca080234a45df3a99f5ccfcce840"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac6482780667d9d17160287439da81d3d"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ac6482780667d9d17160287439da81d3d">PhysicalAddressToVirtualAddressByProcessId</a> (PVOID PhysicalAddress, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:ac6482780667d9d17160287439da81d3d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Physical Address to Virtual Address based on a specific process id.  <a href="hprdbghv_2code_2common_2_common_8c.html#ac6482780667d9d17160287439da81d3d">More...</a><br /></td></tr>
<tr class="separator:ac6482780667d9d17160287439da81d3d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab07b73e748394f71fc32793c1ccccd26"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ab07b73e748394f71fc32793c1ccccd26">PhysicalAddressToVirtualAddressByCr3</a> (PVOID PhysicalAddress, <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> TargetCr3)</td></tr>
<tr class="memdesc:ab07b73e748394f71fc32793c1ccccd26"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Physical Address to Virtual Address based on a specific process's kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#ab07b73e748394f71fc32793c1ccccd26">More...</a><br /></td></tr>
<tr class="separator:ab07b73e748394f71fc32793c1ccccd26"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a512f6b5eb5218445aa58489b8f9d8593"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a512f6b5eb5218445aa58489b8f9d8593">PhysicalAddressToVirtualAddressOnTargetProcess</a> (PVOID PhysicalAddress)</td></tr>
<tr class="memdesc:a512f6b5eb5218445aa58489b8f9d8593"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Physical Address to Virtual Address based on current process's kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a512f6b5eb5218445aa58489b8f9d8593">More...</a><br /></td></tr>
<tr class="separator:a512f6b5eb5218445aa58489b8f9d8593"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3cf8394ebbc5300f74b02f51bd8519f6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a> ()</td></tr>
<tr class="memdesc:a3cf8394ebbc5300f74b02f51bd8519f6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get cr3 of the target running process.  <a href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">More...</a><br /></td></tr>
<tr class="separator:a3cf8394ebbc5300f74b02f51bd8519f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a507e3ba3c1076ac38e61c34f53ef5c38"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a507e3ba3c1076ac38e61c34f53ef5c38">VirtualAddressToPhysicalAddressByProcessId</a> (PVOID VirtualAddress, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:a507e3ba3c1076ac38e61c34f53ef5c38"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Virtual Address to Physical Address based on a specific process id's kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a507e3ba3c1076ac38e61c34f53ef5c38">More...</a><br /></td></tr>
<tr class="separator:a507e3ba3c1076ac38e61c34f53ef5c38"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace32f507228d4b1b3b8e53f82ac09402"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ace32f507228d4b1b3b8e53f82ac09402">VirtualAddressToPhysicalAddressByProcessCr3</a> (PVOID VirtualAddress, <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> TargetCr3)</td></tr>
<tr class="memdesc:ace32f507228d4b1b3b8e53f82ac09402"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Virtual Address to Physical Address based on a specific process's kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#ace32f507228d4b1b3b8e53f82ac09402">More...</a><br /></td></tr>
<tr class="separator:ace32f507228d4b1b3b8e53f82ac09402"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63eff86102e697567fec147fc04f6248"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a63eff86102e697567fec147fc04f6248">VirtualAddressToPhysicalAddressOnTargetProcess</a> (PVOID VirtualAddress)</td></tr>
<tr class="memdesc:a63eff86102e697567fec147fc04f6248"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Virtual Address to Physical Address based on the current process's kernel cr3.  <a href="hprdbghv_2code_2common_2_common_8c.html#a63eff86102e697567fec147fc04f6248">More...</a><br /></td></tr>
<tr class="separator:a63eff86102e697567fec147fc04f6248"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af7f8cac9416a0d6568c820e4437e672c"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#af7f8cac9416a0d6568c820e4437e672c">PhysicalAddressToVirtualAddress</a> (<a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysicalAddress)</td></tr>
<tr class="memdesc:af7f8cac9416a0d6568c820e4437e672c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Converts Physical Address to Virtual Address.  <a href="hprdbghv_2code_2common_2_common_8c.html#af7f8cac9416a0d6568c820e4437e672c">More...</a><br /></td></tr>
<tr class="separator:af7f8cac9416a0d6568c820e4437e672c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adcbb2311c406c2d7866818d6461a8d02"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#adcbb2311c406c2d7866818d6461a8d02">FindSystemDirectoryTableBase</a> ()</td></tr>
<tr class="memdesc:adcbb2311c406c2d7866818d6461a8d02"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find cr3 of system process.  <a href="hprdbghv_2code_2common_2_common_8c.html#adcbb2311c406c2d7866818d6461a8d02">More...</a><br /></td></tr>
<tr class="separator:adcbb2311c406c2d7866818d6461a8d02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d8de41916e9cffe3cb1963847484806"><td class="memItemLeft" align="right" valign="top">PCHAR&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a7d8de41916e9cffe3cb1963847484806">GetProcessNameFromEprocess</a> (PEPROCESS Eprocess)</td></tr>
<tr class="memdesc:a7d8de41916e9cffe3cb1963847484806"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get process name by eprocess.  <a href="hprdbghv_2code_2common_2_common_8c.html#a7d8de41916e9cffe3cb1963847484806">More...</a><br /></td></tr>
<tr class="separator:a7d8de41916e9cffe3cb1963847484806"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd7a24f884afa520da81557896a4abcd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#acd7a24f884afa520da81557896a4abcd">StartsWith</a> (const char *pre, const char *str)</td></tr>
<tr class="memdesc:acd7a24f884afa520da81557896a4abcd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Detects whether the string starts with another string.  <a href="hprdbghv_2code_2common_2_common_8c.html#acd7a24f884afa520da81557896a4abcd">More...</a><br /></td></tr>
<tr class="separator:acd7a24f884afa520da81557896a4abcd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aac8ebaacb2e2c9098a2feecf0d4d3ca8"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#aac8ebaacb2e2c9098a2feecf0d4d3ca8">IsProcessExist</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcId)</td></tr>
<tr class="memdesc:aac8ebaacb2e2c9098a2feecf0d4d3ca8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks whether the process with ProcId exists or not.  <a href="hprdbghv_2code_2common_2_common_8c.html#aac8ebaacb2e2c9098a2feecf0d4d3ca8">More...</a><br /></td></tr>
<tr class="separator:aac8ebaacb2e2c9098a2feecf0d4d3ca8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a80e28f3ea9a1bcf2b4e7e603784eba88"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a80e28f3ea9a1bcf2b4e7e603784eba88">CheckIfAddressIsValidUsingTsx</a> (<a class="el" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *<a class="el" href="symbol-parser_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>)</td></tr>
<tr class="memdesc:a80e28f3ea9a1bcf2b4e7e603784eba88"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function checks whether the address is valid or not using Intel TSX.  <a href="hprdbghv_2code_2common_2_common_8c.html#a80e28f3ea9a1bcf2b4e7e603784eba88">More...</a><br /></td></tr>
<tr class="separator:a80e28f3ea9a1bcf2b4e7e603784eba88"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adf1ba210f06e66c4e8cfec3dd291e4b8"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">GetCpuid</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Func, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> SubFunc, int *CpuInfo)</td></tr>
<tr class="memdesc:adf1ba210f06e66c4e8cfec3dd291e4b8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get cpuid results.  <a href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">More...</a><br /></td></tr>
<tr class="separator:adf1ba210f06e66c4e8cfec3dd291e4b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1ca8d92943fe9fcfbf98b0de88820f07"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a1ca8d92943fe9fcfbf98b0de88820f07">CheckCpuSupportRtm</a> ()</td></tr>
<tr class="memdesc:a1ca8d92943fe9fcfbf98b0de88820f07"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether the processor supports RTM or not.  <a href="hprdbghv_2code_2common_2_common_8c.html#a1ca8d92943fe9fcfbf98b0de88820f07">More...</a><br /></td></tr>
<tr class="separator:a1ca8d92943fe9fcfbf98b0de88820f07"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab0fbc2b64fdf9682a442b18e8dc03e8c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ab0fbc2b64fdf9682a442b18e8dc03e8c">Getx86VirtualAddressWidth</a> ()</td></tr>
<tr class="memdesc:ab0fbc2b64fdf9682a442b18e8dc03e8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get virtual address width for x86 processors.  <a href="hprdbghv_2code_2common_2_common_8c.html#ab0fbc2b64fdf9682a442b18e8dc03e8c">More...</a><br /></td></tr>
<tr class="separator:ab0fbc2b64fdf9682a442b18e8dc03e8c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1c85b7df06c438a8cdda337ff25f9dd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#ae1c85b7df06c438a8cdda337ff25f9dd">CheckCanonicalVirtualAddress</a> (<a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VAddr, <a class="el" href="_script_engine_eval_8h.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a> IsKernelAddress)</td></tr>
<tr class="memdesc:ae1c85b7df06c438a8cdda337ff25f9dd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Checks if the address is canonical based on x86 processor's virtual address width or not.  <a href="hprdbghv_2code_2common_2_common_8c.html#ae1c85b7df06c438a8cdda337ff25f9dd">More...</a><br /></td></tr>
<tr class="separator:ae1c85b7df06c438a8cdda337ff25f9dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ea9e4cef167ff3664811bd8627cde9c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a> (<a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> TargetAddress, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Size)</td></tr>
<tr class="memdesc:a9ea9e4cef167ff3664811bd8627cde9c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check the safety to access the memory.  <a href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">More...</a><br /></td></tr>
<tr class="separator:a9ea9e4cef167ff3664811bd8627cde9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3eb68998b6cd2546b6e4cc1ae0c30417"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a3eb68998b6cd2546b6e4cc1ae0c30417">VmxrootCompatibleStrlen</a> (const <a class="el" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *<a class="el" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>)</td></tr>
<tr class="memdesc:a3eb68998b6cd2546b6e4cc1ae0c30417"><td class="mdescLeft">&#160;</td><td class="mdescRight">implementation of vmx-root mode compatible strlen  <a href="hprdbghv_2code_2common_2_common_8c.html#a3eb68998b6cd2546b6e4cc1ae0c30417">More...</a><br /></td></tr>
<tr class="separator:a3eb68998b6cd2546b6e4cc1ae0c30417"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5bf7c4bfb01c3d44fc654a2de760f587"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a5bf7c4bfb01c3d44fc654a2de760f587">VmxrootCompatibleWcslen</a> (const wchar_t *<a class="el" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>)</td></tr>
<tr class="memdesc:a5bf7c4bfb01c3d44fc654a2de760f587"><td class="mdescLeft">&#160;</td><td class="mdescRight">implementation of vmx-root mode compatible wcslen  <a href="hprdbghv_2code_2common_2_common_8c.html#a5bf7c4bfb01c3d44fc654a2de760f587">More...</a><br /></td></tr>
<tr class="separator:a5bf7c4bfb01c3d44fc654a2de760f587"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e38c76a5365d16f6756273b2bcef843"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a3e38c76a5365d16f6756273b2bcef843">AllocateInvalidMsrBimap</a> ()</td></tr>
<tr class="memdesc:a3e38c76a5365d16f6756273b2bcef843"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocates a buffer and tests for the MSRs that cause #GP.  <a href="hprdbghv_2code_2common_2_common_8c.html#a3e38c76a5365d16f6756273b2bcef843">More...</a><br /></td></tr>
<tr class="separator:a3e38c76a5365d16f6756273b2bcef843"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e01c6f9cd92ee9184c3eb08d2095940"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a3e01c6f9cd92ee9184c3eb08d2095940">GetHandleFromProcess</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, PHANDLE Handle)</td></tr>
<tr class="memdesc:a3e01c6f9cd92ee9184c3eb08d2095940"><td class="mdescLeft">&#160;</td><td class="mdescRight">Get handle from Process Id.  <a href="hprdbghv_2code_2common_2_common_8c.html#a3e01c6f9cd92ee9184c3eb08d2095940">More...</a><br /></td></tr>
<tr class="separator:a3e01c6f9cd92ee9184c3eb08d2095940"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7b5ffb2e195b87edd682e4206d4ebab2"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a7b5ffb2e195b87edd682e4206d4ebab2">UndocumentedNtOpenProcess</a> (PHANDLE ProcessHandle, ACCESS_MASK <a class="el" href="_hooks_8h.html#ac648ae3c24d5148a8ef42128d6bab501">DesiredAccess</a>, HANDLE ProcessId, KPROCESSOR_MODE AccessMode)</td></tr>
<tr class="memdesc:a7b5ffb2e195b87edd682e4206d4ebab2"><td class="mdescLeft">&#160;</td><td class="mdescRight">The undocumented way of NtOpenProcess.  <a href="hprdbghv_2code_2common_2_common_8c.html#a7b5ffb2e195b87edd682e4206d4ebab2">More...</a><br /></td></tr>
<tr class="separator:a7b5ffb2e195b87edd682e4206d4ebab2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7f3d3771846d12b76ac03b0ecf457143"><td class="memItemLeft" align="right" valign="top">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html#a7f3d3771846d12b76ac03b0ecf457143">KillProcess</a> (<a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="hprdbghv_2header_2common_2common_8h.html#ae6070a281c39c841ba636b3c78ebbca6">PROCESS_KILL_METHODS</a> KillingMethod)</td></tr>
<tr class="memdesc:a7f3d3771846d12b76ac03b0ecf457143"><td class="mdescLeft">&#160;</td><td class="mdescRight">Kill a user-mode process with different methods.  <a href="hprdbghv_2code_2common_2_common_8c.html#a7f3d3771846d12b76ac03b0ecf457143">More...</a><br /></td></tr>
<tr class="separator:a7f3d3771846d12b76ac03b0ecf457143"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Common functions that needs to be used in all source code files. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span style="display: none;">.nosp@m.</span>hype<span style="display: none;">.nosp@m.</span>rdbg.<span style="display: none;">.nosp@m.</span>org</a>)</dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-10</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a16f7f49927e1575a97fc0c3b57dceba1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16f7f49927e1575a97fc0c3b57dceba1">&#9670;&nbsp;</a></span>SELECTOR_TABLE_GDT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SELECTOR_TABLE_GDT&#160;&#160;&#160;0x0</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aefc23d5a8cd57a497e57045930e55eed"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aefc23d5a8cd57a497e57045930e55eed">&#9670;&nbsp;</a></span>SELECTOR_TABLE_LDT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SELECTOR_TABLE_LDT&#160;&#160;&#160;0x1</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a3e38c76a5365d16f6756273b2bcef843"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e38c76a5365d16f6756273b2bcef843">&#9670;&nbsp;</a></span>AllocateInvalidMsrBimap()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>* AllocateInvalidMsrBimap </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocates a buffer and tests for the MSRs that cause #GP. </p>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Allocated buffer for MSR Bitmap </dd></dl>
<div class="fragment"><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;{</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> * InvalidMsrBitmap;</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160; </div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    InvalidMsrBitmap = ExAllocatePoolWithTag(NonPagedPool, 0x1000 / 0x8, <a class="code" href="hprdbghv_2header_2common_2common_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160; </div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    <span class="keywordflow">if</span> (InvalidMsrBitmap == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    {</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    }</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160; </div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    RtlZeroMemory(InvalidMsrBitmap, 0x1000 / 0x8);</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160; </div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; 0x1000; ++i)</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    {</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        __try</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        {</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;            __readmsr(i);</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        }</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        __except (EXCEPTION_EXECUTE_HANDLER)</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        {</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;            <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a6ea193321338d577be44e8490533c285">SetBit</a>(i, InvalidMsrBitmap);</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;        }</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    }</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160; </div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    <span class="keywordflow">return</span> InvalidMsrBitmap;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;}</div>
<div class="ttc" id="a_script_engine_eval_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:72</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a6ea193321338d577be44e8490533c285"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a6ea193321338d577be44e8490533c285">SetBit</a></div><div class="ttdeci">void SetBit(int nth, unsigned long *addr)</div><div class="ttdoc">set the bit</div><div class="ttdef"><b>Definition:</b> Common.c:103</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_ab7f91e71074ce1488e61869adbc44d8d"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a></div><div class="ttdeci">#define POOLTAG</div><div class="ttdoc">Pool tag.</div><div class="ttdef"><b>Definition:</b> Common.h:223</div></div>
<div class="ttc" id="anamespacetest-case-generator_html_a24d84c157fb3518eabe5eb9d0304e39f"><div class="ttname"><a href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">test-case-generator.NULL</a></div><div class="ttdeci">def NULL()</div><div class="ttdef"><b>Definition:</b> test-case-generator.py:530</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8a13133ef947f9fe935eda60b66784c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8a13133ef947f9fe935eda60b66784c6">&#9670;&nbsp;</a></span>BroadcastToProcessors()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> BroadcastToProcessors </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td>
          <td class="paramname"><em>ProcessorNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2common_8h.html#a25f777554b949fe8dfd4ffbd1313f30d">RunOnLogicalCoreFunc</a>&#160;</td>
          <td class="paramname"><em>Routine</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast a function to all logical cores. </p>
<p>This function is deprecated as we want to supporrt more than 32 processors</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessorNumber</td><td>The logical core number to execute routine on it </td></tr>
    <tr><td class="paramname">Routine</td><td>The fucntion that should be executed on the target core </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if it was successfull </dd></dl>
<div class="fragment"><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;{</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    KIRQL OldIrql;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    KeSetSystemAffinityThread((KAFFINITY)(1 &lt;&lt; ProcessorNumber));</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160; </div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    OldIrql = KeRaiseIrqlToDpcLevel();</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    Routine(ProcessorNumber);</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; </div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    KeLowerIrql(OldIrql);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160; </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    KeRevertToUserAffinityThread();</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div>
<div class="ttc" id="a_script_engine_eval_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:103</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae1c85b7df06c438a8cdda337ff25f9dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1c85b7df06c438a8cdda337ff25f9dd">&#9670;&nbsp;</a></span>CheckCanonicalVirtualAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> CheckCanonicalVirtualAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>VAddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a5fb149be049e9964b63bdd041c1bb130">PBOOLEAN</a>&#160;</td>
          <td class="paramname"><em>IsKernelAddress</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Checks if the address is canonical based on x86 processor's virtual address width or not. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VAddr</td><td>virtual address to check </td></tr>
    <tr><td class="paramname">IsKernelAddress</td><td>Filled to show whether the address is a kernel address or user-address</td></tr>
  </table>
  </dd>
</dl>
<p>IsKernelAddress wouldn't check for page attributes, it just checks the address convention in Windows</p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;{</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> Addr = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)VAddr;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> MaxVirtualAddrLowHalf, MinVirtualAddressHighHalf;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160; </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">// Get processor&#39;s address width for VA</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> AddrWidth = <a class="code" href="common_8cpp.html#ac126d635c7d2da7f5b1a08e570f784e6">g_VirtualAddressWidth</a>;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="comment">// get max address in lower-half canonical addr space</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="comment">// e.g. if width is 48, then 0x00007FFF_FFFFFFFF</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    MaxVirtualAddrLowHalf = ((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)1ull &lt;&lt; (AddrWidth - 1)) - 1;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160; </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="comment">// get min address in higher-half canonical addr space</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="comment">// e.g., if width is 48, then 0xFFFF8000_00000000</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    MinVirtualAddressHighHalf = ~MaxVirtualAddrLowHalf;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160; </div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="comment">// Check to see if the address in a canonical address</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keywordflow">if</span> ((Addr &gt; MaxVirtualAddrLowHalf) &amp;&amp; (Addr &lt; MinVirtualAddressHighHalf))</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    {</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        *IsKernelAddress = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160; </div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="comment">// Set whether it&#39;s a kernel address or not</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keywordflow">if</span> (MinVirtualAddressHighHalf &lt; Addr)</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        *IsKernelAddress = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    }</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    {</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        *IsKernelAddress = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    }</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160; </div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;}</div>
<div class="ttc" id="a_script_engine_eval_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:102</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:99</div></div>
<div class="ttc" id="acommon_8cpp_html_ac126d635c7d2da7f5b1a08e570f784e6"><div class="ttname"><a href="common_8cpp.html#ac126d635c7d2da7f5b1a08e570f784e6">g_VirtualAddressWidth</a></div><div class="ttdeci">UINT32 g_VirtualAddressWidth</div><div class="ttdoc">Virtual address width for x86 processors.</div><div class="ttdef"><b>Definition:</b> globals.h:28</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1ca8d92943fe9fcfbf98b0de88820f07"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1ca8d92943fe9fcfbf98b0de88820f07">&#9670;&nbsp;</a></span>CheckCpuSupportRtm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> CheckCpuSupportRtm </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check whether the processor supports RTM or not. </p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;{</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordtype">int</span>     Regs1[4];</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="keywordtype">int</span>     Regs2[4];</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> Result;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160; </div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="comment">// TSX is controlled via MSR_IA32_TSX_CTRL.  However, support for this</span></div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="comment">// MSR is enumerated by ARCH_CAP_TSX_MSR bit in MSR_IA32_ARCH_CAPABILITIES.</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment">// TSX control (aka MSR_IA32_TSX_CTRL) is only available after a</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="comment">// microcode update on CPUs that have their MSR_IA32_ARCH_CAPABILITIES</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="comment">// bit MDS_NO=1. CPUs with MDS_NO=0 are not planned to get</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="comment">// MSR_IA32_TSX_CTRL support even after a microcode update. Thus,</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    <span class="comment">// tsx= cmdline requests will do nothing on CPUs without</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="comment">// MSR_IA32_TSX_CTRL support.</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160; </div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">GetCpuid</a>(0, 0, Regs1);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">GetCpuid</a>(7, 0, Regs2);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160; </div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="comment">// Check RTM and MPX extensions in order to filter out TSX on Haswell CPUs</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    Result = Regs1[0] &gt;= 0x7 &amp;&amp; (Regs2[1] &amp; 0x4800) == 0x4800;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160; </div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    <span class="keywordflow">return</span> Result;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;}</div>
<div class="ttc" id="a_script_engine_eval_8h_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:90</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_adf1ba210f06e66c4e8cfec3dd291e4b8"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">GetCpuid</a></div><div class="ttdeci">VOID GetCpuid(UINT32 Func, UINT32 SubFunc, int *CpuInfo)</div><div class="ttdoc">Get cpuid results.</div><div class="ttdef"><b>Definition:</b> Common.c:761</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a80e28f3ea9a1bcf2b4e7e603784eba88"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a80e28f3ea9a1bcf2b4e7e603784eba88">&#9670;&nbsp;</a></span>CheckIfAddressIsValidUsingTsx()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> CheckIfAddressIsValidUsingTsx </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *&#160;</td>
          <td class="paramname"><em>Address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function checks whether the address is valid or not using Intel TSX. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Address</td><td>Address to check</td></tr>
    <tr><td class="paramname">UINT32</td><td>ProcId </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the address is valid; otherwise, false </dd></dl>
<div class="fragment"><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;{</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>  Status = 0;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>    TempContent;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160; </div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">if</span> ((Status = _xbegin()) == <a class="code" href="hprdbghv_2header_2common_2common_8h.html#affa290b6e944d914d80dfc2e469fd14c">_XBEGIN_STARTED</a>)</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    {</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="comment">// Try to read the memory</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        TempContent = *(<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *)<a class="code" href="script-engine_2header_2script-engine_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        _xend();</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160; </div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        <span class="comment">// No error, address is valid</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        Result = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    }</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    {</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="comment">// Address is not valid, it aborts the tsx rtm</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    }</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160; </div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    <span class="keywordflow">return</span> Result;</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;}</div>
<div class="ttc" id="a_script_engine_eval_8h_html_aebb9e13210d88d43e32e735ada43a425"><div class="ttname"><a href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a></div><div class="ttdeci">char CHAR</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:82</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_affa290b6e944d914d80dfc2e469fd14c"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#affa290b6e944d914d80dfc2e469fd14c">_XBEGIN_STARTED</a></div><div class="ttdeci">#define _XBEGIN_STARTED</div><div class="ttdoc">Intel TSX Constants.</div><div class="ttdef"><b>Definition:</b> Common.h:254</div></div>
<div class="ttc" id="ascript-engine_2header_2script-engine_8h_html_a3f7c5b71d899e923be0a80d4ac7902fe"><div class="ttname"><a href="script-engine_2header_2script-engine_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a></div><div class="ttdeci">UINT64 Address</div><div class="ttdef"><b>Definition:</b> script-engine.h:34</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a9ea9e4cef167ff3664811bd8627cde9c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ea9e4cef167ff3664811bd8627cde9c">&#9670;&nbsp;</a></span>CheckMemoryAccessSafety()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> CheckMemoryAccessSafety </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>Size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check the safety to access the memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
    <tr><td class="paramname">Size</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;{</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   OriginalCr3;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>  IsKernelAddress;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>  Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160; </div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    <span class="comment">// First, we check if the address is canonical based</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="comment">// on Intel processor&#39;s virtual address width</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ae1c85b7df06c438a8cdda337ff25f9dd">CheckCanonicalVirtualAddress</a>(TargetAddress, &amp;IsKernelAddress))</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    {</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="comment">// No need for further check, address is invalid</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        <span class="keywordflow">goto</span> Return;</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160; </div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="comment">// Find the current process cr3</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160; </div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="comment">// Move to new cr3</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    OriginalCr3 = __readcr3();</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    __writecr3(GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160; </div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="comment">// We&#39;ll only check address with TSX if the address is a kernel-mode</span></div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="comment">// address because an exception is thrown if we access user-mode code</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// from vmx-root mode, thus, TSX will fail the transaction and the</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="comment">// result is not true, so we check each pages&#39; page-table for user-mode</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">// codes in both user-mode and kernel-mode</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="comment">// if (g_RtmSupport &amp;&amp; IsKernelAddress)</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="comment">// {</span></div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="comment">//     //</span></div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    <span class="comment">//     // The guest supports Intel TSX</span></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="comment">//     //</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="comment">//     UINT64 AlignedPage = (UINT64)PAGE_ALIGN(TargetAddress);</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="comment">//     UINT64 PageCount   = ((TargetAddress - AlignedPage) + Size) / PAGE_SIZE;</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="comment">//     for (size_t i = 0; i &lt;= PageCount; i++)</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <span class="comment">//     {</span></div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">//         UINT64 CheckAddr = AlignedPage + (PAGE_SIZE * i);</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">//         if (!CheckIfAddressIsValidUsingTsx(CheckAddr))</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">//         {</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="comment">//             //</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="comment">//             // Address is not valid</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">//             //</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment">//             Result = FALSE;</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="comment">//             goto RestoreCr3;</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="comment">//         }</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="comment">//     }</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="comment">// }</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160; </div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    <span class="comment">// We&#39;ve realized that using TSX for address checking is not faster</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="comment">// than the legacy memory checking (traversing the page-tables),</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="comment">// based on our resultsm it&#39;s ~50 TSC clock cycles for a valid address</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;    <span class="comment">// and ~180 TSC clock cycles for an invalid address slower to use TSX</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="comment">// for memory checking, that&#39;s why it is deprecated now</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160; </div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <span class="comment">// Check if memory is safe and present</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> AddressToCheck =</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        (<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *)TargetAddress + Size - ((<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *)<a class="code" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress));</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160; </div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    <span class="keywordflow">if</span> (AddressToCheck &gt; <a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>)</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    {</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="comment">// Address should be accessed in more than one page</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> ReadSize = AddressToCheck;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160; </div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="keywordflow">while</span> (Size != 0)</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        {</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;            ReadSize = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress + <a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>) - TargetAddress;</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160; </div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            <span class="keywordflow">if</span> (ReadSize == <a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> &amp;&amp; Size &lt; <a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>)</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            {</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                ReadSize = Size;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            }</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160; </div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="_memory_mapper_8c.html#ac8e4d2586a43095b5d829065524aef3e">MemoryMapperCheckIfPageIsPresentByCr3</a>(TargetAddress, GuestCr3))</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            {</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                <span class="comment">// Address is not valid</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160; </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                <span class="keywordflow">goto</span> RestoreCr3;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            }</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160; </div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;            <span class="comment">/*</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">            LogInfo(&quot;Addr From : %llx to Addr To : %llx | ReadSize : %llx\n&quot;,</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">                    TargetAddress,</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">                    TargetAddress + ReadSize,</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment">                    ReadSize);</span></div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">            */</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160; </div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            <span class="comment">// Apply the changes to the next addresses (if any)</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;            Size          = Size - ReadSize;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            TargetAddress = TargetAddress + ReadSize;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        }</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    }</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="_memory_mapper_8c.html#ac8e4d2586a43095b5d829065524aef3e">MemoryMapperCheckIfPageIsPresentByCr3</a>(TargetAddress, GuestCr3))</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        {</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;            <span class="comment">// Address is not valid</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;            Result = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160; </div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            <span class="keywordflow">goto</span> RestoreCr3;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        }</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    }</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160; </div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment">// If we&#39;ve reached here, the address was valid</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    Result = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160; </div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;RestoreCr3:</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160; </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    __writecr3(OriginalCr3);</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160; </div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;Return:</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">return</span> Result;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;}</div>
<div class="ttc" id="a_memory_mapper_8c_html_ac8e4d2586a43095b5d829065524aef3e"><div class="ttname"><a href="_memory_mapper_8c.html#ac8e4d2586a43095b5d829065524aef3e">MemoryMapperCheckIfPageIsPresentByCr3</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN MemoryMapperCheckIfPageIsPresentByCr3(PVOID Va, CR3_TYPE TargetCr3)</div><div class="ttdoc">This function checks if the page is mapped or not.</div><div class="ttdef"><b>Definition:</b> MemoryMapper.c:234</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_a7d467c1d283fdfa1f2081ba1e0d01b6e"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a></div><div class="ttdeci">#define PAGE_SIZE</div><div class="ttdoc">Size of each page (4096 bytes)</div><div class="ttdef"><b>Definition:</b> common.h:59</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_aa02188de52b66a3aa5e1aecc6bd963ae"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a></div><div class="ttdeci">#define PAGE_ALIGN(Va)</div><div class="ttdoc">Aligning a page.</div><div class="ttdef"><b>Definition:</b> common.h:65</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a3cf8394ebbc5300f74b02f51bd8519f6"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a></div><div class="ttdeci">CR3_TYPE GetRunningCr3OnTargetProcess()</div><div class="ttdoc">Get cr3 of the target running process.</div><div class="ttdef"><b>Definition:</b> Common.c:466</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_ae1c85b7df06c438a8cdda337ff25f9dd"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#ae1c85b7df06c438a8cdda337ff25f9dd">CheckCanonicalVirtualAddress</a></div><div class="ttdeci">BOOLEAN CheckCanonicalVirtualAddress(UINT64 VAddr, PBOOLEAN IsKernelAddress)</div><div class="ttdoc">Checks if the address is canonical based on x86 processor's virtual address width or not.</div><div class="ttdef"><b>Definition:</b> Common.c:831</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html">_CR3_TYPE</a></div><div class="ttdoc">CR3 Structure.</div><div class="ttdef"><b>Definition:</b> MemoryMapper.h:125</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html_a04eb96cc99b0458be739bcc9c640e08b"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">_CR3_TYPE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> MemoryMapper.h:128</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1325b69024a8a649457e13b496d678ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1325b69024a8a649457e13b496d678ee">&#9670;&nbsp;</a></span>ClearBit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ClearBit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long *&#160;</td>
          <td class="paramname"><em>addr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>unset the bit </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nth</td><td></td></tr>
    <tr><td class="paramname">addr</td><td></td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;{</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a599110110e78104661fcfd9686057885">BITMAP_ENTRY</a>(nth, addr) &amp;= ~(1UL &lt;&lt; <a class="code" href="hprdbghv_2header_2common_2common_8h.html#aee4e9629d1c51e53a36c51a7b1820cfe">BITMAP_SHIFT</a>(nth));</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a599110110e78104661fcfd9686057885"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a599110110e78104661fcfd9686057885">BITMAP_ENTRY</a></div><div class="ttdeci">#define BITMAP_ENTRY(_nr, _bmap)</div><div class="ttdef"><b>Definition:</b> Common.h:241</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_aee4e9629d1c51e53a36c51a7b1820cfe"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#aee4e9629d1c51e53a36c51a7b1820cfe">BITMAP_SHIFT</a></div><div class="ttdeci">#define BITMAP_SHIFT(_nr)</div><div class="ttdef"><b>Definition:</b> Common.h:242</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="adcbb2311c406c2d7866818d6461a8d02"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adcbb2311c406c2d7866818d6461a8d02">&#9670;&nbsp;</a></span>FindSystemDirectoryTableBase()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> FindSystemDirectoryTableBase </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Find cr3 of system process. </p>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns cr3 of System process (pid=4) </dd></dl>
<div class="fragment"><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;{</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    <span class="comment">// Return CR3 of the system process.</span></div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> * SystemProcess = (<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> *)(PsInitialSystemProcess);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;    <span class="keywordflow">return</span> SystemProcess-&gt;<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html#a0ba2f55aeffe5e3c92dd8787dc8af022">DirectoryTableBase</a>;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;}</div>
<div class="ttc" id="astruct___n_t___k_p_r_o_c_e_s_s_html"><div class="ttname"><a href="struct___n_t___k_p_r_o_c_e_s_s.html">_NT_KPROCESS</a></div><div class="ttdoc">KPROCESS Brief structure.</div><div class="ttdef"><b>Definition:</b> Common.h:299</div></div>
<div class="ttc" id="astruct___n_t___k_p_r_o_c_e_s_s_html_a0ba2f55aeffe5e3c92dd8787dc8af022"><div class="ttname"><a href="struct___n_t___k_p_r_o_c_e_s_s.html#a0ba2f55aeffe5e3c92dd8787dc8af022">_NT_KPROCESS::DirectoryTableBase</a></div><div class="ttdeci">ULONG_PTR DirectoryTableBase</div><div class="ttdef"><b>Definition:</b> Common.h:302</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="adf1ba210f06e66c4e8cfec3dd291e4b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adf1ba210f06e66c4e8cfec3dd291e4b8">&#9670;&nbsp;</a></span>GetCpuid()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> GetCpuid </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>Func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>SubFunc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>CpuInfo</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get cpuid results. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">UINT32</td><td>Func </td></tr>
    <tr><td class="paramname">UINT32</td><td>SubFunc </td></tr>
    <tr><td class="paramname">int</td><td>* CpuInfo </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;{</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    __cpuidex(CpuInfo, Func, SubFunc);</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af530cb1a7ccd595fa84d7e27001ab933"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af530cb1a7ccd595fa84d7e27001ab933">&#9670;&nbsp;</a></span>GetCr3FromProcessId()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> GetCr3FromProcessId </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts pid to kernel cr3. </p>
<p>this function should NOT be called from vmx-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessId</td><td>ProcessId to switch </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>CR3_TYPE The cr3 of the target process </dd></dl>
<div class="fragment"><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;{</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    PEPROCESS TargetEprocess;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>  ProcessCr3 = {0};</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160; </div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <span class="keywordflow">if</span> (PsLookupProcessByProcessId(ProcessId, &amp;TargetEprocess) != STATUS_SUCCESS)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="comment">// There was an error, probably the process id was not found</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="keywordflow">return</span> ProcessCr3;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="comment">// Due to KVA Shadowing, we need to switch to a different directory table base</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="comment">// if the PCID indicates this is a user mode directory table base.</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> * CurrentProcess = (<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> *)(TargetEprocess);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    ProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>             = CurrentProcess-&gt;<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html#a0ba2f55aeffe5e3c92dd8787dc8af022">DirectoryTableBase</a>;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160; </div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    ObDereferenceObject(TargetEprocess);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">return</span> ProcessCr3;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3e01c6f9cd92ee9184c3eb08d2095940"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3e01c6f9cd92ee9184c3eb08d2095940">&#9670;&nbsp;</a></span>GetHandleFromProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ NTSTATUS GetHandleFromProcess </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PHANDLE&#160;</td>
          <td class="paramname"><em>Handle</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get handle from Process Id. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Handle</td><td></td></tr>
    <tr><td class="paramname">ProcessId</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS </dd></dl>
<div class="fragment"><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;{</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    NTSTATUS Status;</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    Status = STATUS_SUCCESS;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    OBJECT_ATTRIBUTES ObjAttr;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    CLIENT_ID         Cid;</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    InitializeObjectAttributes(&amp;ObjAttr, <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>, 0, <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>, <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>);</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160; </div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    Cid.UniqueProcess = ProcessId;</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    Cid.UniqueThread  = (HANDLE)0;</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160; </div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;    Status = ZwOpenProcess(Handle, PROCESS_ALL_ACCESS, &amp;ObjAttr, &amp;Cid);</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160; </div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="keywordflow">return</span> Status;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7d8de41916e9cffe3cb1963847484806"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7d8de41916e9cffe3cb1963847484806">&#9670;&nbsp;</a></span>GetProcessNameFromEprocess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PCHAR GetProcessNameFromEprocess </td>
          <td>(</td>
          <td class="paramtype">PEPROCESS&#160;</td>
          <td class="paramname"><em>Eprocess</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get process name by eprocess. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Eprocess</td><td>Process eprocess </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PCHAR Returns a pointer to the process name </dd></dl>
<div class="fragment"><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;{</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    PCHAR Result = 0;</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160; </div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    <span class="comment">// We can&#39;t use PsLookupProcessByProcessId as in pageable and not</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;    <span class="comment">// work on vmx-root</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    Result = (<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *)<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a91bc96860d8b1fe8697d475e3a02e840">PsGetProcessImageFileName</a>(Eprocess);</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160; </div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="keywordflow">return</span> Result;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a91bc96860d8b1fe8697d475e3a02e840"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a91bc96860d8b1fe8697d475e3a02e840">PsGetProcessImageFileName</a></div><div class="ttdeci">UCHAR * PsGetProcessImageFileName(IN PEPROCESS Process)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3cf8394ebbc5300f74b02f51bd8519f6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3cf8394ebbc5300f74b02f51bd8519f6">&#9670;&nbsp;</a></span>GetRunningCr3OnTargetProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> GetRunningCr3OnTargetProcess </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get cr3 of the target running process. </p>
<dl class="section return"><dt>Returns</dt><dd>CR3_TYPE Returns the cr3 of running process </dd></dl>
<div class="fragment"><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;{</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="comment">// Due to KVA Shadowing, we need to switch to a different directory table base</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">// if the PCID indicates this is a user mode directory table base.</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> * CurrentProcess = (<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> *)(PsGetCurrentProcess());</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>               = CurrentProcess-&gt;<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html#a0ba2f55aeffe5e3c92dd8787dc8af022">DirectoryTableBase</a>;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160; </div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">return</span> GuestCr3;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a979b3a59be793422133f37c01e471981"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a979b3a59be793422133f37c01e471981">&#9670;&nbsp;</a></span>GetSegmentDescriptor()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> GetSegmentDescriptor </td>
          <td>(</td>
          <td class="paramtype">PUCHAR&#160;</td>
          <td class="paramname"><em>GdtBase</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a09f1a1fb2293e33483cc8d44aefb1eb1">UINT16</a>&#160;</td>
          <td class="paramname"><em>Selector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2common_8h.html#ac0981ad69bb8ce42661d8f4eec22f5fe">PVMX_SEGMENT_SELECTOR</a>&#160;</td>
          <td class="paramname"><em>SegmentSelector</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get Segment Descriptor. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">SegmentSelector</td><td></td></tr>
    <tr><td class="paramname">Selector</td><td></td></tr>
    <tr><td class="paramname">GdtBase</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;{</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    SEGMENT_DESCRIPTOR_32 * DescriptorTable32;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    SEGMENT_DESCRIPTOR_32 * Descriptor32;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    SEGMENT_SELECTOR        SegSelector = {.Flags = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>};</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="preprocessor">#define SELECTOR_TABLE_LDT 0x1</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#define SELECTOR_TABLE_GDT 0x0</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160; </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">// Ignore LDT</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a> == 0x0) || (SegSelector.Table != <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a>))</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    {</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    }</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    DescriptorTable32 = (SEGMENT_DESCRIPTOR_32 *)(GdtBase);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    Descriptor32      = &amp;DescriptorTable32[SegSelector.Index];</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160; </div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#ab6ee44522229df1c55cca4f72f172abf">Selector</a> = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a>    = __segmentlimit(<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a>     = (Descriptor32-&gt;BaseAddressLow | Descriptor32-&gt;BaseAddressMiddle &lt;&lt; 16 | Descriptor32-&gt;BaseAddressHigh &lt;&lt; 24);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160; </div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#add9e4cc36b93b9f13a2457f137fc689a">Attributes</a>.Flags = (<a class="code" href="_inline_asm_8h.html#aedeb3f3df41e4bb43b6aed532e969195">AsmGetAccessRights</a>(<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a>) &gt;&gt; 8);</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; </div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">if</span> (SegSelector.Table == 0 &amp;&amp; SegSelector.Index == 0)</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#add9e4cc36b93b9f13a2457f137fc689a">Attributes</a>.Unusable = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    }</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">if</span> ((Descriptor32-&gt;Type == SEGMENT_DESCRIPTOR_TYPE_TSS_BUSY) ||</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        (Descriptor32-&gt;Type == SEGMENT_DESCRIPTOR_TYPE_CALL_GATE))</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    {</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        <span class="comment">// this is a TSS or callgate etc, save the base high part</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> SegmentLimitHigh;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        SegmentLimitHigh      = (*(<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> *)((PUCHAR)Descriptor32 + 8));</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a> = (<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">Base</a> &amp; 0xffffffff) | (SegmentLimitHigh &lt;&lt; 32);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160; </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#add9e4cc36b93b9f13a2457f137fc689a">Attributes</a>.Granularity)</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    {</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="comment">// 4096-bit granularity is enabled for this segment, scale the limit</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a> = (<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a>-&gt;<a class="code" href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">Limit</a> &lt;&lt; 12) + 0xfff;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    }</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160; </div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;}</div>
<div class="ttc" id="a_inline_asm_8h_html_aedeb3f3df41e4bb43b6aed532e969195"><div class="ttname"><a href="_inline_asm_8h.html#aedeb3f3df41e4bb43b6aed532e969195">AsmGetAccessRights</a></div><div class="ttdeci">UINT32 AsmGetAccessRights(unsigned short Selector)</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a16f7f49927e1575a97fc0c3b57dceba1"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a16f7f49927e1575a97fc0c3b57dceba1">SELECTOR_TABLE_GDT</a></div><div class="ttdeci">#define SELECTOR_TABLE_GDT</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a4a0d94e93bbb0b7abc6f24679b7dfc06"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a4a0d94e93bbb0b7abc6f24679b7dfc06">Selector</a></div><div class="ttdeci">_In_ UINT16 Selector</div><div class="ttdef"><b>Definition:</b> Common.h:708</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a68870ccf6841ce76f7ca30ab1f3b1b4d"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a68870ccf6841ce76f7ca30ab1f3b1b4d">SegmentSelector</a></div><div class="ttdeci">_In_ UINT16 _Out_ PVMX_SEGMENT_SELECTOR SegmentSelector</div><div class="ttdef"><b>Definition:</b> Common.h:708</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_a0bd32da992b5c13d921807c82f3f932a"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#a0bd32da992b5c13d921807c82f3f932a">_VMX_SEGMENT_SELECTOR::Limit</a></div><div class="ttdeci">UINT32 Limit</div><div class="ttdef"><b>Definition:</b> Common.h:278</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_ab6ee44522229df1c55cca4f72f172abf"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#ab6ee44522229df1c55cca4f72f172abf">_VMX_SEGMENT_SELECTOR::Selector</a></div><div class="ttdeci">UINT16 Selector</div><div class="ttdef"><b>Definition:</b> Common.h:276</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_add9e4cc36b93b9f13a2457f137fc689a"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#add9e4cc36b93b9f13a2457f137fc689a">_VMX_SEGMENT_SELECTOR::Attributes</a></div><div class="ttdeci">VMX_SEGMENT_ACCESS_RIGHTS Attributes</div><div class="ttdef"><b>Definition:</b> Common.h:277</div></div>
<div class="ttc" id="astruct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r_html_af782f7b350ce9911745618fa9051428a"><div class="ttname"><a href="struct___v_m_x___s_e_g_m_e_n_t___s_e_l_e_c_t_o_r.html#af782f7b350ce9911745618fa9051428a">_VMX_SEGMENT_SELECTOR::Base</a></div><div class="ttdeci">UINT64 Base</div><div class="ttdef"><b>Definition:</b> Common.h:279</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab0fbc2b64fdf9682a442b18e8dc03e8c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab0fbc2b64fdf9682a442b18e8dc03e8c">&#9670;&nbsp;</a></span>Getx86VirtualAddressWidth()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Getx86VirtualAddressWidth </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Get virtual address width for x86 processors. </p>
<dl class="section return"><dt>Returns</dt><dd>UINT32 </dd></dl>
<div class="fragment"><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;{</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keywordtype">int</span> Regs[4];</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160; </div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#adf1ba210f06e66c4e8cfec3dd291e4b8">GetCpuid</a>(<a class="code" href="hprdbgctrl_2header_2common_8h.html#acfd8b975cbd62360c9e7817285652c23">CPUID_ADDR_WIDTH</a>, 0, Regs);</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160; </div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">// Extracting bit 15:8 from eax register</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">return</span> ((Regs[0] &gt;&gt; 8) &amp; 0x0ff);</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;}</div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_acfd8b975cbd62360c9e7817285652c23"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#acfd8b975cbd62360c9e7817285652c23">CPUID_ADDR_WIDTH</a></div><div class="ttdeci">#define CPUID_ADDR_WIDTH</div><div class="ttdoc">Cpuid to get virtual address width.</div><div class="ttdef"><b>Definition:</b> common.h:71</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="aac8ebaacb2e2c9098a2feecf0d4d3ca8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aac8ebaacb2e2c9098a2feecf0d4d3ca8">&#9670;&nbsp;</a></span>IsProcessExist()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsProcessExist </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcId</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Checks whether the process with ProcId exists or not. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">UINT32</td><td>ProcId </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the process exists and false if it the process doesn't exist </dd></dl>
<div class="fragment"><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;{</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    PEPROCESS TargetEprocess;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>  CurrentProcessCr3 = {0};</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160; </div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">if</span> (PsLookupProcessByProcessId(ProcId, &amp;TargetEprocess) != STATUS_SUCCESS)</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    {</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <span class="comment">// There was an error, probably the process id was not found</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    }</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    {</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        ObDereferenceObject(TargetEprocess);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160; </div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    }</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7f3d3771846d12b76ac03b0ecf457143"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7f3d3771846d12b76ac03b0ecf457143">&#9670;&nbsp;</a></span>KillProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> KillProcess </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2common_8h.html#ae6070a281c39c841ba636b3c78ebbca6">PROCESS_KILL_METHODS</a>&#160;</td>
          <td class="paramname"><em>KillingMethod</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Kill a user-mode process with different methods. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessId</td><td></td></tr>
    <tr><td class="paramname">KillingMethod</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN </dd></dl>
<div class="fragment"><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;{</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    NTSTATUS  Status        = STATUS_SUCCESS;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    HANDLE    ProcessHandle = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    PEPROCESS Process       = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160; </div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keywordflow">if</span> (ProcessId == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    {</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    }</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160; </div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keywordflow">switch</span> (KillingMethod)</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    {</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5fa8a7a9cbb4d530cb0fcd48b9c39a1ada7">PROCESS_KILL_METHOD_1</a>:</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160; </div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;        Status = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3e01c6f9cd92ee9184c3eb08d2095940">GetHandleFromProcess</a>(ProcessId, &amp;ProcessHandle);</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160; </div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        <span class="keywordflow">if</span> (!NT_SUCCESS(Status) || ProcessHandle == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        {</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        }</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160; </div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <span class="comment">// Call ZwTerminateProcess with NULL handle</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        Status = ZwTerminateProcess(ProcessHandle, 0);</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160; </div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;        <span class="keywordflow">if</span> (!NT_SUCCESS(Status))</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        {</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        }</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160; </div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160; </div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5fa5fd6f785eb4eb8f824f4110f59c64483">PROCESS_KILL_METHOD_2</a>:</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160; </div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;        <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a7b5ffb2e195b87edd682e4206d4ebab2">UndocumentedNtOpenProcess</a>(</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;            &amp;ProcessHandle,</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;            PROCESS_ALL_ACCESS,</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;            ProcessId,</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;            KernelMode);</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160; </div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        <span class="keywordflow">if</span> (ProcessHandle == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        {</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        }</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160; </div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="comment">// Call ZwTerminateProcess with NULL handle</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        Status = ZwTerminateProcess(ProcessHandle, 0);</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160; </div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        <span class="keywordflow">if</span> (!NT_SUCCESS(Status))</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        {</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        }</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160; </div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160; </div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5facdd6ffa2c41cbb645d9eb6339f845a43">PROCESS_KILL_METHOD_3</a>:</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160; </div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;        <span class="comment">// Get the base address of process&#39;s executable image and unmap it</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        Status = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a0722d4d4f132fad82c7fbe7a1905e05a">MmUnmapViewOfSection</a>(Process, <a class="code" href="hprdbghv_2header_2common_2common_8h.html#af9d4674f153cbce4fabec19606643ae2">PsGetProcessSectionBaseAddress</a>(Process));</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160; </div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <span class="comment">// Dereference the target process</span></div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        ObDereferenceObject(Process);</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160; </div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160; </div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160; </div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        <span class="comment">// Unknow killing method</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;    }</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160; </div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;    <span class="comment">// If we reached here, it means the functionality of</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    <span class="comment">// the above codes was successful</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a3e01c6f9cd92ee9184c3eb08d2095940"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a3e01c6f9cd92ee9184c3eb08d2095940">GetHandleFromProcess</a></div><div class="ttdeci">_Use_decl_annotations_ NTSTATUS GetHandleFromProcess(UINT32 ProcessId, PHANDLE Handle)</div><div class="ttdoc">Get handle from Process Id.</div><div class="ttdef"><b>Definition:</b> Common.c:1252</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a7b5ffb2e195b87edd682e4206d4ebab2"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a7b5ffb2e195b87edd682e4206d4ebab2">UndocumentedNtOpenProcess</a></div><div class="ttdeci">NTSTATUS UndocumentedNtOpenProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, HANDLE ProcessId, KPROCESSOR_MODE AccessMode)</div><div class="ttdoc">The undocumented way of NtOpenProcess.</div><div class="ttdef"><b>Definition:</b> Common.c:1278</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a0722d4d4f132fad82c7fbe7a1905e05a"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a0722d4d4f132fad82c7fbe7a1905e05a">MmUnmapViewOfSection</a></div><div class="ttdeci">NTSTATUS MmUnmapViewOfSection(PEPROCESS Process, PVOID BaseAddress)</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a6b5ea74a23199b25cd91da7cb7307f5fa5fd6f785eb4eb8f824f4110f59c64483"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5fa5fd6f785eb4eb8f824f4110f59c64483">PROCESS_KILL_METHOD_2</a></div><div class="ttdeci">@ PROCESS_KILL_METHOD_2</div><div class="ttdef"><b>Definition:</b> Common.h:41</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a6b5ea74a23199b25cd91da7cb7307f5fa8a7a9cbb4d530cb0fcd48b9c39a1ada7"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5fa8a7a9cbb4d530cb0fcd48b9c39a1ada7">PROCESS_KILL_METHOD_1</a></div><div class="ttdeci">@ PROCESS_KILL_METHOD_1</div><div class="ttdef"><b>Definition:</b> Common.h:40</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a6b5ea74a23199b25cd91da7cb7307f5facdd6ffa2c41cbb645d9eb6339f845a43"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a6b5ea74a23199b25cd91da7cb7307f5facdd6ffa2c41cbb645d9eb6339f845a43">PROCESS_KILL_METHOD_3</a></div><div class="ttdeci">@ PROCESS_KILL_METHOD_3</div><div class="ttdef"><b>Definition:</b> Common.h:42</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_af9d4674f153cbce4fabec19606643ae2"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#af9d4674f153cbce4fabec19606643ae2">PsGetProcessSectionBaseAddress</a></div><div class="ttdeci">PVOID PsGetProcessSectionBaseAddress(PEPROCESS Process)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a0f16df9e7e4722921b04a6db04144236"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0f16df9e7e4722921b04a6db04144236">&#9670;&nbsp;</a></span>MathPower()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int MathPower </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>Base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>Exp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Power function in order to computer address for MSR bitmaps. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Base</td><td>Base for power function </td></tr>
    <tr><td class="paramname">Exp</td><td>Exponent for power function </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>int Returns the result of power function </dd></dl>
<div class="fragment"><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;{</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="keywordtype">int</span> result;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160; </div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    result = 1;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="keywordflow">for</span> (;;)</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    {</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        <span class="keywordflow">if</span> (Exp &amp; 1)</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        {</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;            result *= Base;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        }</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        Exp &gt;&gt;= 1;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        <span class="keywordflow">if</span> (!Exp)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        {</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        }</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;        Base *= Base;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af7f8cac9416a0d6568c820e4437e672c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af7f8cac9416a0d6568c820e4437e672c">&#9670;&nbsp;</a></span>PhysicalAddressToVirtualAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysicalAddressToVirtualAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Physical Address to Virtual Address. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td>The target physical address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the virtual address </dd></dl>
<div class="fragment"><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;{</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    PHYSICAL_ADDRESS PhysicalAddr;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    PhysicalAddr.QuadPart = PhysicalAddress;</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">return</span> MmGetVirtualForPhysical(PhysicalAddr);</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ab07b73e748394f71fc32793c1ccccd26"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab07b73e748394f71fc32793c1ccccd26">&#9670;&nbsp;</a></span>PhysicalAddressToVirtualAddressByCr3()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysicalAddressToVirtualAddressByCr3 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>TargetCr3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Physical Address to Virtual Address based on a specific process's kernel cr3. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td>The target physical address </td></tr>
    <tr><td class="paramname">TargetCr3</td><td>The target's process cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the virtual address </dd></dl>
<div class="fragment"><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;{</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>         CurrentProcessCr3;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>           VirtualAddress;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    PHYSICAL_ADDRESS PhysicalAddr;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160; </div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">// Switch to new process&#39;s memory layout</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    CurrentProcessCr3 = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">SwitchOnAnotherProcessMemoryLayoutByCr3</a>(TargetCr3);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">// Validate if process id is valid</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="keywordflow">if</span> (CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    {</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <span class="comment">// Pid is invalid</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    }</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160; </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="comment">// Read the virtual address based on new cr3</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    PhysicalAddr.QuadPart = PhysicalAddress;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    VirtualAddress        = MmGetVirtualForPhysical(PhysicalAddr);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160; </div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="comment">// Restore the original process</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a>(CurrentProcessCr3);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="keywordflow">return</span> VirtualAddress;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a3b20ca080234a45df3a99f5ccfcce840"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a></div><div class="ttdeci">_Use_decl_annotations_ VOID RestoreToPreviousProcess(CR3_TYPE PreviousProcess)</div><div class="ttdoc">Switch to previous process's cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:334</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a6fd3d4f5957bf2db1e26c9150500aaa0"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">SwitchOnAnotherProcessMemoryLayoutByCr3</a></div><div class="ttdeci">_Use_decl_annotations_ CR3_TYPE SwitchOnAnotherProcessMemoryLayoutByCr3(CR3_TYPE TargetCr3)</div><div class="ttdoc">Switch to another process's cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:241</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ac6482780667d9d17160287439da81d3d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac6482780667d9d17160287439da81d3d">&#9670;&nbsp;</a></span>PhysicalAddressToVirtualAddressByProcessId()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysicalAddressToVirtualAddressByProcessId </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Physical Address to Virtual Address based on a specific process id. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td>The target physical address </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The target's process id </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the virtual address </dd></dl>
<div class="fragment"><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;{</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>         CurrentProcessCr3;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>           VirtualAddress;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    PHYSICAL_ADDRESS PhysicalAddr;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160; </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="comment">// Switch to new process&#39;s memory layout</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    CurrentProcessCr3 = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a837a1bba323c96382e713627b60e3dad">SwitchOnAnotherProcessMemoryLayout</a>(ProcessId);</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="comment">// Validate if process id is valid</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="keywordflow">if</span> (CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="comment">// Pid is invalid</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">// Read the virtual address based on new cr3</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    PhysicalAddr.QuadPart = PhysicalAddress;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    VirtualAddress        = MmGetVirtualForPhysical(PhysicalAddr);</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160; </div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="comment">// Restore the original process</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a>(CurrentProcessCr3);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160; </div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="keywordflow">return</span> VirtualAddress;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a837a1bba323c96382e713627b60e3dad"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a837a1bba323c96382e713627b60e3dad">SwitchOnAnotherProcessMemoryLayout</a></div><div class="ttdeci">_Use_decl_annotations_ CR3_TYPE SwitchOnAnotherProcessMemoryLayout(UINT32 ProcessId)</div><div class="ttdoc">Switch to another process's cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:167</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a512f6b5eb5218445aa58489b8f9d8593"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a512f6b5eb5218445aa58489b8f9d8593">&#9670;&nbsp;</a></span>PhysicalAddressToVirtualAddressOnTargetProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysicalAddressToVirtualAddressOnTargetProcess </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Physical Address to Virtual Address based on current process's kernel cr3. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td>The target physical address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the virtual address </dd></dl>
<div class="fragment"><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;{</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160; </div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> Temp = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)PhysicalAddress;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160; </div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ab07b73e748394f71fc32793c1ccccd26">PhysicalAddressToVirtualAddressByCr3</a>(PhysicalAddress, GuestCr3);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;}</div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_ab07b73e748394f71fc32793c1ccccd26"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#ab07b73e748394f71fc32793c1ccccd26">PhysicalAddressToVirtualAddressByCr3</a></div><div class="ttdeci">_Use_decl_annotations_ UINT64 PhysicalAddressToVirtualAddressByCr3(PVOID PhysicalAddress, CR3_TYPE TargetCr3)</div><div class="ttdoc">Converts Physical Address to Virtual Address based on a specific process's kernel cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:402</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3b20ca080234a45df3a99f5ccfcce840"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3b20ca080234a45df3a99f5ccfcce840">&#9670;&nbsp;</a></span>RestoreToPreviousProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> RestoreToPreviousProcess </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>PreviousProcess</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Switch to previous process's cr3. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PreviousProcess</td><td>Cr3 of previous process which is returned by SwitchOnAnotherProcessMemoryLayout </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;{</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="comment">// Restore the original cr3</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    __writecr3(PreviousProcess.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a6ea193321338d577be44e8490533c285"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6ea193321338d577be44e8490533c285">&#9670;&nbsp;</a></span>SetBit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SetBit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long *&#160;</td>
          <td class="paramname"><em>addr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>set the bit </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nth</td><td></td></tr>
    <tr><td class="paramname">addr</td><td></td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;{</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a599110110e78104661fcfd9686057885">BITMAP_ENTRY</a>(nth, addr) |= (1UL &lt;&lt; <a class="code" href="hprdbghv_2header_2common_2common_8h.html#aee4e9629d1c51e53a36c51a7b1820cfe">BITMAP_SHIFT</a>(nth));</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="acd7a24f884afa520da81557896a4abcd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd7a24f884afa520da81557896a4abcd">&#9670;&nbsp;</a></span>StartsWith()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> StartsWith </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>str</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Detects whether the string starts with another string. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">const</td><td>char * pre </td></tr>
    <tr><td class="paramname">const</td><td>char * str </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if it starts with and false if not strats with </dd></dl>
<div class="fragment"><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;{</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordtype">size_t</span> lenpre = strlen(pre),</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;           lenstr = strlen(str);</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordflow">return</span> lenstr &lt; lenpre ? <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> : memcmp(pre, str, lenpre) == 0;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a837a1bba323c96382e713627b60e3dad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a837a1bba323c96382e713627b60e3dad">&#9670;&nbsp;</a></span>SwitchOnAnotherProcessMemoryLayout()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> SwitchOnAnotherProcessMemoryLayout </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Switch to another process's cr3. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessId</td><td>ProcessId to switch </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>CR3_TYPE The cr3 of current process which can be used by RestoreToPreviousProcess function </dd></dl>
<div class="fragment"><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;{</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>    GuestCr3;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    PEPROCESS TargetEprocess;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>  CurrentProcessCr3 = {0};</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (PsLookupProcessByProcessId(ProcessId, &amp;TargetEprocess) != STATUS_SUCCESS)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="comment">// There was an error, probably the process id was not found</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <span class="keywordflow">return</span> CurrentProcessCr3;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    }</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160; </div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="comment">// Due to KVA Shadowing, we need to switch to a different directory table base</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="comment">// if the PCID indicates this is a user mode directory table base.</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> * CurrentProcess = (<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html">NT_KPROCESS</a> *)(TargetEprocess);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    GuestCr3                     = CurrentProcess-&gt;<a class="code" href="struct___n_t___k_p_r_o_c_e_s_s.html#a0ba2f55aeffe5e3c92dd8787dc8af022">DirectoryTableBase</a>;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="comment">// Read the current cr3</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">// Change to a new cr3 (of target process)</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    __writecr3(GuestCr3);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    ObDereferenceObject(TargetEprocess);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keywordflow">return</span> CurrentProcessCr3;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a6fd3d4f5957bf2db1e26c9150500aaa0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6fd3d4f5957bf2db1e26c9150500aaa0">&#9670;&nbsp;</a></span>SwitchOnAnotherProcessMemoryLayoutByCr3()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> SwitchOnAnotherProcessMemoryLayoutByCr3 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>TargetCr3</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Switch to another process's cr3. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetCr3</td><td>cr3 to switch </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>CR3_TYPE The cr3 of current process which can be used by RestoreToPreviousProcess function </dd></dl>
<div class="fragment"><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;{</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> CurrentProcessCr3 = {0};</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160; </div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="comment">// Read the current cr3</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160; </div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="comment">// Change to a new cr3 (of target process)</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    __writecr3(TargetCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordflow">return</span> CurrentProcessCr3;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ad28edc4807eae2171a6d8b898863e8e5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad28edc4807eae2171a6d8b898863e8e5">&#9670;&nbsp;</a></span>SwitchOnMemoryLayoutOfTargetProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> SwitchOnMemoryLayoutOfTargetProcess </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Switch to guest's running process's cr3. </p>
<p>this function can be called from vmx-root mode</p>
<dl class="section return"><dt>Returns</dt><dd>CR3_TYPE The cr3 of current process which can be used by RestoreToPreviousProcess function </dd></dl>
<div class="fragment"><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;{</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> CurrentProcessCr3 = {0};</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160; </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="comment">// Read the current cr3</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="comment">// Change to a new cr3 (of target process)</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    __writecr3(GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">return</span> CurrentProcessCr3;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="abf9996f46885e97a5d0f4d6fdbba98e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abf9996f46885e97a5d0f4d6fdbba98e0">&#9670;&nbsp;</a></span>TestBit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int TestBit </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>nth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long *&#160;</td>
          <td class="paramname"><em>addr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check whether the bit is set or not. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">nth</td><td></td></tr>
    <tr><td class="paramname">addr</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>int </dd></dl>
<div class="fragment"><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;{</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="hprdbghv_2header_2common_2common_8h.html#a599110110e78104661fcfd9686057885">BITMAP_ENTRY</a>(nth, addr) &gt;&gt; <a class="code" href="hprdbghv_2header_2common_2common_8h.html#aee4e9629d1c51e53a36c51a7b1820cfe">BITMAP_SHIFT</a>(nth)) &amp; 1;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a7b5ffb2e195b87edd682e4206d4ebab2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7b5ffb2e195b87edd682e4206d4ebab2">&#9670;&nbsp;</a></span>UndocumentedNtOpenProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">NTSTATUS UndocumentedNtOpenProcess </td>
          <td>(</td>
          <td class="paramtype">PHANDLE&#160;</td>
          <td class="paramname"><em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ACCESS_MASK&#160;</td>
          <td class="paramname"><em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">HANDLE&#160;</td>
          <td class="paramname"><em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">KPROCESSOR_MODE&#160;</td>
          <td class="paramname"><em>AccessMode</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The undocumented way of NtOpenProcess. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ProcessHandle</td><td></td></tr>
    <tr><td class="paramname">DesiredAccess</td><td></td></tr>
    <tr><td class="paramname">ProcessId</td><td></td></tr>
    <tr><td class="paramname">AccessMode</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS </dd></dl>
<div class="fragment"><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;{</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    NTSTATUS     status = STATUS_SUCCESS;</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    ACCESS_STATE accessState;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="keywordtype">char</span>         auxData[0x200];</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    PEPROCESS    processObject = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    HANDLE       processHandle = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160; </div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    status = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#afd3aec9b7c0fa91a0ddc3172ed23e585">SeCreateAccessState</a>(</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        &amp;accessState,</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        auxData,</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <a class="code" href="_hooks_8h.html#ac648ae3c24d5148a8ef42128d6bab501">DesiredAccess</a>,</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        (PGENERIC_MAPPING)((PCHAR)*PsProcessType + 52));</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160; </div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="keywordflow">if</span> (!NT_SUCCESS(status))</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordflow">return</span> status;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160; </div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;    accessState.PreviouslyGrantedAccess |= accessState.RemainingDesiredAccess;</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;    accessState.RemainingDesiredAccess = 0;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160; </div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    status = PsLookupProcessByProcessId(ProcessId, &amp;processObject);</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160; </div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">if</span> (!NT_SUCCESS(status))</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    {</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#aac577b18cb9b0c1841628693faef982e">SeDeleteAccessState</a>(&amp;accessState);</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        <span class="keywordflow">return</span> status;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;    }</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;    status = ObOpenObjectByPointer(</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        processObject,</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        0,</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        &amp;accessState,</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        0,</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        *PsProcessType,</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        AccessMode,</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        &amp;processHandle);</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160; </div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#aac577b18cb9b0c1841628693faef982e">SeDeleteAccessState</a>(&amp;accessState);</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160; </div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    ObDereferenceObject(processObject);</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160; </div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">if</span> (NT_SUCCESS(status))</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        *ProcessHandle = processHandle;</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160; </div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordflow">return</span> status;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;}</div>
<div class="ttc" id="a_hooks_8h_html_ac648ae3c24d5148a8ef42128d6bab501"><div class="ttname"><a href="_hooks_8h.html#ac648ae3c24d5148a8ef42128d6bab501">DesiredAccess</a></div><div class="ttdeci">PHANDLE ACCESS_MASK DesiredAccess</div><div class="ttdef"><b>Definition:</b> Hooks.h:139</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_aac577b18cb9b0c1841628693faef982e"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#aac577b18cb9b0c1841628693faef982e">SeDeleteAccessState</a></div><div class="ttdeci">NTKERNELAPI VOID NTAPI SeDeleteAccessState(PACCESS_STATE AccessState)</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_afd3aec9b7c0fa91a0ddc3172ed23e585"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#afd3aec9b7c0fa91a0ddc3172ed23e585">SeCreateAccessState</a></div><div class="ttdeci">NTKERNELAPI NTSTATUS NTAPI SeCreateAccessState(PACCESS_STATE AccessState, PVOID AuxData, ACCESS_MASK DesiredAccess, PGENERIC_MAPPING Mapping)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ab7aedff95075e77cd8fbe128f01d2853"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab7aedff95075e77cd8fbe128f01d2853">&#9670;&nbsp;</a></span>VirtualAddressToPhysicalAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddressToPhysicalAddress </td>
          <td>(</td>
          <td class="paramtype">_In_ PVOID&#160;</td>
          <td class="paramname"><em>VirtualAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Virtual Address to Physical Address. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>The target virtual address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the physical address </dd></dl>
<div class="fragment"><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;{</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">return</span> MmGetPhysicalAddress(VirtualAddress).QuadPart;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ace32f507228d4b1b3b8e53f82ac09402"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ace32f507228d4b1b3b8e53f82ac09402">&#9670;&nbsp;</a></span>VirtualAddressToPhysicalAddressByProcessCr3()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddressToPhysicalAddressByProcessCr3 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>TargetCr3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Virtual Address to Physical Address based on a specific process's kernel cr3. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>The target virtual address </td></tr>
    <tr><td class="paramname">TargetCr3</td><td>The target's process cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the physical address </dd></dl>
<div class="fragment"><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;{</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> CurrentProcessCr3;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   PhysicalAddress;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="comment">// Switch to new process&#39;s memory layout</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    CurrentProcessCr3 = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">SwitchOnAnotherProcessMemoryLayoutByCr3</a>(TargetCr3);</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160; </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">// Validate if process id is valid</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">if</span> (CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    {</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="comment">// Pid is invalid</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    }</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="comment">// Read the physical address based on new cr3</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    PhysicalAddress = MmGetPhysicalAddress(VirtualAddress).QuadPart;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160; </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="comment">// Restore the original process</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a>(CurrentProcessCr3);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160; </div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordflow">return</span> PhysicalAddress;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a507e3ba3c1076ac38e61c34f53ef5c38"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a507e3ba3c1076ac38e61c34f53ef5c38">&#9670;&nbsp;</a></span>VirtualAddressToPhysicalAddressByProcessId()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddressToPhysicalAddressByProcessId </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Virtual Address to Physical Address based on a specific process id's kernel cr3. </p>
<p>this function should NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>The target virtual address </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The target's process id </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the physical address </dd></dl>
<div class="fragment"><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;{</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> CurrentProcessCr3;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   PhysicalAddress;</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// Switch to new process&#39;s memory layout</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    CurrentProcessCr3 = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a837a1bba323c96382e713627b60e3dad">SwitchOnAnotherProcessMemoryLayout</a>(ProcessId);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160; </div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">// Validate if process id is valid</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">if</span> (CurrentProcessCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    {</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="comment">// Pid is invalid</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    }</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160; </div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="comment">// Read the physical address based on new cr3</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    PhysicalAddress = MmGetPhysicalAddress(VirtualAddress).QuadPart;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="comment">// Restore the original process</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a>(CurrentProcessCr3);</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160; </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">return</span> PhysicalAddress;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a63eff86102e697567fec147fc04f6248"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a63eff86102e697567fec147fc04f6248">&#9670;&nbsp;</a></span>VirtualAddressToPhysicalAddressOnTargetProcess()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Use_decl_annotations_ <a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddressToPhysicalAddressOnTargetProcess </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>VirtualAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Converts Virtual Address to Physical Address based on the current process's kernel cr3. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>The target virtual address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT64 Returns the physical address </dd></dl>
<div class="fragment"><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;{</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> CurrentCr3;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   PhysicalAddress;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160; </div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160; </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="comment">// Switch to new process&#39;s memory layout</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    CurrentCr3 = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a6fd3d4f5957bf2db1e26c9150500aaa0">SwitchOnAnotherProcessMemoryLayoutByCr3</a>(GuestCr3);</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160; </div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="comment">// Validate if process id is valid</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <span class="keywordflow">if</span> (CurrentCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> == <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>)</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    {</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="comment">// Pid is invalid</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    }</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160; </div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="comment">// Read the physical address based on new cr3</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    PhysicalAddress = MmGetPhysicalAddress(VirtualAddress).QuadPart;</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="comment">// Restore the original process</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3b20ca080234a45df3a99f5ccfcce840">RestoreToPreviousProcess</a>(CurrentCr3);</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160; </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="keywordflow">return</span> PhysicalAddress;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3eb68998b6cd2546b6e4cc1ae0c30417"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3eb68998b6cd2546b6e4cc1ae0c30417">&#9670;&nbsp;</a></span>VmxrootCompatibleStrlen()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> VmxrootCompatibleStrlen </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a> *&#160;</td>
          <td class="paramname"><em>S</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>implementation of vmx-root mode compatible strlen </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">S</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 If 0x0 indicates an error, otherwise length of the string </dd></dl>
<div class="fragment"><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;{</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>     Temp  = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>   Count = 0;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   AlignedAddress;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> OriginalCr3;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160; </div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    AlignedAddress = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>);</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160; </div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="comment">// Find the current process cr3</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160; </div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="comment">// Move to new cr3</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    __writecr3(GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160; </div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    <span class="comment">// First check</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a>(AlignedAddress, <span class="keyword">sizeof</span>(<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>)))</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    {</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        <span class="comment">// Error</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160; </div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    }</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160; </div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    {</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">        Temp = *S;</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        <a class="code" href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a>(<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>, &amp;Temp, <span class="keyword">sizeof</span>(<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>));</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160; </div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;        <span class="keywordflow">if</span> (Temp != <span class="charliteral">&#39;\0&#39;</span>)</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        {</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            Count++;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;            <a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>++;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        {</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;            <span class="keywordflow">return</span> Count;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;        }</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160; </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        <span class="keywordflow">if</span> (!((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a> &amp; (<a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)))</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        {</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a>((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>, <span class="keyword">sizeof</span>(<a class="code" href="_script_engine_eval_8h.html#aebb9e13210d88d43e32e735ada43a425">CHAR</a>)))</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            {</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                <span class="comment">// Error</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160; </div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;            }</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        }</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    }</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160; </div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;}</div>
<div class="ttc" id="a_grammar_8txt_html_a05250664815950204e4091ddf9c9af89"><div class="ttname"><a href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a></div><div class="ttdeci">ThreeOpFunc1 interlocked_compare_exchange TwoOpFunc1 ed eb eq interlocked_exchange interlocked_exchange_add TwoOpFunc2 spinlock_lock_custom_wait OneOpFunc1 poi db dd dw dq neg hi low not check_address strlen wcslen interlocked_increment interlocked_decrement reference physical_to_virtual virtual_to_physical OneOpFunc2 print formats disable_event enable_event test_statement spinlock_lock spinlock_unlock ZeroOpFunc1 pause VarArgFunc1 printf OperatorsTwoOperand or xor and asr asl add sub mul div mod gt lt egt elt equal neq OperatorsOneOperand inc dec reference dereference SemantiRules start_of_if jmp jz jnz jmp_to_end_and_jzcompleted end_of_if start_of_while end_of_while vargstart mov start_of_do_while start_of_do_while_commands end_of_do_while start_of_for for_inc_dec start_of_for_ommands end_of_if ignore_lvalue Registers rax eax ax ah al rcx ecx cx ch cl rdx edx dx dh dl rbx ebx bx bh bl rsp esp sp spl rbp ebp bp bpl rsi esi si sil rdi edi di dil r8 r8d r8w r8h r8l r9 r9d r9w r9h r9l r10 r10d r10w r10h r10l r11 r11d r11w r11h r11l r12 r12d r12w r12h r12l r13 r13d r13w r13h r13l r14 r14d r14w r14h r14l r15 r15d r15w r15h r15l ds es fs gs cs ss rflags eflags flags cf pf af zf sf tf if df of iopl nt rf vm ac vif vip id rip eip ip idtr ldtr gdtr tr cr0 cr2 cr3 cr4 cr8 dr0 dr1 dr2 dr3 dr6 dr7 PseudoRegisters pid tid pname core proc thread peb teb ip buffer context S STATEMENT S S</div><div class="ttdef"><b>Definition:</b> Grammar.txt:33</div></div>
<div class="ttc" id="a_memory_mapper_8c_html_ac3c23d5644111a6be18ca274f448e9ff"><div class="ttname"><a href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a></div><div class="ttdeci">_Use_decl_annotations_ BOOLEAN MemoryMapperReadMemorySafe(UINT64 VaAddressToRead, PVOID BufferToSaveMemory, SIZE_T SizeToRead)</div><div class="ttdoc">Read memory safely by mapping the buffer (It's a wrapper)</div><div class="ttdef"><b>Definition:</b> MemoryMapper.c:826</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a9ea9e4cef167ff3664811bd8627cde9c"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a></div><div class="ttdeci">BOOLEAN CheckMemoryAccessSafety(UINT64 TargetAddress, UINT32 Size)</div><div class="ttdoc">Check the safety to access the memory.</div><div class="ttdef"><b>Definition:</b> Common.c:885</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5bf7c4bfb01c3d44fc654a2de760f587"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5bf7c4bfb01c3d44fc654a2de760f587">&#9670;&nbsp;</a></span>VmxrootCompatibleWcslen()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> VmxrootCompatibleWcslen </td>
          <td>(</td>
          <td class="paramtype">const wchar_t *&#160;</td>
          <td class="paramname"><em>S</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>implementation of vmx-root mode compatible wcslen </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">S</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 If 0x0 indicates an error, otherwise length of the string </dd></dl>
<div class="fragment"><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;{</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="keywordtype">wchar_t</span>  Temp  = <a class="code" href="namespacetest-case-generator.html#a24d84c157fb3518eabe5eb9d0304e39f">NULL</a>;</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>   Count = 0;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>   AlignedAddress;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> GuestCr3;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> OriginalCr3;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160; </div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    AlignedAddress = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>);</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160; </div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <span class="comment">// Find the current process cr3</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a3cf8394ebbc5300f74b02f51bd8519f6">GetRunningCr3OnTargetProcess</a>().<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160; </div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    <span class="comment">// Move to new cr3</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a> = __readcr3();</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    __writecr3(GuestCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160; </div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    AlignedAddress = (<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>);</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160; </div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    <span class="comment">// First check</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a>(AlignedAddress, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)))</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    {</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        <span class="comment">// Error</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160; </div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    }</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160; </div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="keywordflow">while</span> (<a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    {</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment">        Temp = *S;</span></div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        <a class="code" href="_memory_mapper_8c.html#ac3c23d5644111a6be18ca274f448e9ff">MemoryMapperReadMemorySafe</a>(<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>, &amp;Temp, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>));</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160; </div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        <span class="keywordflow">if</span> (Temp != <span class="stringliteral">&#39;\0\0&#39;</span>)</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        {</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;            Count++;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            <a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>++;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        }</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        {</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;            <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;            __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            <span class="keywordflow">return</span> Count;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        }</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160; </div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;        <span class="keywordflow">if</span> (!((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a> &amp; (<a class="code" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)))</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        {</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a9ea9e4cef167ff3664811bd8627cde9c">CheckMemoryAccessSafety</a>((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)<a class="code" href="_grammar_8txt.html#a05250664815950204e4091ddf9c9af89">S</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)))</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;            {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;                <span class="comment">// Error</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160; </div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;                <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;            }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    }</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160; </div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="comment">// Move back to original cr3</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    __writecr3(OriginalCr3.<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_19054a674c4bd5cb8fceb6542228579c.html">hprdbghv</a></li><li class="navelem"><a class="el" href="dir_aac0c9299474d8b4035e61d55763e72a.html">code</a></li><li class="navelem"><a class="el" href="dir_940884ac64d747c4acfea3308cfad98b.html">common</a></li><li class="navelem"><a class="el" href="hprdbghv_2code_2common_2_common_8c.html">Common.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
