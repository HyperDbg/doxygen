<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg: hyperdbg/hprdbgkd/code/debugger/broadcast/DpcRoutines.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HyperDbg
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">DpcRoutines.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>All the dpc routines which relates to executing on a single core for multi-core you can use <a class="el" href="_broadcast_8c.html" title="Broadcast debugger function to all logical cores.">Broadcast.c</a>.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a860d1d5fbe8605d03eda7327935c799e"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#a860d1d5fbe8605d03eda7327935c799e">DpcRoutineRunTaskOnSingleCore</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> CoreNumber, PVOID Routine, PVOID DeferredContext)</td></tr>
<tr class="memdesc:a860d1d5fbe8605d03eda7327935c799e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function synchronize the function execution for a single core You should only used it for one core, not in multiple threads simultaneously The function that needs to use this featue (Routine parameter function) should have the when it ends :  <br /></td></tr>
<tr class="separator:a860d1d5fbe8605d03eda7327935c799e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#a5db83f6e1cbc79c9147fabc0c3b97744">DpcRoutinePerformWriteMsr</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast msr write.  <br /></td></tr>
<tr class="separator:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b602a352170d025aa12387207214382"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#a6b602a352170d025aa12387207214382">DpcRoutinePerformReadMsr</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:a6b602a352170d025aa12387207214382"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast msr read.  <br /></td></tr>
<tr class="separator:a6b602a352170d025aa12387207214382"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac9051976c97907c7b77703fd5b8d5a79"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#ac9051976c97907c7b77703fd5b8d5a79">DpcRoutineWriteMsrToAllCores</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:ac9051976c97907c7b77703fd5b8d5a79"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast Msr Write.  <br /></td></tr>
<tr class="separator:ac9051976c97907c7b77703fd5b8d5a79"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeac723279c4734876a27723d78950f0a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#aeac723279c4734876a27723d78950f0a">DpcRoutineReadMsrToAllCores</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:aeac723279c4734876a27723d78950f0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast Msr read.  <br /></td></tr>
<tr class="separator:aeac723279c4734876a27723d78950f0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9dfa6e7472910802d84b97ac5fa0d7aa"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#a9dfa6e7472910802d84b97ac5fa0d7aa">DpcRoutineVmExitAndHaltSystemAllCores</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:a9dfa6e7472910802d84b97ac5fa0d7aa"><td class="mdescLeft">&#160;</td><td class="mdescRight">vm-exit and halt the system  <br /></td></tr>
<tr class="separator:a9dfa6e7472910802d84b97ac5fa0d7aa"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad770b621bcb6287f068300a85ba36233"><td class="memItemLeft" align="right" valign="top">volatile LONG&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a></td></tr>
<tr class="memdesc:ad770b621bcb6287f068300a85ba36233"><td class="mdescLeft">&#160;</td><td class="mdescRight">lock for one core execution  <br /></td></tr>
<tr class="separator:ad770b621bcb6287f068300a85ba36233"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>All the dpc routines which relates to executing on a single core for multi-core you can use <a class="el" href="_broadcast_8c.html" title="Broadcast debugger function to all logical cores.">Broadcast.c</a>. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span class="obfuscator">.nosp@m.</span>hype<span class="obfuscator">.nosp@m.</span>rdbg.<span class="obfuscator">.nosp@m.</span>org</a>) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-29</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a6b602a352170d025aa12387207214382" name="a6b602a352170d025aa12387207214382"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b602a352170d025aa12387207214382">&#9670;&#160;</a></span>DpcRoutinePerformReadMsr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> DpcRoutinePerformReadMsr </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast msr read. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Dpc</td><td></td></tr>
    <tr><td class="paramname">DeferredContext</td><td></td></tr>
    <tr><td class="paramname">SystemArgument1</td><td></td></tr>
    <tr><td class="paramname">SystemArgument2</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  162</span>{</div>
<div class="line"><span class="lineno">  163</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                       CurrentCore           = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  164</span>    <a class="code hl_struct" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html">PROCESSOR_DEBUGGING_STATE</a> * CurrentDebuggingState = &amp;<a class="code hl_variable" href="hprdbgkd_2header_2globals_2_global_8h.html#a349ee1adc363d2e4323a35a68fae5646">g_DbgState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">  165</span> </div>
<div class="line"><span class="lineno">  166</span>    UNREFERENCED_PARAMETER(Dpc);</div>
<div class="line"><span class="lineno">  167</span>    UNREFERENCED_PARAMETER(DeferredContext);</div>
<div class="line"><span class="lineno">  168</span>    UNREFERENCED_PARAMETER(SystemArgument1);</div>
<div class="line"><span class="lineno">  169</span>    UNREFERENCED_PARAMETER(SystemArgument2);</div>
<div class="line"><span class="lineno">  170</span> </div>
<div class="line"><span class="lineno">  171</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  172</span>    <span class="comment">// read on MSR</span></div>
<div class="line"><span class="lineno">  173</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  174</span>    CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a> = __readmsr(CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#a3ca94b81f31339286eaa6f27eea5804e">Msr</a>);</div>
<div class="line"><span class="lineno">  175</span> </div>
<div class="line"><span class="lineno">  176</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  177</span>    <span class="comment">// As this function is designed for a single,</span></div>
<div class="line"><span class="lineno">  178</span>    <span class="comment">// we have to release the synchronization lock here</span></div>
<div class="line"><span class="lineno">  179</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  180</span>    <a class="code hl_function" href="spinlock_8cpp.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code hl_variable" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><span class="lineno">  181</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:35</div></div>
<div class="ttc" id="ahprdbghv_2code_2broadcast_2_dpc_routines_8c_html_ad770b621bcb6287f068300a85ba36233"><div class="ttname"><a href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a></div><div class="ttdeci">volatile LONG OneCoreLock</div><div class="ttdoc">lock for one core execution</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:19</div></div>
<div class="ttc" id="ahprdbgkd_2header_2globals_2_global_8h_html_a349ee1adc363d2e4323a35a68fae5646"><div class="ttname"><a href="hprdbgkd_2header_2globals_2_global_8h.html#a349ee1adc363d2e4323a35a68fae5646">g_DbgState</a></div><div class="ttdeci">PROCESSOR_DEBUGGING_STATE * g_DbgState</div><div class="ttdoc">Save the state and variables related to debugging on each to logical core.</div><div class="ttdef"><b>Definition:</b> Global.h:23</div></div>
<div class="ttc" id="aspinlock_8cpp_html_a529db917026601c47af458af0154bfa1"><div class="ttname"><a href="spinlock_8cpp.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a></div><div class="ttdeci">void SpinlockUnlock(volatile LONG *Lock)</div><div class="ttdoc">Release the lock.</div><div class="ttdef"><b>Definition:</b> spinlock.cpp:119</div></div>
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e_html_a3ca94b81f31339286eaa6f27eea5804e"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#a3ca94b81f31339286eaa6f27eea5804e">_PROCESSOR_DEBUGGING_MSR_READ_OR_WRITE::Msr</a></div><div class="ttdeci">UINT64 Msr</div><div class="ttdef"><b>Definition:</b> State.h:24</div></div>
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e_html_af0a7d72554edcca419674fb5dbf3608d"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">_PROCESSOR_DEBUGGING_MSR_READ_OR_WRITE::Value</a></div><div class="ttdeci">UINT64 Value</div><div class="ttdef"><b>Definition:</b> State.h:25</div></div>
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e_html"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html">_PROCESSOR_DEBUGGING_STATE</a></div><div class="ttdoc">Saves the debugger state.</div><div class="ttdef"><b>Definition:</b> State.h:106</div></div>
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e_html_a5d5c22183a428958358e19d6434db8a7"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">_PROCESSOR_DEBUGGING_STATE::MsrState</a></div><div class="ttdeci">PROCESSOR_DEBUGGING_MSR_READ_OR_WRITE MsrState</div><div class="ttdef"><b>Definition:</b> State.h:113</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a5db83f6e1cbc79c9147fabc0c3b97744" name="a5db83f6e1cbc79c9147fabc0c3b97744"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5db83f6e1cbc79c9147fabc0c3b97744">&#9670;&#160;</a></span>DpcRoutinePerformWriteMsr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> DpcRoutinePerformWriteMsr </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast msr write. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Dpc</td><td></td></tr>
    <tr><td class="paramname">DeferredContext</td><td></td></tr>
    <tr><td class="paramname">SystemArgument1</td><td></td></tr>
    <tr><td class="paramname">SystemArgument2</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  129</span>{</div>
<div class="line"><span class="lineno">  130</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                       CurrentProcessorIndex = 0;</div>
<div class="line"><span class="lineno">  131</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                       CurrentCore           = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  132</span>    <a class="code hl_struct" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html">PROCESSOR_DEBUGGING_STATE</a> * CurrentDebuggingState = &amp;<a class="code hl_variable" href="hprdbgkd_2header_2globals_2_global_8h.html#a349ee1adc363d2e4323a35a68fae5646">g_DbgState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">  133</span> </div>
<div class="line"><span class="lineno">  134</span>    UNREFERENCED_PARAMETER(Dpc);</div>
<div class="line"><span class="lineno">  135</span>    UNREFERENCED_PARAMETER(DeferredContext);</div>
<div class="line"><span class="lineno">  136</span>    UNREFERENCED_PARAMETER(SystemArgument1);</div>
<div class="line"><span class="lineno">  137</span>    UNREFERENCED_PARAMETER(SystemArgument2);</div>
<div class="line"><span class="lineno">  138</span> </div>
<div class="line"><span class="lineno">  139</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  140</span>    <span class="comment">// write on MSR</span></div>
<div class="line"><span class="lineno">  141</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  142</span>    __writemsr(CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#a3ca94b81f31339286eaa6f27eea5804e">Msr</a>, CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a>);</div>
<div class="line"><span class="lineno">  143</span> </div>
<div class="line"><span class="lineno">  144</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  145</span>    <span class="comment">// As this function is designed for a single,</span></div>
<div class="line"><span class="lineno">  146</span>    <span class="comment">// we have to release the synchronization lock here</span></div>
<div class="line"><span class="lineno">  147</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  148</span>    <a class="code hl_function" href="spinlock_8cpp.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code hl_variable" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><span class="lineno">  149</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aeac723279c4734876a27723d78950f0a" name="aeac723279c4734876a27723d78950f0a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeac723279c4734876a27723d78950f0a">&#9670;&#160;</a></span>DpcRoutineReadMsrToAllCores()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> DpcRoutineReadMsrToAllCores </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast Msr read. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Dpc</td><td></td></tr>
    <tr><td class="paramname">DeferredContext</td><td></td></tr>
    <tr><td class="paramname">SystemArgument1</td><td></td></tr>
    <tr><td class="paramname">SystemArgument2</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  228</span>{</div>
<div class="line"><span class="lineno">  229</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                       CurrentCore           = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  230</span>    <a class="code hl_struct" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html">PROCESSOR_DEBUGGING_STATE</a> * CurrentDebuggingState = &amp;<a class="code hl_variable" href="hprdbgkd_2header_2globals_2_global_8h.html#a349ee1adc363d2e4323a35a68fae5646">g_DbgState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>    UNREFERENCED_PARAMETER(Dpc);</div>
<div class="line"><span class="lineno">  233</span>    UNREFERENCED_PARAMETER(DeferredContext);</div>
<div class="line"><span class="lineno">  234</span> </div>
<div class="line"><span class="lineno">  235</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  236</span>    <span class="comment">// read msr</span></div>
<div class="line"><span class="lineno">  237</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  238</span>    CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a> = __readmsr(CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#a3ca94b81f31339286eaa6f27eea5804e">Msr</a>);</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  241</span>    <span class="comment">// Wait for all DPCs to synchronize at this point</span></div>
<div class="line"><span class="lineno">  242</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  243</span>    KeSignalCallDpcSynchronize(SystemArgument2);</div>
<div class="line"><span class="lineno">  244</span> </div>
<div class="line"><span class="lineno">  245</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  246</span>    <span class="comment">// Mark the DPC as being complete</span></div>
<div class="line"><span class="lineno">  247</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  248</span>    KeSignalCallDpcDone(SystemArgument1);</div>
<div class="line"><span class="lineno">  249</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a860d1d5fbe8605d03eda7327935c799e" name="a860d1d5fbe8605d03eda7327935c799e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a860d1d5fbe8605d03eda7327935c799e">&#9670;&#160;</a></span>DpcRoutineRunTaskOnSingleCore()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">NTSTATUS DpcRoutineRunTaskOnSingleCore </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>CoreNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>Routine</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function synchronize the function execution for a single core You should only used it for one core, not in multiple threads simultaneously The function that needs to use this featue (Routine parameter function) should have the when it ends : </p>
<pre class="fragment">         SpinlockUnlock(&amp;OneCoreLock);
</pre> <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">CoreNumber</td><td>core number that the target function should run on it </td></tr>
    <tr><td class="paramname">Routine</td><td>the target function that should be runned </td></tr>
    <tr><td class="paramname">DeferredContext</td><td>an optional parameter to Routine </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>NTSTATUS </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   36</span>{</div>
<div class="line"><span class="lineno">   37</span>    PRKDPC Dpc;</div>
<div class="line"><span class="lineno">   38</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessorCount;</div>
<div class="line"><span class="lineno">   39</span> </div>
<div class="line"><span class="lineno">   40</span>    ProcessorCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><span class="lineno">   41</span> </div>
<div class="line"><span class="lineno">   42</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   43</span>    <span class="comment">// Check if the core number is not invalid</span></div>
<div class="line"><span class="lineno">   44</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   45</span>    <span class="keywordflow">if</span> (CoreNumber &gt;= ProcessorCount)</div>
<div class="line"><span class="lineno">   46</span>    {</div>
<div class="line"><span class="lineno">   47</span>        <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;</div>
<div class="line"><span class="lineno">   48</span>    }</div>
<div class="line"><span class="lineno">   49</span> </div>
<div class="line"><span class="lineno">   50</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   51</span>    <span class="comment">// Allocate Memory for DPC</span></div>
<div class="line"><span class="lineno">   52</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   53</span>    Dpc = ExAllocatePoolWithTag(NonPagedPool, <span class="keyword">sizeof</span>(KDPC), <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">   54</span> </div>
<div class="line"><span class="lineno">   55</span>    <span class="keywordflow">if</span> (!Dpc)</div>
<div class="line"><span class="lineno">   56</span>    {</div>
<div class="line"><span class="lineno">   57</span>        <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;</div>
<div class="line"><span class="lineno">   58</span>    }</div>
<div class="line"><span class="lineno">   59</span> </div>
<div class="line"><span class="lineno">   60</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   61</span>    <span class="comment">// Creating a DPC that will run on the target process</span></div>
<div class="line"><span class="lineno">   62</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   63</span>    KeInitializeDpc(Dpc,            <span class="comment">// Dpc</span></div>
<div class="line"><span class="lineno">   64</span>                    Routine,        <span class="comment">// DeferredRoutine</span></div>
<div class="line"><span class="lineno">   65</span>                    DeferredContext <span class="comment">// DeferredContext</span></div>
<div class="line"><span class="lineno">   66</span>    );</div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   69</span>    <span class="comment">// Set the target core</span></div>
<div class="line"><span class="lineno">   70</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   71</span>    KeSetTargetProcessorDpc(Dpc, CoreNumber);</div>
<div class="line"><span class="lineno">   72</span> </div>
<div class="line"><span class="lineno">   73</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   74</span>    <span class="comment">// it&#39;s sure will be executed, but we want to free the above</span></div>
<div class="line"><span class="lineno">   75</span>    <span class="comment">// pool, so we have to wait on a spinlock that will be release</span></div>
<div class="line"><span class="lineno">   76</span>    <span class="comment">// by the the DPC routine, actually Affinity Thread but that</span></div>
<div class="line"><span class="lineno">   77</span>    <span class="comment">// won&#39;t support more than 64 logical cores, I create a discussion</span></div>
<div class="line"><span class="lineno">   78</span>    <span class="comment">// here, and explained the problem, but no one answers</span></div>
<div class="line"><span class="lineno">   79</span>    <span class="comment">// link: https://community.osr.com/discussion/292064/putting-a-barrier-for-dpc-before-continuing-the-rest-of-code</span></div>
<div class="line"><span class="lineno">   80</span>    <span class="comment">// we also can&#39;t use the spinlock routine of Windows as this function</span></div>
<div class="line"><span class="lineno">   81</span>    <span class="comment">// raises the IRQL to DPC and we want to execute at DPC, means that</span></div>
<div class="line"><span class="lineno">   82</span>    <span class="comment">// If we&#39;re currently on the right core, we never find a chance to</span></div>
<div class="line"><span class="lineno">   83</span>    <span class="comment">// release the spinlock so a deadlock happens, all in all it&#39;s complicated :)</span></div>
<div class="line"><span class="lineno">   84</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   85</span> </div>
<div class="line"><span class="lineno">   86</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   87</span>    <span class="comment">// Set the lock to be freed by the other DPC routine</span></div>
<div class="line"><span class="lineno">   88</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   89</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="spinlock_8cpp.html#a442b1a10c7275a6764621203970a68fa">SpinlockTryLock</a>(&amp;<a class="code hl_variable" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>))</div>
<div class="line"><span class="lineno">   90</span>    {</div>
<div class="line"><span class="lineno">   91</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   92</span>        <span class="comment">// We can&#39;t get the lock, probably sth goes wrong !</span></div>
<div class="line"><span class="lineno">   93</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">   94</span>        ExFreePoolWithTag(Dpc, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">   95</span>        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;</div>
<div class="line"><span class="lineno">   96</span>    }</div>
<div class="line"><span class="lineno">   97</span> </div>
<div class="line"><span class="lineno">   98</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">   99</span>    <span class="comment">// Fire the DPC</span></div>
<div class="line"><span class="lineno">  100</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  101</span>    KeInsertQueueDpc(Dpc, NULL, NULL);</div>
<div class="line"><span class="lineno">  102</span> </div>
<div class="line"><span class="lineno">  103</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  104</span>    <span class="comment">// spin on lock to be release, immediately after we get the lock, we&#39;ll</span></div>
<div class="line"><span class="lineno">  105</span>    <span class="comment">// release it for because there is no need to it anymore and DPC is finished</span></div>
<div class="line"><span class="lineno">  106</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  107</span>    <a class="code hl_function" href="spinlock_8cpp.html#a08984f739349991eab67c45376a990bc">SpinlockLock</a>(&amp;<a class="code hl_variable" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><span class="lineno">  108</span>    <a class="code hl_function" href="spinlock_8cpp.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code hl_variable" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><span class="lineno">  109</span> </div>
<div class="line"><span class="lineno">  110</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  111</span>    <span class="comment">// Now it&#39;s safe to deallocate the bugger</span></div>
<div class="line"><span class="lineno">  112</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  113</span>    ExFreePoolWithTag(Dpc, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><span class="lineno">  114</span> </div>
<div class="line"><span class="lineno">  115</span>    <span class="keywordflow">return</span> STATUS_SUCCESS;</div>
<div class="line"><span class="lineno">  116</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:46</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_constants_8h_html_ab7f91e71074ce1488e61869adbc44d8d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a></div><div class="ttdeci">#define POOLTAG</div><div class="ttdoc">Pool tag.</div><div class="ttdef"><b>Definition:</b> Constants.h:377</div></div>
<div class="ttc" id="aspinlock_8cpp_html_a08984f739349991eab67c45376a990bc"><div class="ttname"><a href="spinlock_8cpp.html#a08984f739349991eab67c45376a990bc">SpinlockLock</a></div><div class="ttdeci">void SpinlockLock(volatile LONG *Lock)</div><div class="ttdoc">Tries to get the lock and won't return until successfully get the lock.</div><div class="ttdef"><b>Definition:</b> spinlock.cpp:52</div></div>
<div class="ttc" id="aspinlock_8cpp_html_a442b1a10c7275a6764621203970a68fa"><div class="ttname"><a href="spinlock_8cpp.html#a442b1a10c7275a6764621203970a68fa">SpinlockTryLock</a></div><div class="ttdeci">BOOLEAN SpinlockTryLock(volatile LONG *Lock)</div><div class="ttdoc">Tries to get the lock otherwise returns.</div><div class="ttdef"><b>Definition:</b> spinlock.cpp:41</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a9dfa6e7472910802d84b97ac5fa0d7aa" name="a9dfa6e7472910802d84b97ac5fa0d7aa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9dfa6e7472910802d84b97ac5fa0d7aa">&#9670;&#160;</a></span>DpcRoutineVmExitAndHaltSystemAllCores()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> DpcRoutineVmExitAndHaltSystemAllCores </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>vm-exit and halt the system </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Dpc</td><td></td></tr>
    <tr><td class="paramname">DeferredContext</td><td></td></tr>
    <tr><td class="paramname">SystemArgument1</td><td></td></tr>
    <tr><td class="paramname">SystemArgument2</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  262</span>{</div>
<div class="line"><span class="lineno">  263</span>    UNREFERENCED_PARAMETER(Dpc);</div>
<div class="line"><span class="lineno">  264</span>    UNREFERENCED_PARAMETER(DeferredContext);</div>
<div class="line"><span class="lineno">  265</span> </div>
<div class="line"><span class="lineno">  266</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  267</span>    <span class="comment">// vm-exit and halt current core</span></div>
<div class="line"><span class="lineno">  268</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  269</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ab2e385f36ad04e1650c3855007a91b98">VmFuncVmxVmcall</a>(<a class="code hl_define" href="_debugger_vmcalls_8h.html#a995b2bb03835e5c569e4ea3fca385d9a">DEBUGGER_VMCALL_VM_EXIT_HALT_SYSTEM</a>, 0, 0, 0);</div>
<div class="line"><span class="lineno">  270</span> </div>
<div class="line"><span class="lineno">  271</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  272</span>    <span class="comment">// Wait for all DPCs to synchronize at this point</span></div>
<div class="line"><span class="lineno">  273</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  274</span>    KeSignalCallDpcSynchronize(SystemArgument2);</div>
<div class="line"><span class="lineno">  275</span> </div>
<div class="line"><span class="lineno">  276</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  277</span>    <span class="comment">// Mark the DPC as being complete</span></div>
<div class="line"><span class="lineno">  278</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  279</span>    KeSignalCallDpcDone(SystemArgument1);</div>
<div class="line"><span class="lineno">  280</span>}</div>
<div class="ttc" id="a_debugger_vmcalls_8h_html_a995b2bb03835e5c569e4ea3fca385d9a"><div class="ttname"><a href="_debugger_vmcalls_8h.html#a995b2bb03835e5c569e4ea3fca385d9a">DEBUGGER_VMCALL_VM_EXIT_HALT_SYSTEM</a></div><div class="ttdeci">#define DEBUGGER_VMCALL_VM_EXIT_HALT_SYSTEM</div><div class="ttdoc">VMCALL to cause vm-exit and halt the system.</div><div class="ttdef"><b>Definition:</b> DebuggerVmcalls.h:22</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_ab2e385f36ad04e1650c3855007a91b98"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ab2e385f36ad04e1650c3855007a91b98">VmFuncVmxVmcall</a></div><div class="ttdeci">IMPORT_EXPORT_VMM NTSTATUS VmFuncVmxVmcall(unsigned long long VmcallNumber, unsigned long long OptionalParam1, unsigned long long OptionalParam2, long long OptionalParam3)</div><div class="ttdoc">Export for running VMX VMCALLs.</div><div class="ttdef"><b>Definition:</b> Export.c:561</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ac9051976c97907c7b77703fd5b8d5a79" name="ac9051976c97907c7b77703fd5b8d5a79"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac9051976c97907c7b77703fd5b8d5a79">&#9670;&#160;</a></span>DpcRoutineWriteMsrToAllCores()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> DpcRoutineWriteMsrToAllCores </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast Msr Write. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Dpc</td><td></td></tr>
    <tr><td class="paramname">DeferredContext</td><td></td></tr>
    <tr><td class="paramname">SystemArgument1</td><td></td></tr>
    <tr><td class="paramname">SystemArgument2</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  194</span>{</div>
<div class="line"><span class="lineno">  195</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                       CurrentCore           = KeGetCurrentProcessorNumber();</div>
<div class="line"><span class="lineno">  196</span>    <a class="code hl_struct" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html">PROCESSOR_DEBUGGING_STATE</a> * CurrentDebuggingState = &amp;<a class="code hl_variable" href="hprdbgkd_2header_2globals_2_global_8h.html#a349ee1adc363d2e4323a35a68fae5646">g_DbgState</a>[CurrentCore];</div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span>    UNREFERENCED_PARAMETER(Dpc);</div>
<div class="line"><span class="lineno">  199</span>    UNREFERENCED_PARAMETER(DeferredContext);</div>
<div class="line"><span class="lineno">  200</span> </div>
<div class="line"><span class="lineno">  201</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  202</span>    <span class="comment">// write on MSR</span></div>
<div class="line"><span class="lineno">  203</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  204</span>    __writemsr(CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#a3ca94b81f31339286eaa6f27eea5804e">Msr</a>, CurrentDebuggingState-&gt;<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code hl_variable" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a>);</div>
<div class="line"><span class="lineno">  205</span> </div>
<div class="line"><span class="lineno">  206</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  207</span>    <span class="comment">// Wait for all DPCs to synchronize at this point</span></div>
<div class="line"><span class="lineno">  208</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  209</span>    KeSignalCallDpcSynchronize(SystemArgument2);</div>
<div class="line"><span class="lineno">  210</span> </div>
<div class="line"><span class="lineno">  211</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  212</span>    <span class="comment">// Mark the DPC as being complete</span></div>
<div class="line"><span class="lineno">  213</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  214</span>    KeSignalCallDpcDone(SystemArgument1);</div>
<div class="line"><span class="lineno">  215</span>}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad770b621bcb6287f068300a85ba36233" name="ad770b621bcb6287f068300a85ba36233"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad770b621bcb6287f068300a85ba36233">&#9670;&#160;</a></span>OneCoreLock</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile LONG OneCoreLock</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>lock for one core execution </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_0f75a8685de99980df6b10136f072ea3.html">hprdbgkd</a></li><li class="navelem"><a class="el" href="dir_8e142ed2124cfd6519cf774281966718.html">code</a></li><li class="navelem"><a class="el" href="dir_61d6e265fea93d5a6058493e98d880a4.html">debugger</a></li><li class="navelem"><a class="el" href="dir_304e5451fc60d541d3f52683c1462f5b.html">broadcast</a></li><li class="navelem"><a class="el" href="hprdbgkd_2code_2debugger_2broadcast_2_dpc_routines_8c.html">DpcRoutines.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
