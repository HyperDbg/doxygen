<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg Debugger: hyperdbg/hprdbghv/header/debugger/features/Hooks.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HyperDbg Debugger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_hooks_8h.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Hooks.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Hook headers.  
<a href="#details">More...</a></p>

<p><a href="_hooks_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___s_s_d_t_struct.html">_SSDTStruct</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">SSDT structure.  <a href="struct___s_s_d_t_struct.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___e_n_t_r_y.html">_SYSTEM_MODULE_ENTRY</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___i_n_f_o_r_m_a_t_i_o_n.html">_SYSTEM_MODULE_INFORMATION</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a2633e7e4b97712c8a9924648d48b63f6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a2633e7e4b97712c8a9924648d48b63f6">IS_SYSRET_INSTRUCTION</a>(Code)</td></tr>
<tr class="memdesc:a2633e7e4b97712c8a9924648d48b63f6"><td class="mdescLeft">&#160;</td><td class="mdescRight">As we have just on sysret in all the Windows, we use the following variable to hold its address this way, we're not force to check for the instruction so we remove the memory access to check for sysret in this case.  <a href="_hooks_8h.html#a2633e7e4b97712c8a9924648d48b63f6">More...</a><br /></td></tr>
<tr class="separator:a2633e7e4b97712c8a9924648d48b63f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a765571d13192493adf4e7baa5a9e9468"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a765571d13192493adf4e7baa5a9e9468">IS_SYSCALL_INSTRUCTION</a>(Code)</td></tr>
<tr class="separator:a765571d13192493adf4e7baa5a9e9468"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acde26d24b0ff46215cbd029d8ae87e4d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#acde26d24b0ff46215cbd029d8ae87e4d">IMAGE_DOS_SIGNATURE</a>&#160;&#160;&#160;0x5A4D</td></tr>
<tr class="separator:acde26d24b0ff46215cbd029d8ae87e4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9d186034e0a154cfc3bcc5ec8e977564"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a9d186034e0a154cfc3bcc5ec8e977564">IMAGE_OS2_SIGNATURE</a>&#160;&#160;&#160;0x454E</td></tr>
<tr class="separator:a9d186034e0a154cfc3bcc5ec8e977564"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a41ddf3f83e5c119216c43a3cd98deba4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a41ddf3f83e5c119216c43a3cd98deba4">IMAGE_OS2_SIGNATURE_LE</a>&#160;&#160;&#160;0x454C</td></tr>
<tr class="separator:a41ddf3f83e5c119216c43a3cd98deba4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0d59e625e438a014184cfc9e892553c3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a0d59e625e438a014184cfc9e892553c3">IMAGE_VXD_SIGNATURE</a>&#160;&#160;&#160;0x454C</td></tr>
<tr class="separator:a0d59e625e438a014184cfc9e892553c3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a83570e3e2fba8cb7c2abc8b3eee47d48"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a83570e3e2fba8cb7c2abc8b3eee47d48">IMAGE_NT_SIGNATURE</a>&#160;&#160;&#160;0x00004550</td></tr>
<tr class="separator:a83570e3e2fba8cb7c2abc8b3eee47d48"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a7ef67836bf52e4d218108fb05855a5ee"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_s_d_t_struct.html">_SSDTStruct</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a7ef67836bf52e4d218108fb05855a5ee">SSDTStruct</a></td></tr>
<tr class="memdesc:a7ef67836bf52e4d218108fb05855a5ee"><td class="mdescLeft">&#160;</td><td class="mdescRight">SSDT structure.  <a href="_hooks_8h.html#a7ef67836bf52e4d218108fb05855a5ee">More...</a><br /></td></tr>
<tr class="separator:a7ef67836bf52e4d218108fb05855a5ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:affb3200da2e6d1088947739169dfcfba"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_s_d_t_struct.html">_SSDTStruct</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#affb3200da2e6d1088947739169dfcfba">PSSDTStruct</a></td></tr>
<tr class="separator:affb3200da2e6d1088947739169dfcfba"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afca3bba3357dab1c3380e4b9772f04da"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#afca3bba3357dab1c3380e4b9772f04da">HIDDEN_HOOKS_DETOUR_DETAILS</a></td></tr>
<tr class="separator:afca3bba3357dab1c3380e4b9772f04da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0dd75bc2892ba7c908ee7f1da6f8c760"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a0dd75bc2892ba7c908ee7f1da6f8c760">PHIDDEN_HOOKS_DETOUR_DETAILS</a></td></tr>
<tr class="separator:a0dd75bc2892ba7c908ee7f1da6f8c760"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6874334f705ea54c18fe8e417b192bcf"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___e_n_t_r_y.html">_SYSTEM_MODULE_ENTRY</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a6874334f705ea54c18fe8e417b192bcf">SYSTEM_MODULE_ENTRY</a></td></tr>
<tr class="separator:a6874334f705ea54c18fe8e417b192bcf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a01b72f04cfe7a055417c2d21f548bb44"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___e_n_t_r_y.html">_SYSTEM_MODULE_ENTRY</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a01b72f04cfe7a055417c2d21f548bb44">PSYSTEM_MODULE_ENTRY</a></td></tr>
<tr class="separator:a01b72f04cfe7a055417c2d21f548bb44"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab544297b0d5c1d52d774046be13f483d"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___i_n_f_o_r_m_a_t_i_o_n.html">_SYSTEM_MODULE_INFORMATION</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ab544297b0d5c1d52d774046be13f483d">SYSTEM_MODULE_INFORMATION</a></td></tr>
<tr class="separator:ab544297b0d5c1d52d774046be13f483d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0f259ebddf952a9e0ccfa9c7e7693795"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___i_n_f_o_r_m_a_t_i_o_n.html">_SYSTEM_MODULE_INFORMATION</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a0f259ebddf952a9e0ccfa9c7e7693795">PSYSTEM_MODULE_INFORMATION</a></td></tr>
<tr class="separator:a0f259ebddf952a9e0ccfa9c7e7693795"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae75edb0a85f69b42a96960e023f58c47"><td class="memItemLeft" align="right" valign="top">typedef enum <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a></td></tr>
<tr class="separator:ae75edb0a85f69b42a96960e023f58c47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef74275b90a76319745df6047d624096"><td class="memItemLeft" align="right" valign="top">typedef enum <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#aef74275b90a76319745df6047d624096">PSYSTEM_INFORMATION_CLASS</a></td></tr>
<tr class="separator:aef74275b90a76319745df6047d624096"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a017811c2b939ab5a3ced279a946f990c"><td class="memItemLeft" align="right" valign="top">typedef NTSTATUS(NTAPI *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a017811c2b939ab5a3ced279a946f990c">ZWQUERYSYSTEMINFORMATION</a>) (IN <a class="el" href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a> SystemInformationClass, OUT PVOID SystemInformation, IN <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SystemInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>
<tr class="separator:a017811c2b939ab5a3ced279a946f990c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ad5d815b48e8f4da1ef2eb7a2f18a54e0"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a> { <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a38627594543f01525bf40aa8e09607bd">SystemModuleInformation</a> = 11
, <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a18e658a754e39d6e6c1b653248b8aa78">SystemKernelDebuggerInformation</a> = 35
 }</td></tr>
<tr class="separator:ad5d815b48e8f4da1ef2eb7a2f18a54e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a194622a3ba05a449923eb105cdb37405"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a194622a3ba05a449923eb105cdb37405">EptHookPerformPageHook</a> (PVOID TargetAddress, <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3)</td></tr>
<tr class="memdesc:a194622a3ba05a449923eb105cdb37405"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook in VMX Root Mode with hidden breakpoints (A pre-allocated buffer should be available)  <a href="_hooks_8h.html#a194622a3ba05a449923eb105cdb37405">More...</a><br /></td></tr>
<tr class="separator:a194622a3ba05a449923eb105cdb37405"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77e3785963c79b3ff0efdf13efe0be13"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a> (PVOID TargetAddress, PVOID HookFunction, <a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetRead, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetWrite, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetExecute)</td></tr>
<tr class="memdesc:a77e3785963c79b3ff0efdf13efe0be13"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook in VMX Root Mode with hidden detours and monitor (A pre-allocated buffer should be available)  <a href="_hooks_8h.html#a77e3785963c79b3ff0efdf13efe0be13">More...</a><br /></td></tr>
<tr class="separator:a77e3785963c79b3ff0efdf13efe0be13"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#abcbdb9cd3dbdf238b8b5d484522855e3">EptHook</a> (PVOID TargetAddress, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook in VMX Non Root Mode (hidden breakpoint)  <a href="_hooks_8h.html#abcbdb9cd3dbdf238b8b5d484522855e3">More...</a><br /></td></tr>
<tr class="separator:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c5eb45ffb3514149f329aeb0cf04071"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a3c5eb45ffb3514149f329aeb0cf04071">EptHook2</a> (PVOID TargetAddress, PVOID HookFunction, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForRead, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForWrite, <a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForExec)</td></tr>
<tr class="memdesc:a3c5eb45ffb3514149f329aeb0cf04071"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook in VMX Non Root Mode (hidden detours)  <a href="_hooks_8h.html#a3c5eb45ffb3514149f329aeb0cf04071">More...</a><br /></td></tr>
<tr class="separator:a3c5eb45ffb3514149f329aeb0cf04071"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a163596fcc88f51c8bfa4def02ac577a7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a163596fcc88f51c8bfa4def02ac577a7">EptHookHandleHookedPage</a> (<a class="el" href="_definition_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a> Regs, <a class="el" href="_ept_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *HookedEntryDetails, <a class="el" href="_ept_8h.html#af5532e409040fce4d11ed4f029f0b009">VMX_EXIT_QUALIFICATION_EPT_VIOLATION</a> ViolationQualification, SIZE_T PhysicalAddress)</td></tr>
<tr class="memdesc:a163596fcc88f51c8bfa4def02ac577a7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handle hooked pages in Vmx-root mode.  <a href="_hooks_8h.html#a163596fcc88f51c8bfa4def02ac577a7">More...</a><br /></td></tr>
<tr class="separator:a163596fcc88f51c8bfa4def02ac577a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba59e4d31f5cf37d9436d73933e8158c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#aba59e4d31f5cf37d9436d73933e8158c">EptHookRestoreSingleHookToOrginalEntry</a> (SIZE_T PhysicalAddress)</td></tr>
<tr class="memdesc:aba59e4d31f5cf37d9436d73933e8158c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove a special hook from the hooked pages lists.  <a href="_hooks_8h.html#aba59e4d31f5cf37d9436d73933e8158c">More...</a><br /></td></tr>
<tr class="separator:aba59e4d31f5cf37d9436d73933e8158c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd59638727980bbd58fb4665ffce9091"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#acd59638727980bbd58fb4665ffce9091">EptHookRestoreAllHooksToOrginalEntry</a> ()</td></tr>
<tr class="memdesc:acd59638727980bbd58fb4665ffce9091"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all hooks from the hooked pages lists (Should be called in vmx-root)  <a href="_hooks_8h.html#acd59638727980bbd58fb4665ffce9091">More...</a><br /></td></tr>
<tr class="separator:acd59638727980bbd58fb4665ffce9091"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8845ca75f3b4c267d3542d20621f547"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ac8845ca75f3b4c267d3542d20621f547">EptHookUnHookAll</a> ()</td></tr>
<tr class="memdesc:ac8845ca75f3b4c267d3542d20621f547"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all hooks from the hooked pages lists.  <a href="_hooks_8h.html#ac8845ca75f3b4c267d3542d20621f547">More...</a><br /></td></tr>
<tr class="separator:ac8845ca75f3b4c267d3542d20621f547"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad1e9c3160ff8af6421fcfd6942dcad2e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ad1e9c3160ff8af6421fcfd6942dcad2e">EptHookUnHookSingleAddress</a> (<a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:ad1e9c3160ff8af6421fcfd6942dcad2e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages list and invalidate TLB.  <a href="_hooks_8h.html#ad1e9c3160ff8af6421fcfd6942dcad2e">More...</a><br /></td></tr>
<tr class="separator:ad1e9c3160ff8af6421fcfd6942dcad2e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd0179b7c5730f636141dfea2afcdc5a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a> (<a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsEptHook2)</td></tr>
<tr class="memdesc:acd0179b7c5730f636141dfea2afcdc5a"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the length of active EPT hooks (!epthook and !epthook2)  <a href="_hooks_8h.html#acd0179b7c5730f636141dfea2afcdc5a">More...</a><br /></td></tr>
<tr class="separator:acd0179b7c5730f636141dfea2afcdc5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acac4eff03b2197ae43e4c13f382e20b5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a> (<a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> Address)</td></tr>
<tr class="memdesc:acac4eff03b2197ae43e4c13f382e20b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove an entry from g_EptHook2sDetourListHead.  <a href="_hooks_8h.html#acac4eff03b2197ae43e4c13f382e20b5">More...</a><br /></td></tr>
<tr class="separator:acac4eff03b2197ae43e4c13f382e20b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a74bc6881ecc918d83da9c92e3b2bcc04"><td class="memItemLeft" align="right" valign="top">PHANDLE&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a74bc6881ecc918d83da9c92e3b2bcc04">FileHandle</a></td></tr>
<tr class="separator:a74bc6881ecc918d83da9c92e3b2bcc04"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac648ae3c24d5148a8ef42128d6bab501"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ac648ae3c24d5148a8ef42128d6bab501">DesiredAccess</a></td></tr>
<tr class="separator:ac648ae3c24d5148a8ef42128d6bab501"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22e2a9ce1ada928965365e448fd91e10"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a22e2a9ce1ada928965365e448fd91e10">ObjectAttributes</a></td></tr>
<tr class="separator:a22e2a9ce1ada928965365e448fd91e10"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24ff958436c219a33ff5b86019874568"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a24ff958436c219a33ff5b86019874568">IoStatusBlock</a></td></tr>
<tr class="separator:a24ff958436c219a33ff5b86019874568"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a708148b18a52f70ef6c1e92504f29e92"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a708148b18a52f70ef6c1e92504f29e92">AllocationSize</a></td></tr>
<tr class="separator:a708148b18a52f70ef6c1e92504f29e92"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a54b337d004f8bae1638fab9180d83d08"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a54b337d004f8bae1638fab9180d83d08">FileAttributes</a></td></tr>
<tr class="separator:a54b337d004f8bae1638fab9180d83d08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9ae311c2ebc03cc38ee69edaac2f6e12"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a9ae311c2ebc03cc38ee69edaac2f6e12">ShareAccess</a></td></tr>
<tr class="separator:a9ae311c2ebc03cc38ee69edaac2f6e12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab40749908b174e4a58a46b6bb9a8899f"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ab40749908b174e4a58a46b6bb9a8899f">CreateDisposition</a></td></tr>
<tr class="separator:ab40749908b174e4a58a46b6bb9a8899f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad07b47eb97df97ce6120a6ff17e9c6e2"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#ad07b47eb97df97ce6120a6ff17e9c6e2">CreateOptions</a></td></tr>
<tr class="separator:ad07b47eb97df97ce6120a6ff17e9c6e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e7d4ea496b0d33e07d6813b22aac212"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> PVOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a9e7d4ea496b0d33e07d6813b22aac212">EaBuffer</a></td></tr>
<tr class="separator:a9e7d4ea496b0d33e07d6813b22aac212"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec301946a43309ef0f6da81995361efb"><td class="memItemLeft" align="right" valign="top">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> PVOID <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#aec301946a43309ef0f6da81995361efb">EaLength</a></td></tr>
<tr class="separator:aec301946a43309ef0f6da81995361efb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d405dff9ba7e6c73d78857f415965f4"><td class="memItemLeft" align="right" valign="top">POOL_TYPE&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a></td></tr>
<tr class="separator:a5d405dff9ba7e6c73d78857f415965f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a61083d5dde730c2afd10a336322aaaac"><td class="memItemLeft" align="right" valign="top">POOL_TYPE SIZE_T&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a></td></tr>
<tr class="separator:a61083d5dde730c2afd10a336322aaaac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba7c9f3767dcc5232354d3d17ceedb61"><td class="memItemLeft" align="right" valign="top">POOL_TYPE SIZE_T <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a></td></tr>
<tr class="separator:aba7c9f3767dcc5232354d3d17ceedb61"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Hook headers. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'ray'+'an'+'fam'+'.c'+'om'; return false;">sina@<span style="display: none;">.nosp@m.</span>raya<span style="display: none;">.nosp@m.</span>nfam.<span style="display: none;">.nosp@m.</span>com</a>)</dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-11</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="acde26d24b0ff46215cbd029d8ae87e4d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acde26d24b0ff46215cbd029d8ae87e4d">&#9670;&nbsp;</a></span>IMAGE_DOS_SIGNATURE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IMAGE_DOS_SIGNATURE&#160;&#160;&#160;0x5A4D</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a83570e3e2fba8cb7c2abc8b3eee47d48"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a83570e3e2fba8cb7c2abc8b3eee47d48">&#9670;&nbsp;</a></span>IMAGE_NT_SIGNATURE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IMAGE_NT_SIGNATURE&#160;&#160;&#160;0x00004550</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9d186034e0a154cfc3bcc5ec8e977564"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9d186034e0a154cfc3bcc5ec8e977564">&#9670;&nbsp;</a></span>IMAGE_OS2_SIGNATURE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IMAGE_OS2_SIGNATURE&#160;&#160;&#160;0x454E</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a41ddf3f83e5c119216c43a3cd98deba4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a41ddf3f83e5c119216c43a3cd98deba4">&#9670;&nbsp;</a></span>IMAGE_OS2_SIGNATURE_LE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IMAGE_OS2_SIGNATURE_LE&#160;&#160;&#160;0x454C</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0d59e625e438a014184cfc9e892553c3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0d59e625e438a014184cfc9e892553c3">&#9670;&nbsp;</a></span>IMAGE_VXD_SIGNATURE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IMAGE_VXD_SIGNATURE&#160;&#160;&#160;0x454C</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a765571d13192493adf4e7baa5a9e9468"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a765571d13192493adf4e7baa5a9e9468">&#9670;&nbsp;</a></span>IS_SYSCALL_INSTRUCTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IS_SYSCALL_INSTRUCTION</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">Code</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    (*((<a class="code" href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a>)(Code) + 0) == 0x0F &amp;&amp; \</div>
<div class="line">     *((<a class="code" href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a>)(Code) + 1) == 0x05)</div>
<div class="ttc" id="a_script_engine_eval_8h_html_a02fb353482a88d8a031abe77a38375ea"><div class="ttname"><a href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a></div><div class="ttdeci">unsigned char * PUINT8</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:87</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2633e7e4b97712c8a9924648d48b63f6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2633e7e4b97712c8a9924648d48b63f6">&#9670;&nbsp;</a></span>IS_SYSRET_INSTRUCTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define IS_SYSRET_INSTRUCTION</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">Code</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    (*((<a class="code" href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a>)(Code) + 0) == 0x48 &amp;&amp; \</div>
<div class="line">     *((<a class="code" href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a>)(Code) + 1) == 0x0F &amp;&amp; \</div>
<div class="line">     *((<a class="code" href="_script_engine_eval_8h.html#a02fb353482a88d8a031abe77a38375ea">PUINT8</a>)(Code) + 2) == 0x07)</div>
</div><!-- fragment -->
<p>As we have just on sysret in all the Windows, we use the following variable to hold its address this way, we're not force to check for the instruction so we remove the memory access to check for sysret in this case. </p>
<p>Check for instruction sysret and syscall </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="afca3bba3357dab1c3380e4b9772f04da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afca3bba3357dab1c3380e4b9772f04da">&#9670;&nbsp;</a></span>HIDDEN_HOOKS_DETOUR_DETAILS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a> <a class="el" href="_hooks_8h.html#afca3bba3357dab1c3380e4b9772f04da">HIDDEN_HOOKS_DETOUR_DETAILS</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0dd75bc2892ba7c908ee7f1da6f8c760"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0dd75bc2892ba7c908ee7f1da6f8c760">&#9670;&nbsp;</a></span>PHIDDEN_HOOKS_DETOUR_DETAILS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a> * <a class="el" href="_hooks_8h.html#a0dd75bc2892ba7c908ee7f1da6f8c760">PHIDDEN_HOOKS_DETOUR_DETAILS</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="affb3200da2e6d1088947739169dfcfba"></a>
<h2 class="memtitle"><span class="permalink"><a href="#affb3200da2e6d1088947739169dfcfba">&#9670;&nbsp;</a></span>PSSDTStruct</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_s_d_t_struct.html">_SSDTStruct</a> * <a class="el" href="_hooks_8h.html#affb3200da2e6d1088947739169dfcfba">PSSDTStruct</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aef74275b90a76319745df6047d624096"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aef74275b90a76319745df6047d624096">&#9670;&nbsp;</a></span>PSYSTEM_INFORMATION_CLASS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef enum <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a>
    * <a class="el" href="_hooks_8h.html#aef74275b90a76319745df6047d624096">PSYSTEM_INFORMATION_CLASS</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a01b72f04cfe7a055417c2d21f548bb44"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01b72f04cfe7a055417c2d21f548bb44">&#9670;&nbsp;</a></span>PSYSTEM_MODULE_ENTRY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___e_n_t_r_y.html">_SYSTEM_MODULE_ENTRY</a> * <a class="el" href="_hooks_8h.html#a01b72f04cfe7a055417c2d21f548bb44">PSYSTEM_MODULE_ENTRY</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0f259ebddf952a9e0ccfa9c7e7693795"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0f259ebddf952a9e0ccfa9c7e7693795">&#9670;&nbsp;</a></span>PSYSTEM_MODULE_INFORMATION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___i_n_f_o_r_m_a_t_i_o_n.html">_SYSTEM_MODULE_INFORMATION</a> * <a class="el" href="_hooks_8h.html#a0f259ebddf952a9e0ccfa9c7e7693795">PSYSTEM_MODULE_INFORMATION</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a7ef67836bf52e4d218108fb05855a5ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7ef67836bf52e4d218108fb05855a5ee">&#9670;&nbsp;</a></span>SSDTStruct</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_s_d_t_struct.html">_SSDTStruct</a> <a class="el" href="_hooks_8h.html#a7ef67836bf52e4d218108fb05855a5ee">SSDTStruct</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>SSDT structure. </p>

</div>
</div>
<a id="ae75edb0a85f69b42a96960e023f58c47"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae75edb0a85f69b42a96960e023f58c47">&#9670;&nbsp;</a></span>SYSTEM_INFORMATION_CLASS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef enum <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a> <a class="el" href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a6874334f705ea54c18fe8e417b192bcf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6874334f705ea54c18fe8e417b192bcf">&#9670;&nbsp;</a></span>SYSTEM_MODULE_ENTRY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___e_n_t_r_y.html">_SYSTEM_MODULE_ENTRY</a> <a class="el" href="_hooks_8h.html#a6874334f705ea54c18fe8e417b192bcf">SYSTEM_MODULE_ENTRY</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab544297b0d5c1d52d774046be13f483d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab544297b0d5c1d52d774046be13f483d">&#9670;&nbsp;</a></span>SYSTEM_MODULE_INFORMATION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct___s_y_s_t_e_m___m_o_d_u_l_e___i_n_f_o_r_m_a_t_i_o_n.html">_SYSTEM_MODULE_INFORMATION</a> <a class="el" href="_hooks_8h.html#ab544297b0d5c1d52d774046be13f483d">SYSTEM_MODULE_INFORMATION</a></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a017811c2b939ab5a3ced279a946f990c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a017811c2b939ab5a3ced279a946f990c">&#9670;&nbsp;</a></span>ZWQUERYSYSTEMINFORMATION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef NTSTATUS(NTAPI * ZWQUERYSYSTEMINFORMATION) (IN <a class="el" href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a> SystemInformationClass, OUT PVOID SystemInformation, IN <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> SystemInformationLength, OUT PULONG ReturnLength OPTIONAL)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ad5d815b48e8f4da1ef2eb7a2f18a54e0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad5d815b48e8f4da1ef2eb7a2f18a54e0">&#9670;&nbsp;</a></span>_SYSTEM_INFORMATION_CLASS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0">_SYSTEM_INFORMATION_CLASS</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="ad5d815b48e8f4da1ef2eb7a2f18a54e0a38627594543f01525bf40aa8e09607bd"></a>SystemModuleInformation&#160;</td><td class="fielddoc"></td></tr>
<tr><td class="fieldname"><a id="ad5d815b48e8f4da1ef2eb7a2f18a54e0a18e658a754e39d6e6c1b653248b8aa78"></a>SystemKernelDebuggerInformation&#160;</td><td class="fielddoc"></td></tr>
</table>
<div class="fragment"><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;{</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <a class="code" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a38627594543f01525bf40aa8e09607bd">SystemModuleInformation</a>         = 11,</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a18e658a754e39d6e6c1b653248b8aa78">SystemKernelDebuggerInformation</a> = 35</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;} <a class="code" href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a>,</div>
<div class="ttc" id="a_hooks_8h_html_ad5d815b48e8f4da1ef2eb7a2f18a54e0a18e658a754e39d6e6c1b653248b8aa78"><div class="ttname"><a href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a18e658a754e39d6e6c1b653248b8aa78">SystemKernelDebuggerInformation</a></div><div class="ttdeci">@ SystemKernelDebuggerInformation</div><div class="ttdef"><b>Definition:</b> Hooks.h:96</div></div>
<div class="ttc" id="a_hooks_8h_html_ad5d815b48e8f4da1ef2eb7a2f18a54e0a38627594543f01525bf40aa8e09607bd"><div class="ttname"><a href="_hooks_8h.html#ad5d815b48e8f4da1ef2eb7a2f18a54e0a38627594543f01525bf40aa8e09607bd">SystemModuleInformation</a></div><div class="ttdeci">@ SystemModuleInformation</div><div class="ttdef"><b>Definition:</b> Hooks.h:95</div></div>
<div class="ttc" id="a_hooks_8h_html_ae75edb0a85f69b42a96960e023f58c47"><div class="ttname"><a href="_hooks_8h.html#ae75edb0a85f69b42a96960e023f58c47">SYSTEM_INFORMATION_CLASS</a></div><div class="ttdeci">enum _SYSTEM_INFORMATION_CLASS SYSTEM_INFORMATION_CLASS</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="abcbdb9cd3dbdf238b8b5d484522855e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abcbdb9cd3dbdf238b8b5d484522855e3">&#9670;&nbsp;</a></span>EptHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHook </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook in VMX Non Root Mode (hidden breakpoint) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
    <tr><td class="paramname">ProcessId</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Hook in VMX Non Root Mode (hidden breakpoint)</p>
<p>this command uses hidden breakpoints (0xcc) to hook, THIS FUNCTION SHOULD BE CALLED WHEN THE VMLAUNCH ALREADY EXECUTED, it is because, broadcasting to enable exception bitmap for breakpoint is not clear here, if we want to broadcast to enable exception bitmaps on all cores when vmlaunch is not executed then that's ok but a user might call this function when we didn't configure the vmcs, it's a problem! we can solve it by giving a hint to vmcs configure function to make it ok for future configuration but that sounds stupid, I think it's better to not support this feature. Btw, debugger won't use this function in the above mentioned method, so we won't have any problem with this :)</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successfull or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;{</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPageDetail;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   LogicalCoreIndex;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="comment">// Check whether we are in VMX Root Mode or Not</span></div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    LogicalCoreIndex = KeGetCurrentProcessorIndex();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160; </div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    {</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="comment">// Broadcast to all cores to enable vm-exit for breakpoints (exception bitmaps)</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        <a class="code" href="_broadcast_8c.html#ad3f6212e75c6a7fa25e423c71d9dc1d9">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; </div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code" href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a>, TargetAddress, <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a8380f037985bc787fd303aba07526379">GetCr3FromProcessId</a>(ProcessId).Flags, <a class="code" href="_gdb_stub_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == STATUS_SUCCESS)</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        {</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Hidden breakpoint hook applied from VMX Root Mode&quot;</span>);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].IsOnVmxRootMode)</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            {</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                <a class="code" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            }</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            {</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, unable to notify all cores to invalidate their TLB caches as you called hook on vmx-root mode&quot;</span>);</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            }</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160; </div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="comment">// We won&#39;t support this type of breakpoint when VMLAUNCH is not executed</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="comment">// take a look at &quot;details&quot; about the function to see why we decide to not</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;        <span class="comment">// support this feature.</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div>
<div class="ttc" id="a_broadcast_8c_html_a5be99a073a6003a06347aa85b832060f"><div class="ttname"><a href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a></div><div class="ttdeci">VOID BroadcastNotifyAllToInvalidateEptAllCores()</div><div class="ttdoc">routines to notify to invalidate their ept on all cores</div><div class="ttdef"><b>Definition:</b> Broadcast.c:119</div></div>
<div class="ttc" id="a_broadcast_8c_html_ad3f6212e75c6a7fa25e423c71d9dc1d9"><div class="ttname"><a href="_broadcast_8c.html#ad3f6212e75c6a7fa25e423c71d9dc1d9">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">VOID BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to enable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition:</b> Broadcast.c:63</div></div>
<div class="ttc" id="a_gdb_stub_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="_gdb_stub_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> GdbStub.h:33</div></div>
<div class="ttc" id="a_global_variables_8h_html_a04bac1f4beef0dcf1ce1a4d9ce72ea76"><div class="ttname"><a href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a></div><div class="ttdeci">VIRTUAL_MACHINE_STATE * g_GuestState</div><div class="ttdoc">Save the state and variables related to each to logical core.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:25</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a0fd87b88c03b3c10883f0ad70239bf6c"><div class="ttname"><a href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a></div><div class="ttdeci">NTSTATUS AsmVmxVmcall(unsigned long long VmcallNumber, unsigned long long OptionalParam1, unsigned long long OptionalParam2, long long OptionalParam3)</div><div class="ttdoc">Request Vmcall.</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:93</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:92</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:78</div></div>
<div class="ttc" id="a_vmcall_8h_html_aa23cf4e06f34a78d1efc1049c0c7c9a3"><div class="ttname"><a href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a></div><div class="ttdeci">#define VMCALL_SET_HIDDEN_CC_BREAKPOINT</div><div class="ttdoc">VMCALL to put hidden breakpoints (using EPT)</div><div class="ttdef"><b>Definition:</b> Vmcall.h:124</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a8380f037985bc787fd303aba07526379"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a8380f037985bc787fd303aba07526379">GetCr3FromProcessId</a></div><div class="ttdeci">CR3_TYPE GetCr3FromProcessId(UINT32 ProcessId)</div><div class="ttdoc">Converts pid to kernel cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:128</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a108126279e46f4d46d25abe24da43fdc"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a></div><div class="ttdeci">#define LogDebugInfo(format,...)</div><div class="ttdoc">Log, initilize boot information and debug information.</div><div class="ttdef"><b>Definition:</b> Common.h:595</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a459b19922fecfbb9438dd56b66930d16"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a></div><div class="ttdeci">#define LogError(format,...)</div><div class="ttdoc">Log in the case of error.</div><div class="ttdef"><b>Definition:</b> Common.h:556</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">_EPT_HOOKED_PAGE_DETAIL</a></div><div class="ttdoc">Structure to save the state of each hooked pages.</div><div class="ttdef"><b>Definition:</b> Ept.h:1145</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3c5eb45ffb3514149f329aeb0cf04071"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3c5eb45ffb3514149f329aeb0cf04071">&#9670;&nbsp;</a></span>EptHook2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHook2 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>HookFunction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForRead</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForExec</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook in VMX Non Root Mode (hidden detours) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
    <tr><td class="paramname">HookFunction</td><td></td></tr>
    <tr><td class="paramname">ProcessId</td><td></td></tr>
    <tr><td class="paramname">SetHookForRead</td><td></td></tr>
    <tr><td class="paramname">SetHookForWrite</td><td></td></tr>
    <tr><td class="paramname">SetHookForExec</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Hook in VMX Non Root Mode (hidden detours)</p>
<p>this command uses hidden detours, this NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">SetHookForRead</td><td>Hook READ Access </td></tr>
    <tr><td class="paramname">SetHookForWrite</td><td>Hook WRITE Access </td></tr>
    <tr><td class="paramname">SetHookForExec</td><td>Hook EXECUTE Access </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successfull or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;{</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> PageHookMask = 0;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>  LogicalCoreIndex;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160; </div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="comment">// Check for the features to avoid EPT Violation problems</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="keywordflow">if</span> (SetHookForExec &amp;&amp; !<a class="code" href="_global_variables_8h.html#a736e99274485393b1d06f84a6ee4c03b">g_ExecuteOnlySupport</a>)</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    {</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="comment">// In the current design of hyperdbg we use execute-only pages to implement hidden hooks for exec page,</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        <span class="comment">// so your processor doesn&#39;t have this feature and you have to implment it in other ways :(</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    }</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160; </div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordflow">if</span> (SetHookForWrite &amp;&amp; !SetHookForRead)</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    {</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        <span class="comment">// The hidden hook with Write Enable and Read Disabled will cause EPT violation!</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    }</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160; </div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="comment">// Check whether we are in VMX Root Mode or Not</span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    LogicalCoreIndex = KeGetCurrentProcessorIndex();</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160; </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="keywordflow">if</span> (SetHookForRead)</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    {</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        PageHookMask |= <a class="code" href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a>;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    }</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="keywordflow">if</span> (SetHookForWrite)</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        PageHookMask |= <a class="code" href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a>;</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    }</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">if</span> (SetHookForExec)</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    {</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        PageHookMask |= <a class="code" href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a>;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    }</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160; </div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keywordflow">if</span> (PageHookMask == 0)</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    {</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="comment">// nothing to hook</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;    {</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="comment">// Move Attribute Mask to the upper 32 bits of the VMCALL Number</span></div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmcallNumber = ((<a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)PageHookMask) &lt;&lt; 32 | <a class="code" href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a>;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160; </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(VmcallNumber, TargetAddress, HookFunction, <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a8380f037985bc787fd303aba07526379">GetCr3FromProcessId</a>(ProcessId).<a class="code" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>) == STATUS_SUCCESS)</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        {</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;            <span class="comment">// Test log</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            <span class="comment">// LogInfo(&quot;Hook applied from VMX Root Mode&quot;);</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160; </div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].IsOnVmxRootMode)</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;            {</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                <a class="code" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;            }</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            {</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Err, unable to notify all cores to invalidate their TLB caches as you called hook on vmx-root mode, however, the hook is still works&quot;</span>);</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            }</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        }</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    }</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    {</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="_ept_hook_8c.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a>(TargetAddress, HookFunction, <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a8380f037985bc787fd303aba07526379">GetCr3FromProcessId</a>(ProcessId), SetHookForRead, SetHookForWrite, SetHookForExec) == <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;        {</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Hook applied (VM has not launched)&quot;</span>);</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        }</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    }</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160; </div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="comment">// There was a error, we shouldn&#39;t reach here</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a>(<span class="stringliteral">&quot;Err, hook was not applied&quot;</span>);</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160; </div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;}</div>
<div class="ttc" id="a_ept_8h_html_a31b07aec49a907dc08696d9595c08e5f"><div class="ttname"><a href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a></div><div class="ttdeci">#define PAGE_ATTRIB_EXEC</div><div class="ttdef"><b>Definition:</b> Ept.h:71</div></div>
<div class="ttc" id="a_ept_8h_html_a57f919b94c67edb76b752a2ca83b534a"><div class="ttname"><a href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a></div><div class="ttdeci">#define PAGE_ATTRIB_READ</div><div class="ttdoc">Page attributes for internal use.</div><div class="ttdef"><b>Definition:</b> Ept.h:69</div></div>
<div class="ttc" id="a_ept_8h_html_a6a23c222f617b62cc621b5482a378d8a"><div class="ttname"><a href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a></div><div class="ttdeci">#define PAGE_ATTRIB_WRITE</div><div class="ttdef"><b>Definition:</b> Ept.h:70</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a77e3785963c79b3ff0efdf13efe0be13"><div class="ttname"><a href="_ept_hook_8c.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a></div><div class="ttdeci">BOOLEAN EptHookPerformPageHook2(PVOID TargetAddress, PVOID HookFunction, CR3_TYPE ProcessCr3, BOOLEAN UnsetRead, BOOLEAN UnsetWrite, BOOLEAN UnsetExecute)</div><div class="ttdoc">The main function that performs EPT page hook with hidden detours and monitor.</div><div class="ttdef"><b>Definition:</b> EptHook.c:712</div></div>
<div class="ttc" id="a_global_variables_8h_html_a736e99274485393b1d06f84a6ee4c03b"><div class="ttname"><a href="_global_variables_8h.html#a736e99274485393b1d06f84a6ee4c03b">g_ExecuteOnlySupport</a></div><div class="ttdeci">BOOLEAN g_ExecuteOnlySupport</div><div class="ttdoc">Support for execute-only pages (indicating that data accesses are not allowed while instruction fetch...</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:56</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:62</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:89</div></div>
<div class="ttc" id="a_vmcall_8h_html_a2f893b27a9a2cedec9f4c499011dce0a"><div class="ttname"><a href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a></div><div class="ttdeci">#define VMCALL_CHANGE_PAGE_ATTRIB</div><div class="ttdoc">VMCALL to Hook Change the attribute bits of the EPT Table.</div><div class="ttdef"><b>Definition:</b> Vmcall.h:34</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a97b0adbd65790fb90734daa8e5245a04"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a></div><div class="ttdeci">#define LogInfo(format,...)</div><div class="ttdoc">Define log variables.</div><div class="ttdef"><b>Definition:</b> Common.h:517</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_abf506c814a6f717a87b5d808b828ef56"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a></div><div class="ttdeci">#define LogWarning(format,...)</div><div class="ttdoc">Log in the case of warning.</div><div class="ttdef"><b>Definition:</b> Common.h:543</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html_a04eb96cc99b0458be739bcc9c640e08b"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">_CR3_TYPE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> MemoryMapper.h:290</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acd0179b7c5730f636141dfea2afcdc5a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd0179b7c5730f636141dfea2afcdc5a">&#9670;&nbsp;</a></span>EptHookGetCountOfEpthooks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> EptHookGetCountOfEpthooks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>IsEptHook2</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the length of active EPT hooks (!epthook and !epthook2) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname"></td><td></td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;{</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>      Count    = 0;</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160; </div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    {</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        TempList                            = TempList-&gt;Flink;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160; </div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        <span class="keywordflow">if</span> (IsEptHook2)</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;        {</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;            <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">IsHiddenBreakpoint</a> == <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;            {</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                Count++;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;            }</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        }</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        {</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;            <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">IsHiddenBreakpoint</a> == <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;            {</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                Count++;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;            }</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;        }</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    }</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160; </div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="keywordflow">return</span> Count;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;}</div>
<div class="ttc" id="a_global_variables_8h_html_a302f00c62e7ad092a9f44a3aa7452d99"><div class="ttname"><a href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a></div><div class="ttdeci">EPT_STATE * g_EptState</div><div class="ttdoc">Save the state and variables related to EPT.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:31</div></div>
<div class="ttc" id="alist_8h_html_adec42d53dc3b3e16ab7a1cd98af1c5fc"><div class="ttname"><a href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a></div><div class="ttdeci">#define CONTAINING_RECORD(address, type, field)</div><div class="ttdef"><b>Definition:</b> list.h:14</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a97690afae33315665d9d82ed19b7725c"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">_EPT_HOOKED_PAGE_DETAIL::IsHiddenBreakpoint</a></div><div class="ttdeci">BOOLEAN IsHiddenBreakpoint</div><div class="ttdoc">If TRUE shows that this is the information about a hidden breakpoint command (not a monitor or hidden...</div><div class="ttdef"><b>Definition:</b> Ept.h:1207</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a2503c5862b1bb2b779e2185b4097aa15"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">_EPT_STATE::HookedPagesList</a></div><div class="ttdeci">LIST_ENTRY HookedPagesList</div><div class="ttdef"><b>Definition:</b> Ept.h:992</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a163596fcc88f51c8bfa4def02ac577a7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a163596fcc88f51c8bfa4def02ac577a7">&#9670;&nbsp;</a></span>EptHookHandleHookedPage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookHandleHookedPage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_definition_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a>&#160;</td>
          <td class="paramname"><em>Regs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_ept_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *&#160;</td>
          <td class="paramname"><em>HookedEntryDetails</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_ept_8h.html#af5532e409040fce4d11ed4f029f0b009">VMX_EXIT_QUALIFICATION_EPT_VIOLATION</a>&#160;</td>
          <td class="paramname"><em>ViolationQualification</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handle hooked pages in Vmx-root mode. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Regs</td><td></td></tr>
    <tr><td class="paramname">HookedEntryDetails</td><td></td></tr>
    <tr><td class="paramname">ViolationQualification</td><td></td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Handle hooked pages in Vmx-root mode.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Regs</td><td>Guest registers </td></tr>
    <tr><td class="paramname">HookedEntryDetails</td><td>The entry that describes the hooked page </td></tr>
    <tr><td class="paramname">ViolationQualification</td><td>The exit qualification of vm-exit </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>The physical address that cause this vm-exit </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns TRUE if the function was hook was handled or returns false if there was an unexpected ept violation </dd></dl>
<div class="fragment"><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;{</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a879c8a1e8468389cf82a40cf0690bdce">ULONG64</a> GuestRip;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a879c8a1e8468389cf82a40cf0690bdce">ULONG64</a> ExactAccessedAddress;</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a879c8a1e8468389cf82a40cf0690bdce">ULONG64</a> AlignedVirtualAddress;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a879c8a1e8468389cf82a40cf0690bdce">ULONG64</a> AlignedPhysicalAddress;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160; </div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="comment">// Get alignment</span></div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    AlignedVirtualAddress  = PAGE_ALIGN(HookedEntryDetails-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    AlignedPhysicalAddress = PAGE_ALIGN(PhysicalAddress);</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160; </div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="comment">// Let&#39;s read the exact address that was accesses</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    ExactAccessedAddress = AlignedVirtualAddress + PhysicalAddress - AlignedPhysicalAddress;</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160; </div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="comment">// Reading guest&#39;s RIP</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    __vmx_vmread(<a class="code" href="_vmx_8h.html#a7ff71507e63e5659d2fc6db8b260d9e5a2d7dcf5269ce2d5e634c2838f41477a1">GUEST_RIP</a>, &amp;GuestRip);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160; </div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keywordflow">if</span> (!ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#ae38b7dfe829dd31b299fd12ca2596b55">EptExecutable</a> &amp;&amp; ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#af56db9966a5716c2884b356f126b8560">ExecuteAccess</a>)</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    {</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="comment">// Generally, we should never reach here, we didn&#39;t implement HyperDbg like this ;)</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, Guest RIP : 0x%llx tries to execute the page at : 0x%llx&quot;</span>, GuestRip, ExactAccessedAddress);</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    }</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#aea48209f8122001760173263fdbc0ab0">EptWriteable</a> &amp;&amp; ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#a4dcdebc6d19da0541124003fc9ff976a">WriteAccess</a>)</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    {</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        <span class="comment">// Test</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160; </div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to write on the page at :0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160; </div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        <span class="comment">// Trigger the event related to Monitor Write</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <a class="code" href="_debugger_8c.html#aac71ecf7a7e99662000efef060a32775">DebuggerTriggerEvents</a>(<a class="code" href="_definition_8h.html#ac90d8337845597671bc9d95b598591daaf0d6ee52cb6e4c9689dcec72c8ee25cb">HIDDEN_HOOK_WRITE</a>, Regs, PhysicalAddress);</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160; </div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="comment">// And also search the read/write event</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;        <a class="code" href="_debugger_8c.html#aac71ecf7a7e99662000efef060a32775">DebuggerTriggerEvents</a>(<a class="code" href="_definition_8h.html#ac90d8337845597671bc9d95b598591daad808743389ae088141be0ebec72d3e1f">HIDDEN_HOOK_READ_AND_WRITE</a>, Regs, PhysicalAddress);</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    }</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#aabb81beecc5328dcec40afd8e144d31d">EptReadable</a> &amp;&amp; ViolationQualification.<a class="code" href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#a06be5da0cde4a1bf129bcc270dcb031c">ReadAccess</a>)</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        <span class="comment">// Test</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160; </div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to read the page at :0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160; </div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        <span class="comment">// Trigger the event related to Monitor Read</span></div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        <a class="code" href="_debugger_8c.html#aac71ecf7a7e99662000efef060a32775">DebuggerTriggerEvents</a>(<a class="code" href="_definition_8h.html#ac90d8337845597671bc9d95b598591daae867265e725894418ee56eb70c167607">HIDDEN_HOOK_READ</a>, Regs, PhysicalAddress);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160; </div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <span class="comment">// And also search the read/write event</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <a class="code" href="_debugger_8c.html#aac71ecf7a7e99662000efef060a32775">DebuggerTriggerEvents</a>(<a class="code" href="_definition_8h.html#ac90d8337845597671bc9d95b598591daad808743389ae088141be0ebec72d3e1f">HIDDEN_HOOK_READ_AND_WRITE</a>, Regs, PhysicalAddress);</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    }</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    {</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        <span class="comment">// there was an unexpected ept violation</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    }</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160; </div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    <span class="comment">// Restore to its orginal entry for one instruction</span></div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <a class="code" href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a>(HookedEntryDetails-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a>, HookedEntryDetails-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>, <a class="code" href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a>);</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160; </div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    <span class="comment">// Means that restore the Entry to the previous state after current instruction executed in the guest</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;}</div>
<div class="ttc" id="a_debugger_8c_html_aac71ecf7a7e99662000efef060a32775"><div class="ttname"><a href="_debugger_8c.html#aac71ecf7a7e99662000efef060a32775">DebuggerTriggerEvents</a></div><div class="ttdeci">BOOLEAN DebuggerTriggerEvents(DEBUGGER_EVENT_TYPE_ENUM EventType, PGUEST_REGS Regs, PVOID Context)</div><div class="ttdoc">Trigger events of a special type to be managed by debugger.</div><div class="ttdef"><b>Definition:</b> Debugger.c:612</div></div>
<div class="ttc" id="a_definition_8h_html_ac90d8337845597671bc9d95b598591daad808743389ae088141be0ebec72d3e1f"><div class="ttname"><a href="_definition_8h.html#ac90d8337845597671bc9d95b598591daad808743389ae088141be0ebec72d3e1f">HIDDEN_HOOK_READ_AND_WRITE</a></div><div class="ttdeci">@ HIDDEN_HOOK_READ_AND_WRITE</div><div class="ttdef"><b>Definition:</b> Definition.h:452</div></div>
<div class="ttc" id="a_definition_8h_html_ac90d8337845597671bc9d95b598591daae867265e725894418ee56eb70c167607"><div class="ttname"><a href="_definition_8h.html#ac90d8337845597671bc9d95b598591daae867265e725894418ee56eb70c167607">HIDDEN_HOOK_READ</a></div><div class="ttdeci">@ HIDDEN_HOOK_READ</div><div class="ttdef"><b>Definition:</b> Definition.h:453</div></div>
<div class="ttc" id="a_definition_8h_html_ac90d8337845597671bc9d95b598591daaf0d6ee52cb6e4c9689dcec72c8ee25cb"><div class="ttname"><a href="_definition_8h.html#ac90d8337845597671bc9d95b598591daaf0d6ee52cb6e4c9689dcec72c8ee25cb">HIDDEN_HOOK_WRITE</a></div><div class="ttdeci">@ HIDDEN_HOOK_WRITE</div><div class="ttdef"><b>Definition:</b> Definition.h:454</div></div>
<div class="ttc" id="a_ept_8c_html_a08ea39deb301ed3051e6353a9692cecc"><div class="ttname"><a href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a></div><div class="ttdeci">VOID EptSetPML1AndInvalidateTLB(PEPT_PML1_ENTRY EntryAddress, EPT_PML1_ENTRY EntryValue, INVEPT_TYPE InvalidationType)</div><div class="ttdoc">This function set the specific PML1 entry in a spinlock protected area then invalidate the TLB.</div><div class="ttdef"><b>Definition:</b> Ept.c:827</div></div>
<div class="ttc" id="a_ept_8h_html_ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380"><div class="ttname"><a href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a></div><div class="ttdeci">@ INVEPT_SINGLE_CONTEXT</div><div class="ttdef"><b>Definition:</b> Ept.h:1239</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_a879c8a1e8468389cf82a40cf0690bdce"><div class="ttname"><a href="_script_engine_eval_8h.html#a879c8a1e8468389cf82a40cf0690bdce">ULONG64</a></div><div class="ttdeci">unsigned __int64 ULONG64</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:70</div></div>
<div class="ttc" id="a_vmx_8h_html_a7ff71507e63e5659d2fc6db8b260d9e5a2d7dcf5269ce2d5e634c2838f41477a1"><div class="ttname"><a href="_vmx_8h.html#a7ff71507e63e5659d2fc6db8b260d9e5a2d7dcf5269ce2d5e634c2838f41477a1">GUEST_RIP</a></div><div class="ttdeci">@ GUEST_RIP</div><div class="ttdef"><b>Definition:</b> Vmx.h:502</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a3464acbaf76a38d67558d8ff3bee342f"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">_EPT_HOOKED_PAGE_DETAIL::VirtualAddress</a></div><div class="ttdeci">UINT64 VirtualAddress</div><div class="ttdoc">The virtual address from the caller prespective view (cr3)</div><div class="ttdef"><b>Definition:</b> Ept.h:1157</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_ac7782253bd8fa0ff92bce2b0f5ff269d"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">_EPT_HOOKED_PAGE_DETAIL::EntryAddress</a></div><div class="ttdeci">PEPT_PML1_ENTRY EntryAddress</div><div class="ttdef"><b>Definition:</b> Ept.h:1180</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_acacf76428d2801be17ffb3e8b05e9374"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">_EPT_HOOKED_PAGE_DETAIL::OriginalEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY OriginalEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is removed from the page.</div><div class="ttdef"><b>Definition:</b> Ept.h:1186</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_a06be5da0cde4a1bf129bcc270dcb031c"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#a06be5da0cde4a1bf129bcc270dcb031c">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::ReadAccess</a></div><div class="ttdeci">UINT64 ReadAccess</div><div class="ttdoc">[Bit 0] Set if the access causing the EPT violation was a data read.</div><div class="ttdef"><b>Definition:</b> Ept.h:1046</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_a4dcdebc6d19da0541124003fc9ff976a"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#a4dcdebc6d19da0541124003fc9ff976a">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::WriteAccess</a></div><div class="ttdeci">UINT64 WriteAccess</div><div class="ttdoc">[Bit 1] Set if the access causing the EPT violation was a data write.</div><div class="ttdef"><b>Definition:</b> Ept.h:1051</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_aabb81beecc5328dcec40afd8e144d31d"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#aabb81beecc5328dcec40afd8e144d31d">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::EptReadable</a></div><div class="ttdeci">UINT64 EptReadable</div><div class="ttdoc">[Bit 3] The logical-AND of bit 0 in the EPT paging-structure entries used to translate the guest-phys...</div><div class="ttdef"><b>Definition:</b> Ept.h:1062</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_ae38b7dfe829dd31b299fd12ca2596b55"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#ae38b7dfe829dd31b299fd12ca2596b55">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::EptExecutable</a></div><div class="ttdeci">UINT64 EptExecutable</div><div class="ttdoc">[Bit 5] The logical-AND of bit 2 in the EPT paging-structure entries used to translate the guest-phys...</div><div class="ttdef"><b>Definition:</b> Ept.h:1077</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_aea48209f8122001760173263fdbc0ab0"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#aea48209f8122001760173263fdbc0ab0">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::EptWriteable</a></div><div class="ttdeci">UINT64 EptWriteable</div><div class="ttdoc">[Bit 4] The logical-AND of bit 1 in the EPT paging-structure entries used to translate the guest-phys...</div><div class="ttdef"><b>Definition:</b> Ept.h:1068</div></div>
<div class="ttc" id="aunion___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n_html_af56db9966a5716c2884b356f126b8560"><div class="ttname"><a href="union___v_m_x___e_x_i_t___q_u_a_l_i_f_i_c_a_t_i_o_n___e_p_t___v_i_o_l_a_t_i_o_n.html#af56db9966a5716c2884b356f126b8560">_VMX_EXIT_QUALIFICATION_EPT_VIOLATION::ExecuteAccess</a></div><div class="ttdeci">UINT64 ExecuteAccess</div><div class="ttdoc">[Bit 2] Set if the access causing the EPT violation was an instruction fetch.</div><div class="ttdef"><b>Definition:</b> Ept.h:1056</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a194622a3ba05a449923eb105cdb37405"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a194622a3ba05a449923eb105cdb37405">&#9670;&nbsp;</a></span>EptHookPerformPageHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHook </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>ProcessCr3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook in VMX Root Mode with hidden breakpoints (A pre-allocated buffer should be available) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
    <tr><td class="paramname">ProcessCr3</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Hook in VMX Root Mode with hidden breakpoints (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successfull or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;{</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <a class="code" href="union___e_p_t_e.html">EPT_PML1_ENTRY</a>          ChangedEntry;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <a class="code" href="struct___i_n_v_e_p_t___d_e_s_c_r_i_p_t_o_r.html">INVEPT_DESCRIPTOR</a>       Descriptor;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    SIZE_T                  PhysicalBaseAddress;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    PVOID                   VirtualTarget;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    PVOID                   TargetBuffer;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  TargetAddressInFakePageContent;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  PageOffset;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <a class="code" href="union___e_p_t_e.html">PEPT_PML1_ENTRY</a>         TargetPage;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPage;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   LogicalCoreIndex;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                Cr3OfCurrentProcess;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>                    OriginalByte;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry      = <a class="code" href="_gdb_stub_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>                 HookedEntryFound = <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    PLIST_ENTRY             TempList         = 0;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">// Check whether we are in VMX Root Mode or Not</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    LogicalCoreIndex = KeGetCurrentProcessorIndex();</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].IsOnVmxRootMode &amp;&amp; !<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    }</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">// virtual memory.</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    VirtualTarget = PAGE_ALIGN(TargetAddress);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="comment">// Find cr3 of target core</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    PhysicalBaseAddress = (SIZE_T)<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#aa257cde073bba99546f8edf56fd31661">VirtualAddressToPhysicalAddressByProcessCr3</a>(VirtualTarget, ProcessCr3);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    {</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, target address could not be mapped to physical memory&quot;</span>);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160; </div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        TempList    = TempList-&gt;Flink;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160; </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PhysicalBaseAddress)</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        {</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <span class="comment">// Means that we find the address</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            HookedEntryFound = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    }</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; </div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">// Check if this address is previously splitted and converted to a breakpoint structure or not</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">if</span> (HookedEntryFound &amp;&amp; HookedEntry)</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="comment">// Here we should add the breakpoint to previous breakpoint</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> &gt;= <a class="code" href="_ept_8h.html#a1bea5321e3bc6afd7a50e5208be94d74">MaximumHiddenBreakpointsOnPage</a>)</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        {</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="comment">// Means that breakpoint is full !</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="comment">// we can&#39;t apply this breakpoint</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160; </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="comment">// Apply the hook 0xcc</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;        <span class="comment">// Compute new offset of target offset into a safe bufferr</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="comment">// It will be used to compute the length of the detours</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="comment">// address because we might have a user mode code</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        TargetAddressInFakePageContent = &amp;HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        TargetAddressInFakePageContent = PAGE_ALIGN(TargetAddressInFakePageContent);</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        PageOffset                     = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(TargetAddress);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        TargetAddressInFakePageContent = TargetAddressInFakePageContent + PageOffset;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">// Read the original byte</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        OriginalByte = *(<a class="code" href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160; </div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;        <span class="comment">// Set the breakpoint on the fake page</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        *(<a class="code" href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent = 0xcc;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="comment">// Add target address to the list of breakpoints</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>] = TargetAddress;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160; </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="comment">// Save the original byte</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>] = OriginalByte;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        <span class="comment">// Add to the breakpoint counts</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> = HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> + 1;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    }</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="comment">// Set target buffer, request buffer from pool manager,</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="comment">// we also need to allocate new page to replace the current page ASAP</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        TargetBuffer = <a class="code" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code" href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>, <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>));</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">if</span> (!TargetBuffer)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, there is no pre-allocated buffer available&quot;</span>);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        }</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="_ept_8c.html#a0f232e4af9f1846e615420036d4b6c9a">EptSplitLargePage</a>(<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, TargetBuffer, PhysicalBaseAddress, LogicalCoreIndex))</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        {</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not split page for the address : 0x%llx&quot;</span>, PhysicalBaseAddress);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        TargetPage = <a class="code" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, PhysicalBaseAddress);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160; </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <span class="comment">// Ensure the target is valid</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keywordflow">if</span> (!TargetPage)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, failed to get PML1 entry of the target address&quot;</span>);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        <span class="comment">// Save the original permissions of the page</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        ChangedEntry = *TargetPage;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="comment">// Save the detail of hooked page to keep track of it</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        HookedPage = <a class="code" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code" href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>, <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>));</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <span class="keywordflow">if</span> (!HookedPage)</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, there is no pre-allocated pool for saving hooked page details&quot;</span>);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        }</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160; </div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="comment">// This is a hidden breakpoint</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">IsHiddenBreakpoint</a> = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="comment">// Save the virtual address</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a> = TargetAddress;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="comment">// Save the physical address</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> = PhysicalBaseAddress;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; </div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="comment">// Fake page content physical address</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a> = (SIZE_T)<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ae6bbd169187c6e08bbe584c67175a61d">VirtualAddressToPhysicalAddress</a>(&amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[0]) / PAGE_SIZE;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="comment">// Save the entry address</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a> = TargetPage;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; </div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;        <span class="comment">// Save the orginal entry</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a> = *TargetPage;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160; </div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        <span class="comment">// Show that entry has hidden hooks for execution</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">IsExecutionHook</a> = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        <span class="comment">// Save the address of (first) new breakpoint</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[0] = TargetAddress;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160; </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="comment">// Change the counter (set it to 1)</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> = 1;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160; </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="comment">// In execution hook, we have to make sure to unset read, write because</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="comment">// an EPT violation should occur for these cases and we can swap the original page</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#a49f1b43529360a2627349a72272e81f3">ReadAccess</a>    = 0;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#adb96c4aa485638e90dbedb0e6ec062c5">WriteAccess</a>   = 0;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#ac285d7271e994ee5a8ad0c5abef54ff6">ExecuteAccess</a> = 1;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        <span class="comment">// Also set the current pfn to fake page</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#aae366a4c1e246fb14bd1c63e3eef1589">PageFrameNumber</a> = HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a>;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160; </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <span class="comment">// Compute new offset of target offset into a safe bufferr</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        <span class="comment">// It will be used to compute the length of the detours</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="comment">// address because we might have a user mode code</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        TargetAddressInFakePageContent = &amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        TargetAddressInFakePageContent = PAGE_ALIGN(TargetAddressInFakePageContent);</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        PageOffset                     = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(TargetAddress);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        TargetAddressInFakePageContent = TargetAddressInFakePageContent + PageOffset;</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="comment">// Switch to target process</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        Cr3OfCurrentProcess = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a29100dd8ab15ffcb0ab1d030f195e821">SwitchOnAnotherProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160; </div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="comment">// Copy the content to the fake page</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="comment">// RtlCopyBytes(&amp;HookedPage-&gt;FakePageContents, VirtualTarget, PAGE_SIZE);</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        <a class="code" href="_memory_mapper_8c.html#ad34df1901286734c77884ce9fc7c4f2d">MemoryMapperReadMemorySafe</a>(VirtualTarget, &amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>, PAGE_SIZE);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; </div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        <span class="comment">// Set the breakpoint on the fake page</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        *(<a class="code" href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent = 0xcc;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">// Restore to original process</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ac549eb95ff7d5634b8f1f922275c6a00">RestoreToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160; </div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="comment">// Save the modified entry</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">ChangedEntry</a> = ChangedEntry;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="comment">// Add it to the list</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <a class="code" href="list_8cpp.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a>(&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, &amp;(HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>));</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160; </div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">// if not launched, there is no need to modify it on a safe environment</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        {</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            TargetPage-&gt;<a class="code" href="union___e_p_t_e.html#ad58ee97cc2ac9a96385f5b6ec2c8197d">Flags</a> = ChangedEntry.<a class="code" href="union___e_p_t_e.html#ad58ee97cc2ac9a96385f5b6ec2c8197d">Flags</a>;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        }</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            <a class="code" href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a>(TargetPage, ChangedEntry, <a class="code" href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a>);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        }</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;}</div>
<div class="ttc" id="a_ept_8c_html_a0f232e4af9f1846e615420036d4b6c9a"><div class="ttname"><a href="_ept_8c.html#a0f232e4af9f1846e615420036d4b6c9a">EptSplitLargePage</a></div><div class="ttdeci">BOOLEAN EptSplitLargePage(PVMM_EPT_PAGE_TABLE EptPageTable, PVOID PreAllocatedBuffer, SIZE_T PhysicalAddress, ULONG CoreIndex)</div><div class="ttdoc">Split 2MB (LargePage) into 4kb pages.</div><div class="ttdef"><b>Definition:</b> Ept.c:234</div></div>
<div class="ttc" id="a_ept_8c_html_aca998ecbfe4b433dbb307e5ab1fbcc41"><div class="ttname"><a href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a></div><div class="ttdeci">PEPT_PML1_ENTRY EptGetPml1Entry(PVMM_EPT_PAGE_TABLE EptPageTable, SIZE_T PhysicalAddress)</div><div class="ttdoc">Get the PML1 entry for this physical address if the page is split.</div><div class="ttdef"><b>Definition:</b> Ept.c:142</div></div>
<div class="ttc" id="a_ept_8h_html_a1bea5321e3bc6afd7a50e5208be94d74"><div class="ttname"><a href="_ept_8h.html#a1bea5321e3bc6afd7a50e5208be94d74">MaximumHiddenBreakpointsOnPage</a></div><div class="ttdeci">#define MaximumHiddenBreakpointsOnPage</div><div class="ttdef"><b>Definition:</b> Ept.h:18</div></div>
<div class="ttc" id="a_memory_mapper_8c_html_ad34df1901286734c77884ce9fc7c4f2d"><div class="ttname"><a href="_memory_mapper_8c.html#ad34df1901286734c77884ce9fc7c4f2d">MemoryMapperReadMemorySafe</a></div><div class="ttdeci">BOOLEAN MemoryMapperReadMemorySafe(UINT64 VaAddressToRead, PVOID BufferToSaveMemory, SIZE_T SizeToRead)</div><div class="ttdoc">Read memory safely by mapping the buffer (It's a wrapper)</div><div class="ttdef"><b>Definition:</b> MemoryMapper.c:628</div></div>
<div class="ttc" id="a_pool_manager_8c_html_a065841edb44331344b1a71a2ea397923"><div class="ttname"><a href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a></div><div class="ttdeci">UINT64 PoolManagerRequestPool(POOL_ALLOCATION_INTENTION Intention, BOOLEAN RequestNewPool, UINT32 Size)</div><div class="ttdoc">This function should be called from vmx-root in order to get a pool from the list.</div><div class="ttdef"><b>Definition:</b> PoolManager.c:183</div></div>
<div class="ttc" id="a_pool_manager_8h_html_ac9e1b58ef1b236c646eb5ca0d4205f46a09f33e69ad8e184c21efd29fa2fe7380"><div class="ttname"><a href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a></div><div class="ttdeci">@ SPLIT_2MB_PAGING_TO_4KB_PAGE</div><div class="ttdef"><b>Definition:</b> PoolManager.h:37</div></div>
<div class="ttc" id="a_pool_manager_8h_html_ac9e1b58ef1b236c646eb5ca0d4205f46a1c4249f84cf779cd4cdd72ee27de08c1"><div class="ttname"><a href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a></div><div class="ttdeci">@ TRACKING_HOOKED_PAGES</div><div class="ttdef"><b>Definition:</b> PoolManager.h:35</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:80</div></div>
<div class="ttc" id="a_script_engine_eval_8h_html_a4ae1dab0fb4b072a66584546209e7d58"><div class="ttname"><a href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a></div><div class="ttdeci">unsigned char BYTE</div><div class="ttdef"><b>Definition:</b> ScriptEngineEval.h:65</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_a29100dd8ab15ffcb0ab1d030f195e821"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#a29100dd8ab15ffcb0ab1d030f195e821">SwitchOnAnotherProcessMemoryLayoutByCr3</a></div><div class="ttdeci">CR3_TYPE SwitchOnAnotherProcessMemoryLayoutByCr3(CR3_TYPE TargetCr3)</div><div class="ttdoc">Switch to another process's cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:203</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_aa257cde073bba99546f8edf56fd31661"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#aa257cde073bba99546f8edf56fd31661">VirtualAddressToPhysicalAddressByProcessCr3</a></div><div class="ttdeci">UINT64 VirtualAddressToPhysicalAddressByProcessCr3(PVOID VirtualAddress, CR3_TYPE TargetCr3)</div><div class="ttdoc">Converts Virtual Address to Physical Address based on a specific process's kernel cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:440</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_ac549eb95ff7d5634b8f1f922275c6a00"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#ac549eb95ff7d5634b8f1f922275c6a00">RestoreToPreviousProcess</a></div><div class="ttdeci">VOID RestoreToPreviousProcess(CR3_TYPE PreviousProcess)</div><div class="ttdoc">Switch to previous process's cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:282</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_ae6bbd169187c6e08bbe584c67175a61d"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#ae6bbd169187c6e08bbe584c67175a61d">VirtualAddressToPhysicalAddress</a></div><div class="ttdeci">UINT64 VirtualAddressToPhysicalAddress(PVOID VirtualAddress)</div><div class="ttdoc">Converts Virtual Address to Physical Address.</div><div class="ttdef"><b>Definition:</b> Common.c:114</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a1ebb2ec82baedeecf55e15778b8dd0aa"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a></div><div class="ttdeci">#define PAGE_OFFSET(Va)</div><div class="ttdoc">Offset from a page's 4096 bytes.</div><div class="ttdef"><b>Definition:</b> Common.h:210</div></div>
<div class="ttc" id="alist_8cpp_html_a77df31a5e6a1be59d08b93e9cb028f22"><div class="ttname"><a href="list_8cpp.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a></div><div class="ttdeci">void InsertHeadList(PLIST_ENTRY ListHead, PLIST_ENTRY Entry)</div><div class="ttdoc">insert entry to the top of the list</div><div class="ttdef"><b>Definition:</b> list.cpp:32</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html">_CR3_TYPE</a></div><div class="ttdoc">CR3 Structure.</div><div class="ttdef"><b>Definition:</b> MemoryMapper.h:287</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a325edda9c8d49c2f44319627d86d4a88"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddressOfFakePageContents</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddressOfFakePageContents</div><div class="ttdoc">The base address of the page with fake contents. Used to swap page with fake contents when a hook is ...</div><div class="ttdef"><b>Definition:</b> Ept.h:1175</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a40f5606fe57295d12c430ce08421e544"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">_EPT_HOOKED_PAGE_DETAIL::IsExecutionHook</a></div><div class="ttdeci">BOOLEAN IsExecutionHook</div><div class="ttdoc">This field shows whether the hook contains a hidden hook for execution or not.</div><div class="ttdef"><b>Definition:</b> Ept.h:1201</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4450bd220c3bce95443a102aa90fc93b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">_EPT_HOOKED_PAGE_DETAIL::PageHookList</a></div><div class="ttdeci">LIST_ENTRY PageHookList</div><div class="ttdoc">Linked list entires for each page hook.</div><div class="ttdef"><b>Definition:</b> Ept.h:1152</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4c523ca3a1b46bf34681abfec4fef75e"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">_EPT_HOOKED_PAGE_DETAIL::FakePageContents</a></div><div class="ttdeci">CHAR FakePageContents[PAGE_SIZE]</div><div class="ttdef"><b>Definition:</b> Ept.h:1147</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a87563a62e848638473d980314b01d28b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">_EPT_HOOKED_PAGE_DETAIL::ChangedEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY ChangedEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is remove from the page.</div><div class="ttdef"><b>Definition:</b> Ept.h:1191</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a9a3a0a03e6ce50440efa6185f63a6882"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">_EPT_HOOKED_PAGE_DETAIL::PreviousBytesOnBreakpointAddresses</a></div><div class="ttdeci">CHAR PreviousBytesOnBreakpointAddresses[MaximumHiddenBreakpointsOnPage]</div><div class="ttdoc">Character that was previously used in BreakpointAddresses this is only used in hidden breakpoints (no...</div><div class="ttdef"><b>Definition:</b> Ept.h:1219</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_aaaf2650f56c9581f4724da1e833257ef"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">_EPT_HOOKED_PAGE_DETAIL::BreakpointAddresses</a></div><div class="ttdeci">UINT64 BreakpointAddresses[MaximumHiddenBreakpointsOnPage]</div><div class="ttdoc">Address of hooked pages (multiple breakpoints on a single page) this is only used in hidden breakpoin...</div><div class="ttdef"><b>Definition:</b> Ept.h:1213</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afb78ebcdb15c9df1fc20831d93203019"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddress</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddress</div><div class="ttdoc">The base address of the page. Used to find this structure in the list of page hooks when a hook is hi...</div><div class="ttdef"><b>Definition:</b> Ept.h:1169</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afc5fdacf494efec054863c41f754b0a0"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">_EPT_HOOKED_PAGE_DETAIL::CountOfBreakpoints</a></div><div class="ttdeci">UINT64 CountOfBreakpoints</div><div class="ttdoc">Count of breakpoints (multiple breakpoints on a single page) this is only used in hidden breakpoints ...</div><div class="ttdef"><b>Definition:</b> Ept.h:1225</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a63cb7b9ebbfafeb6f69caa76f755c7bd"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">_EPT_STATE::EptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE EptPageTable</div><div class="ttdef"><b>Definition:</b> Ept.h:996</div></div>
<div class="ttc" id="astruct___i_n_v_e_p_t___d_e_s_c_r_i_p_t_o_r_html"><div class="ttname"><a href="struct___i_n_v_e_p_t___d_e_s_c_r_i_p_t_o_r.html">_INVEPT_DESCRIPTOR</a></div><div class="ttdoc">Structure for INVEPT Instruction.</div><div class="ttdef"><b>Definition:</b> Ept.h:970</div></div>
<div class="ttc" id="astruct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t_html"><div class="ttname"><a href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">_VMM_EPT_DYNAMIC_SPLIT</a></div><div class="ttdoc">Split 2MB granularity to 4 KB granularity.</div><div class="ttdef"><b>Definition:</b> Ept.h:1009</div></div>
<div class="ttc" id="aunion___e_p_t_e_html"><div class="ttname"><a href="union___e_p_t_e.html">_EPTE</a></div><div class="ttdoc">EPT PTE.</div><div class="ttdef"><b>Definition:</b> Ept.h:664</div></div>
<div class="ttc" id="aunion___e_p_t_e_html_a49f1b43529360a2627349a72272e81f3"><div class="ttname"><a href="union___e_p_t_e.html#a49f1b43529360a2627349a72272e81f3">_EPTE::ReadAccess</a></div><div class="ttdeci">UINT64 ReadAccess</div><div class="ttdoc">[Bit 0] Read access; indicates whether reads are allowed from the 4-KByte page referenced by this ent...</div><div class="ttdef"><b>Definition:</b> Ept.h:670</div></div>
<div class="ttc" id="aunion___e_p_t_e_html_aae366a4c1e246fb14bd1c63e3eef1589"><div class="ttname"><a href="union___e_p_t_e.html#aae366a4c1e246fb14bd1c63e3eef1589">_EPTE::PageFrameNumber</a></div><div class="ttdeci">UINT64 PageFrameNumber</div><div class="ttdoc">[Bits 47:12] Physical address of the 4-KByte page referenced by this entry.</div><div class="ttdef"><b>Definition:</b> Ept.h:727</div></div>
<div class="ttc" id="aunion___e_p_t_e_html_ac285d7271e994ee5a8ad0c5abef54ff6"><div class="ttname"><a href="union___e_p_t_e.html#ac285d7271e994ee5a8ad0c5abef54ff6">_EPTE::ExecuteAccess</a></div><div class="ttdeci">UINT64 ExecuteAccess</div><div class="ttdoc">[Bit 2] If the &quot;mode-based execute control for EPT&quot; VM-execution control is 0, execute access; indica...</div><div class="ttdef"><b>Definition:</b> Ept.h:683</div></div>
<div class="ttc" id="aunion___e_p_t_e_html_ad58ee97cc2ac9a96385f5b6ec2c8197d"><div class="ttname"><a href="union___e_p_t_e.html#ad58ee97cc2ac9a96385f5b6ec2c8197d">_EPTE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> Ept.h:740</div></div>
<div class="ttc" id="aunion___e_p_t_e_html_adb96c4aa485638e90dbedb0e6ec062c5"><div class="ttname"><a href="union___e_p_t_e.html#adb96c4aa485638e90dbedb0e6ec062c5">_EPTE::WriteAccess</a></div><div class="ttdeci">UINT64 WriteAccess</div><div class="ttdoc">[Bit 1] Write access; indicates whether writes are allowed from the 4-KByte page referenced by this e...</div><div class="ttdef"><b>Definition:</b> Ept.h:675</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a77e3785963c79b3ff0efdf13efe0be13"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a77e3785963c79b3ff0efdf13efe0be13">&#9670;&nbsp;</a></span>EptHookPerformPageHook2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHook2 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>HookFunction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_memory_mapper_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>ProcessCr3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetRead</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetExecute</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook in VMX Root Mode with hidden detours and monitor (A pre-allocated buffer should be available) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
    <tr><td class="paramname">HookFunction</td><td></td></tr>
    <tr><td class="paramname">ProcessCr3</td><td></td></tr>
    <tr><td class="paramname">UnsetRead</td><td></td></tr>
    <tr><td class="paramname">UnsetWrite</td><td></td></tr>
    <tr><td class="paramname">UnsetExecute</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Hook in VMX Root Mode with hidden detours and monitor (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">UnsetRead</td><td>Hook READ Access </td></tr>
    <tr><td class="paramname">UnsetWrite</td><td>Hook WRITE Access </td></tr>
    <tr><td class="paramname">UnsetExecute</td><td>Hook EXECUTE Access </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successfull or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;{</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <a class="code" href="union___e_p_t_e.html">EPT_PML1_ENTRY</a>          ChangedEntry;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <a class="code" href="struct___i_n_v_e_p_t___d_e_s_c_r_i_p_t_o_r.html">INVEPT_DESCRIPTOR</a>       Descriptor;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    SIZE_T                  PhysicalBaseAddress;</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    PVOID                   VirtualTarget;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;    PVOID                   TargetBuffer;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  TargetAddressInSafeMemory;</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  PageOffset;</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <a class="code" href="union___e_p_t_e.html">PEPT_PML1_ENTRY</a>         TargetPage;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPage;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>                   LogicalCoreIndex;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <a class="code" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                Cr3OfCurrentProcess;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    PLIST_ENTRY             TempList    = 0;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="_gdb_stub_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160; </div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="comment">// Check whether we are in VMX Root Mode or Not</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    LogicalCoreIndex = KeGetCurrentProcessorIndex();</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160; </div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].IsOnVmxRootMode &amp;&amp; !<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    {</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    }</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="comment">// virtual memory.</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    VirtualTarget = PAGE_ALIGN(TargetAddress);</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160; </div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160; </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="comment">// Find cr3 of target core</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    PhysicalBaseAddress = (SIZE_T)<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#aa257cde073bba99546f8edf56fd31661">VirtualAddressToPhysicalAddressByProcessCr3</a>(VirtualTarget, ProcessCr3);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160; </div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    {</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, target address could not be mapped to physical memory&quot;</span>);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160; </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    {</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        TempList    = TempList-&gt;Flink;</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160; </div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PhysicalBaseAddress)</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        {</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            <span class="comment">// Means that we find the address and !epthook2 doesn&#39;t support</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;            <span class="comment">// multiple breakpoints in on page</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        }</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160; </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="comment">// Set target buffer, request buffer from pool manager,</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="comment">// we also need to allocate new page to replace the current page ASAP</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    TargetBuffer = <a class="code" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code" href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>, <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>));</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160; </div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="keywordflow">if</span> (!TargetBuffer)</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, there is no pre-allocated buffer available&quot;</span>);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    }</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160; </div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="_ept_8c.html#a0f232e4af9f1846e615420036d4b6c9a">EptSplitLargePage</a>(<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, TargetBuffer, PhysicalBaseAddress, LogicalCoreIndex))</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;    {</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not split page for the address : 0x%llx&quot;</span>, PhysicalBaseAddress);</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;    }</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160; </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    TargetPage = <a class="code" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, PhysicalBaseAddress);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="comment">// Ensure the target is valid</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordflow">if</span> (!TargetPage)</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    {</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, failed to get PML1 entry of the target address&quot;</span>);</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    }</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="comment">// Save the original permissions of the page</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    ChangedEntry = *TargetPage;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="comment">// Execution is treated differently</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordflow">if</span> (UnsetRead)</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#a49f1b43529360a2627349a72272e81f3">ReadAccess</a> = 0;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#a49f1b43529360a2627349a72272e81f3">ReadAccess</a> = 1;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160; </div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">if</span> (UnsetWrite)</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#adb96c4aa485638e90dbedb0e6ec062c5">WriteAccess</a> = 0;</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#adb96c4aa485638e90dbedb0e6ec062c5">WriteAccess</a> = 1;</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="comment">// Save the detail of hooked page to keep track of it</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    HookedPage = <a class="code" href="_pool_manager_8c.html#a065841edb44331344b1a71a2ea397923">PoolManagerRequestPool</a>(<a class="code" href="_pool_manager_8h.html#ac9e1b58ef1b236c646eb5ca0d4205f46a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>, <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>));</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160; </div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="keywordflow">if</span> (!HookedPage)</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    {</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, there is no pre-allocated pool for saving hooked page details&quot;</span>);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    }</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160; </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="comment">// Save the virtual address</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a> = TargetAddress;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160; </div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="comment">// Save the physical address</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> = PhysicalBaseAddress;</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160; </div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="comment">// Fake page content physical address</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a> = (SIZE_T)<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ae6bbd169187c6e08bbe584c67175a61d">VirtualAddressToPhysicalAddress</a>(&amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[0]) / PAGE_SIZE;</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160; </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="comment">// Save the entry address</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a> = TargetPage;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160; </div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    <span class="comment">// Save the orginal entry</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a> = *TargetPage;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160; </div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="comment">// If it&#39;s Execution hook then we have to set extra fields</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="keywordflow">if</span> (UnsetExecute)</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    {</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="comment">// Show that entry has hidden hooks for execution</span></div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">IsExecutionHook</a> = <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160; </div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        <span class="comment">// In execution hook, we have to make sure to unset read, write because</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        <span class="comment">// an EPT violation should occur for these cases and we can swap the original page</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#a49f1b43529360a2627349a72272e81f3">ReadAccess</a>    = 0;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#adb96c4aa485638e90dbedb0e6ec062c5">WriteAccess</a>   = 0;</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#ac285d7271e994ee5a8ad0c5abef54ff6">ExecuteAccess</a> = 1;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160; </div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="comment">// Also set the current pfn to fake page</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        ChangedEntry.<a class="code" href="union___e_p_t_e.html#aae366a4c1e246fb14bd1c63e3eef1589">PageFrameNumber</a> = HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a>;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160; </div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="comment">// Switch to target process</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        Cr3OfCurrentProcess = <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#a29100dd8ab15ffcb0ab1d030f195e821">SwitchOnAnotherProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160; </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        <span class="comment">// Copy the content to the fake page</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="comment">// RtlCopyBytes(&amp;HookedPage-&gt;FakePageContents, VirtualTarget, PAGE_SIZE);</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        <a class="code" href="_memory_mapper_8c.html#ad34df1901286734c77884ce9fc7c4f2d">MemoryMapperReadMemorySafe</a>(VirtualTarget, &amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>, PAGE_SIZE);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160; </div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <span class="comment">// Restore to original process</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <a class="code" href="hprdbghv_2code_2common_2_common_8c.html#ac549eb95ff7d5634b8f1f922275c6a00">RestoreToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160; </div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="comment">// Compute new offset of target offset into a safe bufferr</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <span class="comment">// It will be used to compute the length of the detours</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="comment">// address because we might have a user mode code</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        TargetAddressInSafeMemory = &amp;HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        TargetAddressInSafeMemory = PAGE_ALIGN(TargetAddressInSafeMemory);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        PageOffset                = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(TargetAddress);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        TargetAddressInSafeMemory = TargetAddressInSafeMemory + PageOffset;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160; </div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="comment">// Create Hook</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="_ept_hook_8c.html#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a>(HookedPage, ProcessCr3, TargetAddress, TargetAddressInSafeMemory, HookFunction))</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        {</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not build the hook&quot;</span>);</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        }</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160; </div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    <span class="comment">// Save the modified entry</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">ChangedEntry</a> = ChangedEntry;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160; </div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="comment">// Add it to the list</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <a class="code" href="list_8cpp.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a>(&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, &amp;(HookedPage-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>));</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160; </div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <span class="comment">// if not launched, there is no need to modify it on a safe environment</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[LogicalCoreIndex].HasLaunched)</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    {</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        TargetPage-&gt;<a class="code" href="union___e_p_t_e.html#ad58ee97cc2ac9a96385f5b6ec2c8197d">Flags</a> = ChangedEntry.<a class="code" href="union___e_p_t_e.html#ad58ee97cc2ac9a96385f5b6ec2c8197d">Flags</a>;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    }</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    {</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        <a class="code" href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a>(TargetPage, ChangedEntry, <a class="code" href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a>);</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    }</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160; </div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;}</div>
<div class="ttc" id="a_ept_hook_8c_html_a1a97cf8a3d1243edf02539139bbfb617"><div class="ttname"><a href="_ept_hook_8c.html#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a></div><div class="ttdeci">BOOLEAN EptHookInstructionMemory(PEPT_HOOKED_PAGE_DETAIL Hook, CR3_TYPE ProcessCr3, PVOID TargetFunction, PVOID TargetFunctionInSafeMemory, PVOID HookFunction)</div><div class="ttdoc">Hook ins.</div><div class="ttdef"><b>Definition:</b> EptHook.c:581</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acac4eff03b2197ae43e4c13f382e20b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acac4eff03b2197ae43e4c13f382e20b5">&#9670;&nbsp;</a></span>EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>Address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove an entry from g_EptHook2sDetourListHead. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Address</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Remove an entry from g_EptHook2sDetourListHead.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Address</td><td>Address to remove </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN TRUE if successfully removed and false if not found </dd></dl>
<div class="fragment"><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;{</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;    <span class="comment">// Iterate through the list of hooked pages details to find</span></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="comment">// the entry in the list</span></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160; </div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        TempList                                          = TempList-&gt;Flink;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        <a class="code" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">PHIDDEN_HOOKS_DETOUR_DETAILS</a> CurrentHookedDetails = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>, OtherHooksList);</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160; </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="keywordflow">if</span> (CurrentHookedDetails-&gt;<a class="code" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">HookedFunctionAddress</a> == Address)</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        {</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            <span class="comment">// We found the address, we should remove it and add it for</span></div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            <span class="comment">// future deallocation</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;            <a class="code" href="list_8cpp.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;CurrentHookedDetails-&gt;<a class="code" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">OtherHooksList</a>);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160; </div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;            <span class="comment">// Free the pool in next ioctl</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>(CurrentHookedDetails))</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            {</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;            }</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;        }</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    }</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <span class="comment">// No entry found !</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;}</div>
<div class="ttc" id="a_global_variables_8h_html_a90f5a18f43567010690d8d7927619fa0"><div class="ttname"><a href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a></div><div class="ttdeci">LIST_ENTRY g_EptHook2sDetourListHead</div><div class="ttdoc">List header of hidden hooks detour.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:81</div></div>
<div class="ttc" id="a_pool_manager_8c_html_aac1a781a8d6463b65848555355e687dd"><div class="ttname"><a href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a></div><div class="ttdeci">BOOLEAN PoolManagerFreePool(UINT64 AddressToFree)</div><div class="ttdoc">This function set a pool flag to be freed, and it will be freed on the next IOCTL when it's safe to r...</div><div class="ttdef"><b>Definition:</b> PoolManager.c:136</div></div>
<div class="ttc" id="alist_8cpp_html_a1384c9ab335080c2fdc01fc7eca7673c"><div class="ttname"><a href="list_8cpp.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a></div><div class="ttdeci">BOOLEAN RemoveEntryList(PLIST_ENTRY Entry)</div><div class="ttdoc">remove the entry from the list</div><div class="ttdef"><b>Definition:</b> list.cpp:50</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a></div><div class="ttdef"><b>Definition:</b> Hooks.h:67</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_a5b7e945d9dd258586acd7e0268c8f11a"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">_HIDDEN_HOOKS_DETOUR_DETAILS::HookedFunctionAddress</a></div><div class="ttdeci">PVOID HookedFunctionAddress</div><div class="ttdef"><b>Definition:</b> Hooks.h:69</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_aa47949f02b08a654dbe910d6d107fa94"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">_HIDDEN_HOOKS_DETOUR_DETAILS::OtherHooksList</a></div><div class="ttdeci">LIST_ENTRY OtherHooksList</div><div class="ttdef"><b>Definition:</b> Hooks.h:68</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acd59638727980bbd58fb4665ffce9091"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd59638727980bbd58fb4665ffce9091">&#9670;&nbsp;</a></span>EptHookRestoreAllHooksToOrginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookRestoreAllHooksToOrginalEntry </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove all hooks from the hooked pages lists (Should be called in vmx-root) </p>
<dl class="section return"><dt>Returns</dt><dd>VOID</dd></dl>
<p>Remove all hooks from the hooked pages lists (Should be called in vmx-root)</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookAll instead</dd></dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;{</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160; </div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].IsOnVmxRootMode)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    }</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160; </div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    {</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        TempList                            = TempList-&gt;Flink;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160; </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="comment">// Undo the hook on the EPT table</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        <a class="code" href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a>(HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a>, HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>, <a class="code" href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a>);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    }</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aba59e4d31f5cf37d9436d73933e8158c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba59e4d31f5cf37d9436d73933e8158c">&#9670;&nbsp;</a></span>EptHookRestoreSingleHookToOrginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRestoreSingleHookToOrginalEntry </td>
          <td>(</td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove a special hook from the hooked pages lists. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Remove a special hook from the hooked pages lists.</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookSingleAddress instead</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Return false if there was an error or returns true if it was successfull </dd></dl>
<div class="fragment"><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;{</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].IsOnVmxRootMode)</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    {</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    }</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160; </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        TempList                            = TempList-&gt;Flink;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PAGE_ALIGN(PhysicalAddress))</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;            <span class="comment">// Undo the hook on the EPT table</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            <a class="code" href="_ept_8c.html#a08ea39deb301ed3051e6353a9692cecc">EptSetPML1AndInvalidateTLB</a>(HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a>, HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>, <a class="code" href="_ept_8h.html#ab219663e4f46d8928baba662d2a330d1a36d6f6073110ebe31c96fe3bb43f3380">INVEPT_SINGLE_CONTEXT</a>);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        }</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    }</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="comment">// Nothing found, probably the list is not found</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac8845ca75f3b4c267d3542d20621f547"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac8845ca75f3b4c267d3542d20621f547">&#9670;&nbsp;</a></span>EptHookUnHookAll()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookUnHookAll </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove all hooks from the hooked pages lists. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID</dd></dl>
<p>Remove all hooks from the hooked pages lists.</p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;{</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160; </div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].IsOnVmxRootMode)</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    {</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;    }</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160; </div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;    <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    KeGenericCallDpc(<a class="code" href="_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a>, 0x0);</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160; </div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    <span class="comment">// In the case of unhooking all pages, we remove the hooked</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    <span class="comment">// from EPT table in vmx-root and at last, we need to deallocate</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;    <span class="comment">// it from the buffers</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160; </div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160; </div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    {</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        TempList                            = TempList-&gt;Flink;</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160; </div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;        <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;        <span class="comment">// if the hook is detours</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;        <span class="keywordflow">if</span> (!HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">IsHiddenBreakpoint</a>)</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;        {</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;            <a class="code" href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        }</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160; </div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;        <span class="comment">// As we are in vmx-root here, we add the hooked entry to the list</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>(HookedEntry))</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        {</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        }</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    }</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;}</div>
<div class="ttc" id="a_dpc_routines_8c_html_ac0df5b089250515279b8c348e0817977"><div class="ttname"><a href="_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes all the hooks and invalidate TLB.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1297</div></div>
<div class="ttc" id="a_ept_hook_8c_html_acac4eff03b2197ae43e4c13f382e20b5"><div class="ttname"><a href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a></div><div class="ttdeci">BOOLEAN EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList(UINT64 Address)</div><div class="ttdoc">Remove the enrty from g_EptHook2sDetourListHead in the case of !epthook2 details.</div><div class="ttdef"><b>Definition:</b> EptHook.c:1178</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad1e9c3160ff8af6421fcfd6942dcad2e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad1e9c3160ff8af6421fcfd6942dcad2e">&#9670;&nbsp;</a></span>EptHookUnHookSingleAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="_script_engine_eval_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_script_engine_eval_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages list and invalidate TLB. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td></td></tr>
    <tr><td class="paramname">ProcessId</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN</dd></dl>
<p>Should be called from vmx non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>Virtual address to unhook </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id of target process </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;{</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    SIZE_T      PhysicalAddress;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>      TargetAddressInFakePageContent;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <a class="code" href="_script_engine_eval_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>      PageOffset;</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    PLIST_ENTRY TempList = 0;</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160; </div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;    <span class="keywordflow">if</span> (ProcessId == <a class="code" href="_definition_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a> || ProcessId == 0)</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    {</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;        ProcessId = PsGetCurrentProcessId();</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    }</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160; </div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;    PhysicalAddress = PAGE_ALIGN(<a class="code" href="hprdbghv_2code_2common_2_common_8c.html#af251f655d5814472abd5f50c68f209f0">VirtualAddressToPhysicalAddressByProcessId</a>(VirtualAddress, ProcessId));</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160; </div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()].IsOnVmxRootMode)</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    {</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    }</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160; </div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    TempList = &amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="keywordflow">while</span> (&amp;<a class="code" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;    {</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;        TempList                            = TempList-&gt;Flink;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = <a class="code" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160; </div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        <span class="comment">// Check if it&#39;s a hidden breakpoint or hidden detours</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a97690afae33315665d9d82ed19b7725c">IsHiddenBreakpoint</a>)</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        {</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;            <span class="comment">// It&#39;s a hidden breakpoint (we have to search through an array of addresses)</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>; i++)</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            {</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;                <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i] == VirtualAddress)</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;                {</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;                    <span class="comment">// We found an address that matches this entry</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160; </div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                    <span class="comment">// Check if it&#39;s a single breakpoint</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                    <span class="comment">//</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                    <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> == 1)</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                    {</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                        <span class="comment">// Remove the hook entirely on all cores</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                        KeGenericCallDpc(<a class="code" href="_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160; </div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;                        <span class="comment">// remove the entry from the list</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                        <a class="code" href="list_8cpp.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160; </div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;                        <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;                        <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                        <span class="keywordflow">if</span> (!<a class="code" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>(HookedEntry))</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                        {</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                            <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                        }</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160; </div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                        <span class="comment">// Check if there is any other breakpoints, if no then we have to disalbe</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                        <span class="comment">// exception bitmaps on vm-exits for breakpoint, for this purpose, we have</span></div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                        <span class="comment">// to visit all the entries to see if there is any entries</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="_ept_hook_8c.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a>(<a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) == 0)</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;                        {</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                            <span class="comment">// Did not find any entry, let&#39;s disable the breakpoints vm-exits</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;                            <span class="comment">// on exception bitmaps</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                            <span class="comment">//</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                            <a class="code" href="_broadcast_8c.html#aa7dce498eb6cbba84d821e4a5c0e1275">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;                        }</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;                    }</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;                    {</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;                        <span class="comment">// Set 0xcc to its previous value</span></div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                        TargetAddressInFakePageContent = &amp;HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                        TargetAddressInFakePageContent = PAGE_ALIGN(TargetAddressInFakePageContent);</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                        PageOffset                     = <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(VirtualAddress);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                        TargetAddressInFakePageContent = TargetAddressInFakePageContent + PageOffset;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160; </div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                        <span class="comment">// Set the previous value</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                        *(<a class="code" href="_script_engine_eval_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent = HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[i];</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160; </div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                        <span class="comment">// Remove just that special entry</span></div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                        <span class="comment">// Btw, No need to remove it, it will be replace automatically</span></div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i]                = <a class="code" href="_gdb_stub_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[i] = 0x0;</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160; </div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                        <span class="comment">// all addresses to a lower array index (because one entry is</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                        <span class="comment">// missing and might) be in the middle of the array</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                        <a class="code" href="_grammar_8txt.html#a0cf843f73f994fb4c3968d1e7bf56874">for</a> (<span class="keywordtype">size_t</span> j = i; j &lt; <a class="code" href="_ept_8h.html#a1bea5321e3bc6afd7a50e5208be94d74">MaximumHiddenBreakpointsOnPage</a> - 1; j++)</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                        {</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;                            HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[j]                = HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[j + 1];</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                            HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[j] = HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[j + 1];</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                        }</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160; </div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;                        <span class="comment">// Decrease the count of breakpoints</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                        <span class="comment">//</span></div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;                        HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> = HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> - 1;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160; </div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                        <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;                    }</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                }</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            }</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        }</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        {</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            <span class="comment">// It&#39;s a hidden detours</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            <span class="comment">//</span></div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PhysicalAddress)</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            {</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                KeGenericCallDpc(<a class="code" href="_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>);</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160; </div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                <a class="code" href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160; </div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                <span class="comment">// remove the entry from the list</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                <a class="code" href="list_8cpp.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160; </div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                <span class="comment">//</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="_pool_manager_8c.html#aac1a781a8d6463b65848555355e687dd">PoolManagerFreePool</a>(HookedEntry))</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                {</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                    <a class="code" href="hprdbghv_2header_2common_2common_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;                }</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160; </div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;            }</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        }</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    }</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="comment">// Nothing found , probably the list is not found</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="_script_engine_eval_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;}</div>
<div class="ttc" id="a_broadcast_8c_html_aa7dce498eb6cbba84d821e4a5c0e1275"><div class="ttname"><a href="_broadcast_8c.html#aa7dce498eb6cbba84d821e4a5c0e1275">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">VOID BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to disable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition:</b> Broadcast.c:77</div></div>
<div class="ttc" id="a_definition_8h_html_ab3bb4c0d2a847e96e2988afd99c82074"><div class="ttname"><a href="_definition_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a></div><div class="ttdeci">#define DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</div><div class="ttdoc">Apply the event to all the processes.</div><div class="ttdef"><b>Definition:</b> Definition.h:1289</div></div>
<div class="ttc" id="a_dpc_routines_8c_html_ae978b3d6e7b660da69ab279da37a529e"><div class="ttname"><a href="_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes the single hook and invalidate TLB.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1325</div></div>
<div class="ttc" id="a_ept_hook_8c_html_acd0179b7c5730f636141dfea2afcdc5a"><div class="ttname"><a href="_ept_hook_8c.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a></div><div class="ttdeci">UINT32 EptHookGetCountOfEpthooks(BOOLEAN IsEptHook2)</div><div class="ttdoc">get the length of active EPT hooks (!epthook and !epthook2)</div><div class="ttdef"><b>Definition:</b> EptHook.c:1224</div></div>
<div class="ttc" id="a_grammar_8txt_html_a0cf843f73f994fb4c3968d1e7bf56874"><div class="ttname"><a href="_grammar_8txt.html#a0cf843f73f994fb4c3968d1e7bf56874">for</a></div><div class="ttdeci">FOR_STATEMENT for(SIMPLE_ASSIGNMENT ; @START_OF_FOR BOOLEAN_EXPRESSION ; @FOR_INC_DEC INC_DEC)</div><div class="ttdef"><b>Definition:</b> Grammar.txt:68</div></div>
<div class="ttc" id="ahprdbghv_2code_2common_2_common_8c_html_af251f655d5814472abd5f50c68f209f0"><div class="ttname"><a href="hprdbghv_2code_2common_2_common_8c.html#af251f655d5814472abd5f50c68f209f0">VirtualAddressToPhysicalAddressByProcessId</a></div><div class="ttdeci">UINT64 VirtualAddressToPhysicalAddressByProcessId(PVOID VirtualAddress, UINT32 ProcessId)</div><div class="ttdoc">Converts Virtual Address to Physical Address based on a specific process id's kernel cr3.</div><div class="ttdef"><b>Definition:</b> Common.c:395</div></div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a708148b18a52f70ef6c1e92504f29e92"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a708148b18a52f70ef6c1e92504f29e92">&#9670;&nbsp;</a></span>AllocationSize</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER AllocationSize</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab40749908b174e4a58a46b6bb9a8899f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab40749908b174e4a58a46b6bb9a8899f">&#9670;&nbsp;</a></span>CreateDisposition</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreateDisposition</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad07b47eb97df97ce6120a6ff17e9c6e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad07b47eb97df97ce6120a6ff17e9c6e2">&#9670;&nbsp;</a></span>CreateOptions</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> CreateOptions</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac648ae3c24d5148a8ef42128d6bab501"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac648ae3c24d5148a8ef42128d6bab501">&#9670;&nbsp;</a></span>DesiredAccess</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK DesiredAccess</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9e7d4ea496b0d33e07d6813b22aac212"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e7d4ea496b0d33e07d6813b22aac212">&#9670;&nbsp;</a></span>EaBuffer</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> PVOID EaBuffer</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aec301946a43309ef0f6da81995361efb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aec301946a43309ef0f6da81995361efb">&#9670;&nbsp;</a></span>EaLength</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> PVOID <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> EaLength</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a54b337d004f8bae1638fab9180d83d08"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a54b337d004f8bae1638fab9180d83d08">&#9670;&nbsp;</a></span>FileAttributes</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> FileAttributes</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a74bc6881ecc918d83da9c92e3b2bcc04"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a74bc6881ecc918d83da9c92e3b2bcc04">&#9670;&nbsp;</a></span>FileHandle</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE FileHandle</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a24ff958436c219a33ff5b86019874568"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a24ff958436c219a33ff5b86019874568">&#9670;&nbsp;</a></span>IoStatusBlock</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK IoStatusBlock</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a61083d5dde730c2afd10a336322aaaac"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a61083d5dde730c2afd10a336322aaaac">&#9670;&nbsp;</a></span>NumberOfBytes</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">POOL_TYPE SIZE_T NumberOfBytes</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a22e2a9ce1ada928965365e448fd91e10"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22e2a9ce1ada928965365e448fd91e10">&#9670;&nbsp;</a></span>ObjectAttributes</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES ObjectAttributes</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a5d405dff9ba7e6c73d78857f415965f4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d405dff9ba7e6c73d78857f415965f4">&#9670;&nbsp;</a></span>PoolType</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">POOL_TYPE PoolType</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9ae311c2ebc03cc38ee69edaac2f6e12"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ae311c2ebc03cc38ee69edaac2f6e12">&#9670;&nbsp;</a></span>ShareAccess</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PHANDLE ACCESS_MASK POBJECT_ATTRIBUTES PIO_STATUS_BLOCK PLARGE_INTEGER <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> ShareAccess</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aba7c9f3767dcc5232354d3d17ceedb61"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba7c9f3767dcc5232354d3d17ceedb61">&#9670;&nbsp;</a></span>Tag</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">POOL_TYPE SIZE_T <a class="el" href="_script_engine_eval_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> Tag</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_19054a674c4bd5cb8fceb6542228579c.html">hprdbghv</a></li><li class="navelem"><a class="el" href="dir_d89c7c13509e82280948b201a87328be.html">header</a></li><li class="navelem"><a class="el" href="dir_4fa671983cd6bc189925f47ec52733ff.html">debugger</a></li><li class="navelem"><a class="el" href="dir_26ae5be5fd2cfd3a9b24f6ab6e10851c.html">features</a></li><li class="navelem"><a class="el" href="_hooks_8h.html">Hooks.h</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
