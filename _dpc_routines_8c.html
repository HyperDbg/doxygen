<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg Debugger: hyperdbg/hprdbghv/DpcRoutines.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HyperDbg Debugger
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_19054a674c4bd5cb8fceb6542228579c.html">hprdbghv</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">DpcRoutines.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>All the dpc routines which relates to executing on a single core for multi-core you can use <a class="el" href="_broadcast_8c.html" title="Broadcast debugger function to all logical cores.">Broadcast.c</a>.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="_common_8h_source.html">Common.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="_global_variables_8h_source.html">GlobalVariables.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a860d1d5fbe8605d03eda7327935c799e"><td class="memItemLeft" align="right" valign="top">NTSTATUS&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_dpc_routines_8c.html#a860d1d5fbe8605d03eda7327935c799e">DpcRoutineRunTaskOnSingleCore</a> (UINT32 CoreNumber, PVOID Routine, PVOID DeferredContext)</td></tr>
<tr class="memdesc:a860d1d5fbe8605d03eda7327935c799e"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function synchronize the function execution for a single core You should only used it for one core, not in multiple threads simultaneously The function that needs to use this featue (Routine parameter function) should have the when it ends :  <a href="_dpc_routines_8c.html#a860d1d5fbe8605d03eda7327935c799e">More...</a><br /></td></tr>
<tr class="separator:a860d1d5fbe8605d03eda7327935c799e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="memItemLeft" align="right" valign="top">VOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_dpc_routines_8c.html#a5db83f6e1cbc79c9147fabc0c3b97744">DpcRoutinePerformWriteMsr</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast msr write.  <a href="_dpc_routines_8c.html#a5db83f6e1cbc79c9147fabc0c3b97744">More...</a><br /></td></tr>
<tr class="separator:a5db83f6e1cbc79c9147fabc0c3b97744"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b602a352170d025aa12387207214382"><td class="memItemLeft" align="right" valign="top">VOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_dpc_routines_8c.html#a6b602a352170d025aa12387207214382">DpcRoutinePerformReadMsr</a> (KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</td></tr>
<tr class="memdesc:a6b602a352170d025aa12387207214382"><td class="mdescLeft">&#160;</td><td class="mdescRight">Broadcast msr read.  <a href="_dpc_routines_8c.html#a6b602a352170d025aa12387207214382">More...</a><br /></td></tr>
<tr class="separator:a6b602a352170d025aa12387207214382"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad770b621bcb6287f068300a85ba36233"><td class="memItemLeft" align="right" valign="top">volatile LONG&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a></td></tr>
<tr class="separator:ad770b621bcb6287f068300a85ba36233"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>All the dpc routines which relates to executing on a single core for multi-core you can use <a class="el" href="_broadcast_8c.html" title="Broadcast debugger function to all logical cores.">Broadcast.c</a>. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'ray'+'an'+'fam'+'.c'+'om'; return false;">sina@<span style="display: none;">.nosp@m.</span>raya<span style="display: none;">.nosp@m.</span>nfam.<span style="display: none;">.nosp@m.</span>com</a>) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-29</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a6b602a352170d025aa12387207214382"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b602a352170d025aa12387207214382">&#9670;&nbsp;</a></span>DpcRoutinePerformReadMsr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">VOID DpcRoutinePerformReadMsr </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast msr read. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;{</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    ULONG CurrentProcessorIndex = 0;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    CurrentProcessorIndex = KeGetCurrentProcessorNumber();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">// read on MSR</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentProcessorIndex].<a class="code" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abeaf053196e625ac00ab12a5dc38c8f1">DebuggingState</a>.<a class="code" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a> = __readmsr(<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentProcessorIndex].DebuggingState.MsrState.Msr);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="comment">// As this function is designed for a single,</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// we have to release the synchronization lock here</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="_common_8h.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a5db83f6e1cbc79c9147fabc0c3b97744"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5db83f6e1cbc79c9147fabc0c3b97744">&#9670;&nbsp;</a></span>DpcRoutinePerformWriteMsr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">VOID DpcRoutinePerformWriteMsr </td>
          <td>(</td>
          <td class="paramtype">KDPC *&#160;</td>
          <td class="paramname"><em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>SystemArgument2</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Broadcast msr write. </p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;{</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    ULONG CurrentProcessorIndex = 0;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    CurrentProcessorIndex = KeGetCurrentProcessorNumber();</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// write on MSR</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    __writemsr(<a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentProcessorIndex].DebuggingState.MsrState.Msr, <a class="code" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[CurrentProcessorIndex].<a class="code" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abeaf053196e625ac00ab12a5dc38c8f1">DebuggingState</a>.<a class="code" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">MsrState</a>.<a class="code" href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">Value</a>);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="comment">// As this function is designed for a single,</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// we have to release the synchronization lock here</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <a class="code" href="_common_8h.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a860d1d5fbe8605d03eda7327935c799e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a860d1d5fbe8605d03eda7327935c799e">&#9670;&nbsp;</a></span>DpcRoutineRunTaskOnSingleCore()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">NTSTATUS DpcRoutineRunTaskOnSingleCore </td>
          <td>(</td>
          <td class="paramtype">UINT32&#160;</td>
          <td class="paramname"><em>CoreNumber</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>Routine</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>DeferredContext</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function synchronize the function execution for a single core You should only used it for one core, not in multiple threads simultaneously The function that needs to use this featue (Routine parameter function) should have the when it ends : </p>
<pre class="fragment">         SpinlockUnlock(&amp;OneCoreLock);
</pre><dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    PRKDPC Dpc;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    UINT32 ProcessorCount;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160; </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    ProcessorCount = KeQueryActiveProcessorCount(0);</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160; </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <span class="comment">// Check if the core number is not invalid</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="keywordflow">if</span> (CoreNumber &gt;= ProcessorCount)</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    {</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;        <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    }</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160; </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// Allocate Memory for DPC</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    Dpc = ExAllocatePoolWithTag(NonPagedPool, <span class="keyword">sizeof</span>(KDPC), <a class="code" href="_common_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordflow">if</span> (!Dpc)</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    {</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    }</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// Creating a DPC that will run on the target process</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    KeInitializeDpc(Dpc,            <span class="comment">// Dpc</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;                    Routine,        <span class="comment">// DeferredRoutine</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                    DeferredContext <span class="comment">// DeferredContext</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    );</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160; </div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// Set the target core</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    KeSetTargetProcessorDpc(Dpc, CoreNumber);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; </div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="comment">// it&#39;s sure will be executed, but we want to free the above</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="comment">// pool, so we have to wait on a spinlock that will be release</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="comment">// by the the DPC routine, actually Affinity Thread but that</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="comment">// won&#39;t support more than 64 logical cores, I create a discussion</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="comment">// here, and explained the problem, but no one answers</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="comment">// link: https://community.osr.com/discussion/292064/putting-a-barrier-for-dpc-before-continuing-the-rest-of-code</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="comment">// we also can&#39;t use the spinlock routine of Windows as this function</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="comment">// raises the IRQL to DPC and we want to execute at DPC, means that</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="comment">// If we&#39;re currently on the right core, we never find a chance to</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">// release the spinlock so a deadlock happens, all in all it&#39;s complicated :)</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="comment">// Set the lock to be freed by the other DPC routine</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="_common_8h.html#a442b1a10c7275a6764621203970a68fa">SpinlockTryLock</a>(&amp;<a class="code" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>))</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    {</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="comment">// We can&#39;t get the lock, probably sth goes wrong !</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160; </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="comment">// Fire the DPC</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    KeInsertQueueDpc(Dpc, NULL, NULL);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">// spin on lock to be release, immediately after we get the lock, we&#39;ll</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">// release it for because there is no need to it anymore and DPC is finished</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <a class="code" href="_common_8h.html#a08984f739349991eab67c45376a990bc">SpinlockLock</a>(&amp;<a class="code" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="_common_8h.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a>(&amp;<a class="code" href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a>);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="comment">// Now it&#39;s safe to deallocate the bugger</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="comment">//</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    ExFreePoolWithTag(Dpc, <a class="code" href="_common_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a>);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160; </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordflow">return</span> STATUS_SUCCESS;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad770b621bcb6287f068300a85ba36233"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad770b621bcb6287f068300a85ba36233">&#9670;&nbsp;</a></span>OneCoreLock</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile LONG OneCoreLock</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e_html_a5d5c22183a428958358e19d6434db8a7"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___s_t_a_t_e.html#a5d5c22183a428958358e19d6434db8a7">_PROCESSOR_DEBUGGING_STATE::MsrState</a></div><div class="ttdeci">PROCESSOR_DEBUGGING_MSR_READ_OR_WRITE MsrState</div><div class="ttdef"><b>Definition:</b> Debugger.h:67</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_abeaf053196e625ac00ab12a5dc38c8f1"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#abeaf053196e625ac00ab12a5dc38c8f1">_VIRTUAL_MACHINE_STATE::DebuggingState</a></div><div class="ttdeci">PROCESSOR_DEBUGGING_STATE DebuggingState</div><div class="ttdef"><b>Definition:</b> Vmx.h:495</div></div>
<div class="ttc" id="a_common_8h_html_a08984f739349991eab67c45376a990bc"><div class="ttname"><a href="_common_8h.html#a08984f739349991eab67c45376a990bc">SpinlockLock</a></div><div class="ttdeci">void SpinlockLock(volatile LONG *Lock)</div><div class="ttdoc">Tries to get the lock and won't return until successfully get the lock.</div><div class="ttdef"><b>Definition:</b> Spinlock.c:53</div></div>
<div class="ttc" id="a_common_8h_html_a529db917026601c47af458af0154bfa1"><div class="ttname"><a href="_common_8h.html#a529db917026601c47af458af0154bfa1">SpinlockUnlock</a></div><div class="ttdeci">void SpinlockUnlock(volatile LONG *Lock)</div><div class="ttdoc">Release the lock.</div><div class="ttdef"><b>Definition:</b> Spinlock.c:87</div></div>
<div class="ttc" id="a_dpc_routines_8c_html_ad770b621bcb6287f068300a85ba36233"><div class="ttname"><a href="_dpc_routines_8c.html#ad770b621bcb6287f068300a85ba36233">OneCoreLock</a></div><div class="ttdeci">volatile LONG OneCoreLock</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:13</div></div>
<div class="ttc" id="a_global_variables_8h_html_a04bac1f4beef0dcf1ce1a4d9ce72ea76"><div class="ttname"><a href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a></div><div class="ttdeci">VIRTUAL_MACHINE_STATE * g_GuestState</div><div class="ttdoc">Save the state and variables related to each to logical core.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:29</div></div>
<div class="ttc" id="astruct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e_html_af0a7d72554edcca419674fb5dbf3608d"><div class="ttname"><a href="struct___p_r_o_c_e_s_s_o_r___d_e_b_u_g_g_i_n_g___m_s_r___r_e_a_d___o_r___w_r_i_t_e.html#af0a7d72554edcca419674fb5dbf3608d">_PROCESSOR_DEBUGGING_MSR_READ_OR_WRITE::Value</a></div><div class="ttdeci">UINT64 Value</div><div class="ttdef"><b>Definition:</b> Debugger.h:55</div></div>
<div class="ttc" id="a_common_8h_html_ab7f91e71074ce1488e61869adbc44d8d"><div class="ttname"><a href="_common_8h.html#ab7f91e71074ce1488e61869adbc44d8d">POOLTAG</a></div><div class="ttdeci">#define POOLTAG</div><div class="ttdef"><b>Definition:</b> Common.h:130</div></div>
<div class="ttc" id="a_common_8h_html_a442b1a10c7275a6764621203970a68fa"><div class="ttname"><a href="_common_8h.html#a442b1a10c7275a6764621203970a68fa">SpinlockTryLock</a></div><div class="ttdeci">BOOLEAN SpinlockTryLock(volatile LONG *Lock)</div><div class="ttdoc">Tries to get the lock otherwise returns.</div><div class="ttdef"><b>Definition:</b> Spinlock.c:42</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
