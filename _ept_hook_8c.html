<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyperDbg: hyperdbg/hprdbghv/code/hooks/ept-hook/EptHook.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">HyperDbg
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_ept_hook_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">EptHook.c File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Implementation of different EPT hidden hooks functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;pch.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a07e6c832deccdf103509a4d362897a7f"><td class="memItemLeft" align="right" valign="top">_Must_inspect_result_&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a07e6c832deccdf103509a4d362897a7f">_Success_</a> (return==<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</td></tr>
<tr class="memdesc:a07e6c832deccdf103509a4d362897a7f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether the desired PhysicalAddress is already in the g_EptState-&gt;HookedPagesList hooks or not.  <br /></td></tr>
<tr class="separator:a07e6c832deccdf103509a4d362897a7f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af62063007bc1450386954e16032ce5fd"><td class="memItemLeft" align="right" valign="top">PVOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#af62063007bc1450386954e16032ce5fd">ExAllocatePoolWithTagHook</a> (POOL_TYPE <a class="el" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>, SIZE_T <a class="el" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a> <a class="el" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>)</td></tr>
<tr class="memdesc:af62063007bc1450386954e16032ce5fd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook function that HooksExAllocatePoolWithTag.  <br /></td></tr>
<tr class="separator:af62063007bc1450386954e16032ce5fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a194622a3ba05a449923eb105cdb37405"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a194622a3ba05a449923eb105cdb37405">EptHookPerformPageHook</a> (PVOID TargetAddress, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3)</td></tr>
<tr class="memdesc:a194622a3ba05a449923eb105cdb37405"><td class="mdescLeft">&#160;</td><td class="mdescRight">The main function that performs EPT page hook with hidden breakpoint.  <br /></td></tr>
<tr class="separator:a194622a3ba05a449923eb105cdb37405"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#abcbdb9cd3dbdf238b8b5d484522855e3">EptHook</a> (PVOID TargetAddress, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook.  <br /></td></tr>
<tr class="separator:abcbdb9cd3dbdf238b8b5d484522855e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba59e4d31f5cf37d9436d73933e8158c"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#aba59e4d31f5cf37d9436d73933e8158c">EptHookRestoreSingleHookToOrginalEntry</a> (SIZE_T PhysicalAddress)</td></tr>
<tr class="memdesc:aba59e4d31f5cf37d9436d73933e8158c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove and Invalidate Hook in TLB (Hidden Detours and if counter of hidden breakpoint is zero)  <br /></td></tr>
<tr class="separator:aba59e4d31f5cf37d9436d73933e8158c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd59638727980bbd58fb4665ffce9091"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#acd59638727980bbd58fb4665ffce9091">EptHookRestoreAllHooksToOrginalEntry</a> ()</td></tr>
<tr class="memdesc:acd59638727980bbd58fb4665ffce9091"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove and Invalidate Hook in TLB.  <br /></td></tr>
<tr class="separator:acd59638727980bbd58fb4665ffce9091"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50935db932e916707520e63212e9e688"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a> (PCHAR TargetBuffer, SIZE_T TargetAddress)</td></tr>
<tr class="memdesc:a50935db932e916707520e63212e9e688"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write an absolute x64 jump to an arbitrary address to a buffer.  <br /></td></tr>
<tr class="separator:a50935db932e916707520e63212e9e688"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8767a6d054fe785e66068e32b4466b87"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a> (PCHAR TargetBuffer, SIZE_T TargetAddress)</td></tr>
<tr class="memdesc:a8767a6d054fe785e66068e32b4466b87"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write an absolute x64 jump to an arbitrary address to a buffer.  <br /></td></tr>
<tr class="separator:a8767a6d054fe785e66068e32b4466b87"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a97cf8a3d1243edf02539139bbfb617"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> Hook, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3, PVOID TargetFunction, PVOID TargetFunctionInSafeMemory, PVOID HookFunction)</td></tr>
<tr class="memdesc:a1a97cf8a3d1243edf02539139bbfb617"><td class="mdescLeft">&#160;</td><td class="mdescRight">Hook ins.  <br /></td></tr>
<tr class="separator:a1a97cf8a3d1243edf02539139bbfb617"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77e3785963c79b3ff0efdf13efe0be13"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a> (PVOID TargetAddress, PVOID HookFunction, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a> ProcessCr3, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetRead, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetWrite, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> UnsetExecute)</td></tr>
<tr class="memdesc:a77e3785963c79b3ff0efdf13efe0be13"><td class="mdescLeft">&#160;</td><td class="mdescRight">The main function that performs EPT page hook with hidden detours and monitor.  <br /></td></tr>
<tr class="separator:a77e3785963c79b3ff0efdf13efe0be13"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c5eb45ffb3514149f329aeb0cf04071"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a3c5eb45ffb3514149f329aeb0cf04071">EptHook2</a> (PVOID TargetAddress, PVOID HookFunction, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForRead, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForWrite, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> SetHookForExec)</td></tr>
<tr class="memdesc:a3c5eb45ffb3514149f329aeb0cf04071"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook.  <br /></td></tr>
<tr class="separator:a3c5eb45ffb3514149f329aeb0cf04071"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d7fb010ec1756aa2f27e861271fc0f0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a3d7fb010ec1756aa2f27e861271fc0f0">EptHookHandleHookedPage</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *VCpu, <a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *HookedEntryDetails, VMX_EXIT_QUALIFICATION_EPT_VIOLATION ViolationQualification, SIZE_T PhysicalAddress, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#a732f5fb65b66d5b23321a9b1c69e64d1">EPT_HOOKS_CONTEXT</a> *LastContext, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *IgnoreReadOrWrite, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *IsTriggeringPostEventAllowed)</td></tr>
<tr class="memdesc:a3d7fb010ec1756aa2f27e861271fc0f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handles page hooks.  <br /></td></tr>
<tr class="separator:a3d7fb010ec1756aa2f27e861271fc0f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acac4eff03b2197ae43e4c13f382e20b5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> <a class="el" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>)</td></tr>
<tr class="memdesc:acac4eff03b2197ae43e4c13f382e20b5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove the enrty from g_EptHook2sDetourListHead in the case of !epthook2 details.  <br /></td></tr>
<tr class="separator:acac4eff03b2197ae43e4c13f382e20b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd0179b7c5730f636141dfea2afcdc5a"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> IsEptHook2)</td></tr>
<tr class="memdesc:acd0179b7c5730f636141dfea2afcdc5a"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the length of active EPT hooks (!epthook and !epthook2)  <br /></td></tr>
<tr class="separator:acd0179b7c5730f636141dfea2afcdc5a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb9948249f757e97fea745b0c0d8f9b0"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#adb9948249f757e97fea745b0c0d8f9b0">EptHookUnHookSingleAddressDetours</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry)</td></tr>
<tr class="memdesc:adb9948249f757e97fea745b0c0d8f9b0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook of detours type.  <br /></td></tr>
<tr class="separator:adb9948249f757e97fea745b0c0d8f9b0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a306251376f5053ae69db0b13c3628b4e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a306251376f5053ae69db0b13c3628b4e">EptHookUnHookSingleAddressHiddenBreakpoint</a> (<a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress)</td></tr>
<tr class="memdesc:a306251376f5053ae69db0b13c3628b4e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook of hidden breakpoint type.  <br /></td></tr>
<tr class="separator:a306251376f5053ae69db0b13c3628b4e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24ce2115ab4514ec8eed08d0911b64d6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a24ce2115ab4514ec8eed08d0911b64d6">EptHookUnHookSingleAddress</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VirtualAddress, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PhysAddress, <a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> ProcessId)</td></tr>
<tr class="memdesc:a24ce2115ab4514ec8eed08d0911b64d6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove single hook from the hooked pages list and invalidate TLB.  <br /></td></tr>
<tr class="separator:a24ce2115ab4514ec8eed08d0911b64d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac8845ca75f3b4c267d3542d20621f547"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#ac8845ca75f3b4c267d3542d20621f547">EptHookUnHookAll</a> ()</td></tr>
<tr class="memdesc:ac8845ca75f3b4c267d3542d20621f547"><td class="mdescLeft">&#160;</td><td class="mdescRight">Remove all hooks from the hooked pages list and invalidate TLB @detailsShould be called from Vmx Non-root.  <br /></td></tr>
<tr class="separator:ac8845ca75f3b4c267d3542d20621f547"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d6894b9430a2758f65c2a646ee6c872"><td class="memItemLeft" align="right" valign="top">PVOID&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a2d6894b9430a2758f65c2a646ee6c872">EptHook2GeneralDetourEventHandler</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a> Regs, PVOID CalledFrom)</td></tr>
<tr class="memdesc:a2d6894b9430a2758f65c2a646ee6c872"><td class="mdescLeft">&#160;</td><td class="mdescRight">routines to generally handle breakpoint hit for detour  <br /></td></tr>
<tr class="separator:a2d6894b9430a2758f65c2a646ee6c872"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a568ee71ca657b5e7f5d613288be096b9"><td class="memItemLeft" align="right" valign="top"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_ept_hook_8c.html#a568ee71ca657b5e7f5d613288be096b9">EptHookAllocateExtraHookingPages</a> (<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Count)</td></tr>
<tr class="memdesc:a568ee71ca657b5e7f5d613288be096b9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate (reserve) extra pages for storing details of page hooks.  <br /></td></tr>
<tr class="separator:a568ee71ca657b5e7f5d613288be096b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of different EPT hidden hooks functions. </p>
<dl class="section author"><dt>Author</dt><dd>Sina Karvandi (<a href="#" onclick="location.href='mai'+'lto:'+'sin'+'a@'+'hyp'+'er'+'dbg'+'.o'+'rg'; return false;">sina@<span class="obfuscator">.nosp@m.</span>hype<span class="obfuscator">.nosp@m.</span>rdbg.<span class="obfuscator">.nosp@m.</span>org</a>)</dd></dl>
<p>All the R/W hooks, Execute hooks and hardware register simulators are implemented here</p>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2020-04-11</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>This project is released under the GNU Public License v3. </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a07e6c832deccdf103509a4d362897a7f" name="a07e6c832deccdf103509a4d362897a7f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a07e6c832deccdf103509a4d362897a7f">&#9670;&#160;</a></span>_Success_()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_Must_inspect_result_ _Success_ </td>
          <td>(</td>
          <td class="paramtype">return&#160;</td>
          <td class="paramname"> = <code>=&#160;<a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check whether the desired PhysicalAddress is already in the g_EptState-&gt;HookedPagesList hooks or not. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalBaseAddress</td><td></td></tr>
    <tr><td class="paramname">HookedEntry</td><td>A pointer to corresponding hook entry in the g_EptState-&gt;HookedPagesList</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>TRUE if the address was already hooked, or FALSE </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">   29</span>{</div>
<div class="line"><span class="lineno">   30</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno">   31</span>    {</div>
<div class="line"><span class="lineno">   32</span>        <span class="keywordflow">if</span> (CurrEntity-&gt;PhysicalBaseAddress == PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">   33</span>        {</div>
<div class="line"><span class="lineno">   34</span>            HookedEntry = CurrEntity;</div>
<div class="line"><span class="lineno">   35</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">   36</span>        }</div>
<div class="line"><span class="lineno">   37</span>    }</div>
<div class="line"><span class="lineno">   38</span> </div>
<div class="line"><span class="lineno">   39</span>    HookedEntry = NULL;</div>
<div class="line"><span class="lineno">   40</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">   41</span>}</div>
<div class="ttc" id="a_global_variables_8h_html_a302f00c62e7ad092a9f44a3aa7452d99"><div class="ttname"><a href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a></div><div class="ttdeci">EPT_STATE * g_EptState</div><div class="ttdoc">Save the state and variables related to EPT.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:50</div></div>
<div class="ttc" id="a_meta_macros_8h_html_ae6305b9ffbb1d946674b7b98431a67e9"><div class="ttname"><a href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a></div><div class="ttdeci">#define LIST_FOR_EACH_LINK(_head, _struct_type, _member, _var)</div><div class="ttdef"><b>Definition:</b> MetaMacros.h:34</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:50</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:49</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">_EPT_HOOKED_PAGE_DETAIL</a></div><div class="ttdoc">Structure to save the state of each hooked pages.</div><div class="ttdef"><b>Definition:</b> State.h:91</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a2503c5862b1bb2b779e2185b4097aa15"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">_EPT_STATE::HookedPagesList</a></div><div class="ttdeci">LIST_ENTRY HookedPagesList</div><div class="ttdef"><b>Definition:</b> Ept.h:148</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="abcbdb9cd3dbdf238b8b5d484522855e3" name="abcbdb9cd3dbdf238b8b5d484522855e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abcbdb9cd3dbdf238b8b5d484522855e3">&#9670;&#160;</a></span>EptHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHook </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook. </p>
<p>Hook in VMX Non Root Mode (hidden breakpoint)</p>
<p>this command uses hidden breakpoints (0xcc) to hook, THIS FUNCTION SHOULD BE CALLED WHEN THE VMLAUNCH ALREADY EXECUTED, it is because, broadcasting to enable exception bitmap for breakpoint is not clear here, if we want to broadcast to enable exception bitmaps on all cores when vmlaunch is not executed then that's ok but a user might call this function when we didn't configure the vmcs, it's a problem! we can solve it by giving a hint to vmcs configure function to make it ok for future configuration but that sounds stupid, I think it's better to not support this feature. Btw, debugger won't use this function in the above mentioned method, so we won't have any problem with this :)</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  444</span>{</div>
<div class="line"><span class="lineno">  445</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  446</span>    <span class="comment">// Broadcast to all cores to enable vm-exit for breakpoints (exception bitmaps)</span></div>
<div class="line"><span class="lineno">  447</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  448</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a66dc34365f51b2131a229c6975df3029">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><span class="lineno">  449</span> </div>
<div class="line"><span class="lineno">  450</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(<a class="code hl_define" href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a>, TargetAddress, <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId).Flags, NULL) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno">  451</span>    {</div>
<div class="line"><span class="lineno">  452</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Hidden breakpoint hook applied from VMX Root Mode&quot;</span>);</div>
<div class="line"><span class="lineno">  453</span> </div>
<div class="line"><span class="lineno">  454</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  455</span>        <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><span class="lineno">  456</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  457</span>        <a class="code hl_function" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><span class="lineno">  458</span> </div>
<div class="line"><span class="lineno">  459</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  460</span>    }</div>
<div class="line"><span class="lineno">  461</span> </div>
<div class="line"><span class="lineno">  462</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  463</span>    <span class="comment">// sth went wrong as we&#39;re here</span></div>
<div class="line"><span class="lineno">  464</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  465</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  466</span>}</div>
<div class="ttc" id="a_broadcast_8c_html_a5be99a073a6003a06347aa85b832060f"><div class="ttname"><a href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a></div><div class="ttdeci">VOID BroadcastNotifyAllToInvalidateEptAllCores()</div><div class="ttdoc">routines to notify to invalidate their ept on all cores</div><div class="ttdef"><b>Definition:</b> Broadcast.c:119</div></div>
<div class="ttc" id="a_inline_asm_8h_html_a0fd87b88c03b3c10883f0ad70239bf6c"><div class="ttname"><a href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a></div><div class="ttdeci">NTSTATUS AsmVmxVmcall(unsigned long long VmcallNumber, unsigned long long OptionalParam1, unsigned long long OptionalParam2, long long OptionalParam3)</div><div class="ttdoc">Request Vmcall.</div></div>
<div class="ttc" id="a_layout_8c_html_aba0911b8d51a6f7b74dd2bb70845c4b2"><div class="ttname"><a href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a></div><div class="ttdeci">_Use_decl_annotations_ CR3_TYPE LayoutGetCr3ByProcessId(UINT32 ProcessId)</div><div class="ttdoc">Converts pid to kernel cr3.</div><div class="ttdef"><b>Definition:</b> Layout.c:24</div></div>
<div class="ttc" id="a_vmcall_8h_html_aa23cf4e06f34a78d1efc1049c0c7c9a3"><div class="ttname"><a href="_vmcall_8h.html#aa23cf4e06f34a78d1efc1049c0c7c9a3">VMCALL_SET_HIDDEN_CC_BREAKPOINT</a></div><div class="ttdeci">#define VMCALL_SET_HIDDEN_CC_BREAKPOINT</div><div class="ttdoc">VMCALL to put hidden breakpoints (using EPT)</div><div class="ttdef"><b>Definition:</b> Vmcall.h:124</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_a108126279e46f4d46d25abe24da43fdc"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a></div><div class="ttdeci">#define LogDebugInfo(format,...)</div><div class="ttdoc">Log, initilize boot information and debug information.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:155</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a66dc34365f51b2131a229c6975df3029"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a66dc34365f51b2131a229c6975df3029">BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">IMPORT_EXPORT_VMM VOID BroadcastEnableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to enable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition:</b> Broadcast.c:63</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a3c5eb45ffb3514149f329aeb0cf04071" name="a3c5eb45ffb3514149f329aeb0cf04071"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3c5eb45ffb3514149f329aeb0cf04071">&#9670;&#160;</a></span>EptHook2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHook2 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>HookFunction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForRead</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>SetHookForExec</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function allocates a buffer in VMX Non Root Mode and then invokes a VMCALL to set the hook. </p>
<p>Hook in VMX Non Root Mode (hidden detours)</p>
<p>this command uses hidden detours, this NOT be called from vmx-root mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">SetHookForRead</td><td>Hook READ Access </td></tr>
    <tr><td class="paramname">SetHookForWrite</td><td>Hook WRITE Access </td></tr>
    <tr><td class="paramname">SetHookForExec</td><td>Hook EXECUTE Access </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1061</span>{</div>
<div class="line"><span class="lineno"> 1062</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> PageHookMask = 0;</div>
<div class="line"><span class="lineno"> 1063</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>  LogicalCoreIndex;</div>
<div class="line"><span class="lineno"> 1064</span> </div>
<div class="line"><span class="lineno"> 1065</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1066</span>    <span class="comment">// Check for the features to avoid EPT Violation problems</span></div>
<div class="line"><span class="lineno"> 1067</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1068</span>    <span class="keywordflow">if</span> (SetHookForExec &amp;&amp; !<a class="code hl_variable" href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a>.<a class="code hl_variable" href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#af68dba0dd8b9469e42d344f82fca8417">ExecuteOnlySupport</a>)</div>
<div class="line"><span class="lineno"> 1069</span>    {</div>
<div class="line"><span class="lineno"> 1070</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1071</span>        <span class="comment">// In the current design of hyperdbg we use execute-only pages</span></div>
<div class="line"><span class="lineno"> 1072</span>        <span class="comment">// to implement hidden hooks for exec page, so your processor doesn&#39;t</span></div>
<div class="line"><span class="lineno"> 1073</span>        <span class="comment">// have this feature and you have to implment it in other ways :(</span></div>
<div class="line"><span class="lineno"> 1074</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1075</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1076</span>    }</div>
<div class="line"><span class="lineno"> 1077</span> </div>
<div class="line"><span class="lineno"> 1078</span>    <span class="keywordflow">if</span> (!SetHookForWrite &amp;&amp; SetHookForRead)</div>
<div class="line"><span class="lineno"> 1079</span>    {</div>
<div class="line"><span class="lineno"> 1080</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1081</span>        <span class="comment">// The hidden hook with Write Enable and Read Disabled will cause EPT violation!</span></div>
<div class="line"><span class="lineno"> 1082</span>        <span class="comment">// fixed</span></div>
<div class="line"><span class="lineno"> 1083</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1084</span>    }</div>
<div class="line"><span class="lineno"> 1085</span> </div>
<div class="line"><span class="lineno"> 1086</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1087</span>    <span class="comment">// Initialize the list of ept hook detours if it&#39;s not already initialized</span></div>
<div class="line"><span class="lineno"> 1088</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1089</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a>)</div>
<div class="line"><span class="lineno"> 1090</span>    {</div>
<div class="line"><span class="lineno"> 1091</span>        <a class="code hl_variable" href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1092</span> </div>
<div class="line"><span class="lineno"> 1093</span>        <a class="code hl_function" href="list_8h.html#a71fd97aa8bac50a2f3a1d98cf680b2f4">InitializeListHead</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>);</div>
<div class="line"><span class="lineno"> 1094</span>    }</div>
<div class="line"><span class="lineno"> 1095</span> </div>
<div class="line"><span class="lineno"> 1096</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1097</span>    <span class="comment">// Check whether we are in VMX Root Mode or Not</span></div>
<div class="line"><span class="lineno"> 1098</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1099</span>    LogicalCoreIndex = KeGetCurrentProcessorIndex();</div>
<div class="line"><span class="lineno"> 1100</span> </div>
<div class="line"><span class="lineno"> 1101</span>    <span class="keywordflow">if</span> (SetHookForRead)</div>
<div class="line"><span class="lineno"> 1102</span>    {</div>
<div class="line"><span class="lineno"> 1103</span>        PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a>;</div>
<div class="line"><span class="lineno"> 1104</span>    }</div>
<div class="line"><span class="lineno"> 1105</span>    <span class="keywordflow">if</span> (SetHookForWrite)</div>
<div class="line"><span class="lineno"> 1106</span>    {</div>
<div class="line"><span class="lineno"> 1107</span>        PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a>;</div>
<div class="line"><span class="lineno"> 1108</span>    }</div>
<div class="line"><span class="lineno"> 1109</span>    <span class="keywordflow">if</span> (SetHookForExec)</div>
<div class="line"><span class="lineno"> 1110</span>    {</div>
<div class="line"><span class="lineno"> 1111</span>        PageHookMask |= <a class="code hl_define" href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a>;</div>
<div class="line"><span class="lineno"> 1112</span>    }</div>
<div class="line"><span class="lineno"> 1113</span> </div>
<div class="line"><span class="lineno"> 1114</span>    <span class="keywordflow">if</span> (PageHookMask == 0)</div>
<div class="line"><span class="lineno"> 1115</span>    {</div>
<div class="line"><span class="lineno"> 1116</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1117</span>        <span class="comment">// nothing to hook</span></div>
<div class="line"><span class="lineno"> 1118</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1119</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1120</span>    }</div>
<div class="line"><span class="lineno"> 1121</span> </div>
<div class="line"><span class="lineno"> 1122</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a54291454c7d99c90bf5e19a939825634">VmxGetCurrentLaunchState</a>())</div>
<div class="line"><span class="lineno"> 1123</span>    {</div>
<div class="line"><span class="lineno"> 1124</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1125</span>        <span class="comment">// Move Attribute Mask to the upper 32 bits of the VMCALL Number</span></div>
<div class="line"><span class="lineno"> 1126</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1127</span>        <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> VmcallNumber = ((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)PageHookMask) &lt;&lt; 32 | <a class="code hl_define" href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a>;</div>
<div class="line"><span class="lineno"> 1128</span> </div>
<div class="line"><span class="lineno"> 1129</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_inline_asm_8h.html#a0fd87b88c03b3c10883f0ad70239bf6c">AsmVmxVmcall</a>(VmcallNumber, TargetAddress, HookFunction, <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId).<a class="code hl_variable" href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">Flags</a>) == STATUS_SUCCESS)</div>
<div class="line"><span class="lineno"> 1130</span>        {</div>
<div class="line"><span class="lineno"> 1131</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1132</span>            <span class="comment">// Test log</span></div>
<div class="line"><span class="lineno"> 1133</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1134</span>            <span class="comment">// LogInfo(&quot;Hook applied from VMX Root Mode&quot;);</span></div>
<div class="line"><span class="lineno"> 1135</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1136</span> </div>
<div class="line"><span class="lineno"> 1137</span>            <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1138</span>            {</div>
<div class="line"><span class="lineno"> 1139</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1140</span>                <span class="comment">// Now we have to notify all the core to invalidate their EPT</span></div>
<div class="line"><span class="lineno"> 1141</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1142</span>                <a class="code hl_function" href="_broadcast_8c.html#a5be99a073a6003a06347aa85b832060f">BroadcastNotifyAllToInvalidateEptAllCores</a>();</div>
<div class="line"><span class="lineno"> 1143</span>            }</div>
<div class="line"><span class="lineno"> 1144</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1145</span>            {</div>
<div class="line"><span class="lineno"> 1146</span>                <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Err, unable to notify all cores to invalidate their TLB &quot;</span></div>
<div class="line"><span class="lineno"> 1147</span>                        <span class="stringliteral">&quot;caches as you called hook on vmx-root mode, however, the &quot;</span></div>
<div class="line"><span class="lineno"> 1148</span>                        <span class="stringliteral">&quot;hook is still works&quot;</span>);</div>
<div class="line"><span class="lineno"> 1149</span>            }</div>
<div class="line"><span class="lineno"> 1150</span> </div>
<div class="line"><span class="lineno"> 1151</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1152</span>        }</div>
<div class="line"><span class="lineno"> 1153</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1154</span>        {</div>
<div class="line"><span class="lineno"> 1155</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1156</span>        }</div>
<div class="line"><span class="lineno"> 1157</span>    }</div>
<div class="line"><span class="lineno"> 1158</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1159</span>    {</div>
<div class="line"><span class="lineno"> 1160</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="_ept_hook_8c.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a>(TargetAddress,</div>
<div class="line"><span class="lineno"> 1161</span>                                    HookFunction,</div>
<div class="line"><span class="lineno"> 1162</span>                                    <a class="code hl_function" href="_layout_8c.html#aba0911b8d51a6f7b74dd2bb70845c4b2">LayoutGetCr3ByProcessId</a>(ProcessId),</div>
<div class="line"><span class="lineno"> 1163</span>                                    SetHookForRead,</div>
<div class="line"><span class="lineno"> 1164</span>                                    SetHookForWrite,</div>
<div class="line"><span class="lineno"> 1165</span>                                    SetHookForExec) == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1166</span>        {</div>
<div class="line"><span class="lineno"> 1167</span>            <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;Hook applied (VM has not launched)&quot;</span>);</div>
<div class="line"><span class="lineno"> 1168</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1169</span>        }</div>
<div class="line"><span class="lineno"> 1170</span>    }</div>
<div class="line"><span class="lineno"> 1171</span> </div>
<div class="line"><span class="lineno"> 1172</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1173</span>    <span class="comment">// There was a error, we shouldn&#39;t reach here</span></div>
<div class="line"><span class="lineno"> 1174</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1175</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a>(<span class="stringliteral">&quot;Err, hook was not applied&quot;</span>);</div>
<div class="line"><span class="lineno"> 1176</span> </div>
<div class="line"><span class="lineno"> 1177</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1178</span>}</div>
<div class="ttc" id="a_ept_8h_html_a31b07aec49a907dc08696d9595c08e5f"><div class="ttname"><a href="_ept_8h.html#a31b07aec49a907dc08696d9595c08e5f">PAGE_ATTRIB_EXEC</a></div><div class="ttdeci">#define PAGE_ATTRIB_EXEC</div><div class="ttdef"><b>Definition:</b> Ept.h:24</div></div>
<div class="ttc" id="a_ept_8h_html_a57f919b94c67edb76b752a2ca83b534a"><div class="ttname"><a href="_ept_8h.html#a57f919b94c67edb76b752a2ca83b534a">PAGE_ATTRIB_READ</a></div><div class="ttdeci">#define PAGE_ATTRIB_READ</div><div class="ttdoc">Page attributes for internal use.</div><div class="ttdef"><b>Definition:</b> Ept.h:22</div></div>
<div class="ttc" id="a_ept_8h_html_a6a23c222f617b62cc621b5482a378d8a"><div class="ttname"><a href="_ept_8h.html#a6a23c222f617b62cc621b5482a378d8a">PAGE_ATTRIB_WRITE</a></div><div class="ttdeci">#define PAGE_ATTRIB_WRITE</div><div class="ttdef"><b>Definition:</b> Ept.h:23</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a77e3785963c79b3ff0efdf13efe0be13"><div class="ttname"><a href="_ept_hook_8c.html#a77e3785963c79b3ff0efdf13efe0be13">EptHookPerformPageHook2</a></div><div class="ttdeci">BOOLEAN EptHookPerformPageHook2(PVOID TargetAddress, PVOID HookFunction, CR3_TYPE ProcessCr3, BOOLEAN UnsetRead, BOOLEAN UnsetWrite, BOOLEAN UnsetExecute)</div><div class="ttdoc">The main function that performs EPT page hook with hidden detours and monitor.</div><div class="ttdef"><b>Definition:</b> EptHook.c:775</div></div>
<div class="ttc" id="a_global_variables_8h_html_a3c92f787270f29f40a4fb1b3440a3baa"><div class="ttname"><a href="_global_variables_8h.html#a3c92f787270f29f40a4fb1b3440a3baa">g_CompatibilityCheck</a></div><div class="ttdeci">COMPATIBILITY_CHECKS_STATUS g_CompatibilityCheck</div><div class="ttdoc">Different attributes and compatibility checks of the current processor.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:26</div></div>
<div class="ttc" id="a_global_variables_8h_html_a6e5074e59b6770a1b187d7e2d50f00bb"><div class="ttname"><a href="_global_variables_8h.html#a6e5074e59b6770a1b187d7e2d50f00bb">g_IsEptHook2sDetourListInitialized</a></div><div class="ttdeci">BOOLEAN g_IsEptHook2sDetourListInitialized</div><div class="ttdoc">List header of hidden hooks detour.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:68</div></div>
<div class="ttc" id="a_global_variables_8h_html_a90f5a18f43567010690d8d7927619fa0"><div class="ttname"><a href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a></div><div class="ttdeci">LIST_ENTRY g_EptHook2sDetourListHead</div><div class="ttdoc">List header of hidden hooks detour.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:62</div></div>
<div class="ttc" id="a_vmcall_8h_html_a2f893b27a9a2cedec9f4c499011dce0a"><div class="ttname"><a href="_vmcall_8h.html#a2f893b27a9a2cedec9f4c499011dce0a">VMCALL_CHANGE_PAGE_ATTRIB</a></div><div class="ttdeci">#define VMCALL_CHANGE_PAGE_ATTRIB</div><div class="ttdoc">VMCALL to Hook Change the attribute bits of the EPT Table.</div><div class="ttdef"><b>Definition:</b> Vmcall.h:34</div></div>
<div class="ttc" id="a_vmx_8c_html_a21a5facaf10e8fbeb70dd00942e51ef1"><div class="ttname"><a href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a></div><div class="ttdeci">BOOLEAN VmxGetCurrentExecutionMode()</div><div class="ttdoc">Check current execution mode (vmx-root and non-root)</div><div class="ttdef"><b>Definition:</b> Vmx.c:76</div></div>
<div class="ttc" id="a_vmx_8c_html_a54291454c7d99c90bf5e19a939825634"><div class="ttname"><a href="_vmx_8c.html#a54291454c7d99c90bf5e19a939825634">VmxGetCurrentLaunchState</a></div><div class="ttdeci">BOOLEAN VmxGetCurrentLaunchState()</div><div class="ttdoc">Check if the VMX is launched or not.</div><div class="ttdef"><b>Definition:</b> Vmx.c:100</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_aae17ebb9ef7279d026817fb22f8aebe9"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a></div><div class="ttdeci">unsigned __int64 UINT64</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:19</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_ae1e6edbbc26d6fbc71a90190d0266018"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a></div><div class="ttdeci">unsigned int UINT32</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:46</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_af632da489ebc3708ec3ab6791ee53fa4"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a></div><div class="ttdeci">unsigned long ULONG</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:35</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_a97b0adbd65790fb90734daa8e5245a04"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a></div><div class="ttdeci">#define LogInfo(format,...)</div><div class="ttdoc">Define log variables.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:71</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_abf506c814a6f717a87b5d808b828ef56"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#abf506c814a6f717a87b5d808b828ef56">LogWarning</a></div><div class="ttdeci">#define LogWarning(format,...)</div><div class="ttdoc">Log in the case of warning.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:99</div></div>
<div class="ttc" id="alist_8h_html_a71fd97aa8bac50a2f3a1d98cf680b2f4"><div class="ttname"><a href="list_8h.html#a71fd97aa8bac50a2f3a1d98cf680b2f4">InitializeListHead</a></div><div class="ttdeci">void InitializeListHead(PLIST_ENTRY ListHead)</div></div>
<div class="ttc" id="astruct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s_html_af68dba0dd8b9469e42d344f82fca8417"><div class="ttname"><a href="struct___c_o_m_p_a_t_i_b_i_l_i_t_y___c_h_e_c_k_s___s_t_a_t_u_s.html#af68dba0dd8b9469e42d344f82fca8417">_COMPATIBILITY_CHECKS_STATUS::ExecuteOnlySupport</a></div><div class="ttdeci">BOOLEAN ExecuteOnlySupport</div><div class="ttdef"><b>Definition:</b> CompatibilityChecks.h:29</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html_a04eb96cc99b0458be739bcc9c640e08b"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html#a04eb96cc99b0458be739bcc9c640e08b">_CR3_TYPE::Flags</a></div><div class="ttdeci">UINT64 Flags</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:139</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a2d6894b9430a2758f65c2a646ee6c872" name="a2d6894b9430a2758f65c2a646ee6c872"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d6894b9430a2758f65c2a646ee6c872">&#9670;&#160;</a></span>EptHook2GeneralDetourEventHandler()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PVOID EptHook2GeneralDetourEventHandler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a2bd4673df5e6e2fb371d770f3f2886d9">PGUEST_REGS</a>&#160;</td>
          <td class="paramname"><em>Regs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>CalledFrom</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>routines to generally handle breakpoint hit for detour </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Regs</td><td></td></tr>
    <tr><td class="paramname">CalledFrom</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PVOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1656</span>{</div>
<div class="line"><span class="lineno"> 1657</span>    PLIST_ENTRY       TempList    = 0;</div>
<div class="line"><span class="lineno"> 1658</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html">EPT_HOOKS_CONTEXT</a> TempContext = {0};</div>
<div class="line"><span class="lineno"> 1659</span> </div>
<div class="line"><span class="lineno"> 1660</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1661</span>    <span class="comment">// The RSP register is the at the RCX and we just added (reverse by stack) to it&#39;s</span></div>
<div class="line"><span class="lineno"> 1662</span>    <span class="comment">// values by the size of the GUEST_REGS</span></div>
<div class="line"><span class="lineno"> 1663</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1664</span>    Regs-&gt;<a class="code hl_variable" href="struct_g_u_e_s_t___r_e_g_s.html#a04918d3fe8010c01a6bd3f1ba4e11bc2">rsp</a> = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)Regs - <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct_g_u_e_s_t___r_e_g_s.html">GUEST_REGS</a>);</div>
<div class="line"><span class="lineno"> 1665</span> </div>
<div class="line"><span class="lineno"> 1666</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1667</span>    <span class="comment">// test</span></div>
<div class="line"><span class="lineno"> 1668</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1669</span> </div>
<div class="line"><span class="lineno"> 1670</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1671</span>    <span class="comment">// LogInfo(&quot;Hidden Hooked function Called with : rcx = 0x%llx , rdx = 0x%llx , r8 = 0x%llx ,  r9 = 0x%llx&quot;,</span></div>
<div class="line"><span class="lineno"> 1672</span>    <span class="comment">//        Regs-&gt;rcx,</span></div>
<div class="line"><span class="lineno"> 1673</span>    <span class="comment">//        Regs-&gt;rdx,</span></div>
<div class="line"><span class="lineno"> 1674</span>    <span class="comment">//        Regs-&gt;r8,</span></div>
<div class="line"><span class="lineno"> 1675</span>    <span class="comment">//        Regs-&gt;r9);</span></div>
<div class="line"><span class="lineno"> 1676</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1677</span> </div>
<div class="line"><span class="lineno"> 1678</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1679</span>    <span class="comment">// Create temporary context</span></div>
<div class="line"><span class="lineno"> 1680</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1681</span>    TempContext.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">VirtualAddress</a>  = CalledFrom;</div>
<div class="line"><span class="lineno"> 1682</span>    TempContext.<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">PhysicalAddress</a> = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a9c177c471eaf6be292a94d8112fa3f36">VirtualAddressToPhysicalAddress</a>(CalledFrom);</div>
<div class="line"><span class="lineno"> 1683</span> </div>
<div class="line"><span class="lineno"> 1684</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1685</span>    <span class="comment">// Create a temporary VCpu</span></div>
<div class="line"><span class="lineno"> 1686</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1687</span>    <a class="code hl_struct" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">VIRTUAL_MACHINE_STATE</a> * VCpu = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a>[KeGetCurrentProcessorNumber()];</div>
<div class="line"><span class="lineno"> 1688</span> </div>
<div class="line"><span class="lineno"> 1689</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1690</span>    <span class="comment">// Set the register for the temporary VCpu</span></div>
<div class="line"><span class="lineno"> 1691</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1692</span>    VCpu-&gt;<a class="code hl_variable" href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aae00ab92fdce5f90e65edb3bd10ae696">Regs</a> = Regs;</div>
<div class="line"><span class="lineno"> 1693</span> </div>
<div class="line"><span class="lineno"> 1694</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1695</span>    <span class="comment">// As the context to event trigger, we send the address of function</span></div>
<div class="line"><span class="lineno"> 1696</span>    <span class="comment">// which is current hidden hook is triggered for it</span></div>
<div class="line"><span class="lineno"> 1697</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1698</span>    <a class="code hl_function" href="_dispatch_8c.html#abdd5d2cff9ea39a842046b1af7a72c51">DispatchEventHiddenHookExecDetours</a>(VCpu, &amp;TempContext);</div>
<div class="line"><span class="lineno"> 1699</span> </div>
<div class="line"><span class="lineno"> 1700</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1701</span>    <span class="comment">// Iterate through the list of hooked pages details to find</span></div>
<div class="line"><span class="lineno"> 1702</span>    <span class="comment">// and return where want to jump after this functions</span></div>
<div class="line"><span class="lineno"> 1703</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1704</span>    TempList = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>;</div>
<div class="line"><span class="lineno"> 1705</span> </div>
<div class="line"><span class="lineno"> 1706</span>    <span class="keywordflow">while</span> (&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a> != TempList-&gt;Flink)</div>
<div class="line"><span class="lineno"> 1707</span>    {</div>
<div class="line"><span class="lineno"> 1708</span>        TempList                                          = TempList-&gt;Flink;</div>
<div class="line"><span class="lineno"> 1709</span>        <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">PHIDDEN_HOOKS_DETOUR_DETAILS</a> CurrentHookedDetails = <a class="code hl_define" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>, OtherHooksList);</div>
<div class="line"><span class="lineno"> 1710</span> </div>
<div class="line"><span class="lineno"> 1711</span>        <span class="keywordflow">if</span> (CurrentHookedDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">HookedFunctionAddress</a> == CalledFrom)</div>
<div class="line"><span class="lineno"> 1712</span>        {</div>
<div class="line"><span class="lineno"> 1713</span>            <span class="keywordflow">return</span> CurrentHookedDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">ReturnAddress</a>;</div>
<div class="line"><span class="lineno"> 1714</span>        }</div>
<div class="line"><span class="lineno"> 1715</span>    }</div>
<div class="line"><span class="lineno"> 1716</span> </div>
<div class="line"><span class="lineno"> 1717</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1718</span>    <span class="comment">// If we reach here, means that we didn&#39;t find the return address</span></div>
<div class="line"><span class="lineno"> 1719</span>    <span class="comment">// that&#39;s an error, generally we can&#39;t do anything but as the user</span></div>
<div class="line"><span class="lineno"> 1720</span>    <span class="comment">// might already cleaned the hook and the structures are removed</span></div>
<div class="line"><span class="lineno"> 1721</span>    <span class="comment">// so we just return the original caller address and continue the</span></div>
<div class="line"><span class="lineno"> 1722</span>    <span class="comment">// guest normally</span></div>
<div class="line"><span class="lineno"> 1723</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1724</span>    <span class="keywordflow">return</span> CalledFrom;</div>
<div class="line"><span class="lineno"> 1725</span>}</div>
<div class="ttc" id="a_dispatch_8c_html_abdd5d2cff9ea39a842046b1af7a72c51"><div class="ttname"><a href="_dispatch_8c.html#abdd5d2cff9ea39a842046b1af7a72c51">DispatchEventHiddenHookExecDetours</a></div><div class="ttdeci">VOID DispatchEventHiddenHookExecDetours(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context)</div><div class="ttdoc">Handling debugger functions related to hidden hook exec detours events.</div><div class="ttdef"><b>Definition:</b> Dispatch.c:875</div></div>
<div class="ttc" id="a_global_variables_8h_html_a04bac1f4beef0dcf1ce1a4d9ce72ea76"><div class="ttname"><a href="_global_variables_8h.html#a04bac1f4beef0dcf1ce1a4d9ce72ea76">g_GuestState</a></div><div class="ttdeci">VIRTUAL_MACHINE_STATE * g_GuestState</div><div class="ttdoc">Save the state and variables related to virtualization on each to logical core.</div><div class="ttdef"><b>Definition:</b> GlobalVariables.h:38</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a9c177c471eaf6be292a94d8112fa3f36"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a9c177c471eaf6be292a94d8112fa3f36">VirtualAddressToPhysicalAddress</a></div><div class="ttdeci">IMPORT_EXPORT_VMM UINT64 VirtualAddressToPhysicalAddress(_In_ PVOID VirtualAddress)</div><div class="ttdoc">Converts Virtual Address to Physical Address.</div><div class="ttdef"><b>Definition:</b> Conversion.c:156</div></div>
<div class="ttc" id="alist_8h_html_adec42d53dc3b3e16ab7a1cd98af1c5fc"><div class="ttname"><a href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a></div><div class="ttdeci">#define CONTAINING_RECORD(address, type, field)</div><div class="ttdef"><b>Definition:</b> list.h:14</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html">_EPT_HOOKS_CONTEXT</a></div><div class="ttdoc">Temporary $context used in some EPT hook commands.</div><div class="ttdef"><b>Definition:</b> DataTypes.h:248</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html_a2f5080d315f72646f57eda6e61e1aff1"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">_EPT_HOOKS_CONTEXT::VirtualAddress</a></div><div class="ttdeci">UINT64 VirtualAddress</div><div class="ttdef"><b>Definition:</b> DataTypes.h:250</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t_html_afc81b90725dc9bc78a4a7b0cdf5a314b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">_EPT_HOOKS_CONTEXT::PhysicalAddress</a></div><div class="ttdeci">UINT64 PhysicalAddress</div><div class="ttdef"><b>Definition:</b> DataTypes.h:249</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">_HIDDEN_HOOKS_DETOUR_DETAILS</a></div><div class="ttdoc">Details of detours style EPT hooks.</div><div class="ttdef"><b>Definition:</b> Hooks.h:74</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_a5b7e945d9dd258586acd7e0268c8f11a"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">_HIDDEN_HOOKS_DETOUR_DETAILS::HookedFunctionAddress</a></div><div class="ttdeci">PVOID HookedFunctionAddress</div><div class="ttdef"><b>Definition:</b> Hooks.h:76</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_a89757e40877fd300bf09ab3b45642f28"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">_HIDDEN_HOOKS_DETOUR_DETAILS::ReturnAddress</a></div><div class="ttdeci">PVOID ReturnAddress</div><div class="ttdef"><b>Definition:</b> Hooks.h:77</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html">_VIRTUAL_MACHINE_STATE</a></div><div class="ttdoc">The status of each core after and before VMX.</div><div class="ttdef"><b>Definition:</b> State.h:208</div></div>
<div class="ttc" id="astruct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e_html_aae00ab92fdce5f90e65edb3bd10ae696"><div class="ttname"><a href="struct___v_i_r_t_u_a_l___m_a_c_h_i_n_e___s_t_a_t_e.html#aae00ab92fdce5f90e65edb3bd10ae696">_VIRTUAL_MACHINE_STATE::Regs</a></div><div class="ttdeci">GUEST_REGS * Regs</div><div class="ttdef"><b>Definition:</b> State.h:223</div></div>
<div class="ttc" id="astruct_g_u_e_s_t___r_e_g_s_html"><div class="ttname"><a href="struct_g_u_e_s_t___r_e_g_s.html">GUEST_REGS</a></div><div class="ttdef"><b>Definition:</b> BasicTypes.h:65</div></div>
<div class="ttc" id="astruct_g_u_e_s_t___r_e_g_s_html_a04918d3fe8010c01a6bd3f1ba4e11bc2"><div class="ttname"><a href="struct_g_u_e_s_t___r_e_g_s.html#a04918d3fe8010c01a6bd3f1ba4e11bc2">GUEST_REGS::rsp</a></div><div class="ttdeci">UINT64 rsp</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:74</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a568ee71ca657b5e7f5d613288be096b9" name="a568ee71ca657b5e7f5d613288be096b9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a568ee71ca657b5e7f5d613288be096b9">&#9670;&#160;</a></span>EptHookAllocateExtraHookingPages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookAllocateExtraHookingPages </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>Count</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocate (reserve) extra pages for storing details of page hooks. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Count</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1735</span>{</div>
<div class="line"><span class="lineno"> 1736</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1737</span>    <span class="comment">// Request pages to be allocated for converting 2MB to 4KB pages</span></div>
<div class="line"><span class="lineno"> 1738</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1739</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aea915a9cf9f226a53f538d496ea7fa40">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>),</div>
<div class="line"><span class="lineno"> 1740</span>                                 Count,</div>
<div class="line"><span class="lineno"> 1741</span>                                 <a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>);</div>
<div class="line"><span class="lineno"> 1742</span> </div>
<div class="line"><span class="lineno"> 1743</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1744</span>    <span class="comment">// Request pages to be allocated for paged hook details</span></div>
<div class="line"><span class="lineno"> 1745</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1746</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aea915a9cf9f226a53f538d496ea7fa40">PoolManagerRequestAllocation</a>(<span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>),</div>
<div class="line"><span class="lineno"> 1747</span>                                 Count,</div>
<div class="line"><span class="lineno"> 1748</span>                                 <a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>);</div>
<div class="line"><span class="lineno"> 1749</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a></div><div class="ttdeci">@ SPLIT_2MB_PAGING_TO_4KB_PAGE</div><div class="ttdef"><b>Definition:</b> DataTypes.h:43</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a></div><div class="ttdeci">@ TRACKING_HOOKED_PAGES</div><div class="ttdef"><b>Definition:</b> DataTypes.h:41</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_aea915a9cf9f226a53f538d496ea7fa40"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aea915a9cf9f226a53f538d496ea7fa40">PoolManagerRequestAllocation</a></div><div class="ttdeci">IMPORT_EXPORT_VMM BOOLEAN PoolManagerRequestAllocation(SIZE_T Size, UINT32 Count, POOL_ALLOCATION_INTENTION Intention)</div><div class="ttdoc">Request to allocate new buffers.</div><div class="ttdef"><b>Definition:</b> PoolManager.c:442</div></div>
<div class="ttc" id="astruct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t_html"><div class="ttname"><a href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">_VMM_EPT_DYNAMIC_SPLIT</a></div><div class="ttdoc">Split 2MB granularity to 4 KB granularity.</div><div class="ttdef"><b>Definition:</b> Ept.h:167</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acd0179b7c5730f636141dfea2afcdc5a" name="acd0179b7c5730f636141dfea2afcdc5a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd0179b7c5730f636141dfea2afcdc5a">&#9670;&#160;</a></span>EptHookGetCountOfEpthooks()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> EptHookGetCountOfEpthooks </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>IsEptHook2</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the length of active EPT hooks (!epthook and !epthook2) </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">IsEptHook2</td><td>Whether the length should be for !epthook or !epthook2</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>UINT32 Count of remained breakpoints </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1330</span>{</div>
<div class="line"><span class="lineno"> 1331</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> Count = 0;</div>
<div class="line"><span class="lineno"> 1332</span> </div>
<div class="line"><span class="lineno"> 1333</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, HookedEntry)</div>
<div class="line"><span class="lineno"> 1334</span>    {</div>
<div class="line"><span class="lineno"> 1335</span>        <span class="keywordflow">if</span> (IsEptHook2)</div>
<div class="line"><span class="lineno"> 1336</span>        {</div>
<div class="line"><span class="lineno"> 1337</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;IsHiddenBreakpoint == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno"> 1338</span>            {</div>
<div class="line"><span class="lineno"> 1339</span>                Count++;</div>
<div class="line"><span class="lineno"> 1340</span>            }</div>
<div class="line"><span class="lineno"> 1341</span>        }</div>
<div class="line"><span class="lineno"> 1342</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1343</span>        {</div>
<div class="line"><span class="lineno"> 1344</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;IsHiddenBreakpoint == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1345</span>            {</div>
<div class="line"><span class="lineno"> 1346</span>                Count++;</div>
<div class="line"><span class="lineno"> 1347</span>            }</div>
<div class="line"><span class="lineno"> 1348</span>        }</div>
<div class="line"><span class="lineno"> 1349</span>    }</div>
<div class="line"><span class="lineno"> 1350</span> </div>
<div class="line"><span class="lineno"> 1351</span>    <span class="keywordflow">return</span> Count;</div>
<div class="line"><span class="lineno"> 1352</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a3d7fb010ec1756aa2f27e861271fc0f0" name="a3d7fb010ec1756aa2f27e861271fc0f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d7fb010ec1756aa2f27e861271fc0f0">&#9670;&#160;</a></span>EptHookHandleHookedPage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookHandleHookedPage </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#ac81d4d9bd1e8dd24918e667b56b67b7e">VIRTUAL_MACHINE_STATE</a> *&#160;</td>
          <td class="paramname"><em>VCpu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a2ef230620f7c5617f62c8022159293fb">EPT_HOOKED_PAGE_DETAIL</a> *&#160;</td>
          <td class="paramname"><em>HookedEntryDetails</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">VMX_EXIT_QUALIFICATION_EPT_VIOLATION&#160;</td>
          <td class="paramname"><em>ViolationQualification</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#a732f5fb65b66d5b23321a9b1c69e64d1">EPT_HOOKS_CONTEXT</a> *&#160;</td>
          <td class="paramname"><em>LastContext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *&#160;</td>
          <td class="paramname"><em>IgnoreReadOrWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> *&#160;</td>
          <td class="paramname"><em>IsTriggeringPostEventAllowed</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Handles page hooks. </p>
<p>Handle hooked pages in Vmx-root mode.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VCpu</td><td>The virtual processor's state </td></tr>
    <tr><td class="paramname">HookedEntryDetails</td><td>The entry that describes the hooked page </td></tr>
    <tr><td class="paramname">ViolationQualification</td><td>The exit qualification of vm-exit </td></tr>
    <tr><td class="paramname">PhysicalAddress</td><td>The physical address that cause this vm-exit </td></tr>
    <tr><td class="paramname">LastContext</td><td>The last (current) context of the execution </td></tr>
    <tr><td class="paramname">IgnoreReadOrWrite</td><td>Whether to ignore the event effects or not </td></tr>
    <tr><td class="paramname">IsTriggeringPostEventAllowed</td><td>Whether the caller should consider executing the post triggering of the event or not</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns TRUE if the function was hook was handled or returns false if there was an unexpected ept violation </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1203</span>{</div>
<div class="line"><span class="lineno"> 1204</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> GuestRip;</div>
<div class="line"><span class="lineno"> 1205</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> ExactAccessedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1206</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> AlignedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1207</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> AlignedPhysicalAddress;</div>
<div class="line"><span class="lineno"> 1208</span> </div>
<div class="line"><span class="lineno"> 1209</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1210</span>    <span class="comment">// Get alignment</span></div>
<div class="line"><span class="lineno"> 1211</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1212</span>    AlignedVirtualAddress  = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(HookedEntryDetails-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><span class="lineno"> 1213</span>    AlignedPhysicalAddress = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(PhysicalAddress);</div>
<div class="line"><span class="lineno"> 1214</span> </div>
<div class="line"><span class="lineno"> 1215</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1216</span>    <span class="comment">// Let&#39;s read the exact address that was accessed</span></div>
<div class="line"><span class="lineno"> 1217</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1218</span>    ExactAccessedVirtualAddress = AlignedVirtualAddress + PhysicalAddress - AlignedPhysicalAddress;</div>
<div class="line"><span class="lineno"> 1219</span> </div>
<div class="line"><span class="lineno"> 1220</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1221</span>    <span class="comment">// Set the last context</span></div>
<div class="line"><span class="lineno"> 1222</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1223</span>    LastContext-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#afc81b90725dc9bc78a4a7b0cdf5a314b">PhysicalAddress</a> = PhysicalAddress;</div>
<div class="line"><span class="lineno"> 1224</span>    LastContext-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_s___c_o_n_t_e_x_t.html#a2f5080d315f72646f57eda6e61e1aff1">VirtualAddress</a>  = ExactAccessedVirtualAddress;</div>
<div class="line"><span class="lineno"> 1225</span> </div>
<div class="line"><span class="lineno"> 1226</span>    <span class="keywordflow">if</span> (!ViolationQualification.EptExecutable &amp;&amp; ViolationQualification.ExecuteAccess)</div>
<div class="line"><span class="lineno"> 1227</span>    {</div>
<div class="line"><span class="lineno"> 1228</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1229</span>        <span class="comment">// Reading guest&#39;s RIP</span></div>
<div class="line"><span class="lineno"> 1230</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1231</span>        __vmx_vmread(VMCS_GUEST_RIP, &amp;GuestRip);</div>
<div class="line"><span class="lineno"> 1232</span> </div>
<div class="line"><span class="lineno"> 1233</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1234</span>        <span class="comment">// Generally, we should never reach here, we didn&#39;t implement HyperDbg like this ;)</span></div>
<div class="line"><span class="lineno"> 1235</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1236</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, Guest RIP : 0x%llx tries to execute the page at : 0x%llx&quot;</span>, GuestRip, ExactAccessedVirtualAddress);</div>
<div class="line"><span class="lineno"> 1237</span>    }</div>
<div class="line"><span class="lineno"> 1238</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.EptWriteable &amp;&amp; ViolationQualification.WriteAccess)</div>
<div class="line"><span class="lineno"> 1239</span>    {</div>
<div class="line"><span class="lineno"> 1240</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1241</span>        <span class="comment">// Test</span></div>
<div class="line"><span class="lineno"> 1242</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1243</span> </div>
<div class="line"><span class="lineno"> 1244</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1245</span>        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to write on the page at :0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><span class="lineno"> 1246</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1247</span> </div>
<div class="line"><span class="lineno"> 1248</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1249</span>        <span class="comment">// Trigger the event related to Monitor Write and Monitor Read &amp; Write</span></div>
<div class="line"><span class="lineno"> 1250</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1251</span>        *IgnoreReadOrWrite = <a class="code hl_function" href="_dispatch_8c.html#ac6048cec3cc762c6c25a7a4c56f1c9e7">DispatchEventHiddenHookPageReadWriteWritePreEvent</a>(VCpu, LastContext, IsTriggeringPostEventAllowed);</div>
<div class="line"><span class="lineno"> 1252</span>    }</div>
<div class="line"><span class="lineno"> 1253</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ViolationQualification.EptReadable &amp;&amp; ViolationQualification.ReadAccess)</div>
<div class="line"><span class="lineno"> 1254</span>    {</div>
<div class="line"><span class="lineno"> 1255</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1256</span>        <span class="comment">// Test</span></div>
<div class="line"><span class="lineno"> 1257</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1258</span> </div>
<div class="line"><span class="lineno"> 1259</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1260</span>        <span class="comment">// LogInfo(&quot;Guest RIP : 0x%llx tries to read the page at :0x%llx&quot;, GuestRip, ExactAccessedAddress);</span></div>
<div class="line"><span class="lineno"> 1261</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1262</span> </div>
<div class="line"><span class="lineno"> 1263</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1264</span>        <span class="comment">// Trigger the event related to Monitor Read and Monitor Read &amp; Write</span></div>
<div class="line"><span class="lineno"> 1265</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1266</span>        *IgnoreReadOrWrite = <a class="code hl_function" href="_dispatch_8c.html#abf10d45341868fb3378f123b59fc99ec">DispatchEventHiddenHookPageReadWriteReadPreEvent</a>(VCpu, LastContext, IsTriggeringPostEventAllowed);</div>
<div class="line"><span class="lineno"> 1267</span>    }</div>
<div class="line"><span class="lineno"> 1268</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1269</span>    {</div>
<div class="line"><span class="lineno"> 1270</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1271</span>        <span class="comment">// there was an unexpected ept violation</span></div>
<div class="line"><span class="lineno"> 1272</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1273</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1274</span>    }</div>
<div class="line"><span class="lineno"> 1275</span> </div>
<div class="line"><span class="lineno"> 1276</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1277</span>    <span class="comment">// Means that restore the Entry to the previous state after current</span></div>
<div class="line"><span class="lineno"> 1278</span>    <span class="comment">// instruction executed in the guest</span></div>
<div class="line"><span class="lineno"> 1279</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1280</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1281</span>}</div>
<div class="ttc" id="a_dispatch_8c_html_abf10d45341868fb3378f123b59fc99ec"><div class="ttname"><a href="_dispatch_8c.html#abf10d45341868fb3378f123b59fc99ec">DispatchEventHiddenHookPageReadWriteReadPreEvent</a></div><div class="ttdeci">BOOLEAN DispatchEventHiddenHookPageReadWriteReadPreEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context, BOOLEAN *IsTriggeringPostEventAllowed)</div><div class="ttdoc">Handling debugger functions related to read &amp; write, read events (pre)</div><div class="ttdef"><b>Definition:</b> Dispatch.c:955</div></div>
<div class="ttc" id="a_dispatch_8c_html_ac6048cec3cc762c6c25a7a4c56f1c9e7"><div class="ttname"><a href="_dispatch_8c.html#ac6048cec3cc762c6c25a7a4c56f1c9e7">DispatchEventHiddenHookPageReadWriteWritePreEvent</a></div><div class="ttdeci">BOOLEAN DispatchEventHiddenHookPageReadWriteWritePreEvent(VIRTUAL_MACHINE_STATE *VCpu, PVOID Context, BOOLEAN *IsTriggeringPostEventAllowed)</div><div class="ttdoc">Handling debugger functions related to read &amp; write, write events (pre)</div><div class="ttdef"><b>Definition:</b> Dispatch.c:899</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h_html_a459b19922fecfbb9438dd56b66930d16"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a></div><div class="ttdeci">#define LogError(format,...)</div><div class="ttdoc">Log in the case of error.</div><div class="ttdef"><b>Definition:</b> HyperDbgHyperLogIntrinsics.h:113</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_aa02188de52b66a3aa5e1aecc6bd963ae"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a></div><div class="ttdeci">#define PAGE_ALIGN(Va)</div><div class="ttdoc">Aligning a page.</div><div class="ttdef"><b>Definition:</b> common.h:65</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a3464acbaf76a38d67558d8ff3bee342f"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">_EPT_HOOKED_PAGE_DETAIL::VirtualAddress</a></div><div class="ttdeci">UINT64 VirtualAddress</div><div class="ttdoc">The virtual address from the caller prespective view (cr3)</div><div class="ttdef"><b>Definition:</b> State.h:103</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a1a97cf8a3d1243edf02539139bbfb617" name="a1a97cf8a3d1243edf02539139bbfb617"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1a97cf8a3d1243edf02539139bbfb617">&#9670;&#160;</a></span>EptHookInstructionMemory()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookInstructionMemory </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a>&#160;</td>
          <td class="paramname"><em>Hook</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>ProcessCr3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetFunction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetFunctionInSafeMemory</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>HookFunction</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook ins. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Hook</td><td>The details of hooked pages </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The target Process CR3 </td></tr>
    <tr><td class="paramname">TargetFunction</td><td>Target function that needs to be hooked </td></tr>
    <tr><td class="paramname">TargetFunctionInSafeMemory</td><td>Target content in the safe memory (used in Length Disassembler Engine) </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or returns false if it was not successful </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  636</span>{</div>
<div class="line"><span class="lineno">  637</span>    <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">PHIDDEN_HOOKS_DETOUR_DETAILS</a> DetourHookDetails;</div>
<div class="line"><span class="lineno">  638</span>    SIZE_T                       SizeOfHookedInstructions;</div>
<div class="line"><span class="lineno">  639</span>    SIZE_T                       OffsetIntoPage;</div>
<div class="line"><span class="lineno">  640</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                     Cr3OfCurrentProcess;</div>
<div class="line"><span class="lineno">  641</span> </div>
<div class="line"><span class="lineno">  642</span>    OffsetIntoPage = <a class="code hl_define" href="_ept_8h.html#a2faab1a93d36f8a2d9ae5c79de293300">ADDRMASK_EPT_PML1_OFFSET</a>((SIZE_T)TargetFunction);</div>
<div class="line"><span class="lineno">  643</span> </div>
<div class="line"><span class="lineno">  644</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  645</span>    <span class="comment">// Log offset</span></div>
<div class="line"><span class="lineno">  646</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  647</span>    <span class="comment">// LogInfo(&quot;OffsetIntoPage: 0x%llx&quot;, OffsetIntoPage);</span></div>
<div class="line"><span class="lineno">  648</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  649</span> </div>
<div class="line"><span class="lineno">  650</span>    <span class="keywordflow">if</span> ((OffsetIntoPage + 19) &gt; <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a> - 1)</div>
<div class="line"><span class="lineno">  651</span>    {</div>
<div class="line"><span class="lineno">  652</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, function extends past a page boundary&quot;</span>);</div>
<div class="line"><span class="lineno">  653</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  654</span>    }</div>
<div class="line"><span class="lineno">  655</span> </div>
<div class="line"><span class="lineno">  656</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  657</span>    <span class="comment">// Determine the number of instructions necessary to overwrite using Length Disassembler Engine</span></div>
<div class="line"><span class="lineno">  658</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  659</span>    <span class="keywordflow">for</span> (SizeOfHookedInstructions = 0;</div>
<div class="line"><span class="lineno">  660</span>         SizeOfHookedInstructions &lt; 19;</div>
<div class="line"><span class="lineno">  661</span>         SizeOfHookedInstructions += <a class="code hl_function" href="_length_disassembler_engine_8h.html#a54247063c60b345c5935afee417bbc1a">ldisasm</a>(((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>)TargetFunctionInSafeMemory + SizeOfHookedInstructions), <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>))</div>
<div class="line"><span class="lineno">  662</span>    {</div>
<div class="line"><span class="lineno">  663</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  664</span>        <span class="comment">// Get the full size of instructions necessary to copy</span></div>
<div class="line"><span class="lineno">  665</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  666</span>    }</div>
<div class="line"><span class="lineno">  667</span> </div>
<div class="line"><span class="lineno">  668</span>    <span class="comment">// for (SizeOfHookedInstructions = 0;</span></div>
<div class="line"><span class="lineno">  669</span>    <span class="comment">//      SizeOfHookedInstructions &lt; 19;</span></div>
<div class="line"><span class="lineno">  670</span>    <span class="comment">//      SizeOfHookedInstructions += ZydisLde(((UINT64)TargetFunctionInSafeMemory + SizeOfHookedInstructions), TRUE))</span></div>
<div class="line"><span class="lineno">  671</span>    <span class="comment">//{</span></div>
<div class="line"><span class="lineno">  672</span>    <span class="comment">//     //</span></div>
<div class="line"><span class="lineno">  673</span>    <span class="comment">//     // Get the full size of instructions necessary to copy</span></div>
<div class="line"><span class="lineno">  674</span>    <span class="comment">//     //</span></div>
<div class="line"><span class="lineno">  675</span>    <span class="comment">// }</span></div>
<div class="line"><span class="lineno">  676</span> </div>
<div class="line"><span class="lineno">  677</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  678</span>    <span class="comment">// For logging purpose</span></div>
<div class="line"><span class="lineno">  679</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  680</span>    <span class="comment">// LogInfo(&quot;Number of bytes of instruction mem: %x&quot;, SizeOfHookedInstructions);</span></div>
<div class="line"><span class="lineno">  681</span> </div>
<div class="line"><span class="lineno">  682</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  683</span>    <span class="comment">// Build a trampoline</span></div>
<div class="line"><span class="lineno">  684</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  685</span> </div>
<div class="line"><span class="lineno">  686</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  687</span>    <span class="comment">// Allocate some executable memory for the trampoline</span></div>
<div class="line"><span class="lineno">  688</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  689</span>    Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a> = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a7f3b17763776a06c42601f8da4cad5ec">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d">EXEC_TRAMPOLINE</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code hl_define" href="_hooks_8h.html#a9b5b17233c5031bc6d520227b440e01a">MAX_EXEC_TRAMPOLINE_SIZE</a>);</div>
<div class="line"><span class="lineno">  690</span> </div>
<div class="line"><span class="lineno">  691</span>    <span class="keywordflow">if</span> (!Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>)</div>
<div class="line"><span class="lineno">  692</span>    {</div>
<div class="line"><span class="lineno">  693</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, could not allocate trampoline function buffer&quot;</span>);</div>
<div class="line"><span class="lineno">  694</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  695</span>    }</div>
<div class="line"><span class="lineno">  696</span> </div>
<div class="line"><span class="lineno">  697</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  698</span>    <span class="comment">// Copy the trampoline instructions in</span></div>
<div class="line"><span class="lineno">  699</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  700</span> </div>
<div class="line"><span class="lineno">  701</span>    <span class="comment">// Switch to target process</span></div>
<div class="line"><span class="lineno">  702</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  703</span>    Cr3OfCurrentProcess = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ad711f252793324cdb878442d74d9098f">SwitchToProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><span class="lineno">  704</span> </div>
<div class="line"><span class="lineno">  705</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  706</span>    <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><span class="lineno">  707</span>    <span class="comment">// RtlCopyMemory(Hook-&gt;Trampoline, TargetFunction, SizeOfHookedInstructions);</span></div>
<div class="line"><span class="lineno">  708</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  709</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a>(TargetFunction, Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>, SizeOfHookedInstructions);</div>
<div class="line"><span class="lineno">  710</span> </div>
<div class="line"><span class="lineno">  711</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  712</span>    <span class="comment">// Restore to original process</span></div>
<div class="line"><span class="lineno">  713</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  714</span>    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a271e5e657ab23c69e078979359903d94">SwitchToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><span class="lineno">  715</span> </div>
<div class="line"><span class="lineno">  716</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  717</span>    <span class="comment">// Add the absolute jump back to the original function</span></div>
<div class="line"><span class="lineno">  718</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  719</span>    <a class="code hl_function" href="_ept_hook_8c.html#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a>(&amp;Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>[SizeOfHookedInstructions], (SIZE_T)TargetFunction + SizeOfHookedInstructions);</div>
<div class="line"><span class="lineno">  720</span> </div>
<div class="line"><span class="lineno">  721</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  722</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  723</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  724</span>    <span class="comment">// LogInfo(&quot;Trampoline: 0x%llx&quot;, Hook-&gt;Trampoline);</span></div>
<div class="line"><span class="lineno">  725</span>    <span class="comment">// LogInfo(&quot;HookFunction: 0x%llx&quot;, HookFunction);</span></div>
<div class="line"><span class="lineno">  726</span> </div>
<div class="line"><span class="lineno">  727</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  728</span>    <span class="comment">// Let the hook function call the original function</span></div>
<div class="line"><span class="lineno">  729</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  730</span>    <span class="comment">// *OrigFunction = Hook-&gt;Trampoline;</span></div>
<div class="line"><span class="lineno">  731</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  732</span> </div>
<div class="line"><span class="lineno">  733</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  734</span>    <span class="comment">// Create the structure to return for the debugger, we do it here because it&#39;s the first</span></div>
<div class="line"><span class="lineno">  735</span>    <span class="comment">// function that changes the original function and if our structure is no ready after this</span></div>
<div class="line"><span class="lineno">  736</span>    <span class="comment">// function then we probably see BSOD on other cores</span></div>
<div class="line"><span class="lineno">  737</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  738</span>    DetourHookDetails                        = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a7f3b17763776a06c42601f8da4cad5ec">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b">DETOUR_HOOK_DETAILS</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>));</div>
<div class="line"><span class="lineno">  739</span>    DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a5b7e945d9dd258586acd7e0268c8f11a">HookedFunctionAddress</a> = TargetFunction;</div>
<div class="line"><span class="lineno">  740</span>    DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#a89757e40877fd300bf09ab3b45642f28">ReturnAddress</a>         = Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">Trampoline</a>;</div>
<div class="line"><span class="lineno">  741</span> </div>
<div class="line"><span class="lineno">  742</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  743</span>    <span class="comment">// Save the address of DetourHookDetails because we want to</span></div>
<div class="line"><span class="lineno">  744</span>    <span class="comment">// deallocate it when the hook is finished</span></div>
<div class="line"><span class="lineno">  745</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  746</span>    Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a20c61155569f9c8a3e3fd4a670e231f7">AddressOfEptHook2sDetourListEntry</a> = DetourHookDetails;</div>
<div class="line"><span class="lineno">  747</span> </div>
<div class="line"><span class="lineno">  748</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  749</span>    <span class="comment">// Insert it to the list of hooked pages</span></div>
<div class="line"><span class="lineno">  750</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  751</span>    <a class="code hl_function" href="list_8h.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>, &amp;(DetourHookDetails-&gt;<a class="code hl_variable" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">OtherHooksList</a>));</div>
<div class="line"><span class="lineno">  752</span> </div>
<div class="line"><span class="lineno">  753</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  754</span>    <span class="comment">// Write the absolute jump to our shadow page memory to jump to our hook</span></div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  756</span>    <a class="code hl_function" href="_ept_hook_8c.html#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a>(&amp;Hook-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[OffsetIntoPage], (SIZE_T)HookFunction);</div>
<div class="line"><span class="lineno">  757</span> </div>
<div class="line"><span class="lineno">  758</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  759</span>}</div>
<div class="ttc" id="a_ept_8h_html_a2faab1a93d36f8a2d9ae5c79de293300"><div class="ttname"><a href="_ept_8h.html#a2faab1a93d36f8a2d9ae5c79de293300">ADDRMASK_EPT_PML1_OFFSET</a></div><div class="ttdeci">#define ADDRMASK_EPT_PML1_OFFSET(_VAR_)</div><div class="ttdoc">Offset into the 1st paging structure (4096 byte)</div><div class="ttdef"><b>Definition:</b> Ept.h:62</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a50935db932e916707520e63212e9e688"><div class="ttname"><a href="_ept_hook_8c.html#a50935db932e916707520e63212e9e688">EptHookWriteAbsoluteJump</a></div><div class="ttdeci">VOID EptHookWriteAbsoluteJump(PCHAR TargetBuffer, SIZE_T TargetAddress)</div><div class="ttdoc">Write an absolute x64 jump to an arbitrary address to a buffer.</div><div class="ttdef"><b>Definition:</b> EptHook.c:540</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a8767a6d054fe785e66068e32b4466b87"><div class="ttname"><a href="_ept_hook_8c.html#a8767a6d054fe785e66068e32b4466b87">EptHookWriteAbsoluteJump2</a></div><div class="ttdeci">VOID EptHookWriteAbsoluteJump2(PCHAR TargetBuffer, SIZE_T TargetAddress)</div><div class="ttdoc">Write an absolute x64 jump to an arbitrary address to a buffer.</div><div class="ttdef"><b>Definition:</b> EptHook.c:589</div></div>
<div class="ttc" id="a_hooks_8h_html_a9b5b17233c5031bc6d520227b440e01a"><div class="ttname"><a href="_hooks_8h.html#a9b5b17233c5031bc6d520227b440e01a">MAX_EXEC_TRAMPOLINE_SIZE</a></div><div class="ttdeci">#define MAX_EXEC_TRAMPOLINE_SIZE</div><div class="ttdoc">Maximum number of supported execution trampoline.</div><div class="ttdef"><b>Definition:</b> Hooks.h:173</div></div>
<div class="ttc" id="a_length_disassembler_engine_8h_html_a54247063c60b345c5935afee417bbc1a"><div class="ttname"><a href="_length_disassembler_engine_8h.html#a54247063c60b345c5935afee417bbc1a">ldisasm</a></div><div class="ttdeci">size_t ldisasm(const void *const address, const BOOLEAN x86_64_mode)</div><div class="ttdef"><b>Definition:</b> LengthDisassemblerEngine.h:64</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a18c553f48bd909ebfea72c42edeea43d">EXEC_TRAMPOLINE</a></div><div class="ttdeci">@ EXEC_TRAMPOLINE</div><div class="ttdef"><b>Definition:</b> DataTypes.h:42</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h_html_ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a898d2549c3e40191c8e23e4ee687663b">DETOUR_HOOK_DETAILS</a></div><div class="ttdeci">@ DETOUR_HOOK_DETAILS</div><div class="ttdef"><b>Definition:</b> DataTypes.h:44</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a271e5e657ab23c69e078979359903d94"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a271e5e657ab23c69e078979359903d94">SwitchToPreviousProcess</a></div><div class="ttdeci">IMPORT_EXPORT_VMM VOID SwitchToPreviousProcess(_In_ CR3_TYPE PreviousProcess)</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a2f6df53976f17e73cc27e73ebcc8156a"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a></div><div class="ttdeci">IMPORT_EXPORT_VMM BOOLEAN MemoryMapperReadMemorySafe(_In_ UINT64 VaAddressToRead, _Inout_ PVOID BufferToSaveMemory, _In_ SIZE_T SizeToRead)</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a7f3b17763776a06c42601f8da4cad5ec"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a7f3b17763776a06c42601f8da4cad5ec">PoolManagerRequestPool</a></div><div class="ttdeci">IMPORT_EXPORT_VMM UINT64 PoolManagerRequestPool(POOL_ALLOCATION_INTENTION Intention, BOOLEAN RequestNewPool, UINT32 Size)</div><div class="ttdoc">This function should be called from vmx-root in order to get a pool from the list.</div><div class="ttdef"><b>Definition:</b> PoolManager.c:234</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_ad711f252793324cdb878442d74d9098f"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ad711f252793324cdb878442d74d9098f">SwitchToProcessMemoryLayoutByCr3</a></div><div class="ttdeci">IMPORT_EXPORT_VMM CR3_TYPE SwitchToProcessMemoryLayoutByCr3(_In_ CR3_TYPE TargetCr3)</div></div>
<div class="ttc" id="ahprdbgctrl_2header_2common_8h_html_a7d467c1d283fdfa1f2081ba1e0d01b6e"><div class="ttname"><a href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a></div><div class="ttdeci">#define PAGE_SIZE</div><div class="ttdoc">Size of each page (4096 bytes)</div><div class="ttdef"><b>Definition:</b> common.h:59</div></div>
<div class="ttc" id="alist_8h_html_a77df31a5e6a1be59d08b93e9cb028f22"><div class="ttname"><a href="list_8h.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a></div><div class="ttdeci">void InsertHeadList(PLIST_ENTRY ListHead, PLIST_ENTRY Entry)</div></div>
<div class="ttc" id="astruct___c_r3___t_y_p_e_html"><div class="ttname"><a href="struct___c_r3___t_y_p_e.html">_CR3_TYPE</a></div><div class="ttdoc">CR3 Structure.</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:136</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a20c61155569f9c8a3e3fd4a670e231f7"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a20c61155569f9c8a3e3fd4a670e231f7">_EPT_HOOKED_PAGE_DETAIL::AddressOfEptHook2sDetourListEntry</a></div><div class="ttdeci">UINT64 AddressOfEptHook2sDetourListEntry</div><div class="ttdoc">The virtual address of it's enty on g_EptHook2sDetourListHead this way we can de-allocate the list wh...</div><div class="ttdef"><b>Definition:</b> State.h:109</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4c523ca3a1b46bf34681abfec4fef75e"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">_EPT_HOOKED_PAGE_DETAIL::FakePageContents</a></div><div class="ttdeci">CHAR FakePageContents[PAGE_SIZE]</div><div class="ttdef"><b>Definition:</b> State.h:93</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a7db42bbe2d48d142bd18747fc53f903f"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a7db42bbe2d48d142bd18747fc53f903f">_EPT_HOOKED_PAGE_DETAIL::Trampoline</a></div><div class="ttdeci">PCHAR Trampoline</div><div class="ttdoc">The buffer of the trampoline function which is used in the inline hook.</div><div class="ttdef"><b>Definition:</b> State.h:142</div></div>
<div class="ttc" id="astruct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s_html_aa47949f02b08a654dbe910d6d107fa94"><div class="ttname"><a href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html#aa47949f02b08a654dbe910d6d107fa94">_HIDDEN_HOOKS_DETOUR_DETAILS::OtherHooksList</a></div><div class="ttdeci">LIST_ENTRY OtherHooksList</div><div class="ttdef"><b>Definition:</b> Hooks.h:75</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a194622a3ba05a449923eb105cdb37405" name="a194622a3ba05a449923eb105cdb37405"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a194622a3ba05a449923eb105cdb37405">&#9670;&#160;</a></span>EptHookPerformPageHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHook </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>ProcessCr3</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The main function that performs EPT page hook with hidden breakpoint. </p>
<p>Hook in VMX Root Mode with hidden breakpoints (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  372</span>{</div>
<div class="line"><span class="lineno">  373</span>    <a class="code hl_typedef" href="hprdbghv_2header_2common_2_state_8h.html#a7f2689338799db6564d2b9cb35d7d596">EPT_PML1_ENTRY</a>          ChangedEntry;</div>
<div class="line"><span class="lineno">  374</span>    INVEPT_DESCRIPTOR       Descriptor;</div>
<div class="line"><span class="lineno">  375</span>    SIZE_T                  PhysicalBaseAddress;</div>
<div class="line"><span class="lineno">  376</span>    PVOID                   VirtualTarget;</div>
<div class="line"><span class="lineno">  377</span>    PVOID                   TargetBuffer;</div>
<div class="line"><span class="lineno">  378</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  TargetAddressInFakePageContent;</div>
<div class="line"><span class="lineno">  379</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  PageOffset;</div>
<div class="line"><span class="lineno">  380</span>    <a class="code hl_typedef" href="hprdbghv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>         TargetPage;</div>
<div class="line"><span class="lineno">  381</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPage;</div>
<div class="line"><span class="lineno">  382</span> </div>
<div class="line"><span class="lineno">  383</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a> Cr3OfCurrentProcess;</div>
<div class="line"><span class="lineno">  384</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a>     OriginalByte;</div>
<div class="line"><span class="lineno">  385</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>  HookedEntryFound = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  386</span> </div>
<div class="line"><span class="lineno">  387</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  388</span>    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><span class="lineno">  389</span>    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><span class="lineno">  390</span>    <span class="comment">// virtual memory.</span></div>
<div class="line"><span class="lineno">  391</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  392</span>    VirtualTarget = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress);</div>
<div class="line"><span class="lineno">  393</span> </div>
<div class="line"><span class="lineno">  394</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  395</span>    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><span class="lineno">  396</span>    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><span class="lineno">  397</span>    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><span class="lineno">  398</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  399</span> </div>
<div class="line"><span class="lineno">  400</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  401</span>    <span class="comment">// Find cr3 of target core</span></div>
<div class="line"><span class="lineno">  402</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  403</span>    PhysicalBaseAddress = (SIZE_T)<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aa4c6128ae9e5d96a297990bf5d3e7c5d">VirtualAddressToPhysicalAddressByProcessCr3</a>(VirtualTarget, ProcessCr3);</div>
<div class="line"><span class="lineno">  404</span> </div>
<div class="line"><span class="lineno">  405</span>    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">  406</span>    {</div>
<div class="line"><span class="lineno">  407</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno">  408</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  409</span>    }</div>
<div class="line"><span class="lineno">  410</span> </div>
<div class="line"><span class="lineno">  411</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  412</span>    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><span class="lineno">  413</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  414</span> </div>
<div class="line"><span class="lineno">  415</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a> * HookedEntry = {0};</div>
<div class="line"><span class="lineno">  416</span> </div>
<div class="line"><span class="lineno">  417</span>    <span class="keywordflow">if</span> (EptHookFindByPhysAddress(PhysicalBaseAddress, HookedEntry) == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; HookedEntry != NULL)</div>
<div class="line"><span class="lineno">  418</span>    {</div>
<div class="line"><span class="lineno">  419</span>        <span class="keywordflow">return</span> EptHookUpdateHookPage(TargetAddress, HookedEntry);</div>
<div class="line"><span class="lineno">  420</span>    }</div>
<div class="line"><span class="lineno">  421</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  422</span>    {</div>
<div class="line"><span class="lineno">  423</span>        <span class="keywordflow">return</span> EptHookCreateHookPage(TargetAddress, ProcessCr3);</div>
<div class="line"><span class="lineno">  424</span>    }</div>
<div class="line"><span class="lineno">  425</span>}</div>
<div class="ttc" id="a_callback_8c_html_a68d4847c16adb5d0d6f8a5513a299029"><div class="ttname"><a href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a></div><div class="ttdeci">VOID VmmCallbackSetLastError(UINT32 LastError)</div><div class="ttdoc">routine callback to set last error</div><div class="ttdef"><b>Definition:</b> Callback.c:154</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_a1cb18096b299d23458d3c7b85fd86555"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a></div><div class="ttdeci">UCHAR BOOLEAN</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:37</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_a4ae1dab0fb4b072a66584546209e7d58"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a></div><div class="ttdeci">unsigned char BYTE</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:22</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_ac1b8dbae6748b88abe05844e42c29952"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a></div><div class="ttdeci">#define DEBUGGER_ERROR_INVALID_ADDRESS</div><div class="ttdoc">error, invalid address specified for debugger</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:63</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_aa4c6128ae9e5d96a297990bf5d3e7c5d"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aa4c6128ae9e5d96a297990bf5d3e7c5d">VirtualAddressToPhysicalAddressByProcessCr3</a></div><div class="ttdeci">IMPORT_EXPORT_VMM UINT64 VirtualAddressToPhysicalAddressByProcessCr3(_In_ PVOID VirtualAddress, _In_ CR3_TYPE TargetCr3)</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2_state_8h_html_a03c563d9799bc8f374809f48c73c7175"><div class="ttname"><a href="hprdbghv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a></div><div class="ttdeci">EPT_PTE * PEPT_PML1_ENTRY</div><div class="ttdef"><b>Definition:</b> State.h:22</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2_state_8h_html_a7f2689338799db6564d2b9cb35d7d596"><div class="ttname"><a href="hprdbghv_2header_2common_2_state_8h.html#a7f2689338799db6564d2b9cb35d7d596">EPT_PML1_ENTRY</a></div><div class="ttdeci">EPT_PTE EPT_PML1_ENTRY</div><div class="ttdef"><b>Definition:</b> State.h:22</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a77e3785963c79b3ff0efdf13efe0be13" name="a77e3785963c79b3ff0efdf13efe0be13"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a77e3785963c79b3ff0efdf13efe0be13">&#9670;&#160;</a></span>EptHookPerformPageHook2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookPerformPageHook2 </td>
          <td>(</td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>TargetAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">PVOID&#160;</td>
          <td class="paramname"><em>HookFunction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aaeec30724d8f0c9d2acd894f41ee06fe">CR3_TYPE</a>&#160;</td>
          <td class="paramname"><em>ProcessCr3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetRead</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetWrite</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a>&#160;</td>
          <td class="paramname"><em>UnsetExecute</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>The main function that performs EPT page hook with hidden detours and monitor. </p>
<p>Hook in VMX Root Mode with hidden detours and monitor (A pre-allocated buffer should be available)</p>
<p>This function returns false in VMX Non-Root Mode if the VM is already initialized This function have to be called through a VMCALL in VMX Root Mode</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetAddress</td><td>The address of function or memory address to be hooked </td></tr>
    <tr><td class="paramname">HookFunction</td><td>The function that will be called when hook triggered </td></tr>
    <tr><td class="paramname">ProcessCr3</td><td>The process cr3 to translate based on that process's cr3 </td></tr>
    <tr><td class="paramname">UnsetRead</td><td>Hook READ Access </td></tr>
    <tr><td class="paramname">UnsetWrite</td><td>Hook WRITE Access </td></tr>
    <tr><td class="paramname">UnsetExecute</td><td>Hook EXECUTE Access </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Returns true if the hook was successful or false if there was an error </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  781</span>{</div>
<div class="line"><span class="lineno">  782</span>    <a class="code hl_typedef" href="hprdbghv_2header_2common_2_state_8h.html#a7f2689338799db6564d2b9cb35d7d596">EPT_PML1_ENTRY</a>          ChangedEntry;</div>
<div class="line"><span class="lineno">  783</span>    INVEPT_DESCRIPTOR       Descriptor;</div>
<div class="line"><span class="lineno">  784</span>    SIZE_T                  PhysicalBaseAddress;</div>
<div class="line"><span class="lineno">  785</span>    PVOID                   VirtualTarget;</div>
<div class="line"><span class="lineno">  786</span>    PVOID                   TargetBuffer;</div>
<div class="line"><span class="lineno">  787</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  TargetAddressInSafeMemory;</div>
<div class="line"><span class="lineno">  788</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>                  PageOffset;</div>
<div class="line"><span class="lineno">  789</span>    <a class="code hl_typedef" href="hprdbghv_2header_2common_2_state_8h.html#a03c563d9799bc8f374809f48c73c7175">PEPT_PML1_ENTRY</a>         TargetPage;</div>
<div class="line"><span class="lineno">  790</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedPage;</div>
<div class="line"><span class="lineno">  791</span>    <a class="code hl_struct" href="struct___c_r3___t_y_p_e.html">CR3_TYPE</a>                Cr3OfCurrentProcess;</div>
<div class="line"><span class="lineno">  792</span>    PLIST_ENTRY             TempList    = 0;</div>
<div class="line"><span class="lineno">  793</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">PEPT_HOOKED_PAGE_DETAIL</a> HookedEntry = NULL;</div>
<div class="line"><span class="lineno">  794</span> </div>
<div class="line"><span class="lineno">  795</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  796</span>    <span class="comment">// Translate the page from a physical address to virtual so we can read its memory.</span></div>
<div class="line"><span class="lineno">  797</span>    <span class="comment">// This function will return NULL if the physical address was not already mapped in</span></div>
<div class="line"><span class="lineno">  798</span>    <span class="comment">// virtual memory.</span></div>
<div class="line"><span class="lineno">  799</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  800</span>    VirtualTarget = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddress);</div>
<div class="line"><span class="lineno">  801</span> </div>
<div class="line"><span class="lineno">  802</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  803</span>    <span class="comment">// Here we have to change the CR3, it is because we are in SYSTEM process</span></div>
<div class="line"><span class="lineno">  804</span>    <span class="comment">// and if the target address is not mapped in SYSTEM address space (e.g</span></div>
<div class="line"><span class="lineno">  805</span>    <span class="comment">// user mode address of another process) then the translation is invalid</span></div>
<div class="line"><span class="lineno">  806</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  807</span> </div>
<div class="line"><span class="lineno">  808</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  809</span>    <span class="comment">// Find cr3 of target core</span></div>
<div class="line"><span class="lineno">  810</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  811</span>    PhysicalBaseAddress = (SIZE_T)<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#aa4c6128ae9e5d96a297990bf5d3e7c5d">VirtualAddressToPhysicalAddressByProcessCr3</a>(VirtualTarget, ProcessCr3);</div>
<div class="line"><span class="lineno">  812</span> </div>
<div class="line"><span class="lineno">  813</span>    <span class="keywordflow">if</span> (!PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">  814</span>    {</div>
<div class="line"><span class="lineno">  815</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#ac1b8dbae6748b88abe05844e42c29952">DEBUGGER_ERROR_INVALID_ADDRESS</a>);</div>
<div class="line"><span class="lineno">  816</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  817</span>    }</div>
<div class="line"><span class="lineno">  818</span> </div>
<div class="line"><span class="lineno">  819</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  820</span>    <span class="comment">// try to see if we can find the address</span></div>
<div class="line"><span class="lineno">  821</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  822</span>    TempList = &amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>;</div>
<div class="line"><span class="lineno">  823</span> </div>
<div class="line"><span class="lineno">  824</span>    <span class="keywordflow">while</span> (&amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a> != TempList-&gt;Flink)</div>
<div class="line"><span class="lineno">  825</span>    {</div>
<div class="line"><span class="lineno">  826</span>        TempList    = TempList-&gt;Flink;</div>
<div class="line"><span class="lineno">  827</span>        HookedEntry = <a class="code hl_define" href="list_8h.html#adec42d53dc3b3e16ab7a1cd98af1c5fc">CONTAINING_RECORD</a>(TempList, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList);</div>
<div class="line"><span class="lineno">  828</span> </div>
<div class="line"><span class="lineno">  829</span>        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> == PhysicalBaseAddress)</div>
<div class="line"><span class="lineno">  830</span>        {</div>
<div class="line"><span class="lineno">  831</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  832</span>            <span class="comment">// Means that we find the address and !epthook2 doesn&#39;t support</span></div>
<div class="line"><span class="lineno">  833</span>            <span class="comment">// multiple breakpoints in on page</span></div>
<div class="line"><span class="lineno">  834</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno">  835</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a9697a726e353b61b5e02c10395f3f382">DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</a>);</div>
<div class="line"><span class="lineno">  836</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  837</span>        }</div>
<div class="line"><span class="lineno">  838</span>    }</div>
<div class="line"><span class="lineno">  839</span> </div>
<div class="line"><span class="lineno">  840</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  841</span>    <span class="comment">// Set target buffer, request buffer from pool manager,</span></div>
<div class="line"><span class="lineno">  842</span>    <span class="comment">// we also need to allocate new page to replace the current page ASAP</span></div>
<div class="line"><span class="lineno">  843</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  844</span>    TargetBuffer = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a7f3b17763776a06c42601f8da4cad5ec">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a09f33e69ad8e184c21efd29fa2fe7380">SPLIT_2MB_PAGING_TO_4KB_PAGE</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___v_m_m___e_p_t___d_y_n_a_m_i_c___s_p_l_i_t.html">VMM_EPT_DYNAMIC_SPLIT</a>));</div>
<div class="line"><span class="lineno">  845</span> </div>
<div class="line"><span class="lineno">  846</span>    <span class="keywordflow">if</span> (!TargetBuffer)</div>
<div class="line"><span class="lineno">  847</span>    {</div>
<div class="line"><span class="lineno">  848</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a>);</div>
<div class="line"><span class="lineno">  849</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  850</span>    }</div>
<div class="line"><span class="lineno">  851</span> </div>
<div class="line"><span class="lineno">  852</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_8c.html#a186f8a530e93e585a153269cdc103f45">EptSplitLargePage</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, TargetBuffer, PhysicalBaseAddress))</div>
<div class="line"><span class="lineno">  853</span>    {</div>
<div class="line"><span class="lineno">  854</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(TargetBuffer);</div>
<div class="line"><span class="lineno">  855</span> </div>
<div class="line"><span class="lineno">  856</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a108126279e46f4d46d25abe24da43fdc">LogDebugInfo</a>(<span class="stringliteral">&quot;Err, could not split page for the address : 0x%llx&quot;</span>, PhysicalBaseAddress);</div>
<div class="line"><span class="lineno">  857</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#afa580b4ad142ec96cadfdc5cec58b1b7">DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</a>);</div>
<div class="line"><span class="lineno">  858</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  859</span>    }</div>
<div class="line"><span class="lineno">  860</span> </div>
<div class="line"><span class="lineno">  861</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  862</span>    <span class="comment">// Pointer to the page entry in the page table</span></div>
<div class="line"><span class="lineno">  863</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  864</span>    TargetPage = <a class="code hl_function" href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">EptPageTable</a>, PhysicalBaseAddress);</div>
<div class="line"><span class="lineno">  865</span> </div>
<div class="line"><span class="lineno">  866</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  867</span>    <span class="comment">// Ensure the target is valid</span></div>
<div class="line"><span class="lineno">  868</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  869</span>    <span class="keywordflow">if</span> (!TargetPage)</div>
<div class="line"><span class="lineno">  870</span>    {</div>
<div class="line"><span class="lineno">  871</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(TargetBuffer);</div>
<div class="line"><span class="lineno">  872</span> </div>
<div class="line"><span class="lineno">  873</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a06398ba01fbfbb3e3acb44a6cd97002c">DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</a>);</div>
<div class="line"><span class="lineno">  874</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  875</span>    }</div>
<div class="line"><span class="lineno">  876</span> </div>
<div class="line"><span class="lineno">  877</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  878</span>    <span class="comment">// Save the original permissions of the page</span></div>
<div class="line"><span class="lineno">  879</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  880</span>    ChangedEntry = *TargetPage;</div>
<div class="line"><span class="lineno">  881</span> </div>
<div class="line"><span class="lineno">  882</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  883</span>    <span class="comment">// Execution is treated differently</span></div>
<div class="line"><span class="lineno">  884</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  885</span>    <span class="keywordflow">if</span> (UnsetRead)</div>
<div class="line"><span class="lineno">  886</span>        ChangedEntry.ReadAccess = 0;</div>
<div class="line"><span class="lineno">  887</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  888</span>        ChangedEntry.ReadAccess = 1;</div>
<div class="line"><span class="lineno">  889</span> </div>
<div class="line"><span class="lineno">  890</span>    <span class="keywordflow">if</span> (UnsetWrite)</div>
<div class="line"><span class="lineno">  891</span>        ChangedEntry.WriteAccess = 0;</div>
<div class="line"><span class="lineno">  892</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  893</span>        ChangedEntry.WriteAccess = 1;</div>
<div class="line"><span class="lineno">  894</span> </div>
<div class="line"><span class="lineno">  895</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  896</span>    <span class="comment">// Save the detail of hooked page to keep track of it</span></div>
<div class="line"><span class="lineno">  897</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  898</span>    HookedPage = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a7f3b17763776a06c42601f8da4cad5ec">PoolManagerRequestPool</a>(<a class="code hl_enumvalue" href="build_2bin_2debug_2_s_d_k_2_headers_2_data_types_8h.html#ad130f0bae4db97169873223d0aad9a63a1c4249f84cf779cd4cdd72ee27de08c1">TRACKING_HOOKED_PAGES</a>, <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="keyword">sizeof</span>(<a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>));</div>
<div class="line"><span class="lineno">  899</span> </div>
<div class="line"><span class="lineno">  900</span>    <span class="keywordflow">if</span> (!HookedPage)</div>
<div class="line"><span class="lineno">  901</span>    {</div>
<div class="line"><span class="lineno">  902</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(TargetBuffer);</div>
<div class="line"><span class="lineno">  903</span> </div>
<div class="line"><span class="lineno">  904</span>        <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a>);</div>
<div class="line"><span class="lineno">  905</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  906</span>    }</div>
<div class="line"><span class="lineno">  907</span> </div>
<div class="line"><span class="lineno">  908</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  909</span>    <span class="comment">// Save the virtual address</span></div>
<div class="line"><span class="lineno">  910</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  911</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a> = TargetAddress;</div>
<div class="line"><span class="lineno">  912</span> </div>
<div class="line"><span class="lineno">  913</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  914</span>    <span class="comment">// Save the physical address</span></div>
<div class="line"><span class="lineno">  915</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  916</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a> = PhysicalBaseAddress;</div>
<div class="line"><span class="lineno">  917</span> </div>
<div class="line"><span class="lineno">  918</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  919</span>    <span class="comment">// Fake page content physical address</span></div>
<div class="line"><span class="lineno">  920</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  921</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a> = (SIZE_T)<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a9c177c471eaf6be292a94d8112fa3f36">VirtualAddressToPhysicalAddress</a>(&amp;HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>[0]) / <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>;</div>
<div class="line"><span class="lineno">  922</span> </div>
<div class="line"><span class="lineno">  923</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  924</span>    <span class="comment">// Save the entry address</span></div>
<div class="line"><span class="lineno">  925</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  926</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a> = TargetPage;</div>
<div class="line"><span class="lineno">  927</span> </div>
<div class="line"><span class="lineno">  928</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  929</span>    <span class="comment">// Save the original entry</span></div>
<div class="line"><span class="lineno">  930</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  931</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a> = *TargetPage;</div>
<div class="line"><span class="lineno">  932</span> </div>
<div class="line"><span class="lineno">  933</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  934</span>    <span class="comment">// Check if the hook relates to the write condition</span></div>
<div class="line"><span class="lineno">  935</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  936</span>    <span class="keywordflow">if</span> (UnsetWrite)</div>
<div class="line"><span class="lineno">  937</span>    {</div>
<div class="line"><span class="lineno">  938</span>        HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a5db4424bb300aec4ffabd7bfc5964417">IsMonitorToWriteOnPages</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  939</span>    }</div>
<div class="line"><span class="lineno">  940</span> </div>
<div class="line"><span class="lineno">  941</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  942</span>    <span class="comment">// If it&#39;s Execution hook then we have to set extra fields</span></div>
<div class="line"><span class="lineno">  943</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  944</span>    <span class="keywordflow">if</span> (UnsetExecute)</div>
<div class="line"><span class="lineno">  945</span>    {</div>
<div class="line"><span class="lineno">  946</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  947</span>        <span class="comment">// Show that entry has hidden hooks for execution</span></div>
<div class="line"><span class="lineno">  948</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  949</span>        HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">IsExecutionHook</a> = <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  950</span> </div>
<div class="line"><span class="lineno">  951</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  952</span>        <span class="comment">// In execution hook, we have to make sure to unset read, write because</span></div>
<div class="line"><span class="lineno">  953</span>        <span class="comment">// an EPT violation should occur for these cases and we can swap the original page</span></div>
<div class="line"><span class="lineno">  954</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  955</span>        ChangedEntry.ReadAccess    = 0;</div>
<div class="line"><span class="lineno">  956</span>        ChangedEntry.WriteAccess   = 0;</div>
<div class="line"><span class="lineno">  957</span>        ChangedEntry.ExecuteAccess = 1;</div>
<div class="line"><span class="lineno">  958</span> </div>
<div class="line"><span class="lineno">  959</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  960</span>        <span class="comment">// Also set the current pfn to fake page</span></div>
<div class="line"><span class="lineno">  961</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  962</span>        ChangedEntry.PageFrameNumber = HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">PhysicalBaseAddressOfFakePageContents</a>;</div>
<div class="line"><span class="lineno">  963</span> </div>
<div class="line"><span class="lineno">  964</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  965</span>        <span class="comment">// Switch to target process</span></div>
<div class="line"><span class="lineno">  966</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  967</span>        Cr3OfCurrentProcess = <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#ad711f252793324cdb878442d74d9098f">SwitchToProcessMemoryLayoutByCr3</a>(ProcessCr3);</div>
<div class="line"><span class="lineno">  968</span> </div>
<div class="line"><span class="lineno">  969</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  970</span>        <span class="comment">// Copy the content to the fake page</span></div>
<div class="line"><span class="lineno">  971</span>        <span class="comment">// The following line can&#39;t be used in user mode addresses</span></div>
<div class="line"><span class="lineno">  972</span>        <span class="comment">// RtlCopyBytes(&amp;HookedPage-&gt;FakePageContents, VirtualTarget, PAGE_SIZE);</span></div>
<div class="line"><span class="lineno">  973</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  974</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a2f6df53976f17e73cc27e73ebcc8156a">MemoryMapperReadMemorySafe</a>(VirtualTarget, &amp;HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>, <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#a7d467c1d283fdfa1f2081ba1e0d01b6e">PAGE_SIZE</a>);</div>
<div class="line"><span class="lineno">  975</span> </div>
<div class="line"><span class="lineno">  976</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  977</span>        <span class="comment">// Restore to original process</span></div>
<div class="line"><span class="lineno">  978</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  979</span>        <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a271e5e657ab23c69e078979359903d94">SwitchToPreviousProcess</a>(Cr3OfCurrentProcess);</div>
<div class="line"><span class="lineno">  980</span> </div>
<div class="line"><span class="lineno">  981</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  982</span>        <span class="comment">// Compute new offset of target offset into a safe bufferr</span></div>
<div class="line"><span class="lineno">  983</span>        <span class="comment">// It will be used to compute the length of the detours</span></div>
<div class="line"><span class="lineno">  984</span>        <span class="comment">// address because we might have a user mode code</span></div>
<div class="line"><span class="lineno">  985</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  986</span>        TargetAddressInSafeMemory = &amp;HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><span class="lineno">  987</span>        TargetAddressInSafeMemory = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddressInSafeMemory);</div>
<div class="line"><span class="lineno">  988</span>        PageOffset                = <a class="code hl_define" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(TargetAddress);</div>
<div class="line"><span class="lineno">  989</span>        TargetAddressInSafeMemory = TargetAddressInSafeMemory + PageOffset;</div>
<div class="line"><span class="lineno">  990</span> </div>
<div class="line"><span class="lineno">  991</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  992</span>        <span class="comment">// Make sure if handler function is valid or if it&#39;s default</span></div>
<div class="line"><span class="lineno">  993</span>        <span class="comment">// then we set it to the default hanlder</span></div>
<div class="line"><span class="lineno">  994</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  995</span>        <span class="keywordflow">if</span> (HookFunction == NULL)</div>
<div class="line"><span class="lineno">  996</span>        {</div>
<div class="line"><span class="lineno">  997</span>            HookFunction = <a class="code hl_function" href="_inline_asm_8h.html#ab0e909131196cbec54246cc925e89251">AsmGeneralDetourHook</a>;</div>
<div class="line"><span class="lineno">  998</span>        }</div>
<div class="line"><span class="lineno">  999</span> </div>
<div class="line"><span class="lineno"> 1000</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1001</span>        <span class="comment">// Create Hook</span></div>
<div class="line"><span class="lineno"> 1002</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1003</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="_ept_hook_8c.html#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a>(HookedPage, ProcessCr3, TargetAddress, TargetAddressInSafeMemory, HookFunction))</div>
<div class="line"><span class="lineno"> 1004</span>        {</div>
<div class="line"><span class="lineno"> 1005</span>            <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(TargetBuffer);</div>
<div class="line"><span class="lineno"> 1006</span>            <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(HookedPage);</div>
<div class="line"><span class="lineno"> 1007</span> </div>
<div class="line"><span class="lineno"> 1008</span>            <a class="code hl_function" href="_callback_8c.html#a68d4847c16adb5d0d6f8a5513a299029">VmmCallbackSetLastError</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#aa080da83ab0982e6d13150d580e7387b">DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</a>);</div>
<div class="line"><span class="lineno"> 1009</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1010</span>        }</div>
<div class="line"><span class="lineno"> 1011</span>    }</div>
<div class="line"><span class="lineno"> 1012</span> </div>
<div class="line"><span class="lineno"> 1013</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1014</span>    <span class="comment">// Save the modified entry</span></div>
<div class="line"><span class="lineno"> 1015</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1016</span>    HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">ChangedEntry</a> = ChangedEntry;</div>
<div class="line"><span class="lineno"> 1017</span> </div>
<div class="line"><span class="lineno"> 1018</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1019</span>    <span class="comment">// Add it to the list</span></div>
<div class="line"><span class="lineno"> 1020</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1021</span>    <a class="code hl_function" href="list_8h.html#a77df31a5e6a1be59d08b93e9cb028f22">InsertHeadList</a>(&amp;<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, &amp;(HookedPage-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>));</div>
<div class="line"><span class="lineno"> 1022</span> </div>
<div class="line"><span class="lineno"> 1023</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1024</span>    <span class="comment">// if not launched, there is no need to modify it on a safe environment</span></div>
<div class="line"><span class="lineno"> 1025</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1026</span>    <span class="comment">/*</span></div>
<div class="line"><span class="lineno"> 1027</span><span class="comment">    if (!g_GuestState[LogicalCoreIndex].HasLaunched)</span></div>
<div class="line"><span class="lineno"> 1028</span><span class="comment">    {</span></div>
<div class="line"><span class="lineno"> 1029</span><span class="comment">        //</span></div>
<div class="line"><span class="lineno"> 1030</span><span class="comment">        // Apply the hook to EPT</span></div>
<div class="line"><span class="lineno"> 1031</span><span class="comment">        //</span></div>
<div class="line"><span class="lineno"> 1032</span><span class="comment">        TargetPage-&gt;AsUInt = ChangedEntry.AsUInt;</span></div>
<div class="line"><span class="lineno"> 1033</span><span class="comment">    }</span></div>
<div class="line"><span class="lineno"> 1034</span><span class="comment">    else</span></div>
<div class="line"><span class="lineno"> 1035</span><span class="comment">    {*/</span></div>
<div class="line"><span class="lineno"> 1036</span> </div>
<div class="line"><span class="lineno"> 1037</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1038</span>    <span class="comment">// Apply the hook to EPT</span></div>
<div class="line"><span class="lineno"> 1039</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1040</span>    <a class="code hl_function" href="_ept_8c.html#aad64c2c08fba48ccdb0a34d5c1dee97f">EptSetPML1AndInvalidateTLB</a>(TargetPage, ChangedEntry, InveptSingleContext);</div>
<div class="line"><span class="lineno"> 1041</span>    <span class="comment">//}</span></div>
<div class="line"><span class="lineno"> 1042</span> </div>
<div class="line"><span class="lineno"> 1043</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1044</span>}</div>
<div class="ttc" id="a_ept_8c_html_a186f8a530e93e585a153269cdc103f45"><div class="ttname"><a href="_ept_8c.html#a186f8a530e93e585a153269cdc103f45">EptSplitLargePage</a></div><div class="ttdeci">BOOLEAN EptSplitLargePage(PVMM_EPT_PAGE_TABLE EptPageTable, PVOID PreAllocatedBuffer, SIZE_T PhysicalAddress)</div><div class="ttdoc">Split 2MB (LargePage) into 4kb pages.</div><div class="ttdef"><b>Definition:</b> Ept.c:299</div></div>
<div class="ttc" id="a_ept_8c_html_aad64c2c08fba48ccdb0a34d5c1dee97f"><div class="ttname"><a href="_ept_8c.html#aad64c2c08fba48ccdb0a34d5c1dee97f">EptSetPML1AndInvalidateTLB</a></div><div class="ttdeci">_Use_decl_annotations_ VOID EptSetPML1AndInvalidateTLB(PEPT_PML1_ENTRY EntryAddress, EPT_PML1_ENTRY EntryValue, INVEPT_TYPE InvalidationType)</div><div class="ttdoc">This function set the specific PML1 entry in a spinlock protected area then invalidate the TLB.</div><div class="ttdef"><b>Definition:</b> Ept.c:904</div></div>
<div class="ttc" id="a_ept_8c_html_aca998ecbfe4b433dbb307e5ab1fbcc41"><div class="ttname"><a href="_ept_8c.html#aca998ecbfe4b433dbb307e5ab1fbcc41">EptGetPml1Entry</a></div><div class="ttdeci">PEPT_PML1_ENTRY EptGetPml1Entry(PVMM_EPT_PAGE_TABLE EptPageTable, SIZE_T PhysicalAddress)</div><div class="ttdoc">Get the PML1 entry for this physical address if the page is split.</div><div class="ttdef"><b>Definition:</b> Ept.c:142</div></div>
<div class="ttc" id="a_ept_hook_8c_html_a1a97cf8a3d1243edf02539139bbfb617"><div class="ttname"><a href="_ept_hook_8c.html#a1a97cf8a3d1243edf02539139bbfb617">EptHookInstructionMemory</a></div><div class="ttdeci">BOOLEAN EptHookInstructionMemory(PEPT_HOOKED_PAGE_DETAIL Hook, CR3_TYPE ProcessCr3, PVOID TargetFunction, PVOID TargetFunctionInSafeMemory, PVOID HookFunction)</div><div class="ttdoc">Hook ins.</div><div class="ttdef"><b>Definition:</b> EptHook.c:631</div></div>
<div class="ttc" id="a_inline_asm_8h_html_ab0e909131196cbec54246cc925e89251"><div class="ttname"><a href="_inline_asm_8h.html#ab0e909131196cbec54246cc925e89251">AsmGeneralDetourHook</a></div><div class="ttdeci">void AsmGeneralDetourHook(void)</div><div class="ttdoc">Detour hook handler.</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_a06398ba01fbfbb3e3acb44a6cd97002c"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a06398ba01fbfbb3e3acb44a6cd97002c">DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_FAILED_TO_GET_PML1_ENTRY_OF_TARGET_ADDRESS</div><div class="ttdoc">error, failed to get PML1 entry of the target address</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:264</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_a35966c13fc80dc6d9055d5b7f46f6ef6"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a35966c13fc80dc6d9055d5b7f46f6ef6">DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</a></div><div class="ttdeci">#define DEBUGGER_ERROR_PRE_ALLOCATED_BUFFER_IS_EMPTY</div><div class="ttdoc">error, there is no pre-allocated buffer</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:251</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_a9697a726e353b61b5e02c10395f3f382"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#a9697a726e353b61b5e02c10395f3f382">DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_MULTIPLE_HOOKS_IN_A_SINGLE_PAGE</div><div class="ttdoc">error, multiple EPT Hooks or Monitors are applied on a single page</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:270</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_aa080da83ab0982e6d13150d580e7387b"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#aa080da83ab0982e6d13150d580e7387b">DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</a></div><div class="ttdeci">#define DEBUGGER_ERROR_COULD_NOT_BUILD_THE_EPT_HOOK</div><div class="ttdoc">error, could not build the EPT Hook</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:276</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h_html_afa580b4ad142ec96cadfdc5cec58b1b7"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_error_codes_8h.html#afa580b4ad142ec96cadfdc5cec58b1b7">DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</a></div><div class="ttdeci">#define DEBUGGER_ERROR_EPT_COULD_NOT_SPLIT_THE_LARGE_PAGE_TO_4KB_PAGES</div><div class="ttdoc">error, in the EPT handler, it could not split the 2MB pages to 512 entries of 4 KB pages</div><div class="ttdef"><b>Definition:</b> ErrorCodes.h:258</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a959d3b71e4d867f6a1499abc90cb6023"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a></div><div class="ttdeci">IMPORT_EXPORT_VMM BOOLEAN PoolManagerFreePool(UINT64 AddressToFree)</div><div class="ttdoc">This function set a pool flag to be freed, and it will be freed on the next IOCTL when it's safe to r...</div><div class="ttdef"><b>Definition:</b> PoolManager.c:157</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2common_8h_html_a1ebb2ec82baedeecf55e15778b8dd0aa"><div class="ttname"><a href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a></div><div class="ttdeci">#define PAGE_OFFSET(Va)</div><div class="ttdoc">Offset from a page's 4096 bytes.</div><div class="ttdef"><b>Definition:</b> Common.h:207</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a325edda9c8d49c2f44319627d86d4a88"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a325edda9c8d49c2f44319627d86d4a88">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddressOfFakePageContents</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddressOfFakePageContents</div><div class="ttdoc">The base address of the page with fake contents. Used to swap page with fake contents when a hook is ...</div><div class="ttdef"><b>Definition:</b> State.h:121</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a40f5606fe57295d12c430ce08421e544"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a40f5606fe57295d12c430ce08421e544">_EPT_HOOKED_PAGE_DETAIL::IsExecutionHook</a></div><div class="ttdeci">BOOLEAN IsExecutionHook</div><div class="ttdoc">This field shows whether the hook contains a hidden hook for execution or not.</div><div class="ttdef"><b>Definition:</b> State.h:147</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a4450bd220c3bce95443a102aa90fc93b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">_EPT_HOOKED_PAGE_DETAIL::PageHookList</a></div><div class="ttdeci">LIST_ENTRY PageHookList</div><div class="ttdoc">Linked list entires for each page hook.</div><div class="ttdef"><b>Definition:</b> State.h:98</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a5db4424bb300aec4ffabd7bfc5964417"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a5db4424bb300aec4ffabd7bfc5964417">_EPT_HOOKED_PAGE_DETAIL::IsMonitorToWriteOnPages</a></div><div class="ttdeci">BOOLEAN IsMonitorToWriteOnPages</div><div class="ttdoc">If TRUE, this hook relates to the write violation of the events.</div><div class="ttdef"><b>Definition:</b> State.h:158</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a87563a62e848638473d980314b01d28b"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a87563a62e848638473d980314b01d28b">_EPT_HOOKED_PAGE_DETAIL::ChangedEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY ChangedEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is remove from the page.</div><div class="ttdef"><b>Definition:</b> State.h:137</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_ac7782253bd8fa0ff92bce2b0f5ff269d"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">_EPT_HOOKED_PAGE_DETAIL::EntryAddress</a></div><div class="ttdeci">PEPT_PML1_ENTRY EntryAddress</div><div class="ttdef"><b>Definition:</b> State.h:126</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_acacf76428d2801be17ffb3e8b05e9374"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">_EPT_HOOKED_PAGE_DETAIL::OriginalEntry</a></div><div class="ttdeci">EPT_PML1_ENTRY OriginalEntry</div><div class="ttdoc">The original page entry. Will be copied back when the hook is removed from the page.</div><div class="ttdef"><b>Definition:</b> State.h:132</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afb78ebcdb15c9df1fc20831d93203019"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">_EPT_HOOKED_PAGE_DETAIL::PhysicalBaseAddress</a></div><div class="ttdeci">SIZE_T PhysicalBaseAddress</div><div class="ttdoc">The base address of the page. Used to find this structure in the list of page hooks when a hook is hi...</div><div class="ttdef"><b>Definition:</b> State.h:115</div></div>
<div class="ttc" id="astruct___e_p_t___s_t_a_t_e_html_a63cb7b9ebbfafeb6f69caa76f755c7bd"><div class="ttname"><a href="struct___e_p_t___s_t_a_t_e.html#a63cb7b9ebbfafeb6f69caa76f755c7bd">_EPT_STATE::EptPageTable</a></div><div class="ttdeci">PVMM_EPT_PAGE_TABLE EptPageTable</div><div class="ttdef"><b>Definition:</b> Ept.h:151</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acac4eff03b2197ae43e4c13f382e20b5" name="acac4eff03b2197ae43e4c13f382e20b5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acac4eff03b2197ae43e4c13f382e20b5">&#9670;&#160;</a></span>EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>Address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove the enrty from g_EptHook2sDetourListHead in the case of !epthook2 details. </p>
<p>Remove an entry from g_EptHook2sDetourListHead.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Address</td><td>Address to remove </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN TRUE if successfully removed and false if not found </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1291</span>{</div>
<div class="line"><span class="lineno"> 1292</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1293</span>    <span class="comment">// Iterate through the list of hooked pages details to find</span></div>
<div class="line"><span class="lineno"> 1294</span>    <span class="comment">// the entry in the list</span></div>
<div class="line"><span class="lineno"> 1295</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1296</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a90f5a18f43567010690d8d7927619fa0">g_EptHook2sDetourListHead</a>, <a class="code hl_struct" href="struct___h_i_d_d_e_n___h_o_o_k_s___d_e_t_o_u_r___d_e_t_a_i_l_s.html">HIDDEN_HOOKS_DETOUR_DETAILS</a>, OtherHooksList, CurrentHookedDetails)</div>
<div class="line"><span class="lineno"> 1297</span>    {</div>
<div class="line"><span class="lineno"> 1298</span>        <span class="keywordflow">if</span> (CurrentHookedDetails-&gt;HookedFunctionAddress == <a class="code hl_variable" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a>)</div>
<div class="line"><span class="lineno"> 1299</span>        {</div>
<div class="line"><span class="lineno"> 1300</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1301</span>            <span class="comment">// We found the address, we should remove it and add it for</span></div>
<div class="line"><span class="lineno"> 1302</span>            <span class="comment">// future deallocation</span></div>
<div class="line"><span class="lineno"> 1303</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1304</span>            <a class="code hl_function" href="list_8h.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;CurrentHookedDetails-&gt;OtherHooksList);</div>
<div class="line"><span class="lineno"> 1305</span> </div>
<div class="line"><span class="lineno"> 1306</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1307</span>            <span class="comment">// Free the pool in next ioctl</span></div>
<div class="line"><span class="lineno"> 1308</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1309</span>            <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(CurrentHookedDetails))</div>
<div class="line"><span class="lineno"> 1310</span>            {</div>
<div class="line"><span class="lineno"> 1311</span>                <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1312</span>            }</div>
<div class="line"><span class="lineno"> 1313</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1314</span>        }</div>
<div class="line"><span class="lineno"> 1315</span>    }</div>
<div class="line"><span class="lineno"> 1316</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1317</span>    <span class="comment">// No entry found !</span></div>
<div class="line"><span class="lineno"> 1318</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1319</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1320</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_script_imports_8h_html_a3f7c5b71d899e923be0a80d4ac7902fe"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_script_imports_8h.html#a3f7c5b71d899e923be0a80d4ac7902fe">Address</a></div><div class="ttdeci">UINT64 Address</div><div class="ttdef"><b>Definition:</b> HyperDbgScriptImports.h:56</div></div>
<div class="ttc" id="alist_8h_html_a1384c9ab335080c2fdc01fc7eca7673c"><div class="ttname"><a href="list_8h.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a></div><div class="ttdeci">BOOLEAN RemoveEntryList(PLIST_ENTRY Entry)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="acd59638727980bbd58fb4665ffce9091" name="acd59638727980bbd58fb4665ffce9091"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd59638727980bbd58fb4665ffce9091">&#9670;&#160;</a></span>EptHookRestoreAllHooksToOrginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookRestoreAllHooksToOrginalEntry </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove and Invalidate Hook in TLB. </p>
<p>Remove all hooks from the hooked pages lists (Should be called in vmx-root)</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookAll instead</dd></dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  514</span>{</div>
<div class="line"><span class="lineno">  515</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  516</span>    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><span class="lineno">  517</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  518</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  519</span>    {</div>
<div class="line"><span class="lineno">  520</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  521</span>    }</div>
<div class="line"><span class="lineno">  522</span> </div>
<div class="line"><span class="lineno">  523</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno">  524</span>    {</div>
<div class="line"><span class="lineno">  525</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  526</span>        <span class="comment">// Undo the hook on the EPT table</span></div>
<div class="line"><span class="lineno">  527</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  528</span>        <a class="code hl_function" href="_ept_8c.html#aad64c2c08fba48ccdb0a34d5c1dee97f">EptSetPML1AndInvalidateTLB</a>(CurrEntity-&gt;EntryAddress, CurrEntity-&gt;OriginalEntry, InveptSingleContext);</div>
<div class="line"><span class="lineno">  529</span>    }</div>
<div class="line"><span class="lineno">  530</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aba59e4d31f5cf37d9436d73933e8158c" name="aba59e4d31f5cf37d9436d73933e8158c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba59e4d31f5cf37d9436d73933e8158c">&#9670;&#160;</a></span>EptHookRestoreSingleHookToOrginalEntry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookRestoreSingleHookToOrginalEntry </td>
          <td>(</td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>PhysicalAddress</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove and Invalidate Hook in TLB (Hidden Detours and if counter of hidden breakpoint is zero) </p>
<p>Remove a special hook from the hooked pages lists.</p>
<dl class="section warning"><dt>Warning</dt><dd>This function won't remove entries from LIST_ENTRY, just invalidate the paging, use EptHookUnHookSingleAddress instead</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PhysicalAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN Return false if there was an error or returns true if it was successfull </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  479</span>{</div>
<div class="line"><span class="lineno">  480</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  481</span>    <span class="comment">// Should be called from vmx-root, for calling from vmx non-root use the corresponding VMCALL</span></div>
<div class="line"><span class="lineno">  482</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  483</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)</div>
<div class="line"><span class="lineno">  484</span>    {</div>
<div class="line"><span class="lineno">  485</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  486</span>    }</div>
<div class="line"><span class="lineno">  487</span> </div>
<div class="line"><span class="lineno">  488</span>    <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a> * HookedEntry = {0};</div>
<div class="line"><span class="lineno">  489</span> </div>
<div class="line"><span class="lineno">  490</span>    <span class="keywordflow">if</span> (EptHookFindByPhysAddress(<a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(PhysicalAddress), HookedEntry) == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> &amp;&amp; HookedEntry != NULL)</div>
<div class="line"><span class="lineno">  491</span>    {</div>
<div class="line"><span class="lineno">  492</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  493</span>        <span class="comment">// Undo the hook on the EPT table</span></div>
<div class="line"><span class="lineno">  494</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno">  495</span>        <a class="code hl_function" href="_ept_8c.html#aad64c2c08fba48ccdb0a34d5c1dee97f">EptSetPML1AndInvalidateTLB</a>(HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#ac7782253bd8fa0ff92bce2b0f5ff269d">EntryAddress</a>, HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#acacf76428d2801be17ffb3e8b05e9374">OriginalEntry</a>, InveptSingleContext);</div>
<div class="line"><span class="lineno">  496</span> </div>
<div class="line"><span class="lineno">  497</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno">  498</span>    }</div>
<div class="line"><span class="lineno">  499</span> </div>
<div class="line"><span class="lineno">  500</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  501</span>    <span class="comment">// Nothing found, probably the list is not found</span></div>
<div class="line"><span class="lineno">  502</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  503</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno">  504</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ac8845ca75f3b4c267d3542d20621f547" name="ac8845ca75f3b4c267d3542d20621f547"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac8845ca75f3b4c267d3542d20621f547">&#9670;&#160;</a></span>EptHookUnHookAll()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookUnHookAll </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove all hooks from the hooked pages list and invalidate TLB @detailsShould be called from Vmx Non-root. </p>
<p>Remove all hooks from the hooked pages lists.</p>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1604</span>{</div>
<div class="line"><span class="lineno"> 1605</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1606</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 1607</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1608</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1609</span>    {</div>
<div class="line"><span class="lineno"> 1610</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno"> 1611</span>    }</div>
<div class="line"><span class="lineno"> 1612</span> </div>
<div class="line"><span class="lineno"> 1613</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1614</span>    <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><span class="lineno"> 1615</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1616</span>    KeGenericCallDpc(<a class="code hl_function" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a>, 0x0);</div>
<div class="line"><span class="lineno"> 1617</span> </div>
<div class="line"><span class="lineno"> 1618</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1619</span>    <span class="comment">// In the case of unhooking all pages, we remove the hooked</span></div>
<div class="line"><span class="lineno"> 1620</span>    <span class="comment">// from EPT table in vmx-root and at last, we need to deallocate</span></div>
<div class="line"><span class="lineno"> 1621</span>    <span class="comment">// it from the buffers</span></div>
<div class="line"><span class="lineno"> 1622</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1623</span> </div>
<div class="line"><span class="lineno"> 1624</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno"> 1625</span>    {</div>
<div class="line"><span class="lineno"> 1626</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1627</span>        <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><span class="lineno"> 1628</span>        <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><span class="lineno"> 1629</span>        <span class="comment">// if the hook is detours</span></div>
<div class="line"><span class="lineno"> 1630</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1631</span>        <span class="keywordflow">if</span> (!CurrEntity-&gt;IsHiddenBreakpoint)</div>
<div class="line"><span class="lineno"> 1632</span>        {</div>
<div class="line"><span class="lineno"> 1633</span>            <a class="code hl_function" href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(CurrEntity-&gt;VirtualAddress);</div>
<div class="line"><span class="lineno"> 1634</span>        }</div>
<div class="line"><span class="lineno"> 1635</span> </div>
<div class="line"><span class="lineno"> 1636</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1637</span>        <span class="comment">// As we are in vmx-root here, we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 1638</span>        <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 1639</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1640</span>        <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(CurrEntity))</div>
<div class="line"><span class="lineno"> 1641</span>        {</div>
<div class="line"><span class="lineno"> 1642</span>            <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1643</span>        }</div>
<div class="line"><span class="lineno"> 1644</span>    }</div>
<div class="line"><span class="lineno"> 1645</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_acac4eff03b2197ae43e4c13f382e20b5"><div class="ttname"><a href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a></div><div class="ttdeci">BOOLEAN EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList(UINT64 Address)</div><div class="ttdoc">Remove the enrty from g_EptHook2sDetourListHead in the case of !epthook2 details.</div><div class="ttdef"><b>Definition:</b> EptHook.c:1290</div></div>
<div class="ttc" id="ahprdbghv_2code_2broadcast_2_dpc_routines_8c_html_ac0df5b089250515279b8c348e0817977"><div class="ttname"><a href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ac0df5b089250515279b8c348e0817977">DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateAllEntriesOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes all the hooks and invalidate TLB.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1572</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a24ce2115ab4514ec8eed08d0911b64d6" name="a24ce2115ab4514ec8eed08d0911b64d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a24ce2115ab4514ec8eed08d0911b64d6">&#9670;&#160;</a></span>EptHookUnHookSingleAddress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddress </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>PhysAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>&#160;</td>
          <td class="paramname"><em>ProcessId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook from the hooked pages list and invalidate TLB. </p>
<p>Should be called from vmx non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">VirtualAddress</td><td>Virtual address to unhook </td></tr>
    <tr><td class="paramname">PhysAddress</td><td>Physical address to unhook (optional) </td></tr>
    <tr><td class="paramname">ProcessId</td><td>The process id of target process</td></tr>
  </table>
  </dd>
</dl>
<p>in unhooking for some hooks only physical address is availables</p>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1538</span>{</div>
<div class="line"><span class="lineno"> 1539</span>    SIZE_T PhysicalAddress;</div>
<div class="line"><span class="lineno"> 1540</span> </div>
<div class="line"><span class="lineno"> 1541</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1542</span>    <span class="comment">// Should be called from vmx non-root</span></div>
<div class="line"><span class="lineno"> 1543</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1544</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="_vmx_8c.html#a21a5facaf10e8fbeb70dd00942e51ef1">VmxGetCurrentExecutionMode</a>() == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)</div>
<div class="line"><span class="lineno"> 1545</span>    {</div>
<div class="line"><span class="lineno"> 1546</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1547</span>    }</div>
<div class="line"><span class="lineno"> 1548</span> </div>
<div class="line"><span class="lineno"> 1549</span>    <span class="keywordflow">if</span> (ProcessId == <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a> || ProcessId == 0)</div>
<div class="line"><span class="lineno"> 1550</span>    {</div>
<div class="line"><span class="lineno"> 1551</span>        ProcessId = PsGetCurrentProcessId();</div>
<div class="line"><span class="lineno"> 1552</span>    }</div>
<div class="line"><span class="lineno"> 1553</span> </div>
<div class="line"><span class="lineno"> 1554</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1555</span>    <span class="comment">// Check if the physical address is available or not</span></div>
<div class="line"><span class="lineno"> 1556</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1557</span>    <span class="keywordflow">if</span> (PhysAddress == NULL)</div>
<div class="line"><span class="lineno"> 1558</span>    {</div>
<div class="line"><span class="lineno"> 1559</span>        PhysicalAddress = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#adb0d4df682039d23559162b1aa2bd1a2">VirtualAddressToPhysicalAddressByProcessId</a>(VirtualAddress, ProcessId));</div>
<div class="line"><span class="lineno"> 1560</span>    }</div>
<div class="line"><span class="lineno"> 1561</span>    <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1562</span>    {</div>
<div class="line"><span class="lineno"> 1563</span>        PhysicalAddress = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(PhysAddress);</div>
<div class="line"><span class="lineno"> 1564</span>    }</div>
<div class="line"><span class="lineno"> 1565</span> </div>
<div class="line"><span class="lineno"> 1566</span>    <a class="code hl_define" href="_meta_macros_8h.html#ae6305b9ffbb1d946674b7b98431a67e9">LIST_FOR_EACH_LINK</a>(<a class="code hl_variable" href="_global_variables_8h.html#a302f00c62e7ad092a9f44a3aa7452d99">g_EptState</a>-&gt;<a class="code hl_variable" href="struct___e_p_t___s_t_a_t_e.html#a2503c5862b1bb2b779e2185b4097aa15">HookedPagesList</a>, <a class="code hl_struct" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html">EPT_HOOKED_PAGE_DETAIL</a>, PageHookList, CurrEntity)</div>
<div class="line"><span class="lineno"> 1567</span>    {</div>
<div class="line"><span class="lineno"> 1568</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1569</span>        <span class="comment">// Check if it&#39;s a hidden breakpoint or hidden detours</span></div>
<div class="line"><span class="lineno"> 1570</span>        <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1571</span>        <span class="keywordflow">if</span> (CurrEntity-&gt;IsHiddenBreakpoint)</div>
<div class="line"><span class="lineno"> 1572</span>        {</div>
<div class="line"><span class="lineno"> 1573</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1574</span>            <span class="comment">// It&#39;s a hidden breakpoint</span></div>
<div class="line"><span class="lineno"> 1575</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1576</span>            <span class="keywordflow">return</span> <a class="code hl_function" href="_ept_hook_8c.html#a306251376f5053ae69db0b13c3628b4e">EptHookUnHookSingleAddressHiddenBreakpoint</a>(CurrEntity, VirtualAddress);</div>
<div class="line"><span class="lineno"> 1577</span>        }</div>
<div class="line"><span class="lineno"> 1578</span>        <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1579</span>        {</div>
<div class="line"><span class="lineno"> 1580</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1581</span>            <span class="comment">// It&#39;s either a hidden detours or a monitor (read/write) entry</span></div>
<div class="line"><span class="lineno"> 1582</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1583</span>            <span class="keywordflow">if</span> (CurrEntity-&gt;PhysicalBaseAddress == PhysicalAddress)</div>
<div class="line"><span class="lineno"> 1584</span>            {</div>
<div class="line"><span class="lineno"> 1585</span>                <span class="keywordflow">return</span> <a class="code hl_function" href="_ept_hook_8c.html#adb9948249f757e97fea745b0c0d8f9b0">EptHookUnHookSingleAddressDetours</a>(CurrEntity);</div>
<div class="line"><span class="lineno"> 1586</span>            }</div>
<div class="line"><span class="lineno"> 1587</span>        }</div>
<div class="line"><span class="lineno"> 1588</span>    }</div>
<div class="line"><span class="lineno"> 1589</span> </div>
<div class="line"><span class="lineno"> 1590</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1591</span>    <span class="comment">// Nothing found , probably the list is not found</span></div>
<div class="line"><span class="lineno"> 1592</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1593</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1594</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_a306251376f5053ae69db0b13c3628b4e"><div class="ttname"><a href="_ept_hook_8c.html#a306251376f5053ae69db0b13c3628b4e">EptHookUnHookSingleAddressHiddenBreakpoint</a></div><div class="ttdeci">BOOLEAN EptHookUnHookSingleAddressHiddenBreakpoint(PEPT_HOOKED_PAGE_DETAIL HookedEntry, UINT64 VirtualAddress)</div><div class="ttdoc">Remove single hook of hidden breakpoint type.</div><div class="ttdef"><b>Definition:</b> EptHook.c:1404</div></div>
<div class="ttc" id="a_ept_hook_8c_html_adb9948249f757e97fea745b0c0d8f9b0"><div class="ttname"><a href="_ept_hook_8c.html#adb9948249f757e97fea745b0c0d8f9b0">EptHookUnHookSingleAddressDetours</a></div><div class="ttdeci">BOOLEAN EptHookUnHookSingleAddressDetours(PEPT_HOOKED_PAGE_DETAIL HookedEntry)</div><div class="ttdoc">Remove single hook of detours type.</div><div class="ttdef"><b>Definition:</b> EptHook.c:1363</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_constants_8h_html_ab3bb4c0d2a847e96e2988afd99c82074"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_constants_8h.html#ab3bb4c0d2a847e96e2988afd99c82074">DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</a></div><div class="ttdeci">#define DEBUGGER_EVENT_APPLY_TO_ALL_PROCESSES</div><div class="ttdoc">Apply the event to all the processes.</div><div class="ttdef"><b>Definition:</b> Constants.h:557</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_adb0d4df682039d23559162b1aa2bd1a2"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#adb0d4df682039d23559162b1aa2bd1a2">VirtualAddressToPhysicalAddressByProcessId</a></div><div class="ttdeci">IMPORT_EXPORT_VMM UINT64 VirtualAddressToPhysicalAddressByProcessId(_In_ PVOID VirtualAddress, _In_ UINT32 ProcessId)</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="adb9948249f757e97fea745b0c0d8f9b0" name="adb9948249f757e97fea745b0c0d8f9b0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb9948249f757e97fea745b0c0d8f9b0">&#9670;&#160;</a></span>EptHookUnHookSingleAddressDetours()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddressDetours </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a>&#160;</td>
          <td class="paramname"><em>HookedEntry</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook of detours type. </p>
<p>Should be called from vmx non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookedEntry</td><td>entry detail of hooked address </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1364</span>{</div>
<div class="line"><span class="lineno"> 1365</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1366</span>    <span class="comment">// Remove it in all the cores</span></div>
<div class="line"><span class="lineno"> 1367</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1368</span>    KeGenericCallDpc(<a class="code hl_function" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>);</div>
<div class="line"><span class="lineno"> 1369</span> </div>
<div class="line"><span class="lineno"> 1370</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1371</span>    <span class="comment">// Now that we removed this hidden detours hook, it is</span></div>
<div class="line"><span class="lineno"> 1372</span>    <span class="comment">// time to remove it from g_EptHook2sDetourListHead</span></div>
<div class="line"><span class="lineno"> 1373</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1374</span>    <a class="code hl_function" href="_ept_hook_8c.html#acac4eff03b2197ae43e4c13f382e20b5">EptHookRemoveEntryAndFreePoolFromEptHook2sDetourList</a>(HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a3464acbaf76a38d67558d8ff3bee342f">VirtualAddress</a>);</div>
<div class="line"><span class="lineno"> 1375</span> </div>
<div class="line"><span class="lineno"> 1376</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1377</span>    <span class="comment">// remove the entry from the list</span></div>
<div class="line"><span class="lineno"> 1378</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1379</span>    <a class="code hl_function" href="list_8h.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><span class="lineno"> 1380</span> </div>
<div class="line"><span class="lineno"> 1381</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1382</span>    <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 1383</span>    <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 1384</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1385</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(HookedEntry))</div>
<div class="line"><span class="lineno"> 1386</span>    {</div>
<div class="line"><span class="lineno"> 1387</span>        <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1388</span>        <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1389</span>    }</div>
<div class="line"><span class="lineno"> 1390</span> </div>
<div class="line"><span class="lineno"> 1391</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1392</span>}</div>
<div class="ttc" id="ahprdbghv_2code_2broadcast_2_dpc_routines_8c_html_ae978b3d6e7b660da69ab279da37a529e"><div class="ttname"><a href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a></div><div class="ttdeci">VOID DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores(KDPC *Dpc, PVOID DeferredContext, PVOID SystemArgument1, PVOID SystemArgument2)</div><div class="ttdoc">The broadcast function which removes the single hook and invalidate TLB.</div><div class="ttdef"><b>Definition:</b> DpcRoutines.c:1603</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a306251376f5053ae69db0b13c3628b4e" name="a306251376f5053ae69db0b13c3628b4e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a306251376f5053ae69db0b13c3628b4e">&#9670;&#160;</a></span>EptHookUnHookSingleAddressHiddenBreakpoint()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a1cb18096b299d23458d3c7b85fd86555">BOOLEAN</a> EptHookUnHookSingleAddressHiddenBreakpoint </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="hprdbghv_2header_2common_2_state_8h.html#a436ee82d49f49a4839e9d4fe2ee8eacf">PEPT_HOOKED_PAGE_DETAIL</a>&#160;</td>
          <td class="paramname"><em>HookedEntry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a>&#160;</td>
          <td class="paramname"><em>VirtualAddress</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Remove single hook of hidden breakpoint type. </p>
<p>Should be called from vmx non-root</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">HookedEntry</td><td>entry detail of hooked address </td></tr>
    <tr><td class="paramname">VirtualAddress</td><td>virtual address to unhook </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>BOOLEAN If unhook was successful it returns true or if it was not successful returns false </dd></dl>
<div class="fragment"><div class="line"><span class="lineno"> 1405</span>{</div>
<div class="line"><span class="lineno"> 1406</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> TargetAddressInFakePageContent;</div>
<div class="line"><span class="lineno"> 1407</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aae17ebb9ef7279d026817fb22f8aebe9">UINT64</a> PageOffset;</div>
<div class="line"><span class="lineno"> 1408</span>    <a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a> CountOfEntriesWithSameAddr = 0;</div>
<div class="line"><span class="lineno"> 1409</span> </div>
<div class="line"><span class="lineno"> 1410</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1411</span>    <span class="comment">// It&#39;s a hidden breakpoint (we have to search through an array of addresses)</span></div>
<div class="line"><span class="lineno"> 1412</span>    <span class="comment">// We count it from top to down because if there are two ept hooks at the</span></div>
<div class="line"><span class="lineno"> 1413</span>    <span class="comment">// same address, then the last one has an invalid PreviousByte and this</span></div>
<div class="line"><span class="lineno"> 1414</span>    <span class="comment">// is the HookedEntry that should be remove (not the first one as it has the</span></div>
<div class="line"><span class="lineno"> 1415</span>    <span class="comment">// correct PreviousByte)</span></div>
<div class="line"><span class="lineno"> 1416</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1417</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>; i-- &gt; 0;)</div>
<div class="line"><span class="lineno"> 1418</span>    {</div>
<div class="line"><span class="lineno"> 1419</span>        <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i] == VirtualAddress)</div>
<div class="line"><span class="lineno"> 1420</span>        {</div>
<div class="line"><span class="lineno"> 1421</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1422</span>            <span class="comment">// Check if it&#39;s a single breakpoint</span></div>
<div class="line"><span class="lineno"> 1423</span>            <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1424</span>            <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> == 1)</div>
<div class="line"><span class="lineno"> 1425</span>            {</div>
<div class="line"><span class="lineno"> 1426</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1427</span>                <span class="comment">// Remove the hook entirely on all cores</span></div>
<div class="line"><span class="lineno"> 1428</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1429</span>                KeGenericCallDpc(<a class="code hl_function" href="hprdbghv_2code_2broadcast_2_dpc_routines_8c.html#ae978b3d6e7b660da69ab279da37a529e">DpcRoutineRemoveHookAndInvalidateSingleEntryOnAllCores</a>, HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afb78ebcdb15c9df1fc20831d93203019">PhysicalBaseAddress</a>);</div>
<div class="line"><span class="lineno"> 1430</span> </div>
<div class="line"><span class="lineno"> 1431</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1432</span>                <span class="comment">// remove the entry from the list</span></div>
<div class="line"><span class="lineno"> 1433</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1434</span>                <a class="code hl_function" href="list_8h.html#a1384c9ab335080c2fdc01fc7eca7673c">RemoveEntryList</a>(&amp;HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4450bd220c3bce95443a102aa90fc93b">PageHookList</a>);</div>
<div class="line"><span class="lineno"> 1435</span> </div>
<div class="line"><span class="lineno"> 1436</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1437</span>                <span class="comment">// we add the hooked entry to the list</span></div>
<div class="line"><span class="lineno"> 1438</span>                <span class="comment">// of pools that will be deallocated on next IOCTL</span></div>
<div class="line"><span class="lineno"> 1439</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1440</span>                <span class="keywordflow">if</span> (!<a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a959d3b71e4d867f6a1499abc90cb6023">PoolManagerFreePool</a>(HookedEntry))</div>
<div class="line"><span class="lineno"> 1441</span>                {</div>
<div class="line"><span class="lineno"> 1442</span>                    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a459b19922fecfbb9438dd56b66930d16">LogError</a>(<span class="stringliteral">&quot;Err, something goes wrong, the pool not found in the list of previously allocated pools by pool manager&quot;</span>);</div>
<div class="line"><span class="lineno"> 1443</span>                }</div>
<div class="line"><span class="lineno"> 1444</span> </div>
<div class="line"><span class="lineno"> 1445</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1446</span>                <span class="comment">// Check if there is any other breakpoints, if no then we have to disalbe</span></div>
<div class="line"><span class="lineno"> 1447</span>                <span class="comment">// exception bitmaps on vm-exits for breakpoint, for this purpose, we have</span></div>
<div class="line"><span class="lineno"> 1448</span>                <span class="comment">// to visit all the entries to see if there is any entries</span></div>
<div class="line"><span class="lineno"> 1449</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1450</span>                <span class="keywordflow">if</span> (<a class="code hl_function" href="_ept_hook_8c.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a>(<a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) == 0)</div>
<div class="line"><span class="lineno"> 1451</span>                {</div>
<div class="line"><span class="lineno"> 1452</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1453</span>                    <span class="comment">// Did not find any entry, let&#39;s disable the breakpoints vm-exits</span></div>
<div class="line"><span class="lineno"> 1454</span>                    <span class="comment">// on exception bitmaps</span></div>
<div class="line"><span class="lineno"> 1455</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1456</span>                    <a class="code hl_function" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a909b7c71e9c9e9948a912eb4254df194">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a>();</div>
<div class="line"><span class="lineno"> 1457</span>                }</div>
<div class="line"><span class="lineno"> 1458</span> </div>
<div class="line"><span class="lineno"> 1459</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1460</span>            }</div>
<div class="line"><span class="lineno"> 1461</span>            <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno"> 1462</span>            {</div>
<div class="line"><span class="lineno"> 1463</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1464</span>                <span class="comment">// Set 0xcc to its previous value</span></div>
<div class="line"><span class="lineno"> 1465</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1466</span>                TargetAddressInFakePageContent = &amp;HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a4c523ca3a1b46bf34681abfec4fef75e">FakePageContents</a>;</div>
<div class="line"><span class="lineno"> 1467</span>                TargetAddressInFakePageContent = <a class="code hl_define" href="hprdbgctrl_2header_2common_8h.html#aa02188de52b66a3aa5e1aecc6bd963ae">PAGE_ALIGN</a>(TargetAddressInFakePageContent);</div>
<div class="line"><span class="lineno"> 1468</span>                PageOffset                     = <a class="code hl_define" href="hprdbghv_2header_2common_2common_8h.html#a1ebb2ec82baedeecf55e15778b8dd0aa">PAGE_OFFSET</a>(VirtualAddress);</div>
<div class="line"><span class="lineno"> 1469</span>                TargetAddressInFakePageContent = TargetAddressInFakePageContent + PageOffset;</div>
<div class="line"><span class="lineno"> 1470</span> </div>
<div class="line"><span class="lineno"> 1471</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1472</span>                <span class="comment">// We&#39;ll check if there is another hooked address with the same virtual address</span></div>
<div class="line"><span class="lineno"> 1473</span>                <span class="comment">// in the array, then we&#39;ll ignore setting the previous bit as previous bit might</span></div>
<div class="line"><span class="lineno"> 1474</span>                <span class="comment">// be modified for the previous command</span></div>
<div class="line"><span class="lineno"> 1475</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1476</span>                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a>; j++)</div>
<div class="line"><span class="lineno"> 1477</span>                {</div>
<div class="line"><span class="lineno"> 1478</span>                    <span class="keywordflow">if</span> (HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i] == VirtualAddress)</div>
<div class="line"><span class="lineno"> 1479</span>                    {</div>
<div class="line"><span class="lineno"> 1480</span>                        CountOfEntriesWithSameAddr++;</div>
<div class="line"><span class="lineno"> 1481</span>                    }</div>
<div class="line"><span class="lineno"> 1482</span>                }</div>
<div class="line"><span class="lineno"> 1483</span> </div>
<div class="line"><span class="lineno"> 1484</span>                <span class="keywordflow">if</span> (CountOfEntriesWithSameAddr == 1)</div>
<div class="line"><span class="lineno"> 1485</span>                {</div>
<div class="line"><span class="lineno"> 1486</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1487</span>                    <span class="comment">// Set the previous value</span></div>
<div class="line"><span class="lineno"> 1488</span>                    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1489</span>                    *(<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)TargetAddressInFakePageContent = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[i];</div>
<div class="line"><span class="lineno"> 1490</span>                }</div>
<div class="line"><span class="lineno"> 1491</span> </div>
<div class="line"><span class="lineno"> 1492</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1493</span>                <span class="comment">// Remove just that special entry</span></div>
<div class="line"><span class="lineno"> 1494</span>                <span class="comment">// Btw, No need to remove it, it will be replaced automatically</span></div>
<div class="line"><span class="lineno"> 1495</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1496</span>                HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[i]                = NULL;</div>
<div class="line"><span class="lineno"> 1497</span>                HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[i] = 0x0;</div>
<div class="line"><span class="lineno"> 1498</span> </div>
<div class="line"><span class="lineno"> 1499</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1500</span>                <span class="comment">// all addresses to a lower array index (because one entry is</span></div>
<div class="line"><span class="lineno"> 1501</span>                <span class="comment">// missing and might) be in the middle of the array</span></div>
<div class="line"><span class="lineno"> 1502</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1503</span>                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = i; j &lt; <a class="code hl_define" href="hprdbghv_2header_2common_2_state_8h.html#a1bea5321e3bc6afd7a50e5208be94d74">MaximumHiddenBreakpointsOnPage</a> - 1; j++)</div>
<div class="line"><span class="lineno"> 1504</span>                {</div>
<div class="line"><span class="lineno"> 1505</span>                    HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[j]                = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">BreakpointAddresses</a>[j + 1];</div>
<div class="line"><span class="lineno"> 1506</span>                    HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[j] = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">PreviousBytesOnBreakpointAddresses</a>[j + 1];</div>
<div class="line"><span class="lineno"> 1507</span>                }</div>
<div class="line"><span class="lineno"> 1508</span> </div>
<div class="line"><span class="lineno"> 1509</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1510</span>                <span class="comment">// Decrease the count of breakpoints</span></div>
<div class="line"><span class="lineno"> 1511</span>                <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1512</span>                HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> = HookedEntry-&gt;<a class="code hl_variable" href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">CountOfBreakpoints</a> - 1;</div>
<div class="line"><span class="lineno"> 1513</span> </div>
<div class="line"><span class="lineno"> 1514</span>                <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line"><span class="lineno"> 1515</span>            }</div>
<div class="line"><span class="lineno"> 1516</span>        }</div>
<div class="line"><span class="lineno"> 1517</span>    }</div>
<div class="line"><span class="lineno"> 1518</span> </div>
<div class="line"><span class="lineno"> 1519</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1520</span>    <span class="comment">// If we reach here, sth went</span></div>
<div class="line"><span class="lineno"> 1521</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno"> 1522</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="lineno"> 1523</span>}</div>
<div class="ttc" id="a_ept_hook_8c_html_acd0179b7c5730f636141dfea2afcdc5a"><div class="ttname"><a href="_ept_hook_8c.html#acd0179b7c5730f636141dfea2afcdc5a">EptHookGetCountOfEpthooks</a></div><div class="ttdeci">UINT32 EptHookGetCountOfEpthooks(BOOLEAN IsEptHook2)</div><div class="ttdoc">get the length of active EPT hooks (!epthook and !epthook2)</div><div class="ttdef"><b>Definition:</b> EptHook.c:1329</div></div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h_html_a909b7c71e9c9e9948a912eb4254df194"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_vmm_imports_8h.html#a909b7c71e9c9e9948a912eb4254df194">BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores</a></div><div class="ttdeci">IMPORT_EXPORT_VMM VOID BroadcastDisableBreakpointExitingOnExceptionBitmapAllCores()</div><div class="ttdoc">routines to disable vm-exit for breakpoints (exception bitmap)</div><div class="ttdef"><b>Definition:</b> Broadcast.c:77</div></div>
<div class="ttc" id="ahprdbghv_2header_2common_2_state_8h_html_a1bea5321e3bc6afd7a50e5208be94d74"><div class="ttname"><a href="hprdbghv_2header_2common_2_state_8h.html#a1bea5321e3bc6afd7a50e5208be94d74">MaximumHiddenBreakpointsOnPage</a></div><div class="ttdeci">#define MaximumHiddenBreakpointsOnPage</div><div class="ttdoc">Maximum number of hidden breakpoints in a page.</div><div class="ttdef"><b>Definition:</b> State.h:38</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_a9a3a0a03e6ce50440efa6185f63a6882"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#a9a3a0a03e6ce50440efa6185f63a6882">_EPT_HOOKED_PAGE_DETAIL::PreviousBytesOnBreakpointAddresses</a></div><div class="ttdeci">CHAR PreviousBytesOnBreakpointAddresses[MaximumHiddenBreakpointsOnPage]</div><div class="ttdoc">Character that was previously used in BreakpointAddresses this is only used in hidden breakpoints (no...</div><div class="ttdef"><b>Definition:</b> State.h:183</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_aaaf2650f56c9581f4724da1e833257ef"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#aaaf2650f56c9581f4724da1e833257ef">_EPT_HOOKED_PAGE_DETAIL::BreakpointAddresses</a></div><div class="ttdeci">UINT64 BreakpointAddresses[MaximumHiddenBreakpointsOnPage]</div><div class="ttdoc">Address of hooked pages (multiple breakpoints on a single page) this is only used in hidden breakpoin...</div><div class="ttdef"><b>Definition:</b> State.h:177</div></div>
<div class="ttc" id="astruct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l_html_afc5fdacf494efec054863c41f754b0a0"><div class="ttname"><a href="struct___e_p_t___h_o_o_k_e_d___p_a_g_e___d_e_t_a_i_l.html#afc5fdacf494efec054863c41f754b0a0">_EPT_HOOKED_PAGE_DETAIL::CountOfBreakpoints</a></div><div class="ttdeci">UINT64 CountOfBreakpoints</div><div class="ttdoc">Count of breakpoints (multiple breakpoints on a single page) this is only used in hidden breakpoints ...</div><div class="ttdef"><b>Definition:</b> State.h:189</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a50935db932e916707520e63212e9e688" name="a50935db932e916707520e63212e9e688"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50935db932e916707520e63212e9e688">&#9670;&#160;</a></span>EptHookWriteAbsoluteJump()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookWriteAbsoluteJump </td>
          <td>(</td>
          <td class="paramtype">PCHAR&#160;</td>
          <td class="paramname"><em>TargetBuffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>TargetAddress</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write an absolute x64 jump to an arbitrary address to a buffer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetBuffer</td><td></td></tr>
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  541</span>{</div>
<div class="line"><span class="lineno">  542</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  543</span>    <span class="comment">// call $ + 5 ; A 64-bit call instruction is still 5 bytes wide!</span></div>
<div class="line"><span class="lineno">  544</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  545</span> </div>
<div class="line"><span class="lineno">  546</span>    TargetBuffer[0] = 0xe8;</div>
<div class="line"><span class="lineno">  547</span>    TargetBuffer[1] = 0x00;</div>
<div class="line"><span class="lineno">  548</span>    TargetBuffer[2] = 0x00;</div>
<div class="line"><span class="lineno">  549</span>    TargetBuffer[3] = 0x00;</div>
<div class="line"><span class="lineno">  550</span>    TargetBuffer[4] = 0x00;</div>
<div class="line"><span class="lineno">  551</span> </div>
<div class="line"><span class="lineno">  552</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  553</span>    <span class="comment">// push Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  554</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  555</span>    TargetBuffer[5] = 0x68;</div>
<div class="line"><span class="lineno">  556</span> </div>
<div class="line"><span class="lineno">  557</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  558</span>    <span class="comment">// Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  559</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  560</span>    *((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[6]) = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)TargetAddress;</div>
<div class="line"><span class="lineno">  561</span> </div>
<div class="line"><span class="lineno">  562</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  563</span>    <span class="comment">// mov [rsp+4],High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  564</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  565</span>    TargetBuffer[10] = 0xC7;</div>
<div class="line"><span class="lineno">  566</span>    TargetBuffer[11] = 0x44;</div>
<div class="line"><span class="lineno">  567</span>    TargetBuffer[12] = 0x24;</div>
<div class="line"><span class="lineno">  568</span>    TargetBuffer[13] = 0x04;</div>
<div class="line"><span class="lineno">  569</span> </div>
<div class="line"><span class="lineno">  570</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  571</span>    <span class="comment">// High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  572</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  573</span>    *((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[14]) = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(TargetAddress &gt;&gt; 32);</div>
<div class="line"><span class="lineno">  574</span> </div>
<div class="line"><span class="lineno">  575</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  576</span>    <span class="comment">// ret</span></div>
<div class="line"><span class="lineno">  577</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  578</span>    TargetBuffer[18] = 0xC3;</div>
<div class="line"><span class="lineno">  579</span>}</div>
<div class="ttc" id="abuild_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h_html_a8e3d0f172defb4e820ad5df4ec48960c"><div class="ttname"><a href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a></div><div class="ttdeci">unsigned int * PUINT32</div><div class="ttdef"><b>Definition:</b> BasicTypes.h:46</div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8767a6d054fe785e66068e32b4466b87" name="a8767a6d054fe785e66068e32b4466b87"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8767a6d054fe785e66068e32b4466b87">&#9670;&#160;</a></span>EptHookWriteAbsoluteJump2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a7f319bfc2492a2136964194204e7a8cf">VOID</a> EptHookWriteAbsoluteJump2 </td>
          <td>(</td>
          <td class="paramtype">PCHAR&#160;</td>
          <td class="paramname"><em>TargetBuffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>TargetAddress</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write an absolute x64 jump to an arbitrary address to a buffer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">TargetBuffer</td><td></td></tr>
    <tr><td class="paramname">TargetAddress</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>VOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  590</span>{</div>
<div class="line"><span class="lineno">  591</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  592</span>    <span class="comment">// push Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  593</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  594</span>    TargetBuffer[0] = 0x68;</div>
<div class="line"><span class="lineno">  595</span> </div>
<div class="line"><span class="lineno">  596</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  597</span>    <span class="comment">// Lower 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  598</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  599</span>    *((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[1]) = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)TargetAddress;</div>
<div class="line"><span class="lineno">  600</span> </div>
<div class="line"><span class="lineno">  601</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  602</span>    <span class="comment">// mov [rsp+4],High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  603</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  604</span>    TargetBuffer[5] = 0xC7;</div>
<div class="line"><span class="lineno">  605</span>    TargetBuffer[6] = 0x44;</div>
<div class="line"><span class="lineno">  606</span>    TargetBuffer[7] = 0x24;</div>
<div class="line"><span class="lineno">  607</span>    TargetBuffer[8] = 0x04;</div>
<div class="line"><span class="lineno">  608</span> </div>
<div class="line"><span class="lineno">  609</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  610</span>    <span class="comment">// High 4-byte TargetAddress</span></div>
<div class="line"><span class="lineno">  611</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  612</span>    *((<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#a8e3d0f172defb4e820ad5df4ec48960c">PUINT32</a>)&amp;TargetBuffer[9]) = (<a class="code hl_typedef" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#ae1e6edbbc26d6fbc71a90190d0266018">UINT32</a>)(TargetAddress &gt;&gt; 32);</div>
<div class="line"><span class="lineno">  613</span> </div>
<div class="line"><span class="lineno">  614</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  615</span>    <span class="comment">// ret</span></div>
<div class="line"><span class="lineno">  616</span>    <span class="comment">//</span></div>
<div class="line"><span class="lineno">  617</span>    TargetBuffer[13] = 0xC3;</div>
<div class="line"><span class="lineno">  618</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="af62063007bc1450386954e16032ce5fd" name="af62063007bc1450386954e16032ce5fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af62063007bc1450386954e16032ce5fd">&#9670;&#160;</a></span>ExAllocatePoolWithTagHook()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">PVOID ExAllocatePoolWithTagHook </td>
          <td>(</td>
          <td class="paramtype">POOL_TYPE&#160;</td>
          <td class="paramname"><em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SIZE_T&#160;</td>
          <td class="paramname"><em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="build_2bin_2debug_2_s_d_k_2_headers_2_basic_types_8h.html#af632da489ebc3708ec3ab6791ee53fa4">ULONG</a>&#160;</td>
          <td class="paramname"><em>Tag</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Hook function that HooksExAllocatePoolWithTag. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PoolType</td><td></td></tr>
    <tr><td class="paramname">NumberOfBytes</td><td></td></tr>
    <tr><td class="paramname">Tag</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PVOID </dd></dl>
<div class="fragment"><div class="line"><span class="lineno">  355</span>{</div>
<div class="line"><span class="lineno">  356</span>    <a class="code hl_define" href="build_2bin_2debug_2_s_d_k_2_imports_2_hyper_dbg_hyper_log_intrinsics_8h.html#a97b0adbd65790fb90734daa8e5245a04">LogInfo</a>(<span class="stringliteral">&quot;ExAllocatePoolWithTag Called with : Tag = 0x%x , Number Of Bytes = 0x%x , Pool Type = 0x%x &quot;</span>, <a class="code hl_variable" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>, <a class="code hl_variable" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>, <a class="code hl_variable" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>);</div>
<div class="line"><span class="lineno">  357</span>    <span class="keywordflow">return</span> ExAllocatePoolWithTagOrig(<a class="code hl_variable" href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a>, <a class="code hl_variable" href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a>, <a class="code hl_variable" href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a>);</div>
<div class="line"><span class="lineno">  358</span>}</div>
<div class="ttc" id="a_hooks_8h_html_a5d405dff9ba7e6c73d78857f415965f4"><div class="ttname"><a href="_hooks_8h.html#a5d405dff9ba7e6c73d78857f415965f4">PoolType</a></div><div class="ttdeci">POOL_TYPE PoolType</div><div class="ttdef"><b>Definition:</b> Hooks.h:165</div></div>
<div class="ttc" id="a_hooks_8h_html_a61083d5dde730c2afd10a336322aaaac"><div class="ttname"><a href="_hooks_8h.html#a61083d5dde730c2afd10a336322aaaac">NumberOfBytes</a></div><div class="ttdeci">POOL_TYPE SIZE_T NumberOfBytes</div><div class="ttdef"><b>Definition:</b> Hooks.h:166</div></div>
<div class="ttc" id="a_hooks_8h_html_aba7c9f3767dcc5232354d3d17ceedb61"><div class="ttname"><a href="_hooks_8h.html#aba7c9f3767dcc5232354d3d17ceedb61">Tag</a></div><div class="ttdeci">POOL_TYPE SIZE_T ULONG Tag</div><div class="ttdef"><b>Definition:</b> Hooks.h:167</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_53a6cdbae347618e9ee76d4be5c6ea96.html">hyperdbg</a></li><li class="navelem"><a class="el" href="dir_19054a674c4bd5cb8fceb6542228579c.html">hprdbghv</a></li><li class="navelem"><a class="el" href="dir_aac0c9299474d8b4035e61d55763e72a.html">code</a></li><li class="navelem"><a class="el" href="dir_7e58684227d09e40750a09b6382a82df.html">hooks</a></li><li class="navelem"><a class="el" href="dir_7b57dd4af321a012b9b72d721b40d6fd.html">ept-hook</a></li><li class="navelem"><a class="el" href="_ept_hook_8c.html">EptHook.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
